<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Painel | Doke Profissional</title>
    <link rel="stylesheet" href="style.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ==========================================================================
           ESTILOS GERAIS (Mantidos do original)
           ========================================================================== */
        .perfil-main { margin-left: 270px; margin-right: 20px; max-width: 1600px; width: auto; padding-bottom: 60px; }
        .perfil-header-card { background: #fff; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; margin-bottom: 30px; }
        .capa-perfil { height: 180px; background: linear-gradient(120deg, var(--cor2), #8e44ad); position: relative; }
        .btn-edit-capa { position: absolute; right: 20px; bottom: 20px; background: rgba(0,0,0,0.5); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .dados-perfil { padding: 0 30px 20px 30px; display: flex; flex-wrap: wrap; align-items: flex-end; gap: 30px; margin-top: -50px; }
        .avatar-container { position: relative; flex-shrink: 0; }
        .avatar-container img { width: 140px; height: 140px; border-radius: 50%; border: 5px solid #fff; object-fit: cover; background: #fff; }
        .status-online { width: 20px; height: 20px; background: #2ecc71; border: 3px solid #fff; border-radius: 50%; position: absolute; bottom: 15px; right: 10px; display: none; /* Controlado via JS */ }
        .info-texto { flex: 1; margin-top: 60px; min-width: 250px; }
        .nome-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .nome-row h1 { font-size: 1.6rem; color: #333; margin: 0; display:flex; align-items:center; gap:5px; }
        .social-stats { display: flex; gap: 25px; margin: 12px 0 15px 0; }
        .stat-social { display: flex; flex-direction: column; align-items: flex-start; cursor: pointer; }
        .stat-social strong { font-size: 1.1rem; color: #333; font-weight: 800; }
        .stat-social span { font-size: 0.85rem; color: #777; }
        .bio { color: #666; font-size: 0.95rem; margin: 8px 0 15px 0; line-height: 1.4; }
        .meta-dados { display: flex; gap: 20px; flex-wrap: wrap; font-size: 0.85rem; color: #777; }
        .acoes-perfil { display: flex; flex-direction: column; align-items: flex-end; gap: 10px; padding-top: 60px; }
        .btn-solid { background: var(--cor0); color: white; border: none; padding: 10px 25px; border-radius: 30px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-solid:hover { background: #096356; transform: translateY(-2px); }
        .toggle-disponivel { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; font-weight: 600; color: #555; margin-bottom: 5px; }

        /* DESTAQUES & ABAS */
        .area-destaques-container { padding: 10px 30px 30px 30px; border-top: 1px solid #f5f5f5; margin-top: 10px; }
        .scroll-destaques { display: flex; gap: 18px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .item-destaque { display: flex; flex-direction: column; align-items: center; cursor: pointer; min-width: 70px; }
        .circulo-destaque { width: 68px; height: 68px; border-radius: 50%; padding: 3px; border: 1px solid #ddd; margin-bottom: 8px; transition: transform 0.2s ease; }
        .circulo-destaque img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .circulo-destaque.add { border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; background: #fafafa; }
        .tabs-container { border-bottom: 1px solid #e0e0e0; margin-bottom: 25px; display: flex; gap: 30px; overflow-x: auto; }
        .tab-btn { background: none; border: none; padding: 10px 5px; font-size: 1rem; color: #777; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.3s; white-space: nowrap; }
        .tab-btn.active { color: var(--cor2); border-bottom-color: var(--cor2); }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* KPIS & GRÁFICOS */
        .painel-stats-geral { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .card-kpi { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #eee; text-align: center; }
        .card-kpi h3 { font-size: 1.8rem; color: #333; margin: 0; }
        .text-success { color: #2ecc71; } .text-danger { color: #e74c3c; }
        .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-card { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #eee; height: 320px; display: flex; flex-direction: column; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .canvas-container { flex: 1; position: relative; width: 100%; height: 100%; overflow: hidden; }

        /* LISTA DE ANÚNCIOS */
        .anuncio-stats-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 12px; padding: 15px; display: flex; gap: 20px; margin-bottom: 15px; align-items: center; }
        .img-anuncio-mini { width: 100px; height: 100px; border-radius: 8px; object-fit: cover; }
        .info-anuncio-stats { flex: 1; }
        .topo-anuncio { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .badge-status { font-size: 0.75rem; font-weight: 700; padding: 4px 10px; border-radius: 20px; }
        .badge-status.ativo { background: #e8f5e9; color: #2e7d32; }
        .badge-status.pausado { background: #fff3e0; color: #ef6c00; }
        .grid-metricas-anuncio { display: flex; gap: 25px; }
        .metrica { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .acoes-anuncio-stats { display: flex; flex-direction: column; gap: 8px; }
        .btn-boost { background: linear-gradient(90deg, #ff9800, #f57c00); color: white; border: none; padding: 8px 15px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.85rem; display: flex; gap: 5px; align-items: center; }
        .btn-icon-stats { background: #f5f5f5; border: none; padding: 8px; border-radius: 6px; cursor: pointer; color: #555; }

        /* FEED (CRIAR POST) */
        .box-criar-post { background: #fff; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .topo-criar { display: flex; gap: 15px; margin-bottom: 15px; }
        .avatar-mini { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; }
        .topo-criar textarea { flex: 1; border: none; resize: none; outline: none; font-family: var(--fonte-padrao); font-size: 1rem; color: #333; padding-top: 10px; height: 60px; }
        .bottom-criar { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f0f0f0; padding-top: 15px; }
        .opcoes-midia { display: flex; gap: 10px; }
        .btn-midia { background: transparent; border: none; cursor: pointer; display: flex; align-items: center; gap: 6px; font-weight: 600; font-size: 0.9rem; }
        .btn-midia.foto { color: #2ecc71; }
        .btn-midia.video { color: #e74c3c; }
        .btn-midia.story { color: #9b59b6; border: 1px dashed #9b59b6; padding: 5px 10px; border-radius: 20px; }
        .btn-publicar { background: var(--cor2); color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: 600; cursor: pointer; }
        
        .post-feed-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 12px; margin-top: 20px; overflow: hidden; }
        .header-post { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .user-post { display: flex; gap: 10px; align-items: center; }
        .user-post img { width: 40px; height: 40px; border-radius: 50%; }
        .legenda-post { padding: 0 15px 15px 15px; margin: 0; font-size: 0.95rem; color: #333; }
        .midia-post img { width: 100%; height: auto; display: block; }
        .stats-post { padding: 15px; border-top: 1px solid #f0f0f0; display: flex; gap: 20px; color: #666; font-size: 0.85rem; font-weight: 600; }

        /* PORTFÓLIO */
        .portfolio-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding: 10px 0; }
        .card-portfolio { background: #fff; border-radius: 12px; border: 1px solid #eee; overflow: hidden; transition: transform 0.3s, box-shadow 0.3s; cursor: pointer; }
        .card-portfolio:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        .portfolio-thumb { width: 100%; height: 180px; object-fit: cover; }
        .portfolio-body { padding: 15px; }
        .portfolio-tags { display: flex; gap: 8px; margin-bottom: 10px; }
        .tag-pf { background: #f0f0f0; color: #666; font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; font-weight: 600; }
        .portfolio-body h4 { margin: 0 0 5px 0; font-size: 1.1rem; color: #333; }
        .portfolio-body p { margin: 0; font-size: 0.85rem; color: #777; line-height: 1.4; }
        .portfolio-footer { padding: 12px 15px; border-top: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; }
        .btn-ver-projeto { font-size: 0.8rem; font-weight: 700; color: var(--cor0); background: none; border: none; cursor: pointer; }

        /* AVALIAÇÕES */
        .avaliacao-container { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #f0f0f0; width: 100%; margin-top: 10px; }
        .avaliacao-header { display: flex; align-items: center; margin-bottom: 30px; gap: 20px; }
        .criterios-badge { background-color: #e0f2f1; color: var(--cor0); font-weight: 800; padding: 8px 25px; border-radius: 30px; font-size: 1rem; flex-shrink: 0; width: 200px; text-align: center; }
        .notas-header { background-color: #ecedf2; color: var(--cor2); font-weight: 700; padding: 8px 20px; border-radius: 30px; flex-grow: 1; display: flex; justify-content: space-between; font-size: 0.9rem; }
        .notas-header span { flex: 1; text-align: left; padding-left: 10px; }
        .avaliacao-row { display: flex; align-items: center; padding: 15px 0; gap: 20px; position: relative; border-bottom: 1px solid #f9f9f9; border-left: 4px solid transparent; cursor: pointer; }
        .avaliacao-row:hover { background-color: #fafafa; }
        .avaliacao-row.selecionado { background-color: #e0f2f1; border-left-color: var(--cor0); }
        .criterio-nome { width: 200px; color: var(--cor2); font-weight: 600; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; flex-shrink: 0; }
        .icon-criterio { width: 20px; height: 20px; stroke: #999; }
        .barras-grupo { flex-grow: 1; display: flex; justify-content: space-between; }
        .barra-item { flex: 1; display: flex; align-items: center; gap: 8px; padding-right: 15px; }
        .barra-item .num { color: var(--cor2); font-weight: 700; min-width: 20px; font-size: 0.85rem; }
        .progress { background-color: #f0f0f0; height: 8px; border-radius: 10px; width: 100%; max-width: 60px; overflow: hidden; }
        .progress .fill { background-color: var(--cor0); height: 100%; border-radius: 10px; }
        .tooltip-msgs { display: none !important; }
        #box-detalhes-criterio { background: #fafafa; border: 1px solid #eee; border-radius: 8px; padding: 20px; margin: 20px 0; display: none; animation: fadeIn 0.3s; }
        .msg-destaque-item { background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 10px; color: #555; font-style: italic; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border-left: 3px solid #ccc; }
        .galeria-posts { display: flex; justify-content: space-between; gap: 20px; margin-top: 40px; padding-top: 20px; border-top: 1px solid #f5f5f5; }
        .post-card { background-color: #f9f9f9; border: 1px solid #eee; border-radius: 15px; min-height: 150px; flex: 1; position: relative; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; }
        .user-comment-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .avatar-comment { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .name-comment { font-size: 0.9rem; font-weight: 700; color: #333; display: flex; flex-direction: column; line-height: 1.2; }
        .conteudo-post { font-size: 0.85rem; color: #555; font-style: italic; line-height: 1.4; }
        .heart-icon { position: absolute; bottom: 15px; right: 15px; font-size: 1.2rem; color: var(--cor0); cursor: pointer; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-card { background: #fff; width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); overflow: hidden; animation: zoomIn 0.3s; }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { background: #f9f9f9; padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.9rem; font-weight: 600; color: #555; margin-bottom: 5px; }
        .input-modal { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: var(--fonte-padrao); }
        /* Estilo para campo bloqueado */
        .input-modal:disabled { background-color: #f0f0f0; color: #999; cursor: not-allowed; }
        
        .modal-footer { padding: 15px 20px; background: #fff; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
        .btn-cancel { background: #f0f0f0; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; color: #666; }
        .btn-save { background: var(--cor0); border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; color: white; }
        .btn-close-modal { border:none; background:transparent; font-size:1.5rem; cursor:pointer;}

        .custom-file-wrapper { display: flex; align-items: center; gap: 10px; }
        .custom-file-label { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background-color: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; color: #555; font-size: 0.9rem; font-weight: 600; transition: 0.2s; }
        .custom-file-label:hover { background-color: #e9ecef; border-color: #ccc; color: #333; }
        .custom-file-label i { font-size: 1.2rem; color: var(--cor0); }
        .file-name { font-size: 0.85rem; color: #888; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .galeria-modal-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
        .thumb-wrapper { position: relative; width: 80px; height: 80px; border-radius: 8px; border: 1px solid #ddd; overflow: hidden; }
        .thumb-img { width: 100%; height: 100%; object-fit: cover; }
        .btn-delete-img { position: absolute; top: 2px; right: 2px; background: rgba(231, 76, 60, 0.9); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; font-weight: bold; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: 0.2s; }
        .btn-delete-img:hover { background: red; transform: scale(1.1); }
        
        /* Estilo para mensagem de "Vazio" */
        .empty-state { width: 100%; text-align: center; color: #888; padding: 40px; font-style: italic; background: #fafafa; border-radius: 8px; border: 1px dashed #ddd; }

        @media (max-width: 768px) {
            .perfil-main { margin-left: 0; margin-right: 0; padding: 0 0 60px 0; }
            .perfil-header-card { border-radius: 0; border: none; margin-bottom: 15px; }
            .dados-perfil { flex-direction: column; align-items: center; text-align: center; margin-top: -60px; }
            .painel-stats-geral { grid-template-columns: 1fr; }
            .charts-grid { display: flex; flex-direction: column; gap: 20px; height: auto; margin-bottom: 20px; }
            .chart-card { width: 100%; height: auto; min-height: 320px; }
            .anuncio-stats-card { flex-direction: column; align-items: flex-start; }
            .img-anuncio-mini { width: 100%; height: 150px; }
            .acoes-anuncio-stats { flex-direction: row; width: 100%; justify-content: space-between; margin-top: 10px; }
            .portfolio-grid { grid-template-columns: 1fr; }
            .avaliacao-header { display: none; }
            .avaliacao-row { flex-direction: column; align-items: flex-start; gap: 15px; padding: 20px; }
            .criterio-nome { width: 100%; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 10px; }
            .barras-grupo { display: grid; grid-template-columns: 1fr 1fr; width: 100%; gap: 10px; }
            .galeria-posts { flex-direction: column; }
        }
    </style>
</head>
<body>

    <header class="navbar-mobile">
        <div id="logo-mobile">
            <a href="index.html"><img src="assets/Imagens/doke-logo.png" alt="Doke" onerror="this.src='https://placehold.co/100x40?text=Doke'"></a>
        </div>
        <div class="mobile-controls">
            <button id="btn-menu-mobile" onclick="abrirMenuMobile()"><i class='bx bx-menu' style="font-size: 30px; color: var(--cor2);"></i></button>
        </div>
    </header>
    <div id="overlay-menu" onclick="fecharMenuMobile()"></div>

    <aside class="sidebar-icones">
        <div id="logo"><a href="index.html"><img src="assets/Imagens/doke-logo.png" alt="Doke"></a></div>
        <div class="item"><a href="index.html"><img src="https://cdn-icons-png.flaticon.com/512/1946/1946436.png" class="icon azul"><span>Início</span></a></div>
        <div class="item"><a href="explorar.html"><img src="https://cdn-icons-png.flaticon.com/512/622/622669.png" class="icon verde"><span>Explorar</span></a></div>
        <div class="item"><a href="notificacoes.html"><img src="https://cdn-icons-png.flaticon.com/512/1827/1827392.png" class="icon azul"><span>Notificações</span></a></div>
        <div class="item"><img src="https://cdn-icons-png.flaticon.com/512/561/561127.png" class="icon azul"><a href="chat.html"><span>Mensagens</span></a></div>
        <div class="item"><a href="comunidade.html"><img src="https://cdn-icons-png.flaticon.com/512/1144/1144760.png" class="icon verde"><span>Comunidades</span></a></div>
        <div class="item active"><img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="icon verde"><a href="meuperfil.html"><span>Perfil</span></a></div>
        <div class="item"><img src="https://cdn-icons-png.flaticon.com/512/56/56763.png" class="icon azul"><a href="mais.html"><span>Mais</span></a></div>
    </aside>

    <header class="navbar-desktop">
        <div id="logo-desktop"><a href="projeto.html"><img src="assets/Imagens/doke-logo.png" alt="Doke"></a></div>
        <nav class="menu">
            <div class="cep-wrapper"><a href="#" class="cep"><span>Informe seu CEP</span></a></div>
            <a href="anunciar.html">Anuncie seu serviço</a>
            <a href="comunidade.html ">Comunidades <span class="badge-novo">NOVO</span></a>
            <a href="novidades.html">Novidades</a>
        </nav>
        <div class="botoes-direita" id="header-user-area">
            </div>
    </header>   

    <main class="perfil-main">
        <section class="perfil-header-card">
            <div class="capa-perfil">
                <button class="btn-edit-capa"><i class='bx bx-camera'></i> Editar Capa</button>
            </div>
            <div class="dados-perfil">
                <div class="avatar-container">
                    <img src="" alt="Perfil" id="fotoPerfilDisplay">
                    <div class="status-online" id="statusOnlineIndicator"></div>
                </div>
                <div class="info-texto">
                    <div class="nome-row">
                        <h1 id="nomePerfilDisplay">...</h1>
                    </div>
                    <div class="social-stats">
                        <div class="stat-social"><strong id="stat-seguidores">0</strong><span>Seguidores</span></div>
                        <div class="stat-social"><strong id="stat-seguindo">0</strong><span>Seguindo</span></div>
                        <div class="stat-social"><strong id="stat-avaliacoes-count">0</strong><span>Avaliações</span></div>
                    </div>
                    <p class="bio" id="bioPerfilDisplay">...</p>
                    <div class="meta-dados">
                        <span id="locPerfilDisplay"><i class='bx bx-map'></i> ...</span>
                        <span id="dataMembroDisplay"><i class='bx bx-calendar'></i> Membro desde ...</span>
                    </div>
                </div>
                <div class="acoes-perfil">
                    <div class="toggle-disponivel">
                        <span>Disponível</span>
                        <label class="switch"><input type="checkbox" id="checkDisponivel"><span class="slider round"></span></label>
                    </div>
                    <button class="btn-solid" onclick="abrirModalEditar()"><i class='bx bx-pencil'></i> Editar Perfil</button>
                </div>
            </div>
            <div class="area-destaques-container">
                <div class="scroll-destaques" id="lista-destaques">
                    <div class="item-destaque"><div class="circulo-destaque add"><i class='bx bx-plus'></i></div><span>Novo</span></div>
                </div>
            </div>
        </section>

        <div class="tabs-container">
            <button class="tab-btn active" onclick="abrirTab(event, 'tab-anuncios')">Gerenciar Anúncios</button>
            <button class="tab-btn" onclick="abrirTab(event, 'tab-feed')">Criar Publicação</button>
            <button class="tab-btn" onclick="abrirTab(event, 'tab-portfolio')">Portfólio</button>
            <button class="tab-btn" onclick="abrirTab(event, 'tab-avaliacoes')">Avaliações</button>
        </div>

        <div id="tab-anuncios" class="tab-content active">
            <div class="painel-stats-geral">
                <div class="card-kpi"><span>Visualizações Totais</span><h3 id="kpi-views">0</h3></div>
                <div class="card-kpi"><span>Cliques no Perfil</span><h3 id="kpi-cliques">0</h3></div>
                <div class="card-kpi"><h3 id="kpi-ctr">0%</h3><small class="text-secondary">-</small></div>
            </div>
            <div class="charts-grid">
                <div class="chart-card"><h4>Desempenho</h4><div class="canvas-container"><canvas id="graficoDesempenho"></canvas></div></div>
                <div class="chart-card"><h4>Origem</h4><div class="canvas-container"><canvas id="graficoOrigem"></canvas></div></div>
            </div>
            <h3 class="titulo-sessao">Meus Anúncios Ativos</h3>
            <div id="lista-meus-anuncios">
                </div>
        </div>

        <div id="tab-feed" class="tab-content">
            <div class="box-criar-post">
                <div class="topo-criar">
                    <img src="" id="avatar-criar-post" class="avatar-mini">
                    <textarea placeholder="O que você realizou hoje? Compartilhe com seus clientes..."></textarea>
                </div>
                <div class="bottom-criar">
                    <div class="opcoes-midia">
                        <button class="btn-midia foto"><i class='bx bx-image'></i> Foto</button>
                        <button class="btn-midia video"><i class='bx bx-video'></i> Vídeo</button>
                        <button class="btn-midia story"><i class='bx bx-history'></i> Add Story</button>
                    </div>
                    <button class="btn-publicar">Publicar</button>
                </div>
            </div>
            <h3 class="titulo-sessao" style="margin-top:30px;">Suas Publicações Recentes</h3>
            
            <div id="container-feed-posts">
                </div>
        </div>

        <div id="tab-portfolio" class="tab-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 class="titulo-sessao" style="margin:0;" id="titulo-portfolio">Meus Projetos (0)</h3>
                <button class="btn-solid" style="padding: 8px 20px; font-size:0.85rem;"><i class='bx bx-plus'></i> Adicionar Projeto</button>
            </div>
            <div class="portfolio-grid" id="container-portfolio">
                </div>
        </div>
        
        <div id="tab-avaliacoes" class="tab-content">
            <h3 class="titulo-sessao">Resumo das Avaliações</h3>
            <div class="avaliacao-container">
                <div class="avaliacao-header">
                    <div class="criterios-badge">Critérios</div>
                    <div class="notas-header"><span>Ótimo</span><span>Bom</span><span>Regular</span><span>Ruim</span><span>Péssimo</span></div>
                </div>

                <div id="container-lista-criterios">
                    </div>

                <div id="box-detalhes-criterio">
                    <h4 id="titulo-detalhe">
                        <i class='bx bx-message-detail'></i> Comentários Selecionados
                    </h4>
                    <div id="lista-comentarios-dinamica"></div>
                </div>

                <div class="galeria-posts" id="container-comentarios-clientes">
                    </div>
            </div>
        </div>
    </main>

    <div id="modalEditar" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header"><h3>Editar Perfil</h3><button onclick="fecharModalEditar()" class="btn-close-modal">×</button></div>
            <div class="modal-body">
                
                <div class="form-group">
                    <label>Nome de Usuário (@)</label>
                    <input type="text" id="inputUserHandle" class="input-modal" placeholder="@usuario">
                    <small id="msgTrocaUser" style="color:#e74c3c; font-size:0.8rem; display:none; margin-top:5px; font-weight:600;"></small>
                </div>

                <div class="form-group"><label>Nome de Exibição</label><input type="text" id="inputNome" class="input-modal"></div>
                <div class="form-group"><label>Biografia</label><textarea id="inputBio" class="input-modal" rows="3"></textarea></div>
                <div class="form-group"><label>Localização (Cidade/UF)</label><input type="text" id="inputLoc" class="input-modal"></div>
                <div class="form-group">
                    <label>Foto de Perfil</label>
                    <div class="custom-file-wrapper">
                        <label for="inputFotoFile" class="custom-file-label"><i class='bx bx-camera'></i> Trocar Foto</label>
                        <span id="fotoFileName" class="file-name">Nenhuma selecionada</span>
                        <input type="file" id="inputFotoFile" accept="image/*" style="display:none;">
                        <input type="hidden" id="inputFotoBase64">
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button onclick="fecharModalEditar()" class="btn-cancel">Cancelar</button><button onclick="salvarPerfil()" class="btn-save">Salvar Alterações</button></div>
        </div>
    </div>

    <div id="modalEditarAnuncio" class="modal-overlay">
        <div class="modal-card" style="max-width: 600px; display: flex; flex-direction: column;">
            <div class="modal-header"><h3>Gerenciar Anúncio</h3><button onclick="fecharModalAnuncio()" class="btn-close-modal">×</button></div>
            <div class="modal-body" style="overflow-y: auto; max-height: 70vh;">
                <input type="hidden" id="editAnuncioId"><input type="hidden" id="editImg"> 
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group"><label>Título</label><input type="text" id="editTitulo" class="input-modal"></div>
                    <div class="form-group"><label>Categoria</label><select id="editCategoria" class="input-modal"><option>Eletricista</option><option>Encanador</option><option>Pedreiro</option><option>Pintor</option><option>Montador</option><option>Outros</option></select></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group"><label>Preço</label><input type="text" id="editPreco" class="input-modal"></div>
                    <div class="form-group"><label>Status</label><select id="editStatus" class="input-modal"><option value="ativo">Ativo</option><option value="pausado">Pausado</option></select></div>
                </div>
                <div class="form-group">
                    <label>Fotos do Serviço</label>
                    <div id="previewGaleriaModal" class="galeria-modal-container"></div>
                    <div class="custom-file-wrapper">
                        <label for="editImgInput" class="custom-file-label"><i class='bx bx-image-add'></i> Adicionar Foto</label>
                        <span id="fileNameDisplay" class="file-name">Adicione mais fotos...</span>
                        <input type="file" id="editImgInput" accept="image/*" style="display:none;">
                    </div>
                </div>
                <div class="form-group"><label>Local</label><input type="text" id="editLocal" class="input-modal"></div>
                <div class="form-group"><label>Descrição</label><textarea id="editDescricao" class="input-modal" rows="4"></textarea></div>
            </div>
            <div class="modal-footer" style="justify-content: space-between; align-items: center;">
                <a href="editar-anuncio-completo.html" style="font-size:0.9rem; color:var(--cor0); margin-right:auto;">Mais opções</a>
                <div style="display: flex; gap: 10px;">
                    <button onclick="excluirAnuncio()" class="btn-cancel" style="color:white; background:#e74c3c;">Excluir</button>
                    <button onclick="salvarAlteracaoAnuncio()" class="btn-save">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="index.html" class="item"><img src="https://cdn-icons-png.flaticon.com/512/1946/1946436.png" class="icon azul"><span>Início</span></a>
        <a href="meuperfil.html" class="item active"><img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="icon verde"><span>Perfil</span></a>
    </nav>

<script type="module">
// ============================================================
// 1. IMPORTAÇÕES E CONFIGURAÇÃO
// ============================================================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";
import { getFirestore, collection, getDocs, addDoc, setDoc, getDoc, query, where, orderBy, doc, updateDoc, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

// SUAS CHAVES DO PROJETO 'Doke-Site'
const firebaseConfig = {
    apiKey: "AIzaSyDbUwwj-joyhJ3aJ-tP4WJhGC1wLrwYh60",
    authDomain: "doke-site.firebaseapp.com",
    projectId: "doke-site",
    storageBucket: "doke-site.firebasestorage.app",
    messagingSenderId: "997098339190",
    appId: "1:997098339190:web:a865b696278be21f069857"
};

// Inicializa o Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getFirestore(app);
const auth = getAuth(app); 

// GARANTE QUE O DB E AUTH ESTEJAM ACESSÍVEIS GLOBALMENTE
window.db = db;
window.auth = auth;

// ... RESTO DO CÓDIGO ...

        let userHandleOriginal = ""; 

        // --- CARREGAR PERFIL ---
        window.carregarPerfil = function() {
            // Tenta pegar do localStorage primeiro para ser rápido
            const usuario = JSON.parse(localStorage.getItem('doke_usuario_perfil')) || {
                nome: "Novo Usuário",
                user: "@usuario",
                bio: "Edite seu perfil para adicionar uma biografia.",
                local: "Brasil",
                foto: "https://placehold.co/150x150?text=Foto",
                membroDesde: "2024"
            };
            
            userHandleOriginal = usuario.user || "@usuario";

            // Exibe o USUÁRIO em Destaque e o Nome embaixo
            if(document.getElementById('nomePerfilDisplay')) {
                const containerNome = document.getElementById('nomePerfilDisplay');
                containerNome.innerHTML = `
                    <div style="display:flex; flex-direction:column; align-items:flex-start;">
                        <span style="font-size: 1.6rem; color: var(--cor2); font-weight: 800; display:flex; align-items:center; gap:5px;">
                            ${usuario.user || '@usuario'} 
                            <i class='bx bxs-badge-check' style="color:#2ecc71; font-size: 1.2rem;"></i>
                        </span>
                        <span style="font-size: 1.0rem; color: #666; font-weight: 500; margin-top: -2px;">
                            ${usuario.nome}
                        </span>
                    </div>
                `;
            }

            if(document.getElementById('bioPerfilDisplay')) 
                document.getElementById('bioPerfilDisplay').innerText = usuario.bio;
            
            if(document.getElementById('locPerfilDisplay')) 
                document.getElementById('locPerfilDisplay').innerHTML = "<i class='bx bx-map'></i> " + usuario.local;
            
            if(document.getElementById('fotoPerfilDisplay')) 
                document.getElementById('fotoPerfilDisplay').src = usuario.foto;
            
            if(document.getElementById('dataMembroDisplay'))
                document.getElementById('dataMembroDisplay').innerHTML = "<i class='bx bx-calendar'></i> Membro desde " + (usuario.membroDesde || "2024");

            // Atualiza avatar do header COM A FUNÇÃO DE MENU
            renderizarMenuDropdown(usuario.foto || "https://placehold.co/150");

            // Preenche modal de edição
            if(document.getElementById('inputNome')) {
                document.getElementById('inputNome').value = usuario.nome;
                document.getElementById('inputBio').value = usuario.bio;
                document.getElementById('inputLoc').value = usuario.local;
                document.getElementById('inputFotoBase64').value = usuario.foto;
                
                // LÓGICA DO USUÁRIO (@) E OS 15 DIAS
                const handleInput = document.getElementById('inputUserHandle');
                const msgUser = document.getElementById('msgTrocaUser');
                
                if (handleInput) {
                    handleInput.value = usuario.user || "@usuario";

                    if (usuario.ultimoTrocaUser) {
                        const ultimaTroca = new Date(usuario.ultimoTrocaUser);
                        const hoje = new Date();
                        const diffTempo = hoje - ultimaTroca;
                        const diffDias = diffTempo / (1000 * 60 * 60 * 24); 

                        if (diffDias < 15) {
                            const diasRestantes = Math.ceil(15 - diffDias);
                            handleInput.disabled = true;
                            handleInput.title = "Aguarde o prazo para trocar novamente";
                            msgUser.style.display = "block";
                            msgUser.innerHTML = `<i class='bx bx-time-five'></i> Você só poderá alterar o usuário novamente em <b>${diasRestantes} dias</b>.`;
                        } else {
                            handleInput.disabled = false;
                            msgUser.style.display = "none";
                        }
                    } else {
                        handleInput.disabled = false;
                        msgUser.style.display = "none";
                    }
                }
            }
        }

        // --- SALVAR PERFIL (AGORA COM FIRESTORE) ---
        window.salvarPerfil = async function() {
            const user = auth.currentUser;
            if(!user) {
                alert("Você precisa estar logado para salvar.");
                return;
            }

            const btnSave = document.querySelector('.btn-save');
            if(btnSave) { btnSave.innerText = "Salvando..."; btnSave.disabled = true; }

            // Pega dados do LocalStorage atual para preservar campos que não mudaram
            const perfilAntigo = JSON.parse(localStorage.getItem('doke_usuario_perfil')) || {};
            
            const novoHandle = document.getElementById('inputUserHandle').value.trim();
            const inputHandle = document.getElementById('inputUserHandle');

            const novoPerfil = {
                ...perfilAntigo, // Mantém dados antigos (ex: membroDesde)
                nome: document.getElementById('inputNome').value,
                bio: document.getElementById('inputBio').value,
                local: document.getElementById('inputLoc').value,
                foto: document.getElementById('inputFotoBase64').value
            };
            
            // Lógica do Handle (@usuario)
            if (inputHandle && !inputHandle.disabled && novoHandle !== userHandleOriginal) {
                let handleFormatado = novoHandle.toLowerCase();
                if (!handleFormatado.startsWith('@')) {
                    handleFormatado = '@' + handleFormatado;
                }
                novoPerfil.user = handleFormatado;
                novoPerfil.ultimoTrocaUser = new Date().toISOString();
            }

            try {
                // 1. SALVA NO FIRESTORE (Banco de Dados)
                // Isso garante que os dados persistam após o logout
                await updateDoc(doc(db, "usuarios", user.uid), novoPerfil);

                // 2. ATUALIZA LOCALSTORAGE (Visual imediato)
                localStorage.setItem('doke_usuario_perfil', JSON.stringify(novoPerfil));
                
                carregarPerfil();
                fecharModalEditar();
                alert("Perfil atualizado com sucesso!");
            } catch (e) {
                console.error("Erro ao salvar:", e);
                alert("Erro ao salvar no banco de dados.");
            } finally {
                if(btnSave) { btnSave.innerText = "Salvar Alterações"; btnSave.disabled = false; }
            }
        }

        // --- RENDERIZAR ANÚNCIOS ---
        window.renderizarAnuncios = async function() {
            const container = document.getElementById('lista-meus-anuncios');
            if(!container) return;
            
            container.innerHTML = '<div style="padding:40px; text-align:center; color:#666;"><i class="bx bx-loader-alt bx-spin"></i> Carregando seus anúncios...</div>'; 
            
            try {
                const usuarioLocal = JSON.parse(localStorage.getItem('doke_usuario_perfil'));
                const meuUserHandle = usuarioLocal ? usuarioLocal.user : null;

                if (!meuUserHandle) {
                    container.innerHTML = '<p style="text-align:center;">Erro: Usuário não identificado.</p>';
                    return;
                }

                const q = query(collection(db, "anuncios"), where("userHandle", "==", meuUserHandle));
                const querySnapshot = await getDocs(q);
                
                container.innerHTML = ''; 

                if (querySnapshot.empty) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class='bx bx-ghost' style="font-size: 40px; margin-bottom: 10px;"></i><br>
                            Você ainda não tem anúncios ativos.<br>
                            <a href="anunciar.html" style="color:var(--cor0); font-weight:bold;">Criar um agora</a>
                        </div>`;
                    atualizarKPIs(0, 0);
                    return;
                }

                let totalViews = 0;
                let totalCliques = 0;

                querySnapshot.forEach((docSnap) => {
                    const anuncio = docSnap.data();
                    const id = docSnap.id;
                    const views = anuncio.views || 0;
                    const cliques = anuncio.cliques || 0;
                    totalViews += views;
                    totalCliques += cliques;

                    let imgCapa = (anuncio.fotos && anuncio.fotos.length > 0) ? anuncio.fotos[0] : (anuncio.img || 'https://placehold.co/100?text=Sem+Foto');
                    
                    const html = `
                        <div class="anuncio-stats-card">
                            <img src="${imgCapa}" class="img-anuncio-mini">
                            <div class="info-anuncio-stats">
                                <div class="topo-anuncio">
                                    <h4 style="margin:0; font-size:1rem;">${anuncio.titulo}</h4>
                                    <span class="badge-status ativo">ATIVO</span>
                                </div>
                                <div class="grid-metricas-anuncio">
                                    <div class="metrica" title="Visualizações"><i class='bx bx-show'></i> <strong>${views}</strong></div>
                                    <div class="metrica" title="Preço"><i class='bx bx-dollar-circle'></i> <strong>${anuncio.preco || 'A combinar'}</strong></div>
                                </div>
                            </div>
                            <div class="acoes-anuncio-stats">
                                <button class="btn-icon-stats" onclick="alert('Edição em breve!')"><i class='bx bx-edit'></i></button>
                                <button class="btn-icon-stats" onclick="deletarAnuncio('${id}')" style="color:#e74c3c;"><i class='bx bx-trash'></i></button>
                            </div>
                        </div>`;
                    container.insertAdjacentHTML('beforeend', html);
                });
                atualizarKPIs(totalViews, totalCliques);
            } catch (error) {
                console.error("Erro ao buscar anúncios:", error);
                container.innerHTML = `<p style="color:red; text-align:center;">Erro de permissão ou conexão.</p>`;
            }
        }

        function atualizarKPIs(views, cliques) {
            const elViews = document.querySelector('.card-kpi:nth-child(1) h3');
            const elCliques = document.querySelector('.card-kpi:nth-child(2) h3');
            const elCTR = document.querySelector('.card-kpi:nth-child(3) h3');
            if(elViews) elViews.innerText = views > 1000 ? (views/1000).toFixed(1) + 'k' : views;
            if(elCliques) elCliques.innerText = cliques;
            if(elCTR) { let ctr = views > 0 ? ((cliques / views) * 100).toFixed(1) : 0; elCTR.innerText = ctr + "%"; }
        }

        window.deletarAnuncio = async function(id) {
            if(confirm("Excluir este anúncio?")) {
                try { await deleteDoc(doc(db, "anuncios", id)); alert("Excluído!"); renderizarAnuncios(); } 
                catch (e) { alert("Erro ao excluir."); }
            }
        }

        // FUNÇÕES DE UI
        window.abrirTab = function(evt, tabName) {
            document.querySelectorAll(".tab-content").forEach(t => t.style.display = "none");
            document.querySelectorAll(".tab-btn").forEach(t => t.classList.remove("active"));
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.classList.add("active");
        }
        window.abrirModalEditar = function() { document.getElementById('modalEditar').style.display = 'flex'; }
        window.fecharModalEditar = function() { document.getElementById('modalEditar').style.display = 'none'; }
        
        const fileInput = document.getElementById('inputFotoFile');
        if(fileInput) {
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = function(evt) { document.getElementById('inputFotoBase64').value = evt.target.result; };
                    reader.readAsDataURL(file);
                }
            });
        }

// --- INICIALIZAÇÃO SEGURA ---
onAuthStateChanged(auth, async (user) => {
    if (user) {
        // Se estiver logado, garante que temos os dados mais recentes do banco
        // Isso corrige o problema de "não salvar" ao trocar de dispositivo/login
        try {
            const docRef = doc(db, "usuarios", user.uid);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                const dadosBanco = docSnap.data();
                // Atualiza o LocalStorage com o que veio do Banco
                localStorage.setItem('doke_usuario_perfil', JSON.stringify(dadosBanco));
                // Agora carrega a tela
                carregarPerfil();
                renderizarAnuncios();
            }
        } catch (e) {
            console.error("Erro ao sincronizar perfil:", e);
            // Se der erro, tenta carregar o que tem localmente
            carregarPerfil();
        }

        // Gráficos (Mocks)
        const ctx1 = document.getElementById('graficoDesempenho');
        if(ctx1) {
            new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'],
                    datasets: [{ 
                        label: 'Visualizações da Semana', 
                        data: [0, 0, 0, 0, 0, 0, 0], 
                        borderColor: '#e0e0e0', borderDash: [5, 5], tension: 0.4, fill: false 
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, title: { display: true, text: 'Sem dados suficientes' } },
                    scales: { y: { beginAtZero: true, max: 10 } }
                }
            });
        }
        
        const ctx2 = document.getElementById('graficoOrigem');
        if(ctx2) {
            new Chart(ctx2, {
                type: 'doughnut',
                data: { labels: ['Sem dados'], datasets: [{ data: [1], backgroundColor: ['#f0f0f0'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

    } else {
        // Se NÃO estiver logado, bloqueia a tela
        const main = document.querySelector('main');
        if(main) main.style.display = 'none';

        const bloqueioDiv = document.createElement('div');
        bloqueioDiv.className = 'bloqueio-container';
        bloqueioDiv.innerHTML = `
            <div class="bloqueio-card">
                <div class="bloqueio-icon"><i class='bx bx-lock-alt'></i></div>
                <h2 class="bloqueio-titulo">Acesso Restrito</h2>
                <p class="bloqueio-texto">Entre na sua conta ou cadastre-se para ver seu perfil.</p>
                <a href="login.html" class="btn-bloqueio-entrar">Entrar Agora</a>
                <a href="cadastro.html" class="btn-bloqueio-criar">Criar Conta</a>
            </div>
        `;
        const header = document.querySelector('.navbar-desktop');
        if(header && header.nextSibling) {
            header.parentNode.insertBefore(bloqueioDiv, header.nextSibling);
        } else {
            document.body.appendChild(bloqueioDiv);
        }
    }
});

// =======================================================
// FUNÇÕES DO MENU DROPDOWN (Adicionadas)
// =======================================================
function renderizarMenuDropdown(fotoUrl) {
    const container = document.getElementById('header-user-area');
    if (!container) return;

    container.innerHTML = `
        <div class="profile-container">
            <img src="${fotoUrl}" class="profile-img-btn" onclick="toggleDropdown(event)" alt="Perfil">
            <div id="dropdownPerfil" class="dropdown-profile">
                <a href="#" class="dropdown-item" style="pointer-events:none; color:#aaa; font-size:0.8rem;"><i class='bx bx-briefcase'></i> Painel Profissional</a>
                <a href="meuperfil.html" class="dropdown-item"><i class='bx bx-user'></i> Ver Perfil</a>
                <a href="anunciar.html" class="dropdown-item"><i class='bx bx-plus-circle'></i> Anunciar</a>
                <a href="#" onclick="fazerLogout()" class="dropdown-item item-sair"><i class='bx bx-log-out'></i> Sair</a>
            </div>
        </div>
    `;
}

window.toggleDropdown = function(event) {
    if(event) event.stopPropagation();
    const drop = document.getElementById('dropdownPerfil');
    if(drop) drop.classList.toggle('show');
}

window.addEventListener('click', function(e) {
    if (!e.target.matches('.profile-img-btn')) {
        const drops = document.getElementsByClassName("dropdown-profile");
        for (let i = 0; i < drops.length; i++) {
            if (drops[i].classList.contains('show')) {
                drops[i].classList.remove('show');
            }
        }
    }
});

window.fazerLogout = function() {
    signOut(auth).then(() => {
        localStorage.removeItem('usuarioLogado');
        window.location.href = 'index.html';
    });
}
</script>
</body>
</html>