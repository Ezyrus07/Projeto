<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Carteira | Doke</title>
    <link rel="stylesheet" href="style.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    
    <script type="module" src="script.js"></script>

    <style>
        /* ======================================================
           ESTILOS DA CARTEIRA (ATUALIZADO - HERO BLUE)
           ====================================================== */
        
        body { background: linear-gradient(180deg, var(--cor2) 0%, var(--cor4) 200px); }

        @media (min-width: 1024px) {
            main { margin-left: 270px; padding: 30px 40px; max-width: 1600px; }
        }

        /* --- NOVO HERO CONTAINER (Igual Notificações) --- */
        .wallet-hero-container {
            background: linear-gradient(135deg, var(--cor2) 0%, #1a3c5e 100%);
            padding: 40px; border-radius: 20px; margin-bottom: 30px;
            color: white; box-shadow: 0 10px 30px rgba(42, 95, 144, 0.25);
            position: relative; overflow: hidden; display: flex;
            justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 20px;
        }
        
        /* Efeito de Círculo Decorativo */
        .wallet-hero-container::before {
            content: ''; position: absolute; top: -50px; right: -20px;
            width: 200px; height: 200px; background: rgba(255,255,255,0.05);
            border-radius: 50%; pointer-events: none;
        }

        .hero-content h1 { 
            font-size: 2rem; margin-bottom: 5px; font-weight: 700; color: white; 
            display: flex; align-items: center; gap: 10px; 
        }
        .hero-content p { color: rgba(255,255,255,0.85); font-size: 0.95rem; }

        .hero-actions { display: flex; gap: 10px; }
        
        .btn-hero-action {
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 10px 18px; border-radius: 30px;
            font-size: 0.85rem; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 8px; transition: 0.2s;
            text-decoration: none; backdrop-filter: blur(5px);
        }
        .btn-hero-action:hover { background: white; color: var(--cor2); }

        /* --- CARDS DE SALDO --- */
        .balance-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px; margin-bottom: 40px;
        }

        .balance-card {
            background: white; border-radius: 20px; padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.04); border: 1px solid #edf2f7;
            display: flex; flex-direction: column; justify-content: space-between;
            position: relative; overflow: hidden; transition: transform 0.2s;
        }
        .balance-card:hover { transform: translateY(-3px); }

        /* Estilo do Card Disponível */
        .card-available { border-bottom: 4px solid #2e7d32; }
        .card-available .icon-bg {
            position: absolute; top: 20px; right: 20px; width: 50px; height: 50px;
            background: #e8f5e9; border-radius: 12px; color: #2e7d32;
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
        }

        /* Estilo do Card Garantia */
        .card-pending { border-bottom: 4px solid #f1c40f; }
        .card-pending .icon-bg {
            position: absolute; top: 20px; right: 20px; width: 50px; height: 50px;
            background: #fff8e1; border-radius: 12px; color: #f1c40f;
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
        }

        .bc-label { font-size: 0.85rem; color: #888; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .bc-value { font-size: 2.5rem; font-weight: 800; color: var(--cor2); margin: 15px 0 5px 0; letter-spacing: -1px; }
        .bc-sub { font-size: 0.85rem; color: #999; margin-bottom: 25px; }

        .btn-withdraw {
            background: var(--cor0); color: white; border: none; padding: 14px;
            border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.2s;
            font-size: 0.95rem; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 4px 12px rgba(11, 119, 104, 0.2);
        }
        .btn-withdraw:hover { background: #096356; transform: translateY(-2px); }
        .btn-withdraw:disabled { background: #e0e0e0; color: #999; cursor: not-allowed; transform: none; box-shadow: none; }

        /* --- LISTA DE TRANSAÇÕES --- */
        .history-container { background: white; border-radius: 20px; padding: 30px; border: 1px solid #edf2f7; box-shadow: 0 5px 20px rgba(0,0,0,0.03); }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; }
        .history-header h3 { margin: 0; color: var(--cor2); font-size: 1.1rem; }

        .transaction-list { display: flex; flex-direction: column; gap: 0; }
        
        .t-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 18px 0; border-bottom: 1px solid #f9f9f9; transition: 0.2s;
        }
        .t-item:last-child { border-bottom: none; }
        .t-item:hover { background: #fcfcfc; padding-left: 10px; padding-right: 10px; border-radius: 8px; }

        .t-left { display: flex; gap: 15px; align-items: center; }
        .t-icon {
            width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        }
        
        .t-icon.in { background: #e8f5e9; color: #2e7d32; }
        .t-icon.wait { background: #fff8e1; color: #f1c40f; }

        .t-info h4 { margin: 0 0 4px 0; font-size: 0.95rem; color: #333; font-weight: 600; }
        .t-info span { font-size: 0.8rem; color: #999; }

        .t-amount { font-weight: 700; font-size: 1rem; color: var(--cor2); }
        .t-amount.plus { color: #2e7d32; }
        .t-amount.waiting { color: #f1c40f; }

        @media (max-width: 768px) {
            main { padding: 20px; padding-bottom: 90px; margin-left: 0; }
            .balance-grid { grid-template-columns: 1fr; }
            .wallet-hero-container { text-align: center; justify-content: center; }
            .hero-actions { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

    <aside class="sidebar-icones">
        <div id="logo">
            <a href="index.html">
                <img src="assets/Imagens/doke-logo.png" alt="Logotipo da plataforma Doke">
            </a>
        </div>

        <div class="item">
            <a href="index.html"><img src="https://cdn-icons-png.flaticon.com/512/1946/1946436.png" class="icon azul" alt="Início">
            <span>Início</span></a>
        </div>
        <div class="item">
            <a href="explorar.html"><img src="https://cdn-icons-png.flaticon.com/512/622/622669.png" class="icon verde" alt="Explorar">
            <span>Explorar</span></a>
        </div>
        <div class="item">
            <a href="notificacoes.html"><img src="https://cdn-icons-png.flaticon.com/512/1827/1827392.png" class="icon azul" alt="Notificações">
            <span>Notificações</span></a>
        </div>
        <div class="item">
            <img src="https://cdn-icons-png.flaticon.com/512/561/561127.png" class="icon azul" alt="Mensagens">
            <a href="chat.html"><span>Mensagens</span></a>
        </div>
        <div class="item">
            <a href="comunidade.html"><img src="https://cdn-icons-png.flaticon.com/512/1144/1144760.png" class="icon verde" alt="Comunidades">
            <span>Comunidades</span></a>
        </div>
        <div class="item">
            <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="icon verde" alt="Comunidades">
            <a href="#" onclick="irParaMeuPerfil(event)"><span>Perfil</span></a>
        </div>
        <div class="item">
            <img src="https://cdn-icons-png.flaticon.com/512/56/56763.png" class="icon azul" alt="Mais">
            <a href="mais.html"><span>Mais</span></a>
        </div>
    </aside>


    <header class="navbar-desktop">
        <div id="logo-desktop">
            <a href="projeto.html">
                <img src="assets/Imagens/doke-logo.png" alt="Doke">
            </a>
        </div>
        <nav class="menu">
            <div class="cep-wrapper">
                <a href="#" class="cep" id="linkCep" onclick="toggleCep(event)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                    </svg>
                    <span id="textoCepSpan">Informe seu CEP</span>
                </a>

                <div class="cep-popup" id="boxCep">
                    <p>Digite seu CEP:</p>
                    <div class="cep-input-group">
                        <input type="text" id="inputCep" placeholder="00000-000" maxlength="9">
                        <button onclick="salvarCep()">OK</button>
                    </div>
                </div>
            </div>
            
            <a href="anunciar.html">Anuncie seu serviço</a>
            <a href="comunidade.html ">Comunidades <span class="badge-novo">NOVO</span></a>
            <a href="novidades.html">Novidades</a>
        </nav>

        <div class="botoes-direita">
            <a href="login.html" class="entrar">Entrar</a>
            <a href="login.html">
            </a>
        </div>
    </header>

    <header class="navbar-mobile">
        <div id="logo-mobile"><a href="index.html"><img src="assets/Imagens/doke-logo.png" alt="Doke" style="height: 25px;"></a></div>
        <a href="meuperfil.html"><i class='bx bx-user-circle' style="font-size: 28px; color: #333;"></i></a>
    </header>

    <main>
        
        <div class="wallet-hero-container">
            <div class="hero-content">
                <h1>Minha Carteira</h1>
                <p>Acompanhe seu saldo, histórico de ganhos e solicitações.</p>
            </div>
            <div class="hero-actions">
                <button class="btn-hero-action" onclick="window.location.href='duvida.html'">
                    <i class='bx bx-help-circle'></i> Ajuda
                </button>
                <button class="btn-hero-action">
                    <i class='bx bx-cog'></i> Configurar Saque
                </button>
            </div>
        </div>

        <div class="balance-grid">
            
            <div class="balance-card card-available">
                <div class="icon-bg"><i class='bx bx-wallet'></i></div>
                <div>
                    <span class="bc-label">Disponível para Saque</span>
                    <div class="bc-value" id="saldoDisponivel">R$ 0,00</div>
                    <div class="bc-sub">Valores liberados de serviços concluídos.</div>
                </div>
                <button class="btn-withdraw" id="btnSacar" onclick="solicitarSaque()" disabled>
                    <i class='bx bx-money-withdraw'></i> Solicitar Transferência
                </button>
            </div>

            <div class="balance-card card-pending">
                <div class="icon-bg"><i class='bx bx-lock-alt'></i></div>
                <div>
                    <span class="bc-label">Saldo em Garantia</span>
                    <div class="bc-value" id="saldoBloqueado" style="color:#f1c40f;">R$ 0,00</div>
                    <div class="bc-sub">Liberado após confirmação do cliente.</div>
                </div>
                <div style="background:#fff8e1; color:#d4ac0d; padding:10px; border-radius:8px; font-size:0.8rem; display:flex; gap:8px; align-items:center;">
                    <i class='bx bxs-shield-quarter'></i>
                    <span>Protegido pela Garantia Doke.</span>
                </div>
            </div>

        </div>

        <div class="history-container">
            <div class="history-header">
                <h3>Extrato Recente</h3>
                <button style="border:none; background:none; color:var(--cor0); font-weight:600; cursor:pointer;">Ver completo</button>
            </div>
            <div id="lista-transacoes" class="transaction-list">
                <div style="text-align:center; padding:30px; color:#999;">
                    <i class='bx bx-loader-alt bx-spin'></i> Carregando...
                </div>
            </div>
        </div>

    </main>

    <nav class="bottom-nav">
        <a href="index.html" class="item"><img src="https://cdn-icons-png.flaticon.com/512/1946/1946436.png" class="icon azul"><span>Início</span></a>
        <a href="notificacoes.html" class="item"><img src="https://cdn-icons-png.flaticon.com/512/1827/1827392.png" class="icon azul"><span>Notificações</span></a>
        <a href="carteira.html" class="item active"><img src="https://cdn-icons-png.flaticon.com/512/2488/2488749.png" class="icon azul"><span>Carteira</span></a>
        <a href="meuperfil.html" class="item"><img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="icon verde"><span>Perfil</span></a>
    </nav>

    <script type="module">
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const db = getFirestore();
        const auth = getAuth();
        let currentUserUid = null;
        let totalDisponivel = 0;

        document.addEventListener("DOMContentLoaded", () => {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserUid = user.uid;
                    carregarCarteira();
                } else {
                    window.location.href = "login.html";
                }
            });
        });

        async function carregarCarteira() {
try {
        // Busca pedidos onde sou o Profissional (paraUid)
        const q = query(collection(db, "pedidos"), where("paraUid", "==", currentUserUid));
        const snap = await getDocs(q);

        let totalDisponivel = 0;
        let totalBloqueado = 0;
        let listaOrdenada = [];
snap.forEach(doc => {
                    const data = doc.data();
                    
                    // CORREÇÃO MATEMÁTICA: Limpa "R$" e converte "," para "."
                    let valorTexto = data.valorFinal || "0";
                    let valorLimpo = valorTexto.toString().replace(/[^\d,]/g, '').replace(',', '.');
                    let valorNumerico = parseFloat(valorLimpo) || 0;

                    if (data.status === 'finalizado') {
                        totalDisponivel += valorNumerico;
                        // ... push na lista ...
                    } else if (data.status === 'pago') {
                        totalBloqueado += valorNumerico;
                        // ... push na lista ...
                    }
                });

                listaOrdenada.sort((a, b) => b.dataOp - a.dataOp);

        document.getElementById('saldoDisponivel').innerText = totalDisponivel.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        document.getElementById('saldoBloqueado').innerText = totalBloqueado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

const btnSacar = document.getElementById('btnSacar');
        if(totalDisponivel > 0) {
            btnSacar.disabled = false;
            btnSacar.innerHTML = `<i class='bx bx-money-withdraw'></i> Solicitar Transferência`;
        } else {
            btnSacar.disabled = true;
            btnSacar.innerHTML = "Sem saldo disponível";
        }

                const containerLista = document.getElementById('lista-transacoes');
                if (listaOrdenada.length === 0) {
                    containerLista.innerHTML = `<div style="text-align:center; padding:30px; color:#999;">Nenhuma movimentação ainda.</div>`;
                } else {
                    containerLista.innerHTML = listaOrdenada.map(item => {
                        let iconClass = item.tipo === 'entrada' ? 'in' : 'wait';
                        let iconName = item.tipo === 'entrada' ? 'bx-up-arrow-alt' : 'bx-lock-alt';
                        let amountClass = item.tipo === 'entrada' ? 'plus' : 'waiting';
                        let sinal = item.tipo === 'entrada' ? '+' : '';

                        return `
                        <div class="t-item">
                            <div class="t-left">
                                <div class="t-icon ${iconClass}">
                                    <i class='bx ${iconName}'></i>
                                </div>
                                <div class="t-info">
                                    <h4>${item.servicoReferencia || 'Serviço'}</h4>
                                    <span>${item.label} • ${new Date(item.dataOp).toLocaleDateString()}</span>
                                </div>
                            </div>
                            <div class="t-amount ${amountClass}">
                                ${sinal} ${formatarMoeda(item.valorNum)}
                            </div>
                        </div>`;
                    }).join('');
                }

} catch (e) {
        console.error("Erro carteira:", e);
    }
}

        function formatarMoeda(valor) {
            return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        window.solicitarSaque = async function() {
            if(window.dokeConfirm) {
                const confirmacao = await window.dokeConfirm(
                    `Deseja solicitar o saque de ${formatarMoeda(totalDisponivel)} para sua conta bancária?`, 
                    "Confirmar Saque"
                );
                if(confirmacao) {
                    await window.dokeAlert("Solicitação enviada! O valor cairá na sua conta em até 1 dia útil.", "Sucesso");
                }
            } else {
                if(confirm(`Sacar ${formatarMoeda(totalDisponivel)}?`)) {
                    alert("Sucesso! Aguarde 1 dia útil.");
                }
            }
        };
    </script>

</body>
</html>