<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Negócios | Doke</title>

  <!-- Supabase (UMD) + init + compat -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-init.js"></script>
  <script src="firebase-compat-supabase.js"></script>
  <script src="firebase-auth-compat-supabase.js"></script>

  <link rel="stylesheet" href="style.css?v=20260117">
  <link rel="stylesheet" href="doke-layout-fix.css">
  <link rel="stylesheet" href="doke-fixes.css?v=20260117">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

  <!-- Leaflet (mapa) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

  <script src="script.js?v=20260117" defer></script>

  <style>
    body[data-page="negocios"]{
      background: radial-gradient(1100px 620px at 10% 0%, rgba(42,95,144,.14), transparent 55%),
                  radial-gradient(900px 520px at 90% 12%, rgba(11,119,104,.12), transparent 60%),
                  #f4f6f8;
    }

    /* usa o mesmo container do index */
    body[data-page="negocios"] .dp-wrap{ width: 100%; }

    /* topo compacto (tipo iFood) */
    .biz-hero{ padding: 20px 20px 16px; }
    .biz-hero .biz-title{
      display:flex; align-items:center; justify-content:space-between; gap: 12px; flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .biz-hero h1{ margin:0; font-size: 1.45rem; font-weight: 900; letter-spacing:-0.02em; color: var(--cor0); }
    .biz-sub{ margin: 0; color: rgba(0,0,0,.58); font-weight: 650; font-size: .95rem; }

    .biz-searchrow{ display:flex; gap: 10px; align-items:center; flex-wrap: wrap; margin-top: 12px; }
    .biz-search{
      flex: 1;
      min-width: 260px;
      display:flex;
      align-items:center;
      gap: 10px;
      background: #fff;
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 999px;
      padding: 12px 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
    }
    .biz-search i{ font-size: 1.1rem; color: rgba(0,0,0,.55); }
    .biz-search input{ width:100%; border:0; outline:0; background:transparent; font-weight: 750; color:#111; }
    .biz-search input::placeholder{ color: rgba(0,0,0,.45); font-weight: 650; }

    .biz-actions{ display:flex; gap: 10px; flex-wrap: wrap; }
    .biz-btn{
      display:inline-flex; align-items:center; gap: 8px;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 900;
      border: 1px solid rgba(0,0,0,.10);
      background: #fff;
      cursor:pointer;
      text-decoration:none;
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
      white-space: nowrap;
    }
    .biz-btn:hover{ transform: translateY(-1px); box-shadow: 0 12px 22px rgba(0,0,0,.08); }
    .biz-btn.primary{
      border: none;
      background: linear-gradient(135deg, #0b7768, #2a5f90);
      color: #fff;
      box-shadow: 0 12px 26px rgba(11,119,104,.18);
    }

    /* chips rápidos */
    .biz-chips{ margin-top: 12px; display:flex; gap: 8px; flex-wrap: wrap; }
    .biz-chip{
      border: 1px solid rgba(42, 95, 144, 0.18);
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.75);
      color: #1f4d75;
      font-weight: 900;
      font-size: .86rem;
      transition: transform .16s ease, background .16s ease;
    }
    .biz-chip:hover{ transform: translateY(-1px); background: rgba(42,95,144,.12); }
    .biz-chip.active{ background: rgba(11,119,104,.14); border-color: rgba(11,119,104,.22); color: #0b7768; }

    /* mapa */
    .biz-mapwrap{ display:none; margin-top: 14px; }
    .biz-map{
      height: 340px;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 14px 28px rgba(0,0,0,.08);
      background: #e9eef2;
    }
    .biz-mapbar{ display:flex; align-items:center; justify-content:space-between; gap: 10px; flex-wrap: wrap; margin: 10px 4px 0; }
    .biz-mapbar .muted{ color: rgba(0,0,0,.58); font-weight: 700; }

    /* cards de negócios */
    .biz-section{ padding: 18px 20px; }
    .biz-inner{ max-width: 1200px; margin: 0 auto; }
    .biz-title-row{ display:flex; align-items:flex-end; justify-content:space-between; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
    .biz-title-row h2{ margin:0; font-size: 1.25rem; font-weight: 900; letter-spacing:-0.02em; color: #111; }
    .biz-hint{ color: rgba(0,0,0,.55); font-weight: 650; font-size: .92rem; }

    .biz-grid{ display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 14px; }
    @media (max-width: 1100px){ .biz-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 720px){ .biz-grid{ grid-template-columns: 1fr; } }

    .biz-card{
      background:#fff;
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 18px;
      overflow:hidden;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
      cursor:pointer;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .biz-card:hover{ transform: translateY(-2px); box-shadow: 0 18px 34px rgba(0,0,0,.10); border-color: rgba(11,119,104,.22); }
    .biz-cover{ height: 130px; background: linear-gradient(135deg, rgba(42,95,144,.18), rgba(11,119,104,.18)); }
    .biz-cover img{ width:100%; height:100%; object-fit: cover; display:block; }
    .biz-body{ padding: 12px 12px 14px; }
    .biz-name{ margin:0; font-size: 1.03rem; font-weight: 950; color:#111; letter-spacing:-0.01em; }
    .biz-meta{ margin-top: 6px; display:flex; gap: 8px; flex-wrap: wrap; align-items:center; }
    .biz-pill{
      display:inline-flex; align-items:center; gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.04);
      border: 1px solid rgba(0,0,0,.06);
      font-weight: 900;
      font-size: .78rem;
      color: rgba(0,0,0,.70);
    }
    .biz-pill.green{ background: rgba(11,119,104,.10); border-color: rgba(11,119,104,.18); color: #0b7768; }
    .biz-desc{ margin-top: 8px; color: rgba(0,0,0,.62); font-weight: 650; font-size: .9rem; line-height: 1.25; }

    .biz-empty{
      background: rgba(255,255,255,.85);
      border: 1px dashed rgba(0,0,0,.14);
      border-radius: 18px;
      padding: 18px;
      text-align:center;
      color: rgba(0,0,0,.62);
      box-shadow: 0 10px 24px rgba(0,0,0,.04);
    }
    .biz-empty strong{ color:#111; }

    /* mobile: chips viram scroll horizontal */
    @media (max-width: 700px){
      .biz-chips{ flex-wrap: nowrap; overflow-x: auto; padding-bottom: 4px; }
      .biz-chips::-webkit-scrollbar{ display:none; }
    }
  </style>
</head>

<body data-page="negocios">
  <a class="skip-link" href="#feedNegocios">Pular para o conteúdo</a>

  <!-- header/menus no padrão do index -->
  <header class="navbar-mobile">
    <div id="logo-mobile">
      <a href="index.html"><img src="assets/Imagens/doke-logo.png" alt="Doke"></a>
    </div>
    <div class="botoes-direita">
      <a href="login.html" class="entrar">Entrar</a>
    </div>
  </header>

  <div id="overlay-menu" onclick="fecharMenuMobile()"></div>

  <header class="navbar-desktop">
    <div id="logo-desktop"><a href="projeto.html"><img src="assets/Imagens/doke-logo.png" alt="Doke"></a></div>
    <nav class="menu">
      <div class="cep-wrapper">
        <a href="#" class="cep" id="linkCep" onclick="toggleCep(event)">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
          </svg>
          <span id="textoCepSpan">Informe seu CEP</span>
        </a>
        <div class="cep-popup" id="boxCep">
          <p>Digite seu CEP:</p>
          <div class="cep-input-group">
            <input type="text" id="inputCep" placeholder="00000-000" maxlength="9">
            <button onclick="salvarCep()">OK</button>
          </div>
        </div>
      </div>
      <a href="escolheranuncio.html">Anunciar</a>
      <a href="comunidade.html">Comunidades <span class="badge-novo1">NOVO</span></a>
      <a href="novidades.html">Novidades</a>
    </nav>
    <div class="botoes-direita"><a href="login.html" class="entrar">Entrar</a></div>
  </header>

  <aside class="sidebar-icones">
    <div id="logo">
      <a href="index.html"><img src="assets/Imagens/doke-logo.png" alt="Logotipo da plataforma Doke"></a>
    </div>
    <div class="item">
      <a href="index.html"><img src="https://cdn-icons-png.flaticon.com/512/1946/1946436.png" class="icon azul" alt="Início"><span>Início</span></a>
    </div>
    <div class="item">
      <a href="negocios.html"><i class='bx bx-store' style="color: var(--cor2); font-size: 26px;"></i><span>Empresas</span></a>
    </div>
    <div class="item">
      <a href="notificacoes.html"><img src="https://cdn-icons-png.flaticon.com/512/1827/1827392.png" class="icon azul" alt="Notificações"><span>Notificações</span></a>
    </div>
    <div class="item">
      <img src="https://cdn-icons-png.flaticon.com/512/561/561127.png" class="icon azul" alt="Mensagens">
      <a href="chat.html"><span>Mensagens</span></a>
    </div>
    <div class="item">
      <a href="comunidade.html"><img src="https://cdn-icons-png.flaticon.com/512/1144/1144760.png" class="icon verde" alt="Comunidades"><span>Comunidades</span></a>
    </div>
    <div class="item">
      <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="icon verde" alt="Perfil">
      <a href="#" onclick="irParaMeuPerfil(event)"><span>Perfil</span></a>
    </div>
    <div class="item">
      <img src="https://cdn-icons-png.flaticon.com/512/56/56763.png" class="icon azul" alt="Mais">
      <a href="mais.html"><span>Mais</span></a>
    </div>
  </aside>

  <main class="dp-wrap">

    <!-- HERO / BUSCA -->
    <section class="secao-busca biz-hero">
      <div class="biz-title">
        <div>
          <h1>Descobrir negócios</h1>
          <p class="biz-sub">Restaurantes, mercados, lojas e serviços — por bairro/cidade (via CEP).</p>
        </div>

        <div class="biz-actions">
          <a class="biz-btn primary" href="anunciar-negocio.html"><i class='bx bx-plus-circle'></i> Anunciar negócio</a>
          <button class="biz-btn" id="btnToggleMapa" type="button"><i class='bx bx-map'></i> Mapa</button>
        </div>
      </div>

      <div class="biz-searchrow">
        <div class="biz-search" role="search">
          <i class='bx bx-search'></i>
          <input id="bizSearch" type="text" placeholder="Buscar restaurante, barbearia, petshop..." autocomplete="off">
        </div>
        <div class="biz-actions">
          <button class="biz-btn" id="btnFiltros" type="button"><i class='bx bx-slider-alt'></i> Filtros</button>
          <button class="biz-btn" id="btnLimpar" type="button"><i class='bx bx-x'></i> Limpar</button>
        </div>
      </div>

      <div class="biz-chips" aria-label="Categorias rápidas">
        <button class="biz-chip active" data-cat="todas" type="button">Tudo</button>
        <button class="biz-chip" data-cat="restaurante" type="button">Restaurantes</button>
        <button class="biz-chip" data-cat="mercado" type="button">Mercados</button>
        <button class="biz-chip" data-cat="lanchonete" type="button">Lanches</button>
        <button class="biz-chip" data-cat="farmacia" type="button">Farmácias</button>
        <button class="biz-chip" data-cat="servicos" type="button">Serviços</button>
      </div>

      <div class="biz-mapwrap" id="bizMapWrap">
        <div class="biz-map" id="bizMap"></div>
        <div class="biz-mapbar">
          <div class="muted" id="mapHint">Mostrando a cidade do seu CEP.</div>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="biz-btn" id="btnRecentrar" type="button"><i class='bx bx-current-location'></i> Recentrar</button>
            <a class="biz-btn" href="#feedNegocios"><i class='bx bx-list-ul'></i> Ver lista</a>
          </div>
        </div>
      </div>
    </section>

    <!-- PROMOÇÕES (começa simples, depois liga no banco) -->
    <section class="biz-section" aria-label="Promoções">
      <div class="biz-inner">
        <div class="biz-title-row">
          <h2>Promoções perto de você</h2>
          <div class="biz-hint" id="promoHint">Carregando...</div>
        </div>
        <div class="tiktok-scroll-wrapper" id="promoCarousel" style="gap:12px; padding-bottom:6px;">
          <div style="padding: 14px; color: rgba(0,0,0,.60); font-weight: 700;">Sem promoções ainda.</div>
        </div>
      </div>
    </section>

    <!-- LISTA -->
    <section class="biz-section" aria-label="Negócios" id="feedNegocios">
      <div class="biz-inner">
        <div class="biz-title-row">
          <h2 id="bizTitle">Perto de você</h2>
          <div class="biz-hint" id="bizHint">Carregando...</div>
        </div>

        <div class="biz-grid" id="bizGrid"></div>
      </div>
    </section>

  </main>

  <!-- Modal simples de filtros -->
  <div id="bizFiltersModal" class="popup" style="display:none;">
    <div class="popup-content" style="max-width: 560px;">
      <span class="close-btn" id="closeBizFilters">×</span>
      <p class="titulo" style="margin-bottom:8px;">Filtros</p>

      <div style="display:grid; gap: 10px;">
        <div>
          <label style="font-weight:900; display:block; margin-bottom:6px;">Categoria</label>
          <select id="fCat" style="width:100%; padding:12px; border-radius:12px; border:1px solid rgba(0,0,0,.12);">
            <option value="todas">Todas</option>
            <option value="restaurante">Restaurantes</option>
            <option value="mercado">Mercados</option>
            <option value="lanchonete">Lanches</option>
            <option value="farmacia">Farmácias</option>
            <option value="servicos">Serviços</option>
            <option value="loja">Lojas</option>
          </select>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <div>
            <label style="font-weight:900; display:block; margin-bottom:6px;">Cidade</label>
            <input id="fCidade" placeholder="(auto pelo CEP)" style="width:100%; padding:12px; border-radius:12px; border:1px solid rgba(0,0,0,.12);" />
          </div>
          <div>
            <label style="font-weight:900; display:block; margin-bottom:6px;">Bairro</label>
            <input id="fBairro" placeholder="(auto pelo CEP)" style="width:100%; padding:12px; border-radius:12px; border:1px solid rgba(0,0,0,.12);" />
          </div>
        </div>
        <div style="display:flex; gap:10px; margin-top: 6px;">
          <button class="btn-pro-action" id="btnAplicarFiltros" type="button" style="flex:1;">Aplicar</button>
          <button class="btn-pro-action" id="btnResetFiltros" type="button" style="flex:1; background:#fff; color:#0b7768; border:1px solid rgba(11,119,104,.28);">Reset</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========= Negócios: iFood-like (por CEP) =========
    (function(){
      const grid = document.getElementById('bizGrid');
      const hint = document.getElementById('bizHint');
      const title = document.getElementById('bizTitle');
      const promoHint = document.getElementById('promoHint');
      const promoCarousel = document.getElementById('promoCarousel');

      const state = {
        term: '',
        cat: 'todas',
        cidade: '',
        bairro: '',
        map: null,
        mapCenter: [-12.9714, -38.5014],
        markers: []
      };

      function getLoc(){
        try{
          const loc = JSON.parse(localStorage.getItem('doke_localizacao') || 'null');
          if (!loc) return null;
          return {
            cep: loc.cep || '',
            cidade: loc.cidade || '',
            bairro: loc.bairro || '',
            uf: loc.uf || ''
          };
        }catch(_){ return null; }
      }

      function setEmpty(msg, cta){
        grid.innerHTML = `
          <div class="biz-empty" style="grid-column: 1 / -1;">
            <div style="font-weight: 950; font-size: 1.05rem; color:#111;">${msg}</div>
            <div style="margin-top: 6px;">${cta || ''}</div>
          </div>
        `;
      }

      function esc(s){
        return String(s || '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
      }

      function buildCard(b){
        const cover = b.imagem_capa || b.capa || '';
        const nome = b.nome || b.nome_fantasia || 'Negócio';
        const cat = (b.categoria || 'Negócio').toString();
        const bairro = b.bairro || '';
        const cidade = b.cidade || '';
        const badge = b.is_active === false ? 'Fechado' : 'Aberto';
        const desc = (b.descricao || '').toString().trim();
        const descTxt = desc ? esc(desc).slice(0, 110) + (desc.length > 110 ? '…' : '') : 'Sem descrição.';

        return `
          <article class="biz-card" tabindex="0" role="button" aria-label="Abrir ${esc(nome)}" data-biz-id="${esc(b.id || '')}">
            <div class="biz-cover">${cover ? `<img loading="lazy" src="${esc(cover)}" alt="${esc(nome)}">` : ''}</div>
            <div class="biz-body">
              <h3 class="biz-name">${esc(nome)}</h3>
              <div class="biz-meta">
                <span class="biz-pill green">${esc(cat)}</span>
                <span class="biz-pill">${esc(bairro ? bairro : cidade)}</span>
                <span class="biz-pill">${esc(badge)}</span>
              </div>
              <div class="biz-desc">${descTxt}</div>
            </div>
          </article>
        `;
      }

      async function geocodeCidade(cidade, uf){
        const q = [cidade, uf, 'Brasil'].filter(Boolean).join(', ');
        try{
          const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
          const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
          const j = await r.json();
          if (Array.isArray(j) && j[0]) {
            return [parseFloat(j[0].lat), parseFloat(j[0].lon)];
          }
        }catch(_){ }
        return null;
      }

      function ensureMap(){
        const wrap = document.getElementById('bizMapWrap');
        const el = document.getElementById('bizMap');
        if (!wrap || !el) return;
        if (state.map) return;

        state.map = L.map(el, { zoomControl: true }).setView(state.mapCenter, 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap'
        }).addTo(state.map);
      }

      function clearMarkers(){
        state.markers.forEach(m => { try{ state.map.removeLayer(m); }catch(_){ } });
        state.markers = [];
      }

      function renderMarkers(list){
        if (!state.map) return;
        clearMarkers();
        list.forEach((b)=>{
          const lat = b.latitude || b.lat;
          const lon = b.longitude || b.lng || b.lon;
          if (!lat || !lon) return;
          const m = L.marker([lat, lon]).addTo(state.map);
          m.bindPopup(`<b>${esc(b.nome || b.nome_fantasia || 'Negócio')}</b><br>${esc((b.bairro||'') + (b.cidade?(', '+b.cidade):''))}`);
          state.markers.push(m);
        });
      }

      async function loadPromos(){
        promoHint.textContent = '—';
        try{
          if (!window.sb) throw new Error('Sem Supabase');
          // join simples (pode ajustar depois)
          const q = window.sb.from('negocios_promocoes')
            .select('id,titulo,descricao,desconto_percent,cupom,valida_ate,negocio_id,negocios(nome,imagem_capa,bairro,cidade)')
            .eq('ativo', true)
            .limit(12);

          // filtro por cidade/bairro se existir
          if (state.cidade) q.ilike('negocios.cidade', `%${state.cidade}%`);
          if (state.bairro) q.ilike('negocios.bairro', `%${state.bairro}%`);

          const { data, error } = await q;
          if (error) throw error;

          if (!data || data.length === 0){
            promoCarousel.innerHTML = `<div style="padding: 14px; color: rgba(0,0,0,.60); font-weight: 700;">Sem promoções ainda.</div>`;
            promoHint.textContent = state.cidade ? state.cidade : '';
            return;
          }

          promoCarousel.innerHTML = '';
          data.forEach((p)=>{
            const n = p.negocios || {};
            const cover = n.imagem_capa ? `<img loading="lazy" src="${esc(n.imagem_capa)}" style="width:100%; height:120px; object-fit:cover; display:block;">` : '';
            const pct = p.desconto_percent ? `${p.desconto_percent}% OFF` : 'Promo';
            const cupom = p.cupom ? `Cupom: <b>${esc(p.cupom)}</b>` : '';
            const card = document.createElement('div');
            card.className = 'biz-card';
            card.style.minWidth = '260px';
            card.style.maxWidth = '320px';
            card.innerHTML = `
              <div class="biz-cover" style="height:120px;">${cover}</div>
              <div class="biz-body">
                <div class="biz-meta" style="margin-top:0;">
                  <span class="biz-pill green">${pct}</span>
                  <span class="biz-pill">${esc(n.bairro || n.cidade || '')}</span>
                </div>
                <h3 class="biz-name" style="margin-top:8px;">${esc(p.titulo || 'Promoção')}</h3>
                <div class="biz-desc">${esc(p.descricao || '')}</div>
                <div class="biz-desc" style="margin-top:8px; font-weight:900; color:#0b7768;">${cupom}</div>
              </div>
            `;
            promoCarousel.appendChild(card);
          });
          promoHint.textContent = state.cidade ? state.cidade : '';
        } catch (e) {
          promoHint.textContent = 'Sem tabela (crie a SQL)';
          promoCarousel.innerHTML = `<div style="padding: 14px; color: rgba(0,0,0,.60); font-weight: 700;">Crie as tabelas de negócios/promoções para aparecer aqui.</div>`;
        }
      }

      async function loadNegocios(){
        hint.textContent = 'Carregando...';
        grid.innerHTML = '';

        const loc = getLoc();
        state.cidade = (document.getElementById('fCidade')?.value || loc?.cidade || '').trim();
        state.bairro = (document.getElementById('fBairro')?.value || loc?.bairro || '').trim();
        title.textContent = state.bairro && state.cidade ? `${state.bairro}, ${state.cidade}` : (state.cidade ? state.cidade : 'Perto de você');

        try{
          if (!window.sb) throw new Error('Sem Supabase');
          let q = window.sb.from('negocios')
            .select('id,nome,descricao,categoria,imagem_capa,capa,bairro,cidade,uf,cep,is_active,latitude,longitude,lat,lng')
            .eq('is_active', true)
            .order('created_at', { ascending: false })
            .limit(24);

          if (state.cidade) q = q.ilike('cidade', `%${state.cidade}%`);
          if (state.bairro) q = q.ilike('bairro', `%${state.bairro}%`);

          if (state.cat && state.cat !== 'todas') q = q.ilike('categoria', `%${state.cat}%`);
          if (state.term && state.term.length >= 2) {
            q = q.or(`nome.ilike.%${state.term}%,descricao.ilike.%${state.term}%,categoria.ilike.%${state.term}%`);
          }

          const { data, error } = await q;
          if (error) throw error;

          if (!data || data.length === 0) {
            hint.textContent = '0 resultados';
            setEmpty('Nada encontrado por aqui.', `Tente mudar a categoria ou atualizar o CEP no topo.`);
            renderMarkers([]);
            return;
          }

          grid.innerHTML = data.map(buildCard).join('');
          hint.textContent = `${data.length} resultado(s)`;
          renderMarkers(data);
        } catch (e) {
          hint.textContent = 'Sem tabela (crie a SQL)';
          setEmpty(
            'Ainda não conseguimos listar negócios.',
            `Provável motivo: tabela <b>negocios</b> não existe ou RLS bloqueando.<br><a class="biz-btn primary" href="anunciar-negocio.html" style="margin-top:10px; display:inline-flex;">Criar meu primeiro negócio</a>`
          );
          renderMarkers([]);
        }
      }

      async function recenterMap(){
        const loc = getLoc();
        const cidade = (state.cidade || loc?.cidade || '').trim();
        const uf = (loc?.uf || '').trim();
        const hintEl = document.getElementById('mapHint');

        if (!state.map) return;

        if (cidade) {
          hintEl.textContent = `Mostrando: ${cidade}${uf ? ' - ' + uf : ''}`;
          const coords = await geocodeCidade(cidade, uf);
          if (coords) {
            state.mapCenter = coords;
            state.map.setView(coords, 12);
            return;
          }
        }

        hintEl.textContent = 'Mostrando a cidade do seu CEP.';
        state.map.setView(state.mapCenter, 12);
      }

      // UI bindings
      const search = document.getElementById('bizSearch');
      search.addEventListener('input', (e)=>{
        state.term = (e.target.value || '').trim();
        // debounce simples
        clearTimeout(window.__bizDeb);
        window.__bizDeb = setTimeout(()=>{ loadNegocios(); }, 250);
      });

      document.querySelectorAll('.biz-chip').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          document.querySelectorAll('.biz-chip').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          state.cat = btn.dataset.cat || 'todas';
          const sel = document.getElementById('fCat');
          if (sel) sel.value = state.cat;
          loadNegocios();
          loadPromos();
        });
      });

      const modal = document.getElementById('bizFiltersModal');
      document.getElementById('btnFiltros').addEventListener('click', ()=>{ modal.style.display = 'block'; });
      document.getElementById('closeBizFilters').addEventListener('click', ()=>{ modal.style.display = 'none'; });
      modal.addEventListener('click', (e)=>{ if (e.target === modal) modal.style.display = 'none'; });

      document.getElementById('btnAplicarFiltros').addEventListener('click', ()=>{
        state.cat = document.getElementById('fCat')?.value || 'todas';
        document.querySelectorAll('.biz-chip').forEach(b=>b.classList.remove('active'));
        const chip = document.querySelector(`.biz-chip[data-cat="${state.cat}"]`) || document.querySelector('.biz-chip[data-cat="todas"]');
        if (chip) chip.classList.add('active');
        modal.style.display = 'none';
        loadNegocios();
        loadPromos();
      });

      document.getElementById('btnResetFiltros').addEventListener('click', ()=>{
        const loc = getLoc();
        document.getElementById('fCat').value = 'todas';
        document.getElementById('fCidade').value = loc?.cidade || '';
        document.getElementById('fBairro').value = loc?.bairro || '';
      });

      document.getElementById('btnLimpar').addEventListener('click', ()=>{
        state.term = '';
        search.value = '';
        state.cat = 'todas';
        document.querySelectorAll('.biz-chip').forEach(b=>b.classList.remove('active'));
        document.querySelector('.biz-chip[data-cat="todas"]').classList.add('active');
        loadNegocios();
        loadPromos();
      });

      const mapWrap = document.getElementById('bizMapWrap');
      document.getElementById('btnToggleMapa').addEventListener('click', async ()=>{
        const isOpen = mapWrap.style.display === 'block';
        mapWrap.style.display = isOpen ? 'none' : 'block';
        if (!isOpen) {
          ensureMap();
          setTimeout(()=>{ try{ state.map.invalidateSize(); }catch(_){ } }, 80);
          await recenterMap();
          // renderiza markers já carregados
          const cards = Array.from(document.querySelectorAll('.biz-card[data-biz-id]'));
          if (cards.length) {
            // markers são renderizados após loadNegocios; aqui só garante o map atualizado
          }
        }
      });
      document.getElementById('btnRecentrar').addEventListener('click', recenterMap);

      // seed dos filtros com CEP
      const loc = getLoc();
      if (loc) {
        const fc = document.getElementById('fCidade');
        const fb = document.getElementById('fBairro');
        if (fc && !fc.value) fc.value = loc.cidade || '';
        if (fb && !fb.value) fb.value = loc.bairro || '';
      }

      // inicial
      loadNegocios();
      loadPromos();

      // quando o usuário salvar CEP no topo, recarrega
      const originalAtualizarTelaCep = window.atualizarTelaCep;
      if (typeof originalAtualizarTelaCep === 'function') {
        window.atualizarTelaCep = function(payload){
          try{ originalAtualizarTelaCep(payload); }catch(_){ }
          // re-sync
          const loc2 = getLoc();
          if (loc2) {
            document.getElementById('fCidade').value = loc2.cidade || '';
            document.getElementById('fBairro').value = loc2.bairro || '';
          }
          loadNegocios();
          loadPromos();
          if (state.map) recenterMap();
        }
      }

    })();
  </script>
</body>
</html>
