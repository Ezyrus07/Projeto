<!DOCTYPE html>

<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Pedidos | Doke</title>
<meta content="#0b7768" name="theme-color"/>
<script>
    (function(){
      try{
        var p = String(location.pathname || '');
        if(p.indexOf('/frontend/frontend/') !== -1){
          var fixed = p.replace('/frontend/frontend/', '/frontend/');
          location.replace(fixed + (location.search || '') + (location.hash || ''));
        }
      }catch(_e){}
    })();
  </script>
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet"/>
<link href="chat-redesign.css" rel="stylesheet"/>
<link href="page-chat.css" rel="stylesheet"/>
<link href="style.css?v=20260211v45" rel="stylesheet"/>
<link href="doke-a11y.css?v=20260207v21" rel="stylesheet"/>
<link href="doke-layout-fix.css?v=20260207v21" rel="stylesheet"/>
<link href="doke-fixes.css?v=20260117" rel="stylesheet"/>
<link href="doke-toast.css" rel="stylesheet"/>
<link href="doke-alerts.css" rel="stylesheet"/>
<link href="doke-ux.css?v=20260207v21" rel="stylesheet"/>
<link href="doke-shell.css?v=20260212v42" rel="stylesheet"/>
<link href="doke-responsive.css?v=20260209v24" rel="stylesheet"/>
<script defer="" src="script.js?v=20260218v60"></script>
<style>
    :root{
      --bg:#eef3f8;
      --panel:#ffffff;
      --line:#dbe5f2;
      --text:#0f2440;
      --muted:#5f748f;
      --brand:#0b7768;
      --danger:#d92f64;
    }

    body[data-page="pedidos"]{background:var(--bg); color:var(--text);}
    @media (min-width:1024px){
      #logo-desktop{display:none !important;}
    }
    body[data-page="pedidos"] .dp-wrap{padding:22px 18px 100px;}
    @media (min-width:1024px){
      body[data-page="pedidos"] .dp-wrap{
        margin-left:var(--sidebar-width,0);
        padding:30px 40px 120px;
        width:auto;
        max-width:none;
      }
    }

    @media (min-width:1024px){
      /* evita logo duplicada: sidebar já exibe a marca */
      body[data-page="pedidos"] .navbar-desktop #logo-desktop,
      body[data-page="pedidos"] .navbar-desktop [id="logo-desktop"],
      body[data-page="pedidos"] header.navbar-desktop > #logo-desktop{
        display:none !important;
        width:0 !important;
        min-width:0 !important;
        margin:0 !important;
        padding:0 !important;
        overflow:hidden !important;
      }
      body[data-page="pedidos"] .navbar-desktop .menu{margin-left:auto; margin-right:auto;}
      body[data-page="pedidos"] .navbar-desktop .botoes-direita{margin-left:auto;}
    }

    @media (min-width:1024px) and (max-width:1366px){
      body[data-page="pedidos"] .dp-wrap{padding:18px 16px 108px;}
      .orders-page{max-width:none;}
      .hero{padding:26px; gap:14px;}
      .hero h1{font-size:1.8rem;}
      .hero p{font-size:.9rem;}
      .hero-stat{min-width:92px; padding:9px 10px;}
      .toolbar{grid-template-columns:minmax(0,1fr);}
      .toolbar-actions{flex-wrap:wrap;}
      .toolbar-actions .btn-ui{min-height:42px;}
    }

    body[data-page="pedidos"] .dp-wrap{min-width:0;}
    .orders-page{width:100%; min-width:0;}
    .hero{min-width:0;}
    .hero > div:first-child{min-width:0; flex:1 1 340px;}
    .hero h1, .hero p{word-break:break-word;}

    .orders-page{max-width:1240px; margin:0 auto;}
    .hero{
      background:radial-gradient(1200px 500px at 50% 0%, rgba(255, 255, 255, 0.20), transparent 55%), linear-gradient(135deg, #1f4d75 0%, #13324f 55%, #0b7768 140%);
      border-radius:20px;
      padding:40px;
      color:#fff;
      display:flex;
      gap:18px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
      box-shadow:0 10px 30px rgba(42,95,144,.25);
      position:relative;
      overflow:hidden;
    }
    .hero::before{
      content:'';
      position:absolute;
      top:-50px;
      right:-20px;
      width:200px;
      height:200px;
      background:rgba(255,255,255,.05);
      border-radius:50%;
      pointer-events:none;
    }
    .hero h1{
      margin:0;
      font-size:2rem;
      line-height:1.05;
      display:flex;
      gap:10px;
      align-items:center;
      color:#fff;
    }
    .hero p{
      margin:8px 0 0;
      color:rgba(255,255,255,.86);
      font-size:.95rem;
    }
    .badge-count{
      background:#ff2e63;
      color:#fff;
      font-size:.8rem;
      padding:3px 10px;
      border-radius:12px;
      vertical-align:middle;
      box-shadow:0 2px 5px rgba(0,0,0,.2);
      font-weight:800;
    }
    .hero-stats{display:flex; gap:10px; flex-wrap:wrap;}
    .hero-stat{
      min-width:100px;
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.24);
      border-radius:16px;
      padding:10px 12px;
      text-align:center;
      backdrop-filter:blur(4px);
    }
    .hero-stat small{display:block; font-size:.72rem; color:rgba(255,255,255,.86);}
    .hero-stat strong{display:block; margin-top:2px; font-size:1.06rem;}

    .toolbar{display:grid; grid-template-columns:1fr auto; gap:10px; margin:14px 0 10px;}
    .search{display:flex; align-items:center; gap:10px; border:1px solid var(--line); background:#fff; border-radius:14px; padding:11px 13px; box-shadow:0 8px 18px rgba(15,36,64,.06);}
    .search i{font-size:20px; color:#6682a6;}
    .search input{border:none; outline:none; width:100%; background:transparent; color:var(--text); font-size:15px;}

    .toolbar-actions{display:flex; gap:10px;}
    .btn-ui{border:1px solid var(--line); background:#fff; color:#203f63; border-radius:12px; min-height:44px; padding:0 14px; font-weight:800; display:inline-flex; align-items:center; gap:8px; cursor:pointer; white-space:nowrap; box-shadow:0 8px 18px rgba(15,36,64,.06);}
    .btn-ui i{font-size:18px;}
    .btn-ui.active{border-color:rgba(11,119,104,.35); background:rgba(11,119,104,.1); color:#0b7768;}

    .filters{display:flex; gap:8px; flex-wrap:wrap; margin:0 0 12px;}
    .filters.filters-collapsible{display:none;}
    .filters.filters-collapsible.show{display:flex;}
    .chip{border:1px solid var(--line); background:#fff; color:#355575; border-radius:999px; min-height:38px; padding:0 14px; font-weight:700; cursor:pointer; display:inline-flex; align-items:center; gap:7px;}
    .chip.active{border-color:rgba(11,119,104,.34); background:rgba(11,119,104,.1); color:var(--brand);}

    .panel{border:1px solid var(--line); background:var(--panel); border-radius:22px; box-shadow:0 10px 24px rgba(15,36,64,.07); padding:16px;}
    .panel-head{display:flex; align-items:flex-end; justify-content:space-between; gap:10px; margin-bottom:10px;}
    .panel-head h2{margin:0; font-size:20px; display:flex; align-items:center; gap:8px;}
    .panel-head p{margin:0; color:var(--muted); font-weight:600;}
    #bulkBar{display:none; margin:0 0 10px; padding:10px 12px; border:1px solid #dce9f5; border-radius:14px; background:#f7fbff;}
    #bulkBar.show{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    #bulkInfo{font-weight:800; color:#2f537d; font-size:.92rem;}
    .bulk-actions{display:flex; gap:8px; flex-wrap:wrap;}
    .bulk-actions .btn-ui{min-height:38px; padding:0 12px;}

    .grid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:14px; align-content:start; align-items:start; grid-auto-rows:min-content;}
    /* Card com mais contraste (nao some no fundo do painel)
       + altura fixa para todos terem a mesma dimensão */
    /* Altura uniforme dos cards (ajustada para evitar cortes quando tags/descrição quebram linha) */
    /* Altura uniforme dos cards (desktop/tablet). Mantemos um valor seguro para não cortar ações/rodapé */
    :root{--pedido-card-h: 440px;}
    .card{
      background:#ffffff;
      border:1px solid rgba(23,56,103,.14);
      border-radius:18px;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:8px;
	      box-shadow:0 14px 34px rgba(15,36,64,.10);
	      transition:transform .16s ease, box-shadow .16s ease, border-color .16s ease;
	      cursor:pointer;
      position:relative;
      overflow:hidden;
      height:var(--pedido-card-h);
    }
	    .card:hover{
	      transform:translateY(-3px);
	      box-shadow:0 20px 46px rgba(15,36,64,.14);
	      border-color:rgba(42,95,144,.26);
	    }
    .card::before{
      content:"";
      position:absolute;
      left:0; right:0; top:0;
      height:4px;
      background:linear-gradient(90deg,#2a5f90 0%, #0b9b8c 100%);
      opacity:.95;
    }
    /* Barra superior por status (diferencia visual rapida) */
    .card[data-status="pendente"]::before{background:linear-gradient(90deg,#f59e0b 0%, #fbbf24 100%);} /* amarelo */
    .card[data-status="andamento"]::before{background:linear-gradient(90deg,#0b9b8c 0%, #2dd4bf 100%);} /* verde/teal */
    .card[data-status="finalizado"]::before{background:linear-gradient(90deg,#94a3b8 0%, #64748b 100%);} /* cinza */
    .card[data-status="cancelado"]::before{background:linear-gradient(90deg,#ef4444 0%, #b91c1c 100%);} /* vermelho */
    .card[data-status="recusado"]::before{background:linear-gradient(90deg,#ef4444 0%, #b91c1c 100%);} /* vermelho */
    .card.selected{
      border-color:rgba(11,119,104,.45);
      box-shadow:0 18px 42px rgba(11,119,104,.22);
      outline:2px solid rgba(42,95,144,.18);
    }
    /* Selecionado: mantem a cor do status, so aumenta contraste */
    .card.selected::before{filter:saturate(1.08) brightness(.95);}
    .card-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
    }
    .card-select{
      position:absolute;
      top:12px;
      right:12px;
      width:34px;
      height:34px;
      min-width:34px;
      border:1px solid #dbe6f3;
      border-radius:10px;
      background:#fff;
      color:#56739a;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      cursor:pointer;
      transition:.2s ease;
    }
    .card.selected .card-select{
      background:#0b7768;
      border-color:#0b7768;
      color:#fff;
    }
    /* limita a área de tags para não variar a altura entre cards */
    .tags{display:flex; align-items:center; gap:8px; flex-wrap:wrap; padding-right:44px; max-height:56px; overflow:hidden;}

    /* Quando o chat está aberto, mostramos só os 2 chips principais (tipo + status)
       para reduzir ruído visual */
    body[data-page="pedidos"].chat-open .card .tags{flex-wrap:nowrap; max-height:none; overflow:visible;}
    body[data-page="pedidos"].chat-open .card .tags .tag:nth-child(n+3){display:none;}
    .tag{border:1px solid #d9e5f3; background:#f6fbff; color:#315579; border-radius:999px; padding:6px 10px; font-size:.76rem; font-weight:800; display:inline-flex; align-items:center; gap:5px;}
    .tag.type{background:#eaf8f4; color:#0b7768; border-color:#cde8df;}
    .tag.pending{background:#fff5e8; color:#b86f08; border-color:#f4dbb8;}
    .tag.progress{background:#eaf8f4; color:#0b7768; border-color:#cde8df;}
    .tag.done{background:#eef2f8; color:#526a86; border-color:#dbe5f2;}
    .tag.role-client{background:#eef6ff; color:#1f4f86; border-color:#cfe2f8;}
    .tag.role-pro{background:#ecfaf5; color:#11664d; border-color:#cceedd;}
    .tag.role-me{background:#f4f7fb; color:#425b78; border-color:#d8e4f2;}
    .tag.urgent{background:#fff0f5; color:var(--danger); border-color:#f8cfe0;}

    .user{display:flex; align-items:center; gap:10px; min-width:0;}
    .user img{width:44px; height:44px; border-radius:50%; object-fit:cover; border:1px solid #d8e4f2; background:#eef3f9;}
    .user-meta{min-width:0;}
    .user-meta strong{display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:1rem;}
    .user-meta span{display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--muted); font-size:.84rem;}

    .title{margin:0; font-size:1.1rem; line-height:1.18;
      display:-webkit-box; -webkit-line-clamp:1; -webkit-box-orient:vertical; overflow:hidden;
    }
    .desc{margin:0; color:var(--muted); line-height:1.35; font-size:.92rem;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    }

    .need-preview{
      margin:10px 0 0;
      padding:10px 12px;
      border:1px dashed rgba(11,119,104,.28);
      background:rgba(11,119,104,.06);
      border-radius:14px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      color:var(--text);
    }
    .need-preview i{color:var(--brand); font-size:1.05rem; margin-top:2px;}
    .need-preview span{
      flex:1;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      line-height:1.25;
      font-size:.92rem;
    }

    body.chat-open .need-preview{display:none !important;}

    .meta{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px;}
    .meta-item{border:1px solid #dfe9f5; background:#f7fbff; border-radius:12px; padding:9px 10px; display:flex; align-items:flex-start; gap:8px;}
    .meta-item i{font-size:17px; color:#5b78a0; margin-top:2px;}
    .meta-item small{display:block; color:#6d829f; font-size:.73rem; line-height:1;}
    .meta-item strong{display:block; margin-top:4px; font-size:.94rem; line-height:1.2;}

    /* footer sempre “grudado” no fim do card (altura uniforme) */
    .footer{margin-top:auto; border-top:1px solid #edf2f8; padding-top:10px; display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;}
    .unread{border:1px solid #dbe6f2; background:#f6fbff; color:#35597f; border-radius:999px; min-height:34px; padding:0 12px; font-size:.85rem; font-weight:800; display:inline-flex; align-items:center; gap:6px;}
    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-left:auto;}
    .btn-order{min-height:40px; border-radius:12px; border:1px solid #d8e4f1; background:#fff; color:#1b3a5b; padding:0 13px; font-weight:800; display:inline-flex; align-items:center; gap:7px; cursor:pointer;}
    .btn-order.primary{background:linear-gradient(135deg,#0f8f7a,#0b7768); color:#fff; border-color:transparent; box-shadow:0 8px 18px rgba(11,119,104,.23);}
    .btn-order.accept{background:linear-gradient(135deg,#1f9f53,#188848); color:#fff; border-color:transparent; box-shadow:0 8px 18px rgba(31,159,83,.22);}
    .btn-order.reject{background:#fff1f2; color:#b4233b; border-color:#fecdd3;}
    .card-decision-top{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:-2px;
    }
    .card-decision-top .btn-order{
      min-height:36px;
      padding:0 12px;
      font-size:.82rem;
      border-radius:11px;
      justify-content:center;
      flex:1 1 140px;
    }
    .recusa-note{
      margin:0;
      border:1px solid #fecdd3;
      background:#fff1f2;
      color:#9f1239;
      border-radius:11px;
      padding:8px 10px;
      font-size:.82rem;
      line-height:1.35;
      display:flex;
      align-items:flex-start;
      gap:6px;
    }

    .empty{display:none; min-height:220px; border:1px dashed #d5e2f2; border-radius:16px; background:#fbfdff; color:#607791; align-items:center; justify-content:center; flex-direction:column; text-align:center; gap:8px; padding:18px;}
    .empty.show{display:flex;}
    .empty i{font-size:34px; color:#8ea4bf;}

    .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:90px; z-index:9999; background:#102846; color:#fff; padding:10px 14px; border-radius:999px; font-weight:700; display:none; box-shadow:0 12px 24px rgba(0,0,0,.24);}    
    .toast.show{display:block;}
    .desc{
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    .chat-drawer{position:fixed; inset:0; z-index:12000; display:none; padding:0;}
    .chat-drawer.open{display:block;}
    .chat-backdrop{position:absolute; inset:0; background:rgba(10,18,32,.38); backdrop-filter:blur(1.5px);}

    /* === Split view do chat (desktop) === */
    .content-split{display:block;}
    .chat-side{display:none; min-width:0;}
    @media (min-width: 1024px){
      body[data-page="pedidos"].chat-split-open .content-split{display:grid; grid-template-columns: minmax(560px, 1fr) minmax(420px, 520px); gap:16px; align-items:start;}
      /* Em split view, a lista de pedidos deve ter a mesma altura do chat e rolar internamente */
      body[data-page="pedidos"].chat-split-open .content-split > section.panel{
        position:sticky;
        top:12px;
        height:calc(100vh - 24px);
        overflow:hidden;
        display:flex;
        flex-direction:column;
      }
      body[data-page="pedidos"].chat-split-open .content-split > section.panel .panel-head{flex:0 0 auto;}
      body[data-page="pedidos"].chat-split-open .content-split > section.panel #bulkBar{flex:0 0 auto;}
      body[data-page="pedidos"].chat-split-open .content-split > section.panel #ordersGrid{
        flex:1 1 auto;
        overflow:auto;
        /* evita cortar o topo dos cards (chips) no início do scroll */
        padding-top:12px;
        padding-right:6px;
        padding-left:2px;
        padding-bottom:14px;
      }
      body[data-page="pedidos"].chat-split-open .content-split > section.panel #emptyState{
        flex:1 1 auto;
        overflow:auto;
        margin-top:0;
      }
      @media (max-width: 1280px){
        body[data-page="pedidos"].chat-split-open .grid{grid-template-columns:1fr;}
      }

      /* Expandir chat (desktop) para ocupar tambem a area da lista de pedidos */
      body[data-page="pedidos"].chat-split-open.chat-split-full .content-split{grid-template-columns: 1fr;}
      body[data-page="pedidos"].chat-split-open.chat-split-full .content-split > section.panel{display:none;}
      body[data-page="pedidos"].chat-split-open .chat-side{display:block;}
      body[data-page="pedidos"].chat-split-open .chat-backdrop{display:none !important;}
      body[data-page="pedidos"].chat-split-open .chat-drawer{display:block; position:static; inset:auto; padding:0; background:transparent;}
      body[data-page="pedidos"].chat-split-open .chat-panel-embed{position:sticky; top:12px; left:auto; right:auto; bottom:auto; height:calc(100vh - 24px); max-width:none; width:100%; min-width:0; border-radius:18px; box-shadow:0 18px 40px rgba(15,23,42,.18);}
      body[data-page="pedidos"].chat-split-open .pedido-chat-frame{height:100%;}
      body[data-page="pedidos"].chat-split-open .chat-resize-handle{display:none !important;}
      body[data-page="pedidos"].chat-split-open .chat-size-controls{display:none !important;}
    }
    .chat-panel-embed{
      position:absolute;
      top:var(--navbar-height-desktop, 76px);
      right:0;
      bottom:0;
      width:min(860px, calc(100vw - var(--sidebar-width, 250px) - 12px));
      min-width:520px;
      max-width:calc(100vw - var(--sidebar-width, 250px));
      border-radius:16px 0 0 0;
      overflow:hidden;
      background:#fff;
      border-top:1px solid #dbe7f3;
      border-left:1px solid #dbe7f3;
      box-shadow:-14px 0 34px rgba(15,23,42,.18);
      z-index:1;
      display:flex;
      flex-direction:column;
    }
    .chat-panel-embed.maximized{
      top:0;
      left:0;
      right:0;
      bottom:0;
      width:100vw !important;
      max-width:none !important;
      min-width:0;
      border-radius:0;
      border:0;
    }
    .pedido-chat-frame{display:block; width:100%; height:100%; border:0; background:#fff; flex:1 1 auto; min-height:0;}
    .chat-panel-toolbar{
      height:56px;
      min-height:56px;
      border-bottom:1px solid #dbe7f3;
      background:linear-gradient(180deg,#ffffff 0%, #f7fbff 100%);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px 0 14px;
      gap:10px;
      flex:0 0 auto;
    }
    .chat-panel-title{
      min-width:0;
      display:flex;
      align-items:center;
      gap:8px;
      color:#173867;
      font-weight:800;
      font-size:.92rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chat-panel-title i{font-size:18px; color:#0b7768;}
    .chat-panel-controls{
      position:relative;
      z-index:3;
      display:flex;
      gap:8px;
      flex:0 0 auto;
    }
    .chat-size-controls{
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin-right:2px;
      padding:3px 8px;
      border:1px solid #dbe7f3;
      border-radius:999px;
      background:#fff;
      box-shadow:0 4px 10px rgba(15,23,42,.08);
    }
    .chat-width-readout{
      min-width:46px;
      padding:0 4px;
      text-align:center;
      font-size:.72rem;
      font-weight:800;
      color:#335377;
      user-select:none;
    }
    .chat-size-controls .chat-control-btn{
      width:30px;
      height:30px;
      border-radius:999px;
      box-shadow:none;
    }
    .chat-size-controls .chat-control-btn:hover{
      transform:none;
      box-shadow:none;
      background:#f8fbff;
    }
    .chat-size-controls .chat-control-btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }
    .chat-control-btn{
      position:relative;
      width:36px;
      height:36px;
      border-radius:11px;
      border:1px solid #d7e5f4;
      background:rgba(255,255,255,.92);
      color:#0f2744;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 4px 10px rgba(15,23,42,.10);
      cursor:pointer;
      transition:transform .18s ease, box-shadow .18s ease, background-color .18s ease;
    }
    .chat-control-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 8px 16px rgba(15,23,42,.16);
      background:#fff;
    }
    .chat-resize-handle{
      position:absolute;
      left:-8px;
      top:56px;
      bottom:0;
      width:16px;
      cursor:ew-resize;
      z-index:4;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(90deg, rgba(11,119,104,.14) 0%, rgba(11,119,104,.04) 60%, rgba(11,119,104,0) 100%);
    }
    .chat-resize-handle::before{
      content:'';
      width:4px;
      height:46px;
      border-radius:999px;
      background:
        radial-gradient(circle, #7a93b3 1.1px, transparent 1.2px) center 2px/4px 8px repeat-y;
      opacity:.9;
    }
    .chat-panel-embed.maximized .chat-resize-handle{display:none;}
    .chat-panel-embed.maximized .chat-size-controls{
      opacity:.55;
      pointer-events:none;
    }
    body.chat-resizing{user-select:none; cursor:ew-resize;}
    html.no-scroll, body.no-scroll{overflow:hidden;}

    .details-modal{
      position:fixed;
      inset:0;
      z-index:12100;
      background:rgba(8,19,34,.52);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .details-modal.open{display:flex;}
    .doke-prompt-modal{
      position:fixed;
      inset:0;
      z-index:12200;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(8,19,34,.55);
      padding:14px;
    }
    .doke-prompt-modal.open{display:flex;}
    .doke-prompt-card{
      width:min(520px, 100%);
      border-radius:16px;
      border:1px solid #dce6f2;
      border-left:5px solid #dc3545;
      background:#fff;
      box-shadow:0 16px 38px rgba(0,0,0,.14);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .doke-prompt-title{margin:0; font-size:1rem; font-weight:800; color:#1f2937;}
    .doke-prompt-text{margin:0; font-size:.9rem; color:#4b5563; line-height:1.35;}
    .doke-prompt-input{
      width:100%;
      min-height:98px;
      resize:vertical;
      border:1px solid #d1deec;
      border-radius:12px;
      background:#f8fbff;
      color:#0f2440;
      padding:10px 12px;
      font-size:.92rem;
      outline:none;
    }
    .doke-prompt-input:focus{
      border-color:#0b5ed7;
      box-shadow:0 0 0 2px rgba(11,94,215,.12);
      background:#fff;
    }
    .doke-prompt-error{min-height:18px; margin:0; font-size:.8rem; color:#b4233b; font-weight:700;}
    .doke-prompt-actions{display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap;}
    .doke-prompt-btn{
      min-height:38px;
      border-radius:10px;
      border:1px solid #d8e3f1;
      background:#fff;
      color:#1f3b60;
      padding:0 14px;
      font-weight:800;
      cursor:pointer;
    }
    .doke-prompt-btn.confirm{
      border-color:transparent;
      background:linear-gradient(135deg,#c91f4b,#a9143b);
      color:#fff;
      box-shadow:0 8px 20px rgba(201,31,75,.25);
    }
    .details-card{
      width:min(820px,100%);
      max-height:min(86vh,880px);
      overflow:auto;
      background:#fff;
      border:1px solid #d9e4f1;
      border-radius:18px;
      box-shadow:0 20px 44px rgba(9,22,40,.24);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .details-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid #edf2f8;
      padding-bottom:10px;
    }
    .details-head h3{margin:0; font-size:1.08rem;}
    .details-head p{margin:4px 0 0; color:#5e7592; font-size:.86rem;}
    .details-close{
      width:36px;
      height:36px;
      border:1px solid #d8e3f1;
      border-radius:10px;
      background:#fff;
      color:#2a4b6f;
      cursor:pointer;
    }
    .details-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
    }
    .details-item{
      border:1px solid #dce8f4;
      background:#f7fbff;
      border-radius:10px;
      padding:8px 10px;
    }
    .details-item small{display:block; color:#69809e; font-size:.73rem;}
    .details-item strong{display:block; margin-top:3px; font-size:.92rem; line-height:1.25;}
    .details-block{
      border:1px solid #dce8f4;
      background:#fbfdff;
      border-radius:12px;
      padding:10px;
    }
    .details-block h4{margin:0 0 6px; font-size:.88rem; color:#32567b;}
    .details-block p{margin:0; color:#2a4464; font-size:.9rem; white-space:pre-wrap; line-height:1.35;}
    .triagem-list{display:grid; gap:8px;}
    .triagem-row{
      border:1px dashed #d4e2f2;
      border-radius:10px;
      background:#fff;
      padding:8px;
    }
    .triagem-row small{display:block; color:#5f7898; font-size:.74rem;}
    .triagem-row strong{display:block; margin-top:4px; font-size:.9rem; color:#153553; white-space:pre-wrap;}
    .anexos-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));
      gap:8px;
    }
    .anexo-item{
      border:1px solid #d8e5f4;
      background:#fff;
      border-radius:10px;
      overflow:hidden;
    }
    .anexo-item a{
      display:block;
      color:#1e4268;
      text-decoration:none;
    }
    .anexo-item img{
      width:100%;
      height:110px;
      object-fit:cover;
      display:block;
      background:#eef3fa;
    }
    .anexo-caption{
      display:block;
      padding:7px 8px;
      font-size:.78rem;
      line-height:1.25;
      word-break:break-word;
    }

    @media (max-width:1360px){
      .hero{padding:28px; gap:14px; align-items:flex-start;}
      .hero-stats{width:100%; justify-content:flex-start;}
      .hero-stat{min-width:110px;}
    }

    @media (max-width:1023px){
      body[data-page="pedidos"] .dp-wrap{padding:12px 12px 94px; margin-left:0;}
      .toolbar{grid-template-columns:1fr;}
      .toolbar-actions{display:grid; grid-template-columns:1fr 1fr;}
      .grid{grid-template-columns:1fr;}
      /* Mobile/tablet: cards nao devem ter altura fixa (evita buracos/cortes e scroll travado) */
      .card{height:auto; min-height:unset; overflow:visible;}
    }

    @media (max-width:768px){
      body[data-page="pedidos"] .dp-wrap{padding:10px 10px 88px;}
      .hero{padding:20px; border-radius:18px; gap:14px;}
      .hero h1{font-size:1.7rem;}
      .hero p{font-size:.88rem; margin-top:6px;}
      .hero-stat{min-width:92px; padding:8px 10px;}
      .toolbar{gap:6px; margin:8px 0 8px;}
      .toolbar-actions{
        display:flex;
        overflow-x:auto;
        scrollbar-width:none;
        -webkit-overflow-scrolling:touch;
      }
      .toolbar-actions::-webkit-scrollbar{display:none;}
      .search{min-height:36px; padding:7px 10px; border-radius:12px;}
      .search input{font-size:13.5px;}
      .toolbar-actions{gap:6px;}
      .btn-ui{min-height:34px; padding:0 10px; font-size:.8rem; border-radius:10px;}
      .btn-ui{flex:0 0 auto;}
      .btn-ui i{font-size:15px;}
      #bulkBar{padding:8px 10px; border-radius:12px;}
      #bulkInfo{font-size:.8rem;}
      .bulk-actions{width:100%;}
      .bulk-actions .btn-ui{flex:1; justify-content:center; min-height:34px; padding:0 8px; font-size:.78rem;}
      .filters{gap:5px; margin-bottom:8px;}
      .chip{min-height:30px; padding:0 10px; font-size:.78rem;}
      .panel{padding:10px; border-radius:16px;}
      .panel-head{margin-bottom:8px;}
      .panel-head h2{font-size:.95rem;}
      .panel-head p{font-size:.74rem;}
      .grid{gap:8px;}
      .card{padding:9px; border-radius:12px; gap:7px;}
      .tags{gap:5px;}
      .tag{padding:5px 8px; font-size:.7rem;}
      .user{gap:8px;}
      .user img{width:34px; height:34px;}
      .user-meta strong{font-size:.88rem;}
      .user-meta span{font-size:.73rem;}
      .title{font-size:.95rem; line-height:1.15;}
      .desc{font-size:.8rem; line-height:1.2; -webkit-line-clamp:1;}
      .need-preview{margin-top:6px; padding:8px 10px; border-radius:12px;}
      .need-preview span{font-size:.82rem; -webkit-line-clamp:2;}
      .meta{gap:5px;}
      .meta-item{padding:6px 7px; border-radius:9px; gap:6px;}
      .meta-item i{font-size:14px;}
      .meta-item small{font-size:.66rem;}
      .meta-item strong{font-size:.79rem; margin-top:2px;}
      .footer{padding-top:7px; gap:6px;}
      .unread{min-height:28px; font-size:.73rem; padding:0 8px;}
      .actions{gap:6px;}
      .btn-order{min-height:32px; font-size:.75rem; padding:0 9px; border-radius:9px;}
      .card-decision-top{gap:6px; margin-top:0;}
      .card-decision-top .btn-order{flex:1 1 calc(50% - 6px); min-height:32px; font-size:.74rem; padding:0 8px;}
      .recusa-note{font-size:.75rem; padding:7px 8px; border-radius:9px;}
      .filters{
        flex-wrap:nowrap;
        overflow-x:auto;
        scrollbar-width:none;
        -webkit-overflow-scrolling:touch;
        padding-bottom:2px;
      }
      .filters::-webkit-scrollbar{display:none;}
      .chip{flex:0 0 auto;}
      .card-select{width:28px; height:28px; min-width:28px; top:10px; right:10px; border-radius:9px; font-size:16px;}
      .details-modal{padding:10px;}
      .details-card{border-radius:14px; padding:10px;}
      .details-grid{grid-template-columns:1fr;}
      .anexo-item img{height:90px;}
    }

    @media (max-width:540px){
      .hero{padding:16px; border-radius:16px;}
      .hero-stats{
        width:100%;
        display:grid;
        grid-template-columns:repeat(3, minmax(0,1fr));
        gap:7px;
      }
      .hero-stat{
        min-width:0;
        width:100%;
        padding:8px 7px;
        border-radius:13px;
      }
      .hero-stat small{
        white-space:normal;
        line-height:1.2;
        font-size:.64rem;
      }
      .hero-stat strong{font-size:.95rem;}
      .meta{grid-template-columns:1fr 1fr;}
      .footer{flex-direction:column; align-items:stretch;}
      .actions{margin-left:0; width:100%;}
      .btn-order{flex:1; justify-content:center;}
      .doke-prompt-card{padding:12px; border-radius:14px;}
      .doke-prompt-actions{width:100%;}
      .doke-prompt-btn{flex:1;}
    
/* --- Mobile compact cards (Pedidos) --- */
.card{padding:12px; border-radius:18px;}
.card-top{gap:10px;}
.tags{gap:6px;}
.tags .tag{padding:6px 10px; border-radius:999px; font-size:.72rem;}
.tags .role-client, .tags .role-pro, .tags .role-me{display:none;}
.title{font-size:1.02rem;}
.desc{
  margin-top:4px;
  display:-webkit-box;
  -webkit-line-clamp:1;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

/* Meta row becomes horizontal pills */
.meta{
  display:flex !important;
  flex-wrap:nowrap !important;
  overflow-x:auto !important;
  -webkit-overflow-scrolling:touch;
  gap:8px !important;
  padding-bottom:2px;
}
.meta-item{
  flex:0 0 auto;
  min-width:max-content;
  padding:7px 9px;
  border-radius:12px;
}
.meta-item small{display:none !important;}
.meta-item strong{
  margin-top:0 !important;
  font-size:.86rem !important;
  white-space:nowrap;
}

/* Footer + buttons */
.unread{display:none;}
.actions{gap:8px;}
.btn-order{min-height:40px; border-radius:12px; padding:0 12px; font-size:.9rem;}
.btn-order i{font-size:1.05rem;}
.btn-order.secondary{
  flex:0 0 44px;
  width:44px;
  padding:0;
  justify-content:center;
}
.btn-order.secondary .btn-text{display:none;}

}

    @media (max-width:420px){
      .orders-page{max-width:100%; min-width:0;}
      .hero{
        padding:14px !important;
        border-radius:16px !important;
        display:grid !important;
        grid-template-columns:1fr !important;
        align-items:start !important;
        gap:10px !important;
      }
      .hero h1{
        font-size:clamp(1.9rem, 9vw, 2.35rem) !important;
        line-height:1.05 !important;
      }
      .hero p{
        font-size:.78rem !important;
        line-height:1.35 !important;
        max-width:100% !important;
      }
      .badge-count{font-size:.8rem !important; padding:2px 8px !important;}
      .hero-stats{
        width:100% !important;
        display:grid !important;
        grid-template-columns:repeat(3, minmax(0,1fr)) !important;
        gap:6px !important;
      }
      .hero-stat{min-width:0 !important; width:100% !important; padding:7px 6px !important; border-radius:13px !important;}
      .hero-stat small{white-space:normal; overflow:visible; text-overflow:initial; font-size:.62rem !important; line-height:1.2;}
      .hero-stat strong{font-size:.92rem !important;}
    }

    @media (max-width:1023px){
      .chat-drawer{padding:0;}
      .chat-panel-embed{
        inset:0;
        width:100%;
        min-width:0;
        height:100dvh;
        max-width:none;
        border-radius:0;
        border:0;
      }
      .chat-panel-toolbar{
        height:52px;
        min-height:52px;
        padding:0 8px 0 10px;
      }
      .chat-size-controls{display:none !important;}
      .chat-resize-handle,
      #chatExpandBtn{display:none !important;}
      #bulkBar{padding:10px;}
    }
  
/* === PATCH: parity do chat no pedidos (header + cobrança + mídia) === */
.pedido-chat-panel .chat-header,
.pedido-chat-inline .chat-header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid #d9e3f3;background:#fff;min-height:72px;}
.pedido-chat-panel .chat-header-left,.pedido-chat-inline .chat-header-left{display:flex;align-items:center;gap:10px;min-width:0;flex:1;}
.pedido-chat-panel .chat-avatar,.pedido-chat-inline .chat-avatar{width:42px;height:42px;border-radius:50%;object-fit:cover;border:2px solid #e8eef8;background:#f3f6fb;}
.pedido-chat-panel .chat-header-info,.pedido-chat-inline .chat-header-info{min-width:0;display:flex;flex-direction:column;}
.pedido-chat-panel .chat-header-info h3,.pedido-chat-inline .chat-header-info h3{margin:0;font-size:14px;line-height:1.2;font-weight:800;color:#14233c;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.pedido-chat-panel .chat-header-info p,.pedido-chat-inline .chat-header-info p{margin:2px 0 0;font-size:11px;color:#6f7f99;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.pedido-chat-panel .chat-header-tools,.pedido-chat-inline .chat-header-tools{display:flex;align-items:center;gap:8px;flex-wrap:nowrap;}
.pedido-chat-panel .icon-btn,.pedido-chat-inline .icon-btn{width:40px;height:40px;border-radius:12px;border:1px solid #d6e0ef;background:#fff;color:#173867;display:flex;align-items:center;justify-content:center;cursor:pointer;}
.pedido-chat-panel .btn-cobranca,.pedido-chat-inline .btn-cobranca{height:40px;display:inline-flex;align-items:center;gap:8px;padding:0 12px;border-radius:12px;border:1px solid #cfe0f4;background:linear-gradient(180deg,#ffffff,#f4f8ff);color:#173867;font-weight:700;font-size:13px;box-shadow:0 4px 10px rgba(17,57,107,.06);cursor:pointer;}
.pedido-chat-panel .btn-cobranca:hover,.pedido-chat-inline .btn-cobranca:hover{background:linear-gradient(180deg,#f9fbff,#edf4ff);}
.pedido-chat-panel .btn-cobranca i,.pedido-chat-inline .btn-cobranca i{font-size:14px;}
.pedido-chat-panel .mensagem-lista,.pedido-chat-inline .mensagem-lista{padding:14px;overflow:auto;background:#edf2f8;}
.pedido-chat-panel .mensagem-vazia,.pedido-chat-inline .mensagem-vazia{height:100%;min-height:220px;display:grid;place-items:center;color:#6f84a3;font-weight:500;}
.pedido-chat-panel .preview-media img,.pedido-chat-inline .preview-media img,.pedido-chat-panel .msg-media img,.pedido-chat-inline .msg-media img{max-width:100%;height:auto;display:block;border-radius:14px;object-fit:cover;}
.pedido-chat-panel .composer,.pedido-chat-inline .composer,.pedido-chat-panel .chat-input-area,.pedido-chat-inline .chat-input-area{display:flex;align-items:center;gap:10px;padding:10px 12px;border-top:1px solid #d9e3f3;background:#fff;}
.pedido-chat-panel .chat-input,.pedido-chat-inline .chat-input,.pedido-chat-panel .mensagem-input,.pedido-chat-inline .mensagem-input{flex:1;min-width:0;height:48px;border-radius:24px;border:1px solid #d6e0ef;background:#f5f8fd;padding:0 16px;font-size:15px;color:#173867;}
.pedido-chat-panel .chat-send,.pedido-chat-inline .chat-send,.pedido-chat-panel .btn-enviar,.pedido-chat-inline .btn-enviar{width:46px;height:46px;border:none;border-radius:50%;background:#0b9b8c;color:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 10px 22px rgba(11,155,140,.25);cursor:pointer;}
.pedido-chat-panel .chat-send:disabled,.pedido-chat-inline .chat-send:disabled{opacity:.5;cursor:not-allowed;box-shadow:none;}
/* impedir estouro visual do chat embutido */
.pedido-chat-panel{overflow:hidden;}
.pedido-chat-panel *{max-width:100%;box-sizing:border-box;}
@media (max-width: 900px){
  .pedido-chat-panel .btn-cobranca .btn-label,.pedido-chat-inline .btn-cobranca .btn-label{display:none;}
  .pedido-chat-panel .btn-cobranca,.pedido-chat-inline .btn-cobranca{width:40px;padding:0;justify-content:center;}
  .pedido-chat-panel .chat-header,.pedido-chat-inline .chat-header{padding:10px;}
}

/* perfil clicável no card */
.card-pedido .user{ cursor:pointer; }
.card-pedido .user:hover .user-meta strong{ text-decoration: underline; }
</style>
</head>
<body data-page="pedidos">
<header class="navbar-mobile">
<div id="logo-mobile"><a href="index.html"><img alt="Doke" decoding="async" loading="lazy" src="assets/Imagens/doke-logo.png"/></a></div>
<div class="botoes-direita"><a class="entrar" href="login.html">Entrar</a><a href="login.html"></a></div>
</header>
<div id="overlay-menu" onclick="fecharMenuMobile()"></div>
<header class="navbar-desktop">
<div id="logo-desktop"><a href="projeto.html"><img alt="Doke" decoding="async" loading="lazy" src="assets/Imagens/doke-logo.png"/></a></div>
<nav class="menu">
<div class="cep-wrapper">
<a class="cep" href="#" id="linkCep" onclick="toggleCep(event)">
<svg fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"></path></svg>
<span id="textoCepSpan">Informe seu CEP</span>
</a>
<div class="cep-popup" id="boxCep">
<p>Digite seu CEP:</p>
<div class="cep-input-group"><label class="sr-only" for="inputCep">CEP</label><input id="inputCep" maxlength="9" name="inputCep" placeholder="00000-000" type="text"/><button onclick="salvarCep()">OK</button></div>
</div>
</div>
<a href="escolheranuncio.html">Anunciar</a>
<a href="comunidade.html ">Comunidades <span class="badge-novo1">NOVO</span></a>
<a href="novidades.html">Novidades</a>
</nav>
<div class="botoes-direita"><a class="entrar" href="login.html">Entrar</a></div>
</header>
<aside class="sidebar-icones">
<div id="logo"><a href="index.html"><img alt="Logotipo da plataforma Doke" decoding="async" loading="lazy" src="assets/Imagens/doke-logo.png"/></a></div>
<div class="item"><a href="index.html"><i class="bx bx-home-alt icon azul"></i><span>Início</span></a></div>
<div class="item" id="pvSearchSidebarItem"><a aria-label="Pesquisar" class="pv-search-toggle" href="#"><i class="bx bx-search-alt-2 icon azul"></i><span>Pesquisar</span></a></div>
<div class="item"><a href="negocios.html"><i class="bx bx-store icon verde"></i><span>Negócios</span></a></div>
<div class="item"><a href="notificacoes.html"><i class="bx bx-bell icon azul"></i><span>Notificações</span></a></div>
<div class="item"><a href="mensagens.html"><i class="bx bx-message-rounded-dots icon azul"></i><span>Mensagens</span></a></div>
<div class="item ativo"><a href="pedidos.html"><i class="bx bx-package icon verde"></i><span>Pedidos</span></a></div>
<div class="item"><a href="comunidade.html"><i class="bx bx-group icon verde"></i><span>Comunidades</span></a></div>
<div class="item"><a href="#" onclick="irParaMeuPerfil(event)"><i class="bx bx-user icon verde"></i><span>Perfil</span></a></div>
<div class="item"><a href="mais.html"><i class="bx bx-menu icon azul"></i><span>Mais</span></a></div>
</aside>
<main class="dp-wrap">
<div class="orders-page">
<section class="hero">
<div>
<h1>Pedidos <span class="badge-count" id="heroCount">0</span></h1>
<p>Gerencie seus pedidos com dados reais e acesso rapido ao chat.</p>
</div>
<div class="hero-stats">
<div class="hero-stat"><small>Hoje</small><strong id="statToday">0</strong></div>
<div class="hero-stat"><small>Em andamento</small><strong id="statProgress">0</strong></div>
<div class="hero-stat"><small>Urgentes</small><strong id="statUrgent">0</strong></div>
</div>
</section>
<section class="toolbar">
<label aria-label="Buscar pedidos" class="search search-collapsible">
<i class="bx bx-search"></i>
<input id="searchInput" placeholder="Buscar por cliente, servico, ID ou descricao" type="text"/>
</label>
<div class="toolbar-actions">
<button class="btn-ui" id="sortBtn" type="button"><i class="bx bx-sort-alt-2"></i><span id="sortLabel">Mais recentes</span></button>
<button class="btn-ui" id="selectBtn" type="button"><i class="bx bx-check-square"></i><span id="selectLabel">Selecionar</span></button>
<button class="btn-ui" id="refreshBtn" type="button"><i class="bx bx-refresh"></i><span>Atualizar</span></button><button class="btn-ui" id="filtersBtn" type="button" aria-expanded="false"><i class="bx bx-filter"></i><span>Filtros</span></button>
</div>
</section>
<div aria-label="Filtros de pedidos" class="filters filters-collapsible" id="filtersBar" role="tablist">
<button class="chip active" data-filter="all" type="button"><i class="bx bx-grid-alt"></i><span>Todos</span></button>
<button class="chip" data-filter="pending" type="button">Pendentes</button>
<button class="chip" data-filter="progress" type="button">Em andamento</button>
<button class="chip" data-filter="done" type="button">Finalizados</button>
<button class="chip" data-filter="urgent" type="button"><i class="bx bx-error"></i><span>Urgentes</span></button>
</div>
<div class="content-split" id="contentSplit">
<section class="panel">
<div class="panel-head">
<div>
<h2><i class="bx bx-package"></i> Pedidos</h2>
<p id="ordersSubtitle">Carregando...</p>
</div>
</div>
<div id="bulkBar">
<div id="bulkInfo">0 pedidos selecionados</div>
<div class="bulk-actions">
<button class="btn-ui" id="bulkFinalizeBtn" type="button"><i class="bx bx-check"></i>Finalizar</button>
<button class="btn-ui" id="bulkArchiveBtn" type="button"><i class="bx bx-archive-in"></i>Arquivar</button>
<button class="btn-ui" id="bulkClearBtn" type="button"><i class="bx bx-x"></i>Limpar</button>
</div>
</div>
<div class="grid" id="ordersGrid"></div>
<div class="empty" id="emptyState">
<i class="bx bx-inbox"></i>
<strong>Nenhum pedido encontrado</strong>
<span>Tente outro filtro ou atualize os dados.</span>
</div>
</section>
<aside aria-hidden="true" class="chat-side" id="chatSide"></aside>
</div>
</div>
</main>
<nav class="bottom-nav">
<a class="item" href="index.html"><img class="icon azul" decoding="async" loading="lazy" src="https://cdn-icons-png.flaticon.com/512/1946/1946436.png"/><span>Início</span></a>
<a class="item" href="busca.html"><img class="icon verde" decoding="async" loading="lazy" src="https://cdn-icons-png.flaticon.com/512/622/622669.png"/><span>Explorar</span></a>
<a class="item" href="anunciar.html"><img class="icon azul" decoding="async" loading="lazy" src="assets/Imagens/icone-anunciar.png"/><span>Anunciar</span></a>
<a class="item" href="notificacoes.html"><img class="icon azul" decoding="async" loading="lazy" src="https://cdn-icons-png.flaticon.com/512/1827/1827392.png"/><span>Notificações</span></a>
<a class="item" href="meuperfil.html"><img class="icon verde" decoding="async" loading="lazy" src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png"/><span>Perfil</span></a>
</nav>
<div class="toast" id="toast">OK</div>
<div aria-hidden="true" class="chat-drawer chat-drawer-embed" id="chatDrawer">
<div class="chat-backdrop" data-close="1"></div>
<div aria-label="Chat do pedido" aria-modal="true" class="chat-panel-embed" role="dialog">
<div class="chat-panel-toolbar">
<div class="chat-panel-title" id="chatPanelTitle"><i class="bx bx-message-square-detail"></i><span>Chat do pedido</span></div>
<div class="chat-panel-controls">
<div class="chat-size-controls" id="chatSizeControls">
<button aria-label="Diminuir largura do chat" class="chat-control-btn" id="chatNarrowBtn" title="Diminuir largura" type="button">
<i class="bx bx-chevron-left"></i>
</button>
<span aria-hidden="true" class="chat-width-readout" id="chatWidthLabel">--</span>
<button aria-label="Aumentar largura do chat" class="chat-control-btn" id="chatWidenBtn" title="Aumentar largura" type="button">
<i class="bx bx-chevron-right"></i>
</button>
</div>
<button aria-label="Expandir chat" aria-pressed="false" class="chat-control-btn" id="chatExpandBtn" title="Expandir chat" type="button">
<i class="bx bx-expand-alt"></i>
</button>
<button aria-label="Fechar chat" class="chat-control-btn chat-close-float" data-close="1" type="button">
<i class="bx bx-x"></i>
</button>
</div>
</div>
<div aria-hidden="true" class="chat-resize-handle" id="chatResizeHandle"></div>
<iframe class="pedido-chat-frame" id="pedidoChatFrame" loading="eager" title="Chat do pedido"></iframe>
</div>
</div>
<section aria-hidden="true" class="details-modal" id="detailsModal">
<article aria-labelledby="detailsTitle" aria-modal="true" class="details-card" role="dialog">
<div class="details-head">
<div>
<h3 id="detailsTitle">Detalhes do pedido</h3>
<p id="detailsSubtitle">Carregando dados...</p>
</div>
<button aria-label="Fechar detalhes" class="details-close" id="detailsCloseBtn" type="button"><i class="bx bx-x"></i></button>
</div>
<div class="details-grid" id="detailsGrid"></div>
<div class="details-block">
<h4>Descrição</h4>
<p id="detailsDescription">Sem descrição.</p>
</div>
<div class="details-block">
<h4>Triagem</h4>
<div class="triagem-list" id="detailsTriagem"></div>
</div>
<div class="details-block">
<h4>Anexos</h4>
<div class="anexos-grid" id="detailsAnexos"></div>
</div>
</article>
</section>
<section aria-hidden="true" class="doke-prompt-modal" id="rejectPromptModal">
<article aria-labelledby="rejectPromptTitle" aria-modal="true" class="doke-prompt-card" role="dialog">
<h3 class="doke-prompt-title" id="rejectPromptTitle">Justificar recusa</h3>
<p class="doke-prompt-text">Informe a justificativa da recusa (minimo de 5 caracteres):</p>
<textarea class="doke-prompt-input" id="rejectPromptInput" placeholder="Ex.: Nao tenho disponibilidade para esta data."></textarea>
<p class="doke-prompt-error" id="rejectPromptError"></p>
<div class="doke-prompt-actions">
<button class="doke-prompt-btn" id="rejectPromptCancelBtn" type="button">Cancelar</button>
<button class="doke-prompt-btn confirm" id="rejectPromptConfirmBtn" type="button">Confirmar recusa</button>
</div>
</article>
</section>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase-init.js?v=20260218v43"></script>
<script src="firebase-compat-supabase.js?v=20260212v25"></script>
<script src="firebase-auth-compat-supabase.js?v=20260217v12"></script>
<script src="doke-toast.js"></script>
<script src="doke-alerts.js?v=20260217v33"></script>
<script src="doke-shell.js?v=20260224v48"></script>
<script>
    (function(){
      const CHAT_WIDTH_KEY = 'doke_pedidos_chat_width_v1';
      const CHAT_WIDTH_STEP = 72;
      const state = {
        pedidos: [],
        filter: 'all',
        query: '',
        sort: 'recent',
        detailsById: new Map(),
	        userByUid: new Map(),
        activeChatUrl: '',
        selectMode: false,
        selected: new Set(),
        chatWidth: 0,
        chatMaximized: false,
        chatResizing: false,
        chatResizeStartX: 0,
        chatResizeStartWidth: 0
      };
      const el = {
        grid: document.getElementById('ordersGrid'),
        empty: document.getElementById('emptyState'),
        subtitle: document.getElementById('ordersSubtitle'),
        count: document.getElementById('heroCount'),
        statToday: document.getElementById('statToday'),
        statProgress: document.getElementById('statProgress'),
        statUrgent: document.getElementById('statUrgent'),
        search: document.getElementById('searchInput'),
        sortBtn: document.getElementById('sortBtn'),
        sortLabel: document.getElementById('sortLabel'),
        selectBtn: document.getElementById('selectBtn'),
        selectLabel: document.getElementById('selectLabel'),
        refreshBtn: document.getElementById('refreshBtn'),
        filtersBtn: document.getElementById('filtersBtn'),
        filtersBar: document.getElementById('filtersBar'),
        toolbar: document.querySelector('section.toolbar'),
        chips: Array.from(document.querySelectorAll('.chip[data-filter]')),
        toast: document.getElementById('toast'),
        bulkBar: document.getElementById('bulkBar'),
        bulkInfo: document.getElementById('bulkInfo'),
        bulkFinalizeBtn: document.getElementById('bulkFinalizeBtn'),
        bulkArchiveBtn: document.getElementById('bulkArchiveBtn'),
        bulkClearBtn: document.getElementById('bulkClearBtn'),
        contentSplit: document.getElementById('contentSplit'),
        chatDrawer: document.getElementById('chatDrawer'),
        chatPanel: document.querySelector('#chatDrawer .chat-panel-embed'),
        chatSide: document.getElementById('chatSide'),
        chatPanelTitle: document.getElementById('chatPanelTitle'),
        chatNarrowBtn: document.getElementById('chatNarrowBtn'),
        chatWidenBtn: document.getElementById('chatWidenBtn'),
        chatWidthLabel: document.getElementById('chatWidthLabel'),
        chatExpandBtn: document.getElementById('chatExpandBtn'),
        chatResizeHandle: document.getElementById('chatResizeHandle'),
        chatFrame: document.getElementById('pedidoChatFrame'),
        detailsModal: document.getElementById('detailsModal'),
        detailsCloseBtn: document.getElementById('detailsCloseBtn'),
        detailsSubtitle: document.getElementById('detailsSubtitle'),
        detailsGrid: document.getElementById('detailsGrid'),
        detailsDescription: document.getElementById('detailsDescription'),
        detailsTriagem: document.getElementById('detailsTriagem'),
        detailsAnexos: document.getElementById('detailsAnexos'),
        rejectPromptModal: document.getElementById('rejectPromptModal'),
        rejectPromptInput: document.getElementById('rejectPromptInput'),
        rejectPromptError: document.getElementById('rejectPromptError'),
        rejectPromptCancelBtn: document.getElementById('rejectPromptCancelBtn'),
        rejectPromptConfirmBtn: document.getElementById('rejectPromptConfirmBtn')
      };

      // Abrir perfil ao clicar no avatar ou @usuario
      if(el.grid){
        el.grid.addEventListener('click', (ev) => {
          const target = ev.target && ev.target.closest ? ev.target.closest('.card-pedido .user[data-profile]') : null;
          if(!target) return;
          const uid = String(target.getAttribute('data-profile-uid') || '').trim();
          const user = String(target.getAttribute('data-profile-user') || '').trim();
          if(uid){
            try{ if(typeof window.abrirPerfil === 'function') return window.abrirPerfil(uid); }catch(_){ }
            location.href = `perfil-profissional.html?uid=${encodeURIComponent(uid)}`;
            return;
          }
          if(user){
            // fallback por username
            location.href = `perfil-profissional.html?user=${encodeURIComponent(user)}`;
          }
        });
      }



      // garante que a página continue rolando (principalmente em mobile)
      lockScrollIfNeeded();

      function showToast(msg){
        if(!el.toast) return;
        el.toast.textContent = String(msg || 'OK');
        el.toast.classList.add('show');
        clearTimeout(window.__ordersToastTimer);
        window.__ordersToastTimer = setTimeout(() => el.toast.classList.remove('show'), 1800);
      }

      function esc(v){
        return String(v ?? '').replace(/[&<>"']/g, (m) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
      }

      function displayHandle(p){
        const u = String((p && p.usuario) || '').trim();
        if(u) return u.startsWith('@') ? u : `@${u}`;
        // fallback curto (não usa nome completo com vários sobrenomes)
        const nome = String((p && p.nome) || '').trim();
        if(nome){
          const first = nome.split(/\s+/)[0].toLowerCase().replace(/[^a-z0-9_\.]/gi,'');
          return first ? `@${first}` : '@usuario';
        }
        return '@usuario';
      }

      function parseJSON(raw){
        if(!raw) return null;
        try { return JSON.parse(raw); } catch (_) { return null; }
      }

      function asArray(input){
        if(Array.isArray(input)) return input;
        if(input && typeof input === 'object'){
          if(Array.isArray(input.items)) return input.items;
          if(Array.isArray(input.data)) return input.data;
          if(Array.isArray(input.rows)) return input.rows;
          if(Array.isArray(input.pedidos)) return input.pedidos;
          if(Array.isArray(input.orcamentos)) return input.orcamentos;
        }
        return [];
      }

      function pick(obj, keys, fallback){
        for(const k of keys){
          const v = obj ? obj[k] : null;
          if(v == null) continue;
          const s = String(v).trim();
          if(s) return s;
        }
        return fallback;
      }

      function toDate(v){
        if(!v) return null;
        if(v instanceof Date && Number.isFinite(v.getTime())) return v;
        if(typeof v === 'number'){
          const d = new Date(v > 1e12 ? v : v * 1000);
          return Number.isFinite(d.getTime()) ? d : null;
        }
        if(typeof v === 'string'){
          const n = Number(v.trim());
          if(Number.isFinite(n)){
            const dn = new Date(v.trim().length >= 13 ? n : n * 1000);
            if(Number.isFinite(dn.getTime())) return dn;
          }
          const d = new Date(v);
          return Number.isFinite(d.getTime()) ? d : null;
        }
        if(typeof v === 'object'){
          if(typeof v.toDate === 'function'){
            const d = v.toDate();
            if(d instanceof Date && Number.isFinite(d.getTime())) return d;
          }
          if(typeof v.seconds === 'number') return new Date(v.seconds * 1000);
          if(typeof v._seconds === 'number') return new Date(v._seconds * 1000);
        }
        return null;
      }

      function formatUpdated(v){
        const d = toDate(v);
        if(!d) return String(v || 'recentemente');
        const diff = Date.now() - d.getTime();
        if(diff < 60000) return 'agora';
        if(diff < 3600000) return `ha ${Math.max(1, Math.round(diff/60000))} min`;
        if(diff < 86400000) return `ha ${Math.max(1, Math.round(diff/3600000))} h`;
        return d.toLocaleDateString('pt-BR');
      }

      function statusCode(raw){
        const s = String(raw || 'pendente').toLowerCase();
        if(s.includes('cancel')) return 'cancelado';
        if(s.includes('and') || s.includes('aceit') || s.includes('pago')) return 'andamento';
        if(s.includes('recus') || s.includes('negad') || s.includes('reprov')) return 'recusado';
        if(s.includes('fin') || s.includes('conc')) return 'finalizado';
        return 'pendente';
      }

      function statusLabel(s){
        if(s === 'andamento') return 'Em andamento';
        if(s === 'cancelado') return 'Cancelado';
        if(s === 'recusado') return 'Recusado';
        if(s === 'finalizado') return 'Finalizado';
        return 'Pendente';
      }

      function statusClass(s){
        if(s === 'andamento') return 'progress';
        if(s === 'cancelado') return 'done';
        if(s === 'recusado') return 'done';
        if(s === 'finalizado') return 'done';
        return 'pending';
      }

      function isPendenteStatus(status){
        const s = String(status || '').toLowerCase();
        return s === 'pendente' || s.includes('pend') || s.includes('aguard') || s.includes('novo') || s.includes('analise');
      }

      function canOpenChat(p){
        const raw = String(p?.statusOriginal || p?.status || '').toLowerCase();
        if(raw.includes('aceit') || raw.includes('pago')) return true;
        if(raw === 'andamento') return true;
        return false;
      }

      function isStatusFinalizadoOuRecusado(p){
        const sNorm = String(p?.status || '').toLowerCase();
        const sRaw = String(p?.statusOriginal || '').toLowerCase();
        return sNorm === 'finalizado' || sNorm === 'recusado' || sNorm === 'cancelado' || sRaw.includes('finaliz') || sRaw.includes('recus') || sRaw.includes('cancel');
      }

      function getSidebarWidth(){
        const rawCss = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width') || '');
        if(Number.isFinite(rawCss) && rawCss > 0) return rawCss;
        const sidebar = document.querySelector('.sidebar-icones');
        const w = sidebar?.getBoundingClientRect?.().width || 0;
        return Number.isFinite(w) && w > 0 ? w : 250;
      }

      function isDesktopChatMode(){
        return window.innerWidth >= 1024;
      }

      function getChatPanelBounds(){
        const sidebar = getSidebarWidth();
        const available = Math.max(420, Math.round(window.innerWidth - sidebar));
        const keepOrdersVisible = Math.max(280, Math.min(560, Math.round(window.innerWidth * 0.28)));
        const minWidth = Math.min(760, Math.max(500, Math.round(available * 0.48)));
        const maxByViewport = Math.min(1120, available);
        const maxBySplit = available - keepOrdersVisible;
        const maxWidth = Math.max(minWidth, Math.min(maxByViewport, maxBySplit));
        return { minWidth, maxWidth, available };
      }

      function getDefaultChatWidth(){
        const { minWidth, maxWidth, available } = getChatPanelBounds();
        const preferred = Math.round(available * 0.6);
        return Math.max(minWidth, Math.min(maxWidth, preferred));
      }

      function clampChatWidth(v){
        const { minWidth, maxWidth } = getChatPanelBounds();
        const n = Number(v || 0);
        if(!Number.isFinite(n) || n <= 0){
          return getDefaultChatWidth();
        }
        return Math.max(minWidth, Math.min(maxWidth, Math.round(n)));
      }

      function persistChatWidth(){
        if(!state.chatWidth) return;
        try{ localStorage.setItem(CHAT_WIDTH_KEY, String(state.chatWidth)); }catch(_){}
      }

      function setChatPanelTitle(p){
        if(!el.chatPanelTitle) return;
        const nome = String(p?.nome || p?.usuario || '').trim();
        const titulo = String(p?.titulo || '').trim();
        const text = [nome, titulo].filter(Boolean).join(' - ');
        el.chatPanelTitle.innerHTML = `<i class='bx bx-message-square-detail'></i><span>${esc(text || 'Chat do pedido')}</span>`;
      }

      function isAllowedChatIframeLocation(href){
        const src = String(href || '').toLowerCase();
        if(!src || src === 'about:blank') return true;
        return src.includes('/chat.html') || /chat\.html(\?|#|$)/i.test(src);
      }

      function ensureIframeLockedInChat(){
        if(!el.chatFrame || !state.activeChatUrl) return;
        let href = '';
        try{
          href = String(el.chatFrame.contentWindow?.location?.href || '');
        }catch(_){
          href = String(el.chatFrame.getAttribute('src') || '');
        }
        if(isAllowedChatIframeLocation(href)) return;
        el.chatFrame.setAttribute('src', state.activeChatUrl);
        showToast('Navegação bloqueada neste painel. Use Fechar para sair do chat.');
      }

      function setChatExpandButtonState(){
        if(!el.chatExpandBtn) return;
        const expanded = !!state.chatMaximized;
        el.chatExpandBtn.setAttribute('aria-pressed', expanded ? 'true' : 'false');
        el.chatExpandBtn.setAttribute('title', expanded ? 'Restaurar tamanho' : 'Expandir chat');
        el.chatExpandBtn.setAttribute('aria-label', expanded ? 'Restaurar tamanho do chat' : 'Expandir chat');
        el.chatExpandBtn.innerHTML = `<i class='bx ${expanded ? 'bx-collapse-alt' : 'bx-expand-alt'}'></i>`;
      }

      function updateChatWidthUi(){
        const hasDesktop = isDesktopChatMode();
        const { minWidth, maxWidth } = getChatPanelBounds();
        const width = clampChatWidth(state.chatWidth || localStorage.getItem(CHAT_WIDTH_KEY));
        if(el.chatNarrowBtn){
          el.chatNarrowBtn.disabled = !hasDesktop || state.chatMaximized || width <= minWidth;
        }
        if(el.chatWidenBtn){
          el.chatWidenBtn.disabled = !hasDesktop || state.chatMaximized || width >= maxWidth;
        }
        if(el.chatWidthLabel){
          if(!hasDesktop){
            el.chatWidthLabel.textContent = '--';
            el.chatWidthLabel.title = '';
          }else if(state.chatMaximized){
            el.chatWidthLabel.textContent = 'MAX';
            el.chatWidthLabel.title = 'Tela inteira';
          }else{
            const pct = Math.round((width / Math.max(1, window.innerWidth)) * 100);
            el.chatWidthLabel.textContent = `${pct}%`;
            el.chatWidthLabel.title = `${width}px`;
          }
        }
      }

      function applyChatPanelLayout(){
        if(!el.chatPanel) return;
        if(!isDesktopChatMode()){
          state.chatResizing = false;
          state.chatMaximized = false;
          el.chatPanel.classList.remove('maximized');
          el.chatPanel.style.width = '';
          document.body.classList.remove('chat-resizing');
          document.body.classList.remove('chat-split-full');
          setChatExpandButtonState();
          updateChatWidthUi();
          return;
        }

        // Em split view (desktop), permitimos expandir para ocupar tambem a area dos pedidos
        if(document.body.classList.contains('chat-split-open')){
          state.chatResizing = false;
          el.chatPanel.classList.remove('maximized');
          el.chatPanel.style.width = '';
          document.body.classList.remove('chat-resizing');
          document.body.classList.toggle('chat-split-full', !!state.chatMaximized);
          setChatExpandButtonState();
          updateChatWidthUi();
          return;
        }

        if(state.chatMaximized){
          el.chatPanel.classList.add('maximized');
          el.chatPanel.style.width = '';
        }else{
          el.chatPanel.classList.remove('maximized');
          state.chatWidth = clampChatWidth(state.chatWidth || localStorage.getItem(CHAT_WIDTH_KEY));
          el.chatPanel.style.width = `${state.chatWidth}px`;
        }
        setChatExpandButtonState();
        updateChatWidthUi();
      }

      function toggleChatMaximize(){
        if(!isDesktopChatMode()) return;
        state.chatMaximized = !state.chatMaximized;
        applyChatPanelLayout();
      }

      function startChatResize(ev){
        if(!isDesktopChatMode() || state.chatMaximized || !el.chatPanel) return;
        if(ev.button !== 0) return;
        ev.preventDefault();
        state.chatResizing = true;
        state.chatResizeStartX = ev.clientX;
        state.chatResizeStartWidth = el.chatPanel.getBoundingClientRect().width;
        document.body.classList.add('chat-resizing');
      }

      function handleChatResizeMove(ev){
        if(!state.chatResizing || !el.chatPanel) return;
        const delta = state.chatResizeStartX - ev.clientX;
        const width = clampChatWidth(state.chatResizeStartWidth + delta);
        state.chatWidth = width;
        el.chatPanel.style.width = `${width}px`;
        updateChatWidthUi();
      }

      function stopChatResize(){
        if(!state.chatResizing) return;
        state.chatResizing = false;
        document.body.classList.remove('chat-resizing');
        persistChatWidth();
      }

      function nudgeChatWidth(delta){
        if(!isDesktopChatMode() || state.chatMaximized) return;
        const base = clampChatWidth(state.chatWidth || localStorage.getItem(CHAT_WIDTH_KEY));
        state.chatWidth = clampChatWidth(base + Number(delta || 0));
        if(el.chatPanel) el.chatPanel.style.width = `${state.chatWidth}px`;
        updateChatWidthUi();
        persistChatWidth();
      }

      function resetChatWidth(){
        if(!isDesktopChatMode() || state.chatMaximized) return;
        state.chatWidth = getDefaultChatWidth();
        if(el.chatPanel) el.chatPanel.style.width = `${state.chatWidth}px`;
        updateChatWidthUi();
        persistChatWidth();
      }

      function looksLikeImage(url){
        const s = String(url || '').toLowerCase();
        return /\.(png|jpe?g|webp|gif|bmp|svg)(\?|$)/.test(s) || s.includes('/storage/v1/object/public/');
      }

      function normalizeMediaUrl(v){
        if(!v) return '';
        if(typeof v === 'string') return v.trim();
        if(typeof v === 'object'){
          return String(v.url || v.src || v.link || '').trim();
        }
        return '';
      }

      function normalizeId(v){
        const id = String(v == null ? '' : v).trim();
        if(!id) return '';
        if(/^PD-\d+$/i.test(id)) return '';
        if(/^TEMP-/i.test(id)) return '';
        if(/^NEW-/i.test(id)) return '';
        return id;
      }

      function normalizePedido(row, idx, forcedId){
        if(!row || typeof row !== 'object') return null;
        const id = normalizeId(forcedId || pick(row, ['id','codigo','pedidoId','idPedido','orderId','orcamentoId','chatId','threadId','postid','docId'], ''));
        if(!id) return null;

        const uidAtual = resolveUid();
        const deUid = pick(row, ['deUid','deuid','de_uid','clienteUid','clienteuid','cliente_uid'], '');
        const paraUid = pick(row, ['paraUid','parauid','para_uid','prestadorUid','prestadoruid','prestador_uid'], '');
        const isSouCliente = !!uidAtual && !!deUid && String(uidAtual) === String(deUid);
        const isSouProfissional = !!uidAtual && !!paraUid && String(uidAtual) === String(paraUid);

        const nome = isSouCliente
          ? pick(row, ['paraNome','nomePrestador','profissionalNome','nomeProfissional','prestadorNome','profissional_nome','prestador_nome','nome','nomeCliente','clienteNome','cliente','usuarioNome','userName','deNome'], 'Profissional')
          : isSouProfissional
            ? pick(row, ['deNome','nomeCliente','clienteNome','nome','cliente','usuarioNome','userName','paraNome'], 'Cliente')
            : pick(row, ['nome','nomeCliente','clienteNome','cliente','usuarioNome','userName','deNome','paraNome'], 'Cliente');

	        // IMPORTANT: não inventar @handle a partir do nome completo (vira "@nome.sobrenome..." gigantesco).
	        // Se não houver user explícito no pedido, deixamos vazio e o enrich (usuarios/usuarios_legacy) resolve.
	        const usuarioBase = isSouCliente
	          ? pick(row, ['paraUser','usuarioPrestador','usernamePrestador','profissionalUser','profissional_user','prestadorUser','prestador_user','usuario','username','user','handle'], '')
	          : isSouProfissional
	            ? pick(row, ['deUser','usuarioCliente','usernameCliente','usuario','username','user','handle'], '')
	            : pick(row, ['usuario','username','user','handle','deUser','paraUser'], '');
	        const usuario = usuarioBase
	          ? (String(usuarioBase).startsWith('@') ? String(usuarioBase) : `@${String(usuarioBase).trim()}`)
	          : '';
        const titulo = pick(row, ['titulo','servicoReferencia','nomeServico','servico','assunto','pedidoTitulo','orcamentoTitulo','title'], 'Pedido');
        const descricao = pick(row, ['descricao','descricaoBase','mensagem','mensagemInicial','detalhes','observacoes','preview','ultimaMensagem'], 'Sem detalhes adicionais.');
        const tipoRaw = pick(row, ['tipo','tipoPedido','categoriaTipo'], '');
        const tipo = tipoRaw || (String(titulo).toLowerCase().includes('orc') ? 'Orcamento' : 'Servico');
        const status = statusCode(pick(row, ['status','statusPedido','situacao','estado'], 'pendente'));

        const updatedRaw = pick(row, ['dataAtualizacao','updatedAt','updatedat','ultimaAtualizacao','timestamp','lastMessageAt','createdAt'], '');
        const createdRaw = pick(row, ['criadoEm','createdAt','createdat','dataCriacao','dataPedido'], updatedRaw || new Date().toISOString());
        const recusaObj = (row.recusa && typeof row.recusa === 'object') ? row.recusa : {};
        const meuPapel = isSouCliente ? 'cliente' : (isSouProfissional ? 'profissional' : pick(row, ['meuPapel','papelMeu','papel_usuario'], ''));
        const papelContato = isSouCliente ? 'profissional' : (isSouProfissional ? 'cliente' : pick(row, ['papelContato','papel_outro','papelDestino'], ''));
        const papelContatoLabel = papelContato === 'profissional' ? 'Profissional' : (papelContato === 'cliente' ? 'Cliente' : '');
        const meuPapelLabel = meuPapel === 'profissional' ? 'Voce: Profissional' : (meuPapel === 'cliente' ? 'Voce: Cliente' : '');

        return {
          id,
          usuario,
          nome,
          avatar: pick(row, isSouCliente
            ? ['paraFoto','fotoPrestador','fotoProfissional','profissionalFoto','profissional_foto','prestadorFoto','prestador_foto','fotoContato','contatoFoto','profilePicture','avatar','foto','fotoPerfil','deFoto','fotoCliente']
            : isSouProfissional
              ? ['deFoto','fotoCliente','fotoContato','contatoFoto','profilePicture','avatar','foto','fotoPerfil','paraFoto','profissionalFoto']
              : ['avatar','foto','fotoContato','contatoFoto','fotoCliente','fotoPerfil','profilePicture','deFoto','paraFoto','clienteFoto','profissionalFoto']
          , 'assets/Imagens/user_placeholder.png'),
          titulo,
          descricao,
          tipo,
          status,
          urgente: !!(row.urgente || String(row.prioridade || '').toLowerCase() === 'alta' || String(row.priority || '').toLowerCase() === 'high'),
          prazo: pick(row, ['prazo','paraQuando','dataEspecifica','deadline','turno'], 'A combinar'),
          atualizado: formatUpdated(updatedRaw || createdRaw),
          valor: pick(row, ['valor','preco','orcamento','faixa','precoFormatado','valorOrcamento','valor_orcamento'], 'Sob Orcamento'),
          naoLidas: Number(row.naoLidas || row.naolidas || row.unread || row.unreadCount || row.mensagensNaoLidas || row.qtdNaoLidas || 0) || 0,
          criadoEm: (toDate(createdRaw) || new Date()).toISOString(),
          categoria: pick(row, ['categoria','area','segmento','tipoServico'], 'Geral'),
          meuPapel,
          meuPapelLabel,
          papelContato,
          papelContatoLabel,
          deUid,
          paraUid,
          anuncioId: pick(row, ['anuncioId','anuncio_id','aid','anuncioid'], ''),
          servicoReferencia: pick(row, ['servicoReferencia','titulo','nomeServico','servico'], ''),
          mensagemInicial: pick(row, ['mensagemInicial','descricao','descricaoBase','detalhes'], ''),
          descricaoBase: pick(row, ['descricaoBase','descricao','mensagemInicial'], ''),
          paraQuando: pick(row, ['paraQuando','prazo','dataEspecifica'], ''),
          dataEspecifica: pick(row, ['dataEspecifica'], ''),
          turno: pick(row, ['turno'], ''),
          respostasTriagem: Array.isArray(row.respostasTriagem) ? row.respostasTriagem : [],
          localizacao: row.localizacao || row.localização || row['localizacao'] || row['localização'] || null,
          modoAtend: pick(row, ['modoAtend','modo_atend'], ''),
          statusOriginal: pick(row, ['status','statusPedido','situacao','estado'], ''),
          motivoRecusa: pick(row, ['motivoRecusa','justificativaRecusa','recusaMotivo','motivoRejeicao','motivo_recusa','motivoCancelamento','motivo_cancelamento'], pick(recusaObj, ['motivo','justificativa','descricao'], '')),
          anexos: Array.isArray(row.anexos) ? row.anexos : []
        };
      }

      function mergePedidos(list){
        const statusRank = (val) => {
          const s = String(val || '').toLowerCase();
          if(!s) return -1;
          if(s.includes('finaliz') || s.includes('conc')) return 4;
          if(s.includes('recus') || s.includes('cancel') || s.includes('negad') || s.includes('reprov')) return 3;
          if(s.includes('and') || s.includes('aceit') || s.includes('pago')) return 2;
          if(s.includes('pend') || s.includes('aguard') || s.includes('novo') || s.includes('analise')) return 1;
          return 0;
        };
        const map = new Map();
        (list || []).forEach((p) => {
          if(!p || !p.id) return;
          const key = String(p.id);
          const cur = map.get(key);
          if(!cur){ map.set(key, {...p}); return; }
          const next = {...cur};
          Object.keys(p).forEach((k) => {
            const v = p[k];
            if(k === 'status' || k === 'statusOriginal'){
              const curRank = statusRank(next[k]);
              const newRank = statusRank(v);
              if(newRank > curRank && String(v || '').trim() !== '') next[k] = v;
              return;
            }
            if(k === 'motivoRecusa'){
              const curTxt = String(next[k] || '').trim();
              const newTxt = String(v || '').trim();
              if(newTxt && (!curTxt || newTxt.length > curTxt.length)) next[k] = newTxt;
              return;
            }
            if(k === 'naoLidas'){ next[k] = Math.max(Number(next[k] || 0), Number(v || 0)); return; }
            if(k === 'descricao' && String(v || '').length > String(next[k] || '').length){ next[k] = v; return; }
            if(Array.isArray(v) && v.length && (!Array.isArray(next[k]) || !next[k].length)){ next[k] = v; return; }
            if(v && typeof v === 'object' && !Array.isArray(v) && (!next[k] || typeof next[k] !== 'object' || Array.isArray(next[k]))){ next[k] = v; return; }
            if((next[k] == null || String(next[k]).trim() === '' || String(next[k]) === '—') && String(v ?? '').trim() !== '') next[k] = v;
          });
          map.set(key, next);
        });
        return Array.from(map.values());
      }

      function looksPedidoRow(row){
        if(!row || typeof row !== 'object') return false;
        const id = normalizeId(pick(row, ['id','codigo','pedidoId','idPedido','orderId','orcamentoId','chatId','threadId','postid','docId'], ''));
        if(!id) return false;
        const directSignals = [
          row.pedidoId, row.idPedido, row.orcamentoId, row.statusPedido, row.paraQuando,
          row.dataEspecifica, row.prazo, row.descricaoBase, row.respostasTriagem,
          row.formularioRespostas, row.modoAtend, row.localizacao, row.localização, row.servicoReferencia
        ];
        if(directSignals.some(Boolean)) return true;
        const keys = Object.keys(row).map((k) => String(k || '').toLowerCase());
        return keys.some((k) =>
          k.includes('pedido') ||
          k.includes('orcamento') ||
          k.includes('prazo') ||
          k.includes('triagem')
        );
      }

      function loadLocal(){
        const uid = resolveUid();
        if(!uid) return [];
        const hidden = getHiddenPedidosSet();
        let list = [];
        if(Array.isArray(window.pedidosCache)){
          list = list.concat(window.pedidosCache.map((r,i)=>normalizePedido(r,i)).filter((p) => p && !hidden.has(String(p.id))));
        }

        const primaryKeys = [
          'doke_pedidos','pedidos','DOKE_PEDIDOS','meus_pedidos','cachePedidos','doke_cache_pedidos',
          'orcamentos','doke_orcamentos','orcamentosCache','doke_orcamentos_cache','doke_cache_orcamentos','orcamentos_pedidos'
        ];

        primaryKeys.forEach((key) => {
          const arr = asArray(parseJSON(localStorage.getItem(key)));
          arr.forEach((row, idx) => {
            const n = normalizePedido(row, idx);
            if(n && !hidden.has(String(n.id))) list.push(n);
          });
        });

        const singleRows = [
          parseJSON(localStorage.getItem('doke_pedido_contexto')),
          parseJSON(localStorage.getItem('doke_pedido_detalhes')),
          parseJSON(localStorage.getItem('pedidoAtual')),
          parseJSON(localStorage.getItem('doke_chat_prefill')),
          parseJSON(localStorage.getItem('pedidoSelecionado'))
        ].filter(Boolean);
        singleRows.forEach((row, idx) => {
          const n = normalizePedido(row, idx);
          if(n && !hidden.has(String(n.id))) list.push(n);
        });

        return mergePedidos(list);
      }
      function resolveUid(){
        const perfil = parseJSON(localStorage.getItem('doke_usuario_perfil')) || {};
        return String(window.auth?.currentUser?.uid || window.firebaseAuth?.currentUser?.uid || localStorage.getItem('doke_uid') || perfil.uid || perfil.id || '').trim();
      }

	      function isPlaceholderAvatar(url){
	        const s = String(url || '').trim();
	        if(!s) return true;
	        if(/user_placeholder\.png$/i.test(s)) return true;
	        if(s.includes('assets/Imagens/user_placeholder.png')) return true;
	        return false;
	      }

	      	  async function fetchUsuarioPerfil(key, mode){
	        const raw = String(key || '').trim();
	        if(!raw) return null;
	        const kind = mode || (raw.startsWith('user:') ? 'user' : 'uid');
	        const cacheKey = (raw.startsWith('uid:') || raw.startsWith('user:')) ? raw : `${kind}:${raw}`;
	        if(state.userByUid.has(cacheKey)) return state.userByUid.get(cacheKey);

	        const sb = window.sb;
	        if(!sb || typeof sb.from !== 'function'){
	          state.userByUid.set(cacheKey, null);
	          return null;
	        }

	        	  const cols = 'id,uid,user,nome,foto,categoria,area,isProfissional,is_profissional';
	        	  try{
	        	    // Primeiro tenta view/tabela pública (evita RLS bloqueando SELECT em "usuarios")
	        	    async function tryTable(table){
	        	      let q = sb.from(table).select(cols).limit(1);

	        	      // Compat: usuarios_legacy costuma ter uid_text (e às vezes "usuario"/"username" no lugar de "user")
	        	      const uidField = table === 'usuarios_legacy' ? 'uid_text' : 'uid';
	        	      const userFieldCandidates = ['user','usuario','username'];

	        	      if(kind === 'user'){
	        	        const u = raw.replace(/^user:/,'').replace(/^@/,'').trim();
	        	        if(!u) return { data: null, error: null };
	        	        // tenta eq em qualquer coluna compatível
	        	        // supabase-js não suporta "or" com ilike em colunas diferentes de forma simples; fazemos OR eq.
	        	        q = q.or(userFieldCandidates.map((f)=> `${f}.eq.${u}`).join(','));
	        	      }else{
	        	        const u = raw.replace(/^uid:/,'').trim();
	        	        q = q.or(`${uidField}.eq.${u},id.eq.${u}`);
	        	      }

	        	      const res = (q.maybeSingle ? await q.maybeSingle() : await q);
	        	      return res;
	        	    }

	        	    let { data, error } = await tryTable('usuarios_legacy');
	        	    if((error || !data)){
	        	      // fallback para tabela principal
	        	      const r2 = await tryTable('usuarios');
	        	      data = r2?.data || null;
	        	      error = r2?.error || null;
	        	    }
	          if(error){
	            console.warn('[pedidos] usuarios fetch error:', error);
	            state.userByUid.set(cacheKey, null);
	            return null;
	          }

	          // normaliza foto para URL pública (bucket "perfil")
	          if(data && data.foto){
	            const f = String(data.foto).trim();
	            if(f && !/^https?:\/\//i.test(f) && !f.includes('/storage/v1/object/public/')){
	              try{
	                const pub = sb.storage?.from?.('perfil')?.getPublicUrl?.(f);
	                const url = pub?.data?.publicUrl;
	                if(url) data.foto = url;
	              }catch(_){}
	            }
	          }

	          state.userByUid.set(cacheKey, data || null);
	          return data || null;
	        }catch(err){
	          console.warn('[pedidos] usuarios fetch exception:', err);
	          state.userByUid.set(cacheKey, null);
	          return null;
	        }
	      }

	      function otherUidFromPedido(p){
	        if(!p) return '';
	        // Se eu sou cliente, o outro é o profissional (paraUid). Se sou profissional, o outro é o cliente (deUid).
	        if(String(p.meuPapel || '') === 'cliente') return String(p.paraUid || '').trim();
	        if(String(p.meuPapel || '') === 'profissional') return String(p.deUid || '').trim();
	        // fallback
	        const uid = resolveUid();
	        const a = String(p.deUid || '').trim();
	        const b = String(p.paraUid || '').trim();
	        if(uid && a && uid === a) return b;
	        if(uid && b && uid === b) return a;
	        return b || a;
	      }

	      function otherUserFromPedido(p){
	        const u = String((p && (p.usuario || p.user || p.username)) || '').trim();
	        return u.replace(/^@/,'').trim();
	      }



	      async function enrichPedidosComUsuarios(pedidos){
	        const arr = Array.isArray(pedidos) ? pedidos : [];
	        if(!arr.length) return arr;

	        const keysSet = new Set();
	        arr.forEach((p) => {
	          const ouid = otherUidFromPedido(p);
	          if(ouid) keysSet.add(`uid:${String(ouid).trim()}`);
	          else{
	            const u = otherUserFromPedido(p);
	            if(u) keysSet.add(`user:${u}`);
	          }
	        });

	        const keys = Array.from(keysSet).filter(Boolean);
	        if(!keys.length) return arr;

	        const CONC = 8;
	        let i = 0;
	        const results = new Map();
	        async function worker(){
	          while(i < keys.length){
	            const idx = i++;
	            const k = keys[idx];
	            const mode = k.startsWith('user:') ? 'user' : 'uid';
	            const data = await fetchUsuarioPerfil(k, mode);
	            results.set(k, data);
	          }
	        }
	        await Promise.all(Array.from({length: Math.min(CONC, keys.length)}, worker));

	        arr.forEach((p) => {
	          const ouid = otherUidFromPedido(p);
	          const uhandle = otherUserFromPedido(p);
	          const k = ouid ? `uid:${String(ouid).trim()}` : (uhandle ? `user:${uhandle}` : '');
	          const u = k ? results.get(k) : null;
	          if(!u) return;

	          const nome = String(u.nome || '').trim();
	          const user = String(u.user || u.usuario || u.username || '').trim();
	          const foto = normalizeMediaUrl(u.foto);
	          const cat = String(u.categoria || u.area || '').trim();

	          if(nome) p.nome = nome;
	          if(user){
	            const handle = user.startsWith('@') ? user : `@${user}`;
	            p.usuario = handle;
	          }
	          if(foto && (isPlaceholderAvatar(p.avatar) || !p.avatar)) p.avatar = foto;
	          if(cat && (!p.categoria || p.categoria === 'Geral')) p.categoria = cat;
	        });

	        return arr;
	      }

      function ensurePedidosAuth(){
        const uid = resolveUid();
        if(uid) return true;
        const next = encodeURIComponent((location.pathname || '').split('/').pop() || 'pedidos.html');
        try{ showToast('Faça login para acessar seus pedidos.'); }catch(_){}
        setTimeout(() => { location.href = `login.html?next=${next}`; }, 120);
        return false;
      }

      
      function hiddenPedidosKey(){
        const uid = resolveUid();
        // Usa chave por-usuario quando houver UID, mas também mantém uma chave global
        // para evitar que itens "voltem" caso o UID não esteja disponível em algum reload.
        return uid ? `doke_hidden_pedidos_${uid}` : `doke_hidden_pedidos`;
      }

      function hiddenPedidosGlobalKey(){
        return `doke_hidden_pedidos`;
      }

      function getHiddenPedidosSet(){
        const out = new Set();

        const readKey = (k) => {
          try{
            const arr = parseJSON(localStorage.getItem(k));
            if(Array.isArray(arr)){
              arr.forEach((v) => {
                const s = String(v || '').trim();
                if(s) out.add(s);
              });
            }
          }catch(_){ }
        };

        // Sempre lê a global
        readKey(hiddenPedidosGlobalKey());

        // E a do usuário (se existir)
        const uid = resolveUid();
        if(uid) readKey(`doke_hidden_pedidos_${uid}`);

        return out;
      }

      function persistHiddenPedidosSet(set){
        const arr = JSON.stringify(Array.from(set));
        try{ localStorage.setItem(hiddenPedidosKey(), arr); }catch(_){}
        try{ localStorage.setItem(hiddenPedidosGlobalKey(), arr); }catch(_){}
      }

      function addHiddenPedidos(ids){
        const set = getHiddenPedidosSet();
        (ids || []).forEach((id) => {
          const key = String(id || '').trim();
          if(key) set.add(key);
        });
        persistHiddenPedidosSet(set);
      }

      // Remove pedidos de caches locais para garantir que nao retornem apos reload.
      // Isso complementa o "hidden set" (que filtra na leitura), lidando com casos
      // em que o ID possa variar entre fontes (localStorage / Firestore).
      function purgePedidosFromLocalCaches(ids){
        const idset = new Set((ids || []).map((v) => String(v || '').trim()).filter(Boolean));
        if(!idset.size) return;

        // window.pedidosCache (se existir)
        try{
          if(Array.isArray(window.pedidosCache)){
            window.pedidosCache = window.pedidosCache.filter((row) => {
              const rid = normalizeId(pick(row, ['id','codigo','pedidoId','idPedido','orderId','orcamentoId','chatId','threadId','postid','docId'], ''));
              return !idset.has(String(rid));
            });
          }
        }catch(_){ }

        // localStorage arrays mais comuns
        const keys = [
          'doke_pedidos','pedidos','DOKE_PEDIDOS','meus_pedidos','cachePedidos','doke_cache_pedidos',
          'orcamentos','doke_orcamentos','orcamentosCache','doke_orcamentos_cache','doke_cache_orcamentos','orcamentos_pedidos'
        ];
        keys.forEach((key) => {
          try{
            const arr = asArray(parseJSON(localStorage.getItem(key)));
            if(!arr.length) return;
            const next = arr.filter((row) => {
              const rid = normalizeId(pick(row, ['id','codigo','pedidoId','idPedido','orderId','orcamentoId','chatId','threadId','postid','docId'], ''));
              return !idset.has(String(rid));
            });
            if(next.length !== arr.length) localStorage.setItem(key, JSON.stringify(next));
          }catch(_){ }
        });
      }

      function patchPedidoRowLike(row, id, status, motivoRecusa){
        if(!row || typeof row !== 'object') return row;
        const rid = normalizeId(pick(row, ['id','codigo','pedidoId','idPedido','orderId','orcamentoId','chatId','threadId','postid','docId'], ''));
        if(String(rid) !== String(id)) return row;
        const out = { ...row };
        const nowIso = new Date().toISOString();
        out.status = status;
        out.statusPedido = status;
        out.situacao = status;
        out.estado = status;
        out.dataAtualizacao = nowIso;
        out.updatedAt = nowIso;
        if(status === 'aceito') out.dataAceite = nowIso;
        if(status === 'recusado'){
          const motivo = String(motivoRecusa || '').trim();
          out.dataRecusa = nowIso;
          out.motivoRecusa = motivo;
          out.justificativaRecusa = motivo;
          out.recusaMotivo = motivo;
          out.motivoRejeicao = motivo;
          out.motivo = motivo;
          out.recusa = { motivo, data: nowIso };
        }
        return out;
      }

      function patchLocalPedidoCaches(id, status, motivoRecusa){
        const arrKeys = [
          'doke_pedidos','pedidos','DOKE_PEDIDOS','meus_pedidos','cachePedidos','doke_cache_pedidos',
          'orcamentos','doke_orcamentos','orcamentosCache','doke_orcamentos_cache','doke_cache_orcamentos','orcamentos_pedidos'
        ];
        arrKeys.forEach((key) => {
          const raw = parseJSON(localStorage.getItem(key));
          const arr = asArray(raw);
          if(!arr.length) return;
          const next = arr.map((row) => patchPedidoRowLike(row, id, status, motivoRecusa));
          try{ localStorage.setItem(key, JSON.stringify(next)); }catch(_){}
        });

        const singleKeys = ['doke_pedido_contexto','doke_pedido_detalhes','pedidoAtual','pedidoSelecionado'];
        singleKeys.forEach((key) => {
          const row = parseJSON(localStorage.getItem(key));
          if(!row || typeof row !== 'object') return;
          const next = patchPedidoRowLike(row, id, status, motivoRecusa);
          try{ localStorage.setItem(key, JSON.stringify(next)); }catch(_){}
        });
      }

      function mine(row, uid){
        if(!uid) return false;
        const fields = [
          row.deUid,row.deuid,row.de_uid,row.clienteUid,row.clienteuid,row.cliente_uid,row.uidCliente,row.uid_cliente,row.solicitanteUid,row.solicitante_uid,
          row.paraUid,row.parauid,row.para_uid,row.prestadorUid,row.prestadoruid,row.prestador_uid,row.profissionalUid,row.profissionaluid,row.profissional_uid,row.uidPrestador,row.uid_prestador,
          row.participante1,row.participante2,row.uid1,row.uid2,row.clienteId,row.profissionalId
        ].map(v => String(v || '').trim()).filter(Boolean);
        if(Array.isArray(row.participantes)) fields.push(...row.participantes.map(v => String(v || '').trim()).filter(Boolean));
        return fields.includes(String(uid));
      }

      async function loadFirestore(){
        const { getFirestore, collection, query, limit, getDocs } = window || {};
        if(typeof getFirestore !== 'function' || typeof collection !== 'function' || typeof query !== 'function' || typeof limit !== 'function' || typeof getDocs !== 'function') return [];
        const uid = resolveUid();
        const hidden = getHiddenPedidosSet();
        const db = window.db || getFirestore();

        try{
          const snap = await getDocs(query(collection(db, 'pedidos'), limit(300)));
          const out = [];
          let idx = 0;
          snap.forEach((d) => {
            const row = d.data() || {};
            if(!mine(row, uid)) return;
            const n = normalizePedido(row, idx++, d.id);
            if(n && !hidden.has(String(n.id))) out.push(n);
          });
	          const merged = mergePedidos(out);
	          // Enriquecer com usuario/foto a partir da tabela usuarios (Supabase)
	          try{ await enrichPedidosComUsuarios(merged); }catch(_e){}
	          return mergePedidos(merged);
        }catch(err){
          console.warn('Firestore pedidos erro:', err);
          return [];
        }
      }

      function sortList(list){
        const arr = [...list];
        if(state.sort === 'updated') return arr.sort((a,b)=>String(a.atualizado).localeCompare(String(b.atualizado), 'pt-BR'));
        if(state.sort === 'unread') return arr.sort((a,b)=>Number(b.naoLidas||0)-Number(a.naoLidas||0) || (new Date(b.criadoEm)-new Date(a.criadoEm)));
        if(state.sort === 'urgent') return arr.sort((a,b)=>Number(b.urgente)-Number(a.urgente) || (new Date(b.criadoEm)-new Date(a.criadoEm)));
        return arr.sort((a,b)=>new Date(b.criadoEm)-new Date(a.criadoEm));
      }

      function filtered(){
        let arr = [...state.pedidos];
        if(state.filter === 'pending') arr = arr.filter(p=>p.status === 'pendente');
        if(state.filter === 'progress') arr = arr.filter(p=>p.status === 'andamento');
        if(state.filter === 'done') arr = arr.filter(p=>p.status === 'finalizado' || p.status === 'recusado' || p.status === 'cancelado');
        if(state.filter === 'urgent') arr = arr.filter(p=>p.urgente);

        const q = state.query.trim().toLowerCase();
        if(q){
          arr = arr.filter(p => [p.id,p.nome,p.usuario,p.titulo,p.descricao,p.categoria,p.tipo,p.prazo,p.valor].filter(Boolean).join(' ').toLowerCase().includes(q));
        }

        return sortList(arr);
      }

      function card(p){
        const selected = state.selected.has(String(p.id));
        const pendente = isPendenteStatus(p.status);
        const isProfViewer = String(p.meuPapel || '') === 'profissional';
        const isClientViewer = String(p.meuPapel || '') === 'cliente';
        const canDecide = pendente && isProfViewer;
        const canCancel = pendente && isClientViewer;
        const chatLiberado = canOpenChat(p);
        const motivoRecusa = String(p.motivoRecusa || '').trim();
        const isRecusado = String(p.status || '').toLowerCase() === 'recusado';
        const rawNeed = String(p.mensagemInicial || p.descricaoBase || p.servicoReferencia || '').trim();
        const rawDesc = String(p.descricao || '').trim();
        const rawTitle = String(p.titulo || '').trim();
        const needPreview = (rawNeed && rawNeed !== rawDesc && rawNeed !== rawTitle && rawNeed.toLowerCase() !== 'sem detalhes adicionais.') ? rawNeed : '';
        return `
          <article class="card ${selected ? 'selected' : ''}" data-id="${esc(p.id)}" data-status="${esc(String(p.status||''))}">
            <div class="card-top">
              <div class="tags">
                <span class="tag type"><i class='bx bx-receipt'></i>${esc(p.tipo)}</span>
                <span class="tag ${statusClass(p.status)}">${esc(statusLabel(p.status))}</span>
                ${p.papelContato === 'cliente' ? `<span class="tag role-client"><i class='bx bx-user'></i>Cliente</span>` : ``}
                ${p.papelContato === 'profissional' ? `<span class="tag role-pro"><i class='bx bx-briefcase'></i>Profissional</span>` : ``}
                ${p.meuPapelLabel ? `<span class="tag role-me">${esc(p.meuPapelLabel)}</span>` : ``}
                ${p.urgente ? `<span class="tag urgent"><i class='bx bx-error'></i>Urgente</span>` : ''}
              </div>
              <button class="card-select" type="button" data-action="select" data-id="${esc(p.id)}" aria-label="Selecionar pedido">
                <i class='bx bx-check'></i>
              </button>
            </div>

            ${canDecide ? `
              <div class="card-decision-top">
                <button class="btn-order accept" type="button" data-action="accept" data-id="${esc(p.id)}"><i class='bx bx-check'></i>Aceitar</button>
                <button class="btn-order reject" type="button" data-action="reject" data-id="${esc(p.id)}"><i class='bx bx-x'></i>Recusar</button>
              </div>
            ` : ``}
            ${canCancel ? `
              <div class="card-decision-top">
                <button class="btn-order reject" type="button" data-action="cancel" data-id="${esc(p.id)}"><i class='bx bx-x-circle'></i>Cancelar pedido</button>
              </div>
            ` : ``}

            <div class="user" data-profile="1" data-profile-uid="${esc(otherUidFromPedido(p))}" data-profile-user="${esc(otherUserFromPedido(p))}">
              <img src="${esc(normalizeMediaUrl(p.avatar) || 'assets/Imagens/user_placeholder.png')}" alt="Avatar" onerror="this.onerror=null;this.src='assets/Imagens/user_placeholder.png'"/>
              <div class="user-meta">
                <strong>${esc(displayHandle(p))}</strong>
                <span>${esc(p.categoria || 'Geral')}</span>
              </div>
            </div>

            <h3 class="title">${esc(p.titulo)}</h3>
            ${needPreview ? `<p class="need-preview"><i class='bx bx-bulb'></i><span>${esc(needPreview)}</span></p>` : ``}
            ${p.descricao ? `<p class="desc">${esc(p.descricao)}</p>` : ``}
            ${isRecusado && motivoRecusa ? `<p class="recusa-note"><i class='bx bx-error-circle'></i><span>${esc(motivoRecusa)}</span></p>` : ``}

            <div class="meta">
              <div class="meta-item"><i class='bx bx-time-five'></i><div><small>Prazo</small><strong>${esc(p.prazo || 'A combinar')}</strong></div></div>
              <div class="meta-item"><i class='bx bx-refresh'></i><div><small>Atualizado</small><strong>${esc(p.atualizado || 'recentemente')}</strong></div></div>
              <div class="meta-item"><i class='bx bx-wallet'></i><div><small>Valor</small><strong>${esc(String(p.valor ?? 'Sob Orcamento'))}</strong></div></div>
              <div class="meta-item"><i class='bx bx-message-dots'></i><div><small>Chat</small><strong>${p.naoLidas ? `${p.naoLidas} nao lida${p.naoLidas > 1 ? 's' : ''}` : 'Sem novas'}</strong></div></div>
            </div>

            <div class="footer">
              <span class="unread"><i class='bx bx-message-rounded-dots'></i>${pendente ? 'Novo pedido' : (p.naoLidas ? `${p.naoLidas} novas` : 'Sem novas')}</span>
              <div class="actions">
                ${chatLiberado ? `<button class="btn-order primary" type="button" data-action="chat" data-id="${esc(p.id)}"><i class='bx bx-message-square-detail'></i><span class="btn-text">Abrir chat</span></button>` : ``}
                <button class="btn-order secondary" type="button" data-action="details" data-id="${esc(p.id)}"><i class='bx bx-file'></i><span class="btn-text">Detalhes</span></button>
              </div>
            </div>
          </article>
        `;
      }

      function counters(list){
        return {
          all: list.length,
          pending: list.filter(p => isPendenteStatus(p.status)).length,
          today: list.filter(p => String(p.atualizado).includes('agora') || String(p.atualizado).includes('ha')).length,
          progress: list.filter(p => p.status === 'andamento').length,
          urgent: list.filter(p => p.urgente).length
        };
      }

      function render(){
        const list = filtered();
        const c = counters(state.pedidos);
        const existing = new Set((state.pedidos || []).map((p) => String(p.id)));
        Array.from(state.selected).forEach((id) => { if(!existing.has(String(id))) state.selected.delete(String(id)); });
        document.body.classList.toggle('select-mode', !!state.selectMode);
        if(el.bulkBar) el.bulkBar.classList.toggle('show', !!state.selectMode);
        el.count.textContent = String(c.pending);
        el.statToday.textContent = String(c.today);
        el.statProgress.textContent = String(c.progress);
        el.statUrgent.textContent = String(c.urgent);
        el.subtitle.textContent = list.length ? `Mostrando ${list.length} pedido${list.length > 1 ? 's' : ''}` : 'Nenhum pedido encontrado';
        el.grid.innerHTML = list.map(card).join('');
        el.empty.classList.toggle('show', list.length === 0);
        el.grid.style.display = list.length ? 'grid' : 'none';
        el.chips.forEach(ch => ch.classList.toggle('active', ch.dataset.filter === state.filter));
        if(el.selectBtn) el.selectBtn.classList.toggle('active', !!state.selectMode);
        updateBulkInfo();
        if(el.selectLabel){
          const total = state.selected.size;
          el.selectLabel.textContent = state.selectMode ? (total ? `${total} selecionado${total > 1 ? 's' : ''}` : 'Cancelar') : 'Selecionar';
        }
      }

      function sortLabel(){
        if(state.sort === 'updated') return 'Atualizacao';
        if(state.sort === 'unread') return 'Nao lidas';
        if(state.sort === 'urgent') return 'Urgentes';
        return 'Mais recentes';
      }

      function nextSort(){
        if(state.sort === 'recent') state.sort = 'unread';
        else if(state.sort === 'unread') state.sort = 'urgent';
        else if(state.sort === 'urgent') state.sort = 'updated';
        else state.sort = 'recent';
        el.sortLabel.textContent = sortLabel();
      }

      function byId(id){
        return state.pedidos.find(p => String(p.id) === String(id)) || null;
      }

      function detailsValue(v, fallback){
        const s = String(v == null ? '' : v).trim();
        return s || (fallback || '-');
      }

      async function fetchPedidoCompleto(p){
        if(!p || !p.id) return null;
        const pid = String(p.id);
        const cached = state.detailsById.get(pid);
        if(cached) return mergePedidos([p, cached])[0] || p;

        const { getFirestore, getDoc, doc } = window || {};
        if(typeof getFirestore !== 'function' || typeof getDoc !== 'function' || typeof doc !== 'function'){
          return p;
        }

        try{
          const db = window.db || getFirestore();
          const snap = await getDoc(doc(db, 'pedidos', pid));
          if(!snap.exists()) return p;
          const row = snap.data() || {};
          const normalized = normalizePedido(row, 0, pid);
          if(!normalized) return p;
          const merged = mergePedidos([p, normalized, {
            id: pid,
            respostasTriagem: Array.isArray(row.respostasTriagem) ? row.respostasTriagem : [],
            localizacao: row.localizacao || row.localização || row['localizacao'] || row['localização'] || null,
            mensagemInicial: pick(row, ['mensagemInicial','descricaoBase','descricao'], normalized.mensagemInicial || ''),
            descricaoBase: pick(row, ['descricaoBase','mensagemInicial','descricao'], normalized.descricaoBase || ''),
            paraQuando: pick(row, ['paraQuando','prazo','dataEspecifica'], normalized.paraQuando || ''),
            turno: pick(row, ['turno'], normalized.turno || ''),
            modoAtend: pick(row, ['modoAtend','modo_atend'], normalized.modoAtend || ''),
            servicoReferencia: pick(row, ['servicoReferencia','titulo','nomeServico','servico'], normalized.servicoReferencia || '')
          }])[0];

          if(merged){
            state.detailsById.set(pid, merged);
            state.pedidos = mergePedidos([...(state.pedidos || []), merged]);
            render();
            return merged;
          }
          return p;
        }catch(err){
          console.warn('Falha ao carregar detalhes do pedido:', err);
          return p;
        }
      }

            function collectAnexos(p){
        const out = [];
        const pushUrl = (url, name) => {
          const u = normalizeMediaUrl(url);
          if(!u) return;
          if(out.some((item) => item.url === u)) return;
          out.push({ url: u, name: name || '' });
        };

        if(Array.isArray(p.anexos)){
          p.anexos.forEach((a, idx) => {
            if(typeof a === 'string') pushUrl(a, `Anexo ${idx + 1}`);
            else if(a && typeof a === 'object') pushUrl(a.url || a.src || a.link, a.nome || a.name || `Anexo ${idx + 1}`);
          });
        }

        const triagem = Array.isArray(p.respostasTriagem) ? p.respostasTriagem : [];
        triagem.forEach((row) => {
          const raw = typeof row === 'object' ? String(row.resposta || '') : String(row || '');
          const namedMatch = raw.match(/^\s*([^\n]+?)\s*-\s*https?:\/\//i);
          const maybeName = namedMatch ? namedMatch[1].trim() : '';
          const matches = raw.match(/https?:\/\/[^\s)]+/g) || [];
          matches.forEach((url) => {
            const clean = url.replace(/[.,;!?]+$/, '');
            const name = maybeName || clean.split('/').pop() || 'Anexo';
            pushUrl(clean, name);
          });
        });

        return out;
      }

      function renderDetailsModal(p){
        if(!p) return;
        const locObj = p.localizacao || {};
        const locText = [
          locObj.endereco || locObj['endereço'] || '',
          locObj.numero || locObj['número'] || '',
          locObj.complemento || '',
          locObj.referencia || ''
        ].map((v)=>String(v || '').trim()).filter(Boolean).join(', ');

        const rows = [
          ['ID', detailsValue(p.id)],
          ['Cliente', detailsValue(p.nome || p.usuario, 'Cliente')],
          ['Status', detailsValue(statusLabel(p.status))],
          ['Tipo', detailsValue(p.tipo)],
          ['Prazo', detailsValue(p.paraQuando || p.prazo, 'A combinar')],
          ['Turno', detailsValue(p.turno, 'Nao informado')],
          ['Modo', detailsValue(p.modoAtend, 'Nao informado')],
          ['Valor', detailsValue(p.valor, 'Sob orcamento')]
        ];
        const motivoRecusa = detailsValue(p.motivoRecusa, '');
        if(String(p.status || '').toLowerCase() === 'recusado' && motivoRecusa){
          rows.push(['Motivo da recusa', motivoRecusa]);
        }

        el.detailsSubtitle.textContent = `${detailsValue(p.usuario || p.nome, '@cliente')} • ${detailsValue(p.categoria, 'Geral')}`;
        el.detailsGrid.innerHTML = rows.map(([k,v]) => `<div class="details-item"><small>${esc(k)}</small><strong>${esc(v)}</strong></div>`).join('');
        el.detailsDescription.textContent = detailsValue(p.mensagemInicial || p.descricaoBase || p.descricao, 'Sem descricao.');

        const triagem = Array.isArray(p.respostasTriagem) ? p.respostasTriagem : [];
        const triagemRows = [];
        if(locText){
          triagemRows.push({ pergunta:'Local', resposta: locText });
        }
        triagem.forEach((item, idx) => {
          if(item && typeof item === 'object'){
            triagemRows.push({
              pergunta: detailsValue(item.pergunta, `Pergunta ${idx + 1}`),
              resposta: detailsValue(item.resposta, '')
            });
          }else if(item != null){
            triagemRows.push({ pergunta:`Triagem ${idx + 1}`, resposta: detailsValue(item, '') });
          }
        });
        if(!triagemRows.length){
          triagemRows.push({ pergunta:'Triagem', resposta:'Sem respostas de triagem neste pedido.' });
        }
        el.detailsTriagem.innerHTML = triagemRows.map((r) => `
          <div class="triagem-row">
            <small>${esc(r.pergunta)}</small>
            <strong>${esc(r.resposta)}</strong>
          </div>
        `).join('');

        const anexos = collectAnexos(p);
        if(!anexos.length){
          el.detailsAnexos.innerHTML = `<div class="triagem-row"><small>Anexos</small><strong>Sem anexos neste pedido.</strong></div>`;
        }else{
          el.detailsAnexos.innerHTML = anexos.map((a, idx) => {
            const isImg = looksLikeImage(a.url);
            return `
              <div class="anexo-item">
                <a href="${esc(a.url)}" target="_blank" rel="noopener">
                  ${isImg ? `<img src="${esc(a.url)}" alt="Anexo ${idx + 1}" onerror="this.style.display='none'"/>` : ''}
                  <span class="anexo-caption">${esc(a.name || `Anexo ${idx + 1}`)}</span>
                </a>
              </div>
            `;
          }).join('');
        }

        el.detailsModal.classList.add('open');
        el.detailsModal.setAttribute('aria-hidden', 'false');
      }

      function closeDetailsModal(){
        el.detailsModal.classList.remove('open');
        el.detailsModal.setAttribute('aria-hidden', 'true');
      }

      function lockScrollIfNeeded(){
        const isMobile = window.matchMedia('(max-width: 900px)').matches;
        const isOpen = !!(el.chatDrawer && el.chatDrawer.classList.contains('open'));
        if(isMobile && isOpen){
          document.documentElement.classList.add('no-scroll');
          document.body.classList.add('no-scroll');
        }else{
          // Nao recursar aqui (isso gerava "Maximum call stack size exceeded").
          // Quando nao estiver no mobile ou o chat estiver fechado, liberamos o scroll.
          document.documentElement.classList.remove('no-scroll');
          document.body.classList.remove('no-scroll');
        }
      }

      window.addEventListener('resize', lockScrollIfNeeded);

      function openInlineChat(p){
        if(!p || !p.id){ showToast('Pedido invalido para abrir chat.'); return; }
        if(!canOpenChat(p)){ showToast('O chat sera liberado quando o pedido for aceito.'); return; }
        setChatPanelTitle(p);
        try{
          localStorage.setItem('doke_pedido_contexto', JSON.stringify(p));
          localStorage.setItem('pedidoAtual', JSON.stringify(p));
          localStorage.setItem('doke_chat_prefill', JSON.stringify({ pedidoId: p.id, titulo: p.titulo, usuario: p.usuario, nome: p.nome, origem: 'pedidos.html' }));
        }catch(_){ }

        const meUid = resolveUid();
        const outroUid = String(
          (meUid && p.deUid && p.paraUid)
            ? (String(p.deUid) === String(meUid) ? p.paraUid : p.deUid)
            : (p.paraUid || p.deUid || '')
        ).trim();
        const peerName = String(p.nome || p.usuario || '').trim();
        const peerPhoto = normalizeMediaUrl(p.avatar);
        const statusHint = String(p.statusOriginal || p.status || '').trim();
        const pid = encodeURIComponent(String(p.id));
        const q = [
          'embed=1',
          `chatId=${pid}`,
          `pedidoId=${pid}`,
          'from=pedidos',
          'aba=pedidos',
          'origin=pedido'
        ];
        if(outroUid) q.push(`outroUid=${encodeURIComponent(outroUid)}`);
        if(peerName) q.push(`peerName=${encodeURIComponent(peerName)}`);
        if(peerPhoto) q.push(`peerPhoto=${encodeURIComponent(peerPhoto)}`);
        if(statusHint) q.push(`status=${encodeURIComponent(statusHint)}`);
        const chatUrl = `chat.html?${q.join('&')}`;
        state.activeChatUrl = chatUrl;

        const isDesktop = window.matchMedia('(min-width: 1024px)').matches;

        // No desktop, abrimos em split view (lista à esquerda, chat à direita)
        if(isDesktop && el.chatSide && el.chatPanel){
          document.body.classList.add('chat-open');
          document.body.classList.add('chat-split-open');
          document.body.classList.remove('chat-split-full');
          el.chatSide.setAttribute('aria-hidden', 'false');
          // garante que o painel esteja dockado no aside (sem overlay/backdrop)
          if(!el.chatSide.contains(el.chatPanel)) el.chatSide.appendChild(el.chatPanel);
          if(el.chatDrawer){
            el.chatDrawer.classList.remove('open');
            el.chatDrawer.setAttribute('aria-hidden', 'true');
          }
          document.documentElement.classList.remove('no-scroll');
          document.body.classList.remove('no-scroll');
        }

        if(el.chatFrame && el.chatFrame.getAttribute('src') !== chatUrl){
          el.chatFrame.setAttribute('src', chatUrl);
        }
        if(!isDesktop && el.chatDrawer){
          document.body.classList.add('chat-open');
          el.chatDrawer.classList.add('open');
          el.chatDrawer.setAttribute('aria-hidden', 'false');
        }
        state.chatMaximized = false;
        state.chatWidth = clampChatWidth(state.chatWidth || localStorage.getItem(CHAT_WIDTH_KEY));
        applyChatPanelLayout();
        if(!isDesktop) lockScrollIfNeeded();
      }

      function closeInlineChat(){
        stopChatResize();
        const isDesktop = window.matchMedia('(min-width: 1024px)').matches;
        // Fecha split view no desktop
        if(isDesktop){
          document.body.classList.remove('chat-split-open');
          document.body.classList.remove('chat-split-full');
          document.body.classList.remove('chat-open');
          if(el.chatSide) el.chatSide.setAttribute('aria-hidden', 'true');
          // devolve o painel para o drawer (para funcionar no mobile)
          if(el.chatDrawer && el.chatPanel && !el.chatDrawer.contains(el.chatPanel)){
            el.chatDrawer.appendChild(el.chatPanel);
          }
        }

        if(el.chatDrawer){
          el.chatDrawer.classList.remove('open');
          el.chatDrawer.setAttribute('aria-hidden', 'true');
        }
        document.body.classList.remove('chat-open');
        document.documentElement.classList.remove('no-scroll');
        document.body.classList.remove('no-scroll');
        try{ el.chatFrame?.contentWindow?.postMessage?.({type:'doke-chat-pause'}, '*'); }catch(_){ }
      }

      function openChat(p){
        openInlineChat(p);
      }

      function askRecusaMotivo(){
        return new Promise((resolve) => {
          const modal = el.rejectPromptModal;
          const input = el.rejectPromptInput;
          const err = el.rejectPromptError;
          const btnCancel = el.rejectPromptCancelBtn;
          const btnConfirm = el.rejectPromptConfirmBtn;
          if(!modal || !input || !err || !btnCancel || !btnConfirm){
            const fallback = window.prompt('Informe a justificativa da recusa (minimo de 5 caracteres):', '');
            const motivoFallback = fallback == null ? null : String(fallback || '').trim();
            resolve(motivoFallback && motivoFallback.length >= 5 ? motivoFallback : null);
            return;
          }

          const cleanup = () => {
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
            modal.removeEventListener('click', onBackdrop);
            btnCancel.removeEventListener('click', onCancel);
            btnConfirm.removeEventListener('click', onConfirm);
            input.removeEventListener('keydown', onKeydown);
            document.removeEventListener('keydown', onEscape);
          };
          const done = (value) => {
            cleanup();
            resolve(value);
          };
          const onBackdrop = (ev) => { if(ev.target === modal) done(null); };
          const onCancel = () => done(null);
          const onConfirm = () => {
            const motivo = String(input.value || '').trim();
            if(motivo.length < 5){
              err.textContent = 'Digite ao menos 5 caracteres.';
              input.focus();
              return;
            }
            done(motivo);
          };
          const onKeydown = (ev) => {
            if(ev.key === 'Enter' && (ev.ctrlKey || ev.metaKey)){
              ev.preventDefault();
              onConfirm();
            }
          };
          const onEscape = (ev) => {
            if(ev.key === 'Escape' && modal.classList.contains('open')){
              ev.preventDefault();
              done(null);
            }
          };

          input.value = '';
          err.textContent = '';
          modal.classList.add('open');
          modal.setAttribute('aria-hidden', 'false');
          modal.addEventListener('click', onBackdrop);
          btnCancel.addEventListener('click', onCancel);
          btnConfirm.addEventListener('click', onConfirm);
          input.addEventListener('keydown', onKeydown);
          document.addEventListener('keydown', onEscape);
          setTimeout(() => input.focus(), 20);
        });
      }

      async function persistPedidoStatus(p, nextStatus, motivoRecusa){
        const { getFirestore, doc, updateDoc } = window || {};
        if(typeof getFirestore !== 'function' || typeof doc !== 'function' || typeof updateDoc !== 'function') return false;
        const db = window.db || getFirestore();
        const nowIso = new Date().toISOString();
        const payload = {
          status: nextStatus,
          statusPedido: nextStatus,
          situacao: nextStatus,
          estado: nextStatus,
          dataAtualizacao: nowIso,
          updatedAt: nowIso
        };
        if(nextStatus === 'aceito') payload.dataAceite = nowIso;
        if(nextStatus === 'cancelado') payload.dataCancelamento = nowIso;
        if(nextStatus === 'recusado'){
          payload.dataRecusa = nowIso;
          const motivo = String(motivoRecusa || '').trim();
          if(motivo){
            payload.motivoRecusa = motivo;
            payload.justificativaRecusa = motivo;
            payload.recusaMotivo = motivo;
            payload.motivoRejeicao = motivo;
            payload.motivo = motivo;
            payload.recusa = { motivo, data: nowIso };
          }
        }
        await updateDoc(doc(db, 'pedidos', String(p.id)), payload);
        return true;
      }

      async function decidePedido(p, nextStatus){
        if(!ensurePedidosAuth()) return;
        if(!p || !p.id){
          showToast('Pedido invalido.');
          return;
        }
        const meuPapel = String(p?.meuPapel || '').toLowerCase();
        if((nextStatus === 'aceito' || nextStatus === 'recusado') && meuPapel !== 'profissional'){
          showToast('Somente o profissional pode aceitar ou recusar este pedido.');
          return;
        }
        if(nextStatus === 'cancelado'){
          if(meuPapel !== 'cliente'){
            showToast('Somente o cliente pode cancelar este pedido.');
            return;
          }
          if(!isPendenteStatus(p.status)){
            showToast('So e possivel cancelar enquanto o pedido estiver pendente.');
            return;
          }
          const ok = (typeof window.dokeConfirm === 'function')
            ? await window.dokeConfirm('Cancelar este pedido? O profissional ainda nao respondeu.', 'Cancelar pedido')
            : window.confirm('Cancelar este pedido?');
          if(!ok) return;
        }
        const pid = String(p.id);
        const normalized = statusCode(nextStatus);
        const motivoRecusa = nextStatus === 'recusado' ? await askRecusaMotivo() : '';
        if(nextStatus === 'recusado' && !motivoRecusa) return;
        let savedServer = true;
        try{
          await persistPedidoStatus(p, nextStatus, motivoRecusa);
        }catch(err){
          savedServer = false;
          console.warn('Falha ao atualizar status do pedido:', err);
        }
        patchLocalPedidoCaches(pid, nextStatus, motivoRecusa);
        state.pedidos = (state.pedidos || []).map((item) => {
          if(String(item.id) !== pid) return item;
          return {
            ...item,
            status: normalized,
            statusOriginal: nextStatus,
            motivoRecusa: nextStatus === 'recusado' ? motivoRecusa : '',
            atualizado: 'agora',
            urgente: nextStatus === 'recusado' ? false : item.urgente
          };
        });
        render();
        if(savedServer) showToast(nextStatus === 'aceito' ? 'Pedido aceito.' : (nextStatus === 'recusado' ? 'Pedido recusado.' : 'Pedido cancelado.'));
        else showToast('Atualizado localmente. Conecte-se para sincronizar no servidor.');
      }

      async function openDetails(p){
        if(!p || !p.id){ showToast('Pedido invalido para abrir detalhes.'); return; }
        try{
          localStorage.setItem('doke_pedido_detalhes', JSON.stringify(p));
          localStorage.setItem('pedidoAtual', JSON.stringify(p));
        }catch(_){ }
        const full = await fetchPedidoCompleto(p);
        renderDetailsModal(full || p);
      }

      function toggleSelectMode(force){
        const next = typeof force === 'boolean' ? force : !state.selectMode;
        state.selectMode = next;
        if(!next) state.selected.clear();
        render();
      }

      function toggleSelected(id){
        const key = String(id || '');
        if(!key) return;
        if(state.selected.has(key)) state.selected.delete(key);
        else state.selected.add(key);
        render();
      }

      function updateBulkInfo(){
        if(!el.bulkInfo) return;
        const selectedItems = (state.pedidos || []).filter((p) => state.selected.has(String(p.id)));
        const total = selectedItems.length;
        const clearable = selectedItems.filter(isStatusFinalizadoOuRecusado).length;
        el.bulkInfo.textContent = total
          ? `${total} selecionado(s) - ${clearable} apto(s) para limpar`
          : '0 pedidos selecionados';
        if(el.bulkFinalizeBtn){
          el.bulkFinalizeBtn.disabled = (total === 0);
          el.bulkFinalizeBtn.title = 'A finalizacao so ocorre apos confirmacao do cliente no app dele.';
        }
        if(el.bulkArchiveBtn){
          el.bulkArchiveBtn.disabled = (total === 0);
        }
        if(el.bulkClearBtn){
          el.bulkClearBtn.disabled = (clearable === 0);
          el.bulkClearBtn.title = clearable ? 'Limpar pedidos finalizados ou recusados' : 'Selecione pedidos recusados/finalizados para limpar';
        }
      }

      function clearSelection(){
        state.selected.clear();
        state.selectMode = false;
        render();
      }

      function finalizeSelected(){
        if(!state.selected.size){ showToast('Selecione pelo menos 1 pedido.'); return; }
        showToast('A finalizacao depende da confirmacao do cliente na tela dele.');
      }

      function archiveSelected(){
        if(!state.selected.size){ showToast('Selecione pelo menos 1 pedido.'); return; }
        const ids = Array.from(state.selected).map((id) => String(id));
        addHiddenPedidos(ids);
        purgePedidosFromLocalCaches(ids);
        state.pedidos = (state.pedidos || []).filter((p) => !state.selected.has(String(p.id)));
        state.selected.clear();
        render();
        showToast('Pedidos arquivados da lista.');
      }

      function clearSelectedDoneOrRejected(){
        if(!state.selected.size){ showToast('Selecione pelo menos 1 pedido.'); return; }
        const selectedItems = (state.pedidos || []).filter((p) => state.selected.has(String(p.id)));
        const canClearIds = new Set(selectedItems.filter(isStatusFinalizadoOuRecusado).map((p) => String(p.id)));
        if(!canClearIds.size){
          showToast('Limpar so funciona para pedidos finalizados ou recusados.');
          return;
        }
        addHiddenPedidos(Array.from(canClearIds));
        purgePedidosFromLocalCaches(Array.from(canClearIds));
        const before = state.pedidos.length;
        state.pedidos = (state.pedidos || []).filter((p) => !canClearIds.has(String(p.id)));
        Array.from(canClearIds).forEach((id) => state.selected.delete(String(id)));
        const removed = before - state.pedidos.length;
        render();
        showToast(`${removed} pedido${removed !== 1 ? 's' : ''} limpo${removed !== 1 ? 's' : ''}.`);
      }

      function setupFallbacks(){
        window.toggleCep = window.toggleCep || function(e){ if(e) e.preventDefault(); const box = document.getElementById('boxCep'); if(box) box.style.display = box.style.display === 'block' ? 'none' : 'block'; };
        window.salvarCep = window.salvarCep || function(){ const val = String(document.getElementById('inputCep')?.value || '').trim(); if(!val) return; localStorage.setItem('doke_cep', val); const span = document.getElementById('textoCepSpan'); if(span) span.textContent = val; const box = document.getElementById('boxCep'); if(box) box.style.display='none'; showToast('CEP salvo'); };
        window.abrirMenuMobile = window.abrirMenuMobile || function(){ document.querySelector('.sidebar-icones')?.classList.add('menu-aberto'); document.body.classList.add('menu-ativo'); const ov = document.getElementById('overlay-menu'); if(ov) ov.style.display='block'; };
        window.fecharMenuMobile = window.fecharMenuMobile || function(){ document.querySelector('.sidebar-icones')?.classList.remove('menu-aberto'); document.body.classList.remove('menu-ativo'); const ov = document.getElementById('overlay-menu'); if(ov) ov.style.display='none'; };
        window.irParaMeuPerfil = window.irParaMeuPerfil || function(e){ if(e) e.preventDefault(); location.href='meuperfil.html'; };

        const cep = localStorage.getItem('doke_cep');
        if(cep){ const span = document.getElementById('textoCepSpan'); if(span) span.textContent = cep; }
      }

      async function hydrate(forceFs){
        let local = [];
        try{ local = loadLocal(); }catch(err){ console.warn('loadLocal erro:', err); }
        let merged = mergePedidos(local);
	      try{ await enrichPedidosComUsuarios(merged); }catch(_e){}
        if(forceFs || merged.length < 3){
          try{
            const fs = await loadFirestore();
            merged = mergePedidos([...(merged || []), ...(fs || [])]);
          }catch(err){
            console.warn('loadFirestore erro:', err);
          }
        }
        state.pedidos = merged;
        render();
      }

      function bind(){
        const on = (node, evt, fn) => { if (node && typeof node.addEventListener === 'function') node.addEventListener(evt, fn); };
        on(el.search, 'input', () => { state.query = String(el.search?.value || ''); render(); });
        on(el.sortBtn, 'click', () => { nextSort(); render(); });
        on(el.selectBtn, 'click', () => toggleSelectMode());
        on(el.bulkFinalizeBtn, 'click', finalizeSelected);
        on(el.bulkArchiveBtn, 'click', archiveSelected);
        on(el.bulkClearBtn, 'click', clearSelectedDoneOrRejected);
        on(el.refreshBtn, 'click', async () => { if(el.refreshBtn){ el.refreshBtn.disabled = true; } await hydrate(true); if(el.refreshBtn){ el.refreshBtn.disabled = false; } showToast('Pedidos atualizados'); });

        on(el.filtersBtn, 'click', () => {
          if(!el.filtersBar) return;
          const open = el.filtersBar.classList.toggle('show');
          el.filtersBtn.classList.toggle('active', open);
          el.filtersBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
        });
(el.chips || []).forEach(ch => on(ch, 'click', () => { state.filter = ch.dataset.filter || 'all'; render(); }));
        on(el.grid, 'click', (ev) => {
          const btn = ev.target.closest('button[data-action][data-id]');
          if(btn){
            const p = byId(btn.dataset.id);
            const action = String(btn.dataset.action || '');
            if(btn.dataset.action === 'select'){
              if(!state.selectMode) state.selectMode = true;
              toggleSelected(btn.dataset.id);
              return;
            }
            if(state.selectMode){ toggleSelected(btn.dataset.id); return; }
            if(action === 'accept'){ decidePedido(p, 'aceito'); return; }
            if(action === 'reject'){ decidePedido(p, 'recusado'); return; }
            if(action === 'cancel'){ decidePedido(p, 'cancelado'); return; }
            if(action === 'chat'){ openChat(p); return; }
            if(action === 'details'){ openDetails(p); return; }
            return;
          }
          const cardEl = ev.target.closest('.card[data-id]');
          if(!cardEl || !state.selectMode) return;
          toggleSelected(cardEl.dataset.id);
        });
        document.addEventListener('click', (ev) => {
          const btn = ev.target.closest('#chatDrawer [data-close], #chatSide [data-close]');
          if(btn) closeInlineChat();
        });
        on(el.chatNarrowBtn, 'click', () => nudgeChatWidth(-CHAT_WIDTH_STEP));
        on(el.chatWidenBtn, 'click', () => nudgeChatWidth(CHAT_WIDTH_STEP));
        on(el.chatWidthLabel, 'dblclick', resetChatWidth);
        on(el.chatExpandBtn, 'click', toggleChatMaximize);
        on(el.chatResizeHandle, 'mousedown', startChatResize);
        on(el.chatFrame, 'load', ensureIframeLockedInChat);
        document.addEventListener('mousemove', handleChatResizeMove);
        document.addEventListener('mouseup', stopChatResize);
        window.addEventListener('resize', applyChatPanelLayout);
        on(el.detailsCloseBtn, 'click', closeDetailsModal);
        on(el.detailsModal, 'click', (ev) => {
          if(ev.target === el.detailsModal) closeDetailsModal();
        });
        document.addEventListener('keydown', (ev) => {
          if(ev.key !== 'Escape') return;
          if(el.detailsModal.classList.contains('open')) closeDetailsModal();
          if(el.chatDrawer?.classList.contains('open')) closeInlineChat();
        });
        window.addEventListener('storage', (ev) => { const key = String(ev?.key || ''); if(!key || /(pedido|orcamento|doke_)/i.test(key)) hydrate(false); });
      }

      function bootstrapPedidos(){
        try{
          if(!ensurePedidosAuth()) return;
          setupFallbacks();
          bind();
          state.chatWidth = clampChatWidth(localStorage.getItem(CHAT_WIDTH_KEY));
          state.chatMaximized = false;
          setChatExpandButtonState();
          applyChatPanelLayout();
          setTimeout(() => {
            try {
              const loadingText = String(state?.subtitleEl?.textContent || '');
              const semPedidos = !Array.isArray(state?.pedidos) || state.pedidos.length === 0;
              if (/Carregando/i.test(loadingText) && semPedidos) {
                render([], { preservePanel:true });
              }
            } catch (_e) {}
          }, 2200);
          hydrate(true).catch((err) => {
            console.error('[pedidos] hydrate error', err);
            try{ state.pedidos = mergePedidos(loadLocal()); }catch(_){ state.pedidos = []; }
            render();
            try{ showToast('Erro ao carregar pedidos. Mostrando dados locais.'); }catch(_){ }
          });
        }catch(err){
          console.error('[pedidos] bootstrap error', err);
          try{ state.pedidos = mergePedidos(loadLocal()); }catch(_){ state.pedidos = []; }
          try{ render(); }catch(_){ }
        }
      }

      bootstrapPedidos();
    })();
  </script>
</body>
</html>