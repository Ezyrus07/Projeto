<!DOCTYPE html>
<html lang="pt-br">
<head>
  <!-- Supabase (UMD) + init + compat (Firestore/Auth) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-init.js"></script>
  <script src="firebase-compat-supabase.js"></script>
  <script src="firebase-auth-compat-supabase.js"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Grupo | Doke</title>
  <link rel="stylesheet" href="style.css">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

  <!-- script central (cria window.db/auth + helpers) -->
  <script src="script.js" defer></script>

  <style>
    /* ===========================
       Grupo (layout Doke 3 colunas)
       =========================== */
    body.doke-group-page{
      padding-top: 0 !important;
      padding-bottom: 0 !important;
      overflow: hidden; /* scroll por coluna */
      background: #f4f6fb;
    }
    .doke-group-root{
      height: 100vh;
      width: 100%;
      display:flex;
      flex-direction: column;
    }

    .dg-topbar{
      height: 64px;
      min-height: 64px;
      background: #fff;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      display:flex;
      align-items:center;
      padding: 0 14px;
      gap: 12px;
      flex-shrink: 0;
    }
    .dg-icon-btn{
      width: 42px; height: 42px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.10);
      background: #fff;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .dg-icon-btn:hover{ filter: brightness(0.99); }
    .dg-title{
      display:flex;
      flex-direction: column;
      line-height: 1.1;
      flex: 1;
      min-width: 0;
    }
    .dg-title h1{
      font-size: 1.05rem;
      margin: 0;
      color: #111827;
      font-weight: 800;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .dg-sub{
      font-size: 0.82rem;
      color: rgba(17,24,39,0.62);
      display:flex;
      gap: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .dg-actions{
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .dg-btn{
      border: 0;
      border-radius: 14px;
      padding: 10px 14px;
      font-weight: 800;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap: 8px;
      background: var(--cor0);
      color: #fff;
    }
    .dg-btn.secondary{
      background: #fff;
      color: #111827;
      border: 1px solid rgba(0,0,0,0.12);
    }
    .dg-btn[disabled]{
      opacity: .55;
      cursor: not-allowed;
    }

    .dg-grid{
      flex: 1;
      min-height: 0;
      display:grid;
      grid-template-columns: 280px 1fr 320px;
      gap: 14px;
      padding: 14px;
    }

    .dg-col{
      background: #fff;
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,0.08);
      box-shadow: 0 10px 25px rgba(0,0,0,0.04);
      min-height: 0;
      overflow: hidden;
      display:flex;
      flex-direction: column;
    }
    .dg-col-scroll{
      overflow: auto;
      min-height: 0;
      -webkit-overflow-scrolling: touch;
    }

    .dg-panel-title{
      padding: 14px 14px 10px;
      font-weight: 900;
      letter-spacing: .02em;
      color: #111827;
      display:flex;
      align-items:center;
      justify-content: space-between;
    }

    .dg-nav{
      padding: 6px 10px 14px;
      display:flex;
      flex-direction: column;
      gap: 8px;
    }
    .dg-nav-btn{
      border: 1px solid rgba(0,0,0,0.08);
      background: #fff;
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      gap: 10px;
      cursor:pointer;
      font-weight: 800;
      color:#111827;
    }
    .dg-nav-btn.active{
      border-color: rgba(11,119,104,0.35);
      background: rgba(11,119,104,0.07);
      color: var(--cor0);
    }
    .dg-nav-btn i{ font-size: 1.2rem; }

    .dg-admin{
      margin-top: 8px;
      padding-top: 10px;
      border-top: 1px dashed rgba(0,0,0,0.12);
    }

    /* Centro */
    .dg-center-header{
      padding: 0;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }
    .dg-cover{
      height: 170px;
      background: linear-gradient(120deg, var(--cor2), #8e44ad);
      background-size: cover;
      background-position: center;
      position: relative;
    }
    .dg-cover::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.25));
    }
    .dg-cover-body{
      padding: 14px;
      display:flex;
      gap: 12px;
      align-items: center;
      transform: translateY(-26px);
    }
    .dg-avatar{
      width: 62px; height: 62px;
      border-radius: 18px;
      background: #fff;
      border: 3px solid #fff;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
    }
    .dg-info{
      min-width:0;
      flex: 1;
    }
    .dg-info .name{
      font-weight: 900;
      color: #111827;
      margin: 0;
      font-size: 1.05rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .dg-info .desc{
      margin-top: 4px;
      color: rgba(17,24,39,0.65);
      font-weight: 600;
      font-size: 0.9rem;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }
    .dg-badges{
      display:flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .dg-pill{
      font-size: 0.72rem;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.10);
      color: rgba(17,24,39,0.75);
      background: #fff;
    }
    .dg-pill.lock{
      color: #b45309;
      border-color: rgba(180,83,9,0.25);
      background: rgba(251,191,36,0.12);
    }
    .dg-pill.tag{
      color: var(--cor0);
      border-color: rgba(11,119,104,0.25);
      background: rgba(11,119,104,0.08);
    }

    /* Composer igual chat (padrão Doke) */
    .dg-composer{
      padding: 0 14px 14px;
      margin-top: -12px;
    }
    .chat-footer{
      min-height: 60px;
      background: #f0f2f5;
      border: 1px solid #d1d7db;
      border-radius: 18px;
      display:flex;
      align-items:center;
      padding: 10px 12px;
      gap: 10px;
    }
    .input-msg{
      flex: 1;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,0.08);
      outline: none;
      background: #fff;
      font-weight: 700;
    }
    .btn-enviar{
      background: var(--cor0);
      color:#fff;
      border:none;
      width: 44px;
      height: 44px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 1.2rem;
      cursor:pointer;
    }
    .btn-attach{
      background: #e0e0e0;
      color:#555;
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 1.2rem;
      cursor:pointer;
    }

    .dg-attach-preview{
      margin-top: 10px;
      padding: 10px;
      border-radius: 14px;
      border: 1px dashed rgba(0,0,0,0.20);
      background: #fff;
      display:none;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
    }
    .dg-attach-preview .left{
      display:flex;
      gap: 10px;
      align-items:center;
      min-width:0;
    }
    .dg-attach-preview .file{
      font-weight: 800;
      color:#111827;
      font-size: 0.9rem;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 360px;
    }
    .dg-attach-preview .remove{
      border: 0;
      background: rgba(243,91,91,0.12);
      color: var(--cor3);
      padding: 8px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 900;
    }

    /* Feed */
    .dg-feed{
      padding: 0 14px 16px;
      display:flex;
      flex-direction: column;
      gap: 14px;
    }
    .dg-post{
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 18px;
      overflow:hidden;
      background: #fff;
    }
    .dg-post-head{
      padding: 12px 12px 10px;
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .dg-post-userimg{
      width: 42px; height: 42px;
      border-radius: 14px;
      background: #eee;
      background-size: cover;
      background-position: center;
      flex-shrink:0;
    }
    .dg-post-meta{ min-width:0; flex: 1; }
    .dg-post-meta .u{
      font-weight: 900;
      color:#111827;
      display:flex;
      gap: 8px;
      align-items:center;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .dg-role-badge{
      font-size: 0.68rem;
      font-weight: 900;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.10);
    }
    .dg-post-meta .t{
      margin-top: 2px;
      font-size: 0.78rem;
      color: rgba(17,24,39,0.55);
      font-weight: 700;
    }
    .dg-post-body{
      padding: 0 12px 12px;
      color:#111827;
      font-weight: 650;
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .dg-media{
      width: 100%;
      background: #000;
      aspect-ratio: 4 / 5; /* padrão feed Doke */
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      border-top: 1px solid rgba(0,0,0,0.06);
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }
    .dg-media img, .dg-media video{
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .dg-media a{
      color:#fff;
      font-weight: 900;
      text-decoration: underline;
      padding: 18px;
      text-align:center;
    }

    /* Membros (direita) */
    .dg-members{
      padding: 0 10px 12px;
      display:flex;
      flex-direction: column;
      gap: 12px;
    }
    .dg-sec-label{
      padding: 0 6px;
      font-size: 0.72rem;
      font-weight: 1000;
      letter-spacing: .12em;
      color: rgba(17,24,39,0.55);
      text-transform: uppercase;
    }
    .dg-member{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,0.06);
      background: #fff;
    }
    .dg-member:hover{ background: rgba(0,0,0,0.015); }
    .dg-member .a{
      width: 36px; height: 36px;
      border-radius: 14px;
      background:#eee;
      background-size: cover;
      background-position: center;
      position: relative;
      flex-shrink:0;
    }
    .dg-dot{
      position:absolute;
      right: -2px;
      bottom: -2px;
      width: 12px; height: 12px;
      border-radius: 999px;
      border: 2px solid #fff;
      background: #9ca3af; /* offline */
    }
    .dg-dot.online{ background: #22c55e; }
    .dg-member .n{
      min-width:0;
      flex: 1;
      display:flex;
      flex-direction: column;
    }
    .dg-member .n .name{
      font-weight: 900;
      color:#111827;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .dg-member .n .sub{
      font-size: 0.78rem;
      color: rgba(17,24,39,0.55);
      font-weight: 700;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .dg-member .role{
      font-size: 0.72rem;
      font-weight: 1000;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.10);
      white-space: nowrap;
    }
    .dg-member select{
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.12);
      padding: 8px 10px;
      font-weight: 800;
      background:#fff;
      max-width: 130px;
    }

    /* Modal / Toast */
    .dg-modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display:none;
      align-items: flex-start;
      justify-content: center;
      padding: 18px 10px;
      z-index: 9999;
      overflow: auto;
    }
    .dg-modal.show{ display:flex; }
    .dg-modal-card{
      width: 100%;
      max-width: 560px;
      background: #fff;
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,0.10);
      box-shadow: 0 18px 45px rgba(0,0,0,0.22);
      padding: 16px;
      max-height: calc(100vh - 36px);
      overflow:auto;
    }
    .dg-modal-head{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
    }
    .dg-modal-head h2{
      margin:0;
      font-size: 1rem;
      color:#111827;
    }
    .dg-x{
      width: 40px; height: 40px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.12);
      background:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 1.3rem;
    }
    .dg-form label{
      display:block;
      font-weight: 900;
      margin: 10px 0 6px;
      color:#111827;
      font-size: .9rem;
    }
    .dg-form input, .dg-form textarea, .dg-form select{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,0.12);
      padding: 12px;
      font-weight: 750;
      outline:none;
      background:#fff;
    }
    .dg-form textarea{ min-height: 110px; resize: vertical; }
    .dg-row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .dg-help{
      margin-top: 8px;
      font-size: .82rem;
      color: rgba(17,24,39,0.55);
      font-weight: 700;
    }
    .dg-actions-row{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      margin-top: 14px;
    }

    .dg-toast-wrap{
      position: fixed;
      right: 14px;
      bottom: 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      z-index: 10000;
    }
    .dg-toast{
      background:#111827;
      color:#fff;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 800;
      box-shadow: 0 12px 30px rgba(0,0,0,0.22);
      max-width: 320px;
    }
    .dg-toast.success{ background: var(--cor0); }
    .dg-toast.error{ background: #b91c1c; }

    /* Responsivo */
    @media(max-width: 980px){
      body.doke-group-page{ overflow:auto; }
      .dg-grid{
        grid-template-columns: 1fr;
        height: auto;
      }
      .dg-col{ min-height: auto; }
      .dg-col-scroll{ max-height: none; }
    }
  </style>
</head>

<body class="doke-group-page">
  <div class="doke-group-root">
    <header class="dg-topbar">
      <button class="dg-icon-btn" id="btnBack" title="Voltar"><i class='bx bx-arrow-back'></i></button>
      <div class="dg-title">
        <h1 id="groupName">Carregando...</h1>
        <div class="dg-sub" id="groupMeta"> </div>
      </div>
      <div class="dg-actions">
        <button class="dg-btn secondary" id="btnJoin" style="display:none;"><i class='bx bx-log-in'></i><span>Entrar</span></button>
        <button class="dg-btn secondary" id="btnLeave" style="display:none;"><i class='bx bx-log-out'></i><span>Sair</span></button>
        <button class="dg-btn" id="btnEdit" style="display:none;"><i class='bx bx-cog'></i><span>Editar</span></button>
      </div>
    </header>

    <div class="dg-grid">
      <!-- Esquerda -->
      <aside class="dg-col">
        <div class="dg-panel-title">Navegação</div>
        <div class="dg-col-scroll">
          <div class="dg-nav">
            <button class="dg-nav-btn active" data-view="feed"><i class='bx bx-news'></i>Feed</button>
            <button class="dg-nav-btn" data-view="arquivos"><i class='bx bx-folder'></i>Arquivos</button>
            <button class="dg-nav-btn" data-view="sobre"><i class='bx bx-info-circle'></i>Sobre</button>

            <div class="dg-admin" id="adminArea" style="display:none;">
              <div class="dg-panel-title" style="padding:12px 6px 8px;">Admin</div>
              <button class="dg-nav-btn" data-action="edit"><i class='bx bx-edit'></i>Editar grupo</button>
              <button class="dg-nav-btn" data-action="roles"><i class='bx bx-layer'></i>Cargos</button>
            </div>
          </div>
        </div>
      </aside>

      <!-- Centro -->
      <section class="dg-col">
        <div class="dg-center-header">
          <div class="dg-cover" id="groupCover"></div>
          <div class="dg-cover-body">
            <div class="dg-avatar" id="groupAvatar"></div>
            <div class="dg-info">
              <p class="name" id="groupTitle">Carregando...</p>
              <div class="desc" id="groupDesc"></div>
              <div class="dg-badges" id="groupBadges"></div>
            </div>
          </div>
        </div>

        <div class="dg-col-scroll">
          <div class="dg-composer" id="composerWrap" style="display:none;">
            <div class="chat-footer">
              <button class="btn-attach" id="btnAttach" title="Anexar"><i class='bx bx-paperclip'></i></button>
              <input class="input-msg" id="postText" placeholder="Escreva algo no grupo..." />
              <button class="btn-enviar" id="btnSend" title="Enviar"><i class='bx bx-send'></i></button>
            </div>
            <input type="file" id="postFile" accept="image/*,video/*,application/pdf" hidden>
            <div class="dg-attach-preview" id="attachPreview">
              <div class="left">
                <i class='bx bx-file' style="font-size:1.2rem;"></i>
                <div class="file" id="attachName"></div>
              </div>
              <button class="remove" id="attachRemove">Remover</button>
            </div>
          </div>

          <div class="dg-feed" id="feedWrap"></div>
        </div>
      </section>

      <!-- Direita -->
      <aside class="dg-col">
        <div class="dg-panel-title">Membros</div>
        <div class="dg-col-scroll">
          <div class="dg-members">
            <div class="dg-sec-label">Online (<span id="onlineCount">0</span>)</div>
            <div id="membersOnline"></div>

            <div class="dg-sec-label">Offline (<span id="offlineCount">0</span>)</div>
            <div id="membersOffline"></div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal Editar Grupo -->
  <div class="dg-modal" id="modalEdit" aria-hidden="true">
    <div class="dg-modal-card" role="dialog" aria-modal="true" aria-labelledby="modalEditTitle">
      <div class="dg-modal-head">
        <h2 id="modalEditTitle">Editar grupo</h2>
        <button class="dg-x" data-close="modalEdit" aria-label="Fechar">&times;</button>
      </div>
      <form class="dg-form" id="formEdit">
        <label>Nome</label>
        <input id="editNome" required>

        <label>Descrição</label>
        <textarea id="editDesc" required></textarea>

        <div class="dg-row">
          <div>
            <label>Tipo</label>
            <select id="editTipo">
              <option value="Pro">Pro</option>
              <option value="Condomínio">Condomínio</option>
              <option value="Hobby">Hobby</option>
            </select>
          </div>
          <div>
            <label>Privacidade</label>
            <select id="editPrivacidade">
              <option value="Público">Público</option>
              <option value="Privado">Privado</option>
            </select>
          </div>
        </div>

        <div class="dg-row">
          <div>
            <label>Categoria</label>
            <input id="editCategoria" placeholder="Ex: Reforma e Construção">
          </div>
          <div>
            <label>Subcategoria</label>
            <input id="editSubcategoria" placeholder="Ex: Elétrica">
          </div>
        </div>

        <label>Imagem de capa</label>
        <input type="file" id="editCapa" accept="image/*">

        <div class="dg-help">PNG/JPG até 2MB. A capa aparece no topo do grupo.</div>

        <div class="dg-actions-row">
          <button type="button" class="dg-btn secondary" data-close="modalEdit">Cancelar</button>
          <button type="submit" class="dg-btn">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Cargos -->
  <div class="dg-modal" id="modalRoles" aria-hidden="true">
    <div class="dg-modal-card" role="dialog" aria-modal="true" aria-labelledby="modalRolesTitle">
      <div class="dg-modal-head">
        <h2 id="modalRolesTitle">Cargos do grupo</h2>
        <button class="dg-x" data-close="modalRoles" aria-label="Fechar">&times;</button>
      </div>

      <div class="dg-form">
        <div id="rolesList"></div>

        <label style="margin-top:14px;">Criar novo cargo</label>
        <div class="dg-row">
          <input id="roleNome" placeholder="Ex: Administrador">
          <input id="roleCor" type="color" value="#0b7768" title="Cor do cargo">
        </div>
        <div class="dg-help">O Dono pode criar cargos e atribuir aos membros.</div>

        <div class="dg-actions-row">
          <button class="dg-btn secondary" type="button" data-close="modalRoles">Fechar</button>
          <button class="dg-btn" type="button" id="btnCreateRole"><i class='bx bx-plus'></i>Criar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="dg-toast-wrap" id="toastWrap"></div>

  <script>
    // Bucket padrão para anexos (se estiver usando Supabase Storage)
    window.__DOKE_SUPABASE_STORAGE_BUCKET__ = window.__DOKE_SUPABASE_STORAGE_BUCKET__ || 'posts';

    (function(){
      const $ = (sel, root=document) => root.querySelector(sel);
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
      const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

      function toast(msg, kind='info'){
        const wrap = $('#toastWrap');
        if(!wrap) return;
        const el = document.createElement('div');
        el.className = 'dg-toast ' + (kind||'');
        el.textContent = String(msg||'');
        wrap.appendChild(el);
        setTimeout(()=>{ el.style.opacity='0.0'; el.style.transition='opacity .25s'; }, 3400);
        setTimeout(()=>{ try{ el.remove(); }catch(e){} }, 3800);
      }

      // Mata alert padrão
      const nativeAlert = window.alert;
      window.alert = function(msg){
        const t = String(msg||'');
        const kind = /erro|error|falha|inválid/i.test(t) ? 'error' : /sucesso|criado|ok|conclu/i.test(t) ? 'success' : 'info';
        toast(t, kind);
      };

      function getSupabaseClient(){
        return window.sb || window.supabaseClient || window.sbClient || window.supabase || null;
      }

      async function readAsDataURL(file){
        return await new Promise((resolve, reject)=>{
          const reader = new FileReader();
          reader.onload = ()=>resolve(reader.result);
          reader.onerror = ()=>reject(reader.error);
          reader.readAsDataURL(file);
        });
      }

      async function uploadToSupabase(file, groupId){
        const sb = getSupabaseClient();
        if(!sb || !sb.storage) return null;
        const bucket = window.__DOKE_SUPABASE_STORAGE_BUCKET__ || 'posts';
        const safeName = (file.name || 'file').replace(/[^a-z0-9._-]/gi,'_');
        const path = `comunidades/${groupId}/posts/${Date.now()}_${safeName}`;
        const { error } = await sb.storage.from(bucket).upload(path, file, { upsert: true });
        if(error) throw error;
        const { data } = sb.storage.from(bucket).getPublicUrl(path);
        return data?.publicUrl || null;
      }

      function fmtTime(iso){
        try{
          const d = new Date(iso);
          return d.toLocaleString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
        }catch(e){ return ''; }
      }

      function getGroupId(){
        const id = new URLSearchParams(location.search).get('id');
        return id ? String(id) : '';
      }

      function openModal(id){
        const el = document.getElementById(id);
        if(!el) return;
        el.classList.add('show');
        el.setAttribute('aria-hidden','false');
      }
      function closeModal(id){
        const el = document.getElementById(id);
        if(!el) return;
        el.classList.remove('show');
        el.setAttribute('aria-hidden','true');
      }

      function roleStyle(role){
        const c = role?.cor || 'rgba(0,0,0,0.55)';
        return { borderColor: 'rgba(0,0,0,0.10)', background: c+'22', color: c };
      }

      async function waitForDb(){
        for(let i=0;i<60;i++){
          if(window.db && window.auth && window.doc && window.getDoc) return true;
          await sleep(50);
        }
        return false;
      }

      // ====== Estado ======
      const state = {
        groupId: getGroupId(),
        group: null,
        user: null,
        roles: [],
        roleMap: new Map(),
        members: [], // {uid, roleId, roleName, roleCor, userDoc, online}
        isOwner: false,
        isMod: false,
        isMember: false,
        view: 'feed',
        pendingFile: null,
      };

      // ====== Render ======
      function setView(view){
        state.view = view;
        $$('.dg-nav-btn[data-view]').forEach(b=>{
          b.classList.toggle('active', b.getAttribute('data-view')===view);
        });
        const feedWrap = $('#feedWrap');
        if(!feedWrap) return;
        feedWrap.innerHTML = '';
        if(view === 'sobre'){
          renderAbout();
        }else if(view === 'arquivos'){
          renderFiles();
        }else{
          renderFeed();
        }
      }

      function renderHeader(){
        const g = state.group || {};
        $('#groupName').textContent = g.nome || 'Grupo';
        $('#groupTitle').textContent = g.nome || 'Grupo';
        $('#groupDesc').textContent = g.descricao || '';
        const metaBits = [];
        if(g.tipo) metaBits.push(g.tipo);
        if(g.privacidade) metaBits.push(g.privacidade);
        if(typeof g.membrosCount === 'number') metaBits.push(`${g.membrosCount} membros`);
        $('#groupMeta').textContent = metaBits.join(' • ');

        const cover = $('#groupCover');
        if(cover){
          if(g.capa && String(g.capa).trim()){
            cover.style.backgroundImage = `url('${g.capa}')`;
          }else{
            cover.style.backgroundImage = '';
          }
        }
        const avatar = $('#groupAvatar');
        if(avatar){
          const url = g.capa && String(g.capa).trim() ? g.capa : '';
          avatar.style.backgroundImage = url ? `url('${url}')` : '';
        }

        const badges = $('#groupBadges');
        if(badges){
          badges.innerHTML = '';
          const priv = document.createElement('span');
          priv.className = 'dg-pill ' + (String(g.privacidade||'').toLowerCase().includes('priv') ? 'lock':'');
          priv.textContent = (g.privacidade || 'Público');
          badges.appendChild(priv);

          if(g.categoria){
            const t = document.createElement('span');
            t.className = 'dg-pill tag';
            t.textContent = g.categoria;
            badges.appendChild(t);
          }
          if(g.subcategoria){
            const t2 = document.createElement('span');
            t2.className = 'dg-pill tag';
            t2.textContent = g.subcategoria;
            badges.appendChild(t2);
          }
        }

        // botões join/leave/edit
        const btnJoin = $('#btnJoin');
        const btnLeave = $('#btnLeave');
        const btnEdit = $('#btnEdit');

        if(btnJoin) btnJoin.style.display = (!state.isMember && state.user) ? 'inline-flex' : 'none';
        if(btnLeave) btnLeave.style.display = (state.isMember && state.user) ? 'inline-flex' : 'none';
        const canAdmin = state.isOwner || state.isMod;
        if(btnEdit) btnEdit.style.display = canAdmin ? 'inline-flex' : 'none';
        $('#adminArea').style.display = canAdmin ? 'block' : 'none';

        // composer aparece só se membro
        $('#composerWrap').style.display = (state.isMember && state.user) ? 'block' : 'none';
      }

      function renderMembers(){
        const onEl = $('#membersOnline');
        const offEl = $('#membersOffline');
        if(!onEl || !offEl) return;
        onEl.innerHTML = '';
        offEl.innerHTML = '';
        const online = [];
        const offline = [];
        state.members.forEach(m => (m.online ? online : offline).push(m));
        $('#onlineCount').textContent = String(online.length);
        $('#offlineCount').textContent = String(offline.length);

        const canAssign = state.isOwner || state.isMod;

        function createMemberRow(m){
          const u = m.userDoc || {};
          const foto = u.foto || 'https://i.pravatar.cc/150?u=' + encodeURIComponent(m.uid);
          let nome = u.user || (u.nome ? String(u.nome).split(' ')[0] : 'Usuário');
          const item = document.createElement('div');
          item.className = 'dg-member';

          const a = document.createElement('div');
          a.className = 'a';
          a.style.backgroundImage = `url('${foto}')`;
          const dot = document.createElement('div');
          dot.className = 'dg-dot ' + (m.online ? 'online' : '');
          a.appendChild(dot);

          const n = document.createElement('div');
          n.className = 'n';
          n.innerHTML = `<div class="name">${escapeHtml(nome)}</div><div class="sub">${escapeHtml(u.categoria_profissional || '')}</div>`;

          // role badge / selector
          const roleObj = state.roleMap.get(m.roleId) || { nome: m.roleName || 'Membro', cor: m.roleCor || '#6b7280' };
          const roleName = roleObj.nome || 'Membro';
          const roleCor = roleObj.cor || '#6b7280';

          if(canAssign){
            const sel = document.createElement('select');
            state.roles.forEach(r=>{
              const opt = document.createElement('option');
              opt.value = r.id;
              opt.textContent = r.nome;
              sel.appendChild(opt);
            });
            sel.value = m.roleId || (state.roles.find(r=>r.nome==='Membro')?.id || '');
            sel.addEventListener('change', async ()=>{
              try{
                await window.setDoc(window.doc(window.db, "comunidades", state.groupId, "membros", m.uid), {
                  uid: m.uid,
                  roleId: sel.value
                }, { merge: true });
                toast("Cargo atualizado", "success");
                await loadMembers();
              }catch(e){
                console.error(e);
                toast("Erro ao atualizar cargo", "error");
              }
            });
            item.appendChild(sel);
          }else{
            const role = document.createElement('div');
            role.className = 'role';
            role.textContent = roleName;
            role.style.borderColor = roleCor+'44';
            role.style.background = roleCor+'22';
            role.style.color = roleCor;
            item.appendChild(role);
          }

          item.prepend(a);
          item.appendChild(n);
          return item;
        }

        online.forEach(m=>onEl.appendChild(createMemberRow(m)));
        offline.forEach(m=>offEl.appendChild(createMemberRow(m)));
      }

      function renderFeed(){
        const wrap = $('#feedWrap');
        if(!wrap) return;
        wrap.innerHTML = '<div style="padding:10px;color:rgba(17,24,39,0.55);font-weight:800;">Carregando posts...</div>';
        loadPosts().catch(e=>{
          console.error(e);
          wrap.innerHTML = '<div style="padding:10px;color:rgba(17,24,39,0.55);font-weight:800;">Erro ao carregar posts.</div>';
        });
      }

      function renderAbout(){
        const g = state.group || {};
        const wrap = $('#feedWrap');
        if(!wrap) return;
        wrap.innerHTML = `
          <div style="padding:14px;">
            <div style="font-weight:1000;color:#111827;font-size:1rem;">Sobre</div>
            <div style="margin-top:8px;color:rgba(17,24,39,0.70);font-weight:700;white-space:pre-wrap;">${escapeHtml(g.descricao || '')}</div>
            <div style="margin-top:14px;color:rgba(17,24,39,0.55);font-weight:800;font-size:.9rem;">
              Criado em: ${escapeHtml(g.dataCriacao ? fmtTime(g.dataCriacao) : '—')}
            </div>
          </div>
        `;
      }

      function renderFiles(){
        const wrap = $('#feedWrap');
        if(!wrap) return;
        wrap.innerHTML = `
          <div style="padding:14px;">
            <div style="font-weight:1000;color:#111827;font-size:1rem;">Arquivos</div>
            <div style="margin-top:8px;color:rgba(17,24,39,0.55);font-weight:800;">
              Aqui aparecem anexos (imagens/vídeos/PDF) dos posts.
            </div>
          </div>
        `;
      }

      function escapeHtml(s){
        return String(s ?? '')
          .replaceAll('&','&amp;')
          .replaceAll('<','&lt;')
          .replaceAll('>','&gt;')
          .replaceAll('"','&quot;')
          .replaceAll("'","&#039;");
      }

      // ====== DB Loaders ======
      async function loadGroup(){
        const ref = window.doc(window.db, "comunidades", state.groupId);
        const snap = await window.getDoc(ref);
        if(!snap.exists()){
          toast("Grupo não encontrado", "error");
          $('#groupName').textContent = 'Grupo não encontrado';
          return false;
        }
        state.group = snap.data() || {};
        return true;
      }

      async function ensureDefaultRolesIfNeeded(){
        const rolesCol = window.collection(window.db, "comunidades", state.groupId, "cargos");
        const snap = await window.getDocs(rolesCol);
        if(!snap.empty) return;

        // só o dono cria defaults automaticamente
        if(!state.isOwner) return;

        const defaults = [
          { nome: "Dono", cor: "#0b7768", rank: 100 },
          { nome: "Moderador", cor: "#2a5f90", rank: 70 },
          { nome: "Membro", cor: "#6b7280", rank: 10 },
        ];
        for(const r of defaults){
          await window.addDoc(rolesCol, r);
        }
      }

      async function loadRoles(){
        const rolesCol = window.collection(window.db, "comunidades", state.groupId, "cargos");
        const snap = await window.getDocs(rolesCol);
        const roles = [];
        snap.forEach(d=>{
          const data = d.data() || {};
          roles.push({ id: d.id, ...data });
        });
        roles.sort((a,b)=>(b.rank||0)-(a.rank||0));
        state.roles = roles;
        state.roleMap = new Map(roles.map(r=>[r.id, r]));
      }

      async function loadMembers(){
        // tenta subcoleção primeiro
        const memCol = window.collection(window.db, "comunidades", state.groupId, "membros");
        let memSnap = null;
        try{
          memSnap = await window.getDocs(memCol);
        }catch(e){
          memSnap = null;
        }

        let memberEntries = [];
        if(memSnap && !memSnap.empty){
          memSnap.forEach(d=>{
            const data = d.data() || {};
            memberEntries.push({ uid: data.uid || d.id, roleId: data.roleId || '', roleName: data.roleName || '', roleCor: data.roleCor || '' });
          });
        }else{
          const arr = Array.isArray(state.group?.membros) ? state.group.membros : [];
          memberEntries = arr.map(uid => ({ uid, roleId:'', roleName:'', roleCor:'' }));
        }

        // garante dono presente
        const dono = state.group?.donoUid;
        if(dono && !memberEntries.some(m=>m.uid===dono)){
          memberEntries.unshift({ uid: dono, roleId:'', roleName:'', roleCor:'' });
        }

        // busca dados do usuário
        const members = [];
        for(const m of memberEntries){
          if(!m.uid) continue;
          try{
            const uSnap = await window.getDoc(window.doc(window.db, "usuarios", m.uid));
            const uData = uSnap.exists() ? (uSnap.data()||{}) : {};
            const last = uData.ultimaVezOnline ? Date.parse(uData.ultimaVezOnline) : 0;
            const isOnline = (String(uData.status||'').toLowerCase() === 'online') && (Date.now()-last < 10*60*1000);
            members.push({ ...m, userDoc: uData, online: isOnline });
          }catch(e){
            members.push({ ...m, userDoc: {}, online: false });
          }
        }

        // atribui role default se faltando
        const roleMembroId = state.roles.find(r=>r.nome==="Membro")?.id || '';
        const roleDonoId = state.roles.find(r=>r.nome==="Dono")?.id || '';
        const roleModId = state.roles.find(r=>r.nome==="Moderador")?.id || '';

        members.forEach(mem=>{
          if(!mem.roleId){
            if(mem.uid === state.group?.donoUid) mem.roleId = roleDonoId || roleMembroId;
            else mem.roleId = roleMembroId;
          }
        });

        state.members = members;
        renderMembers();
      }

      async function loadPosts(){
        const wrap = $('#feedWrap');
        const postsCol = window.collection(window.db, "comunidades", state.groupId, "posts");
        const snap = await window.getDocs(window.query(postsCol, window.limit(50)));
        const posts = [];
        snap.forEach(d=>{
          const data = d.data() || {};
          posts.push({ id: d.id, ...data });
        });
        posts.sort((a,b)=> (Date.parse(b.createdAt||0) - Date.parse(a.createdAt||0)));

        wrap.innerHTML = '';
        if(posts.length === 0){
          wrap.innerHTML = '<div style="padding:10px;color:rgba(17,24,39,0.55);font-weight:800;">Ainda não há posts.</div>';
          return;
        }

        for(const p of posts){
          const card = document.createElement('div');
          card.className = 'dg-post';

          // user info
          let uData = {};
          try{
            if(p.uid){
              const uSnap = await window.getDoc(window.doc(window.db,"usuarios",p.uid));
              uData = uSnap.exists()? (uSnap.data()||{}) : {};
            }
          }catch(e){}

          const foto = uData.foto || 'https://i.pravatar.cc/150?u=' + encodeURIComponent(p.uid||p.id);
          const nome = uData.user || (uData.nome ? String(uData.nome).split(' ')[0] : 'Usuário');

          // role badge from member mapping
          const member = state.members.find(m=>m.uid===p.uid);
          const roleObj = member ? (state.roleMap.get(member.roleId) || {}) : {};
          const roleName = roleObj.nome || (p.roleName||'');
          const roleCor  = roleObj.cor  || (p.roleCor||'');

          const head = document.createElement('div');
          head.className = 'dg-post-head';
          head.innerHTML = `
            <div class="dg-post-userimg" style="background-image:url('${escapeHtml(foto)}')"></div>
            <div class="dg-post-meta">
              <div class="u">
                <span style="overflow:hidden;text-overflow:ellipsis;">${escapeHtml(nome)}</span>
                ${roleName ? `<span class="dg-role-badge" style="border-color:${escapeHtml(roleCor||'#6b7280')}44;background:${escapeHtml(roleCor||'#6b7280')}22;color:${escapeHtml(roleCor||'#6b7280')}">${escapeHtml(roleName)}</span>` : ''}
              </div>
              <div class="t">${escapeHtml(p.createdAt ? fmtTime(p.createdAt) : '')}</div>
            </div>
          `;

          card.appendChild(head);

          if(p.mediaUrl){
            const media = document.createElement('div');
            media.className = 'dg-media';
            if(String(p.mediaType||'').startsWith('image')){
              media.innerHTML = `<img src="${escapeHtml(p.mediaUrl)}" loading="lazy" alt="Imagem do post">`;
            }else if(String(p.mediaType||'').startsWith('video')){
              media.innerHTML = `<video src="${escapeHtml(p.mediaUrl)}" controls></video>`;
            }else{
              media.innerHTML = `<a href="${escapeHtml(p.mediaUrl)}" target="_blank" rel="noopener">Abrir arquivo</a>`;
            }
            card.appendChild(media);
          }

          if(p.texto){
            const body = document.createElement('div');
            body.className = 'dg-post-body';
            body.textContent = String(p.texto);
            card.appendChild(body);
          }

          wrap.appendChild(card);
        }
      }

      async function joinGroup(){
        if(!state.user){ toast("Faça login para entrar", "error"); return; }
        const gRef = window.doc(window.db, "comunidades", state.groupId);
        const uid = state.user.uid;

        try{
          // adiciona uid no array membros (se existir)
          const gSnap = await window.getDoc(gRef);
          if(!gSnap.exists()) return;
          const g = gSnap.data() || {};
          const membros = Array.isArray(g.membros) ? g.membros : [];
          if(!membros.includes(uid)){
            membros.push(uid);
            await window.updateDoc(gRef, { membros, membrosCount: membros.length });
          }

          // cria doc em subcoleção membros
          const roleMembroId = state.roles.find(r=>r.nome==="Membro")?.id || '';
          await window.setDoc(window.doc(window.db, "comunidades", state.groupId, "membros", uid), {
            uid, roleId: roleMembroId
          }, { merge: true });

          toast("Você entrou no grupo", "success");
          await refreshAll();
        }catch(e){
          console.error(e);
          toast("Erro ao entrar no grupo", "error");
        }
      }

      async function leaveGroup(){
        if(!state.user){ return; }
        const uid = state.user.uid;
        const gRef = window.doc(window.db, "comunidades", state.groupId);
        try{
          const gSnap = await window.getDoc(gRef);
          if(!gSnap.exists()) return;
          const g = gSnap.data() || {};
          const membros = Array.isArray(g.membros) ? g.membros : [];
          const next = membros.filter(x=>x!==uid);
          await window.updateDoc(gRef, { membros: next, membrosCount: next.length });

          // remove membro doc (se não for dono)
          if(uid !== g.donoUid){
            try{ await window.deleteDoc(window.doc(window.db, "comunidades", state.groupId, "membros", uid)); }catch(e){}
          }

          toast("Você saiu do grupo", "success");
          await refreshAll();
        }catch(e){
          console.error(e);
          toast("Erro ao sair", "error");
        }
      }

      async function createPost(){
        if(!state.user || !state.isMember){
          toast("Entre no grupo para postar", "error");
          return;
        }
        const texto = $('#postText').value.trim();
        const file = state.pendingFile;

        if(!texto && !file){
          toast("Escreva algo ou anexe um arquivo", "info");
          return;
        }

        $('#btnSend').disabled = true;

        try{
          let mediaUrl = '';
          let mediaType = '';

          if(file){
            mediaType = file.type || '';
            // tenta upload supabase, senão base64 (só imagens pequenas)
            try{
              const url = await uploadToSupabase(file, state.groupId);
              if(url) mediaUrl = url;
            }catch(e){
              console.warn("Upload supabase falhou:", e);
              if((file.type||'').startsWith('image/') && file.size <= 2*1024*1024){
                mediaUrl = await readAsDataURL(file);
              }else{
                throw new Error("Falha ao enviar arquivo. Tente novamente ou use uma imagem menor.");
              }
            }
          }

          const post = {
            uid: state.user.uid,
            texto: texto || '',
            mediaUrl: mediaUrl || '',
            mediaType: mediaType || '',
            createdAt: new Date().toISOString()
          };

          await window.addDoc(window.collection(window.db, "comunidades", state.groupId, "posts"), post);

          $('#postText').value = '';
          clearAttachment();
          toast("Post enviado!", "success");
          await loadPosts();
        }catch(e){
          console.error(e);
          toast(e?.message || "Erro ao postar", "error");
        }finally{
          $('#btnSend').disabled = false;
        }
      }

      function clearAttachment(){
        state.pendingFile = null;
        $('#postFile').value = '';
        $('#attachPreview').style.display = 'none';
        $('#attachName').textContent = '';
      }

      async function refreshAll(){
        if(!state.groupId){
          toast("Faltou o ID do grupo na URL", "error");
          return;
        }
        const ok = await loadGroup();
        if(!ok) return;

        // owner/mod/member flags
        state.isOwner = !!(state.user && state.group && state.user.uid === state.group.donoUid);
        state.isMember = !!(state.user && Array.isArray(state.group.membros) && state.group.membros.includes(state.user.uid));

        await ensureDefaultRolesIfNeeded();
        await loadRoles();

        // mod check: se tiver doc membro e role=Moderador
        state.isMod = false;
        if(state.user){
          try{
            const ms = await window.getDoc(window.doc(window.db, "comunidades", state.groupId, "membros", state.user.uid));
            if(ms.exists()){
              const md = ms.data()||{};
              const role = state.roleMap.get(md.roleId);
              if(role && String(role.nome).toLowerCase().includes('moder')) state.isMod = true;
            }
          }catch(e){}
        }

        // se for dono, forçar como membro
        if(state.isOwner) state.isMember = true;

        // UI
        renderHeader();
        await loadMembers();
        setView(state.view);
      }

      // ====== UI Events ======
      function bind(){
        $('#btnBack').addEventListener('click', ()=> history.length>1 ? history.back() : (location.href='comunidade.html'));

        $$('.dg-nav-btn[data-view]').forEach(btn=>{
          btn.addEventListener('click', ()=> setView(btn.getAttribute('data-view')));
        });

        // ações admin
        $$('.dg-nav-btn[data-action]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const act = btn.getAttribute('data-action');
            if(act==='edit') openModal('modalEdit');
            if(act==='roles') openModal('modalRoles');
          });
        });

        $('#btnEdit').addEventListener('click', ()=> openModal('modalEdit'));
        $('#btnJoin').addEventListener('click', joinGroup);
        $('#btnLeave').addEventListener('click', leaveGroup);

        // modal close handlers
        $$('.dg-modal').forEach(modal=>{
          modal.addEventListener('click', (e)=>{
            if(e.target === modal) closeModal(modal.id);
          });
        });
        $$('[data-close]').forEach(btn=>{
          btn.addEventListener('click', ()=> closeModal(btn.getAttribute('data-close')));
        });
        document.addEventListener('keydown', (e)=>{
          if(e.key === 'Escape'){
            ['modalEdit','modalRoles'].forEach(closeModal);
          }
        });

        // composer file
        $('#btnAttach').addEventListener('click', ()=> $('#postFile').click());
        $('#postFile').addEventListener('change', ()=>{
          const f = $('#postFile').files && $('#postFile').files[0];
          if(!f) return;
          state.pendingFile = f;
          $('#attachName').textContent = f.name;
          $('#attachPreview').style.display = 'flex';
        });
        $('#attachRemove').addEventListener('click', clearAttachment);
        $('#btnSend').addEventListener('click', createPost);
        $('#postText').addEventListener('keydown', (e)=>{
          if(e.key === 'Enter' && !e.shiftKey){
            e.preventDefault();
            createPost();
          }
        });

        // edit group
        $('#formEdit').addEventListener('submit', async (e)=>{
          e.preventDefault();
          if(!(state.isOwner || state.isMod)){
            toast("Sem permissão", "error");
            return;
          }
          const patch = {
            nome: $('#editNome').value.trim(),
            descricao: $('#editDesc').value.trim(),
            tipo: $('#editTipo').value,
            privacidade: $('#editPrivacidade').value,
            categoria: $('#editCategoria').value.trim(),
            subcategoria: $('#editSubcategoria').value.trim(),
          };

          // capa upload (base64 simples se não tiver storage)
          const file = $('#editCapa').files && $('#editCapa').files[0];
          if(file){
            if(file.size > 2*1024*1024){ toast("Imagem muito grande (máx 2MB)", "error"); return; }
            try{
              let url = null;
              try{ url = await uploadToSupabase(file, state.groupId); }catch(e){}
              if(!url) url = await readAsDataURL(file);
              patch.capa = url;
            }catch(e){
              toast("Erro ao enviar capa", "error");
              return;
            }
          }

          try{
            await window.updateDoc(window.doc(window.db, "comunidades", state.groupId), patch);
            toast("Grupo atualizado!", "success");
            closeModal('modalEdit');
            await refreshAll();
          }catch(err){
            console.error(err);
            toast("Erro ao salvar", "error");
          }
        });

        // roles
        $('#btnCreateRole').addEventListener('click', async ()=>{
          if(!state.isOwner){ toast("Só o Dono cria cargos", "error"); return; }
          const nome = $('#roleNome').value.trim();
          const cor = $('#roleCor').value || '#0b7768';
          if(!nome){ toast("Informe o nome do cargo", "info"); return; }
          try{
            await window.addDoc(window.collection(window.db, "comunidades", state.groupId, "cargos"), {
              nome, cor, rank: 20
            });
            $('#roleNome').value = '';
            toast("Cargo criado!", "success");
            await loadRoles();
            await loadMembers();
            renderRolesList();
          }catch(e){
            console.error(e);
            toast("Erro ao criar cargo", "error");
          }
        });
      }

      function renderRolesList(){
        const wrap = $('#rolesList');
        if(!wrap) return;
        wrap.innerHTML = '';
        if(state.roles.length === 0){
          wrap.innerHTML = '<div class="dg-help">Nenhum cargo ainda.</div>';
          return;
        }
        state.roles.forEach(r=>{
          const row = document.createElement('div');
          row.style.display = 'flex';
          row.style.gap = '10px';
          row.style.alignItems = 'center';
          row.style.padding = '10px 0';
          row.style.borderBottom = '1px solid rgba(0,0,0,0.06)';
          row.innerHTML = `
            <div style="width:14px;height:14px;border-radius:999px;background:${escapeHtml(r.cor||'#6b7280')};"></div>
            <div style="font-weight:900;color:#111827;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(r.nome||'Cargo')}</div>
            ${state.isOwner && r.nome!=="Dono" && r.nome!=="Membro" && r.nome!=="Moderador" ? `<button class="dg-btn secondary" style="padding:8px 10px;border-radius:12px;" data-del-role="${escapeHtml(r.id)}"><i class='bx bx-trash'></i></button>` : ''}
          `;
          wrap.appendChild(row);
        });

        // delete role
        $$('[data-del-role]', wrap).forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            if(!state.isOwner) return;
            const id = btn.getAttribute('data-del-role');
            try{
              await window.deleteDoc(window.doc(window.db, "comunidades", state.groupId, "cargos", id));
              toast("Cargo removido", "success");
              await loadRoles();
              await loadMembers();
              renderRolesList();
            }catch(e){
              console.error(e);
              toast("Erro ao remover cargo", "error");
            }
          });
        });
      }

      async function main(){
        if(!state.groupId){
          toast("URL sem id do grupo (ex: grupo.html?id=XYZ)", "error");
          $('#groupName').textContent = 'Grupo inválido';
          return;
        }

        const ok = await waitForDb();
        if(!ok){
          toast("Falha ao iniciar banco", "error");
          return;
        }

        bind();

        // auth
        try{
          onAuthStateChanged(window.auth, async (user)=>{
            state.user = user || null;
            if(user){
              // usa o seu script central (marca online)
              if(window.marcarComoOnline) window.marcarComoOnline(user.uid);
            }
            await refreshAll();
            renderRolesList();
            // preenche modal edit
            if(state.group){
              $('#editNome').value = state.group.nome || '';
              $('#editDesc').value = state.group.descricao || '';
              $('#editTipo').value = state.group.tipo || 'Pro';
              $('#editPrivacidade').value = state.group.privacidade || 'Público';
              $('#editCategoria').value = state.group.categoria || '';
              $('#editSubcategoria').value = state.group.subcategoria || '';
            }
          });
        }catch(e){
          // fallback se não existir onAuthStateChanged
          state.user = window.auth?.currentUser || null;
          await refreshAll();
          renderRolesList();
        }

        // presença offline (melhor esforço)
        window.addEventListener('beforeunload', ()=>{
          const u = state.user;
          if(u && window.marcarComoOffline) window.marcarComoOffline(u.uid);
        });

        // atualiza roles list quando abrir modal
        $('#modalRoles').addEventListener('transitionend', renderRolesList);
        $('#btnEdit').addEventListener('click', ()=>{
          if(state.group){
            $('#editNome').value = state.group.nome || '';
            $('#editDesc').value = state.group.descricao || '';
            $('#editTipo').value = state.group.tipo || 'Pro';
            $('#editPrivacidade').value = state.group.privacidade || 'Público';
            $('#editCategoria').value = state.group.categoria || '';
            $('#editSubcategoria').value = state.group.subcategoria || '';
          }
        });
      }

      window.addEventListener('load', main);
    })();
  </script>
</body>
</html>
