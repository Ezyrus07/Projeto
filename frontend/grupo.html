<!DOCTYPE html>
<html lang="pt-br">
<head>

  <!-- Supabase (UMD) + init + compat (Firestore/Auth) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-init.js"></script>
  <script src="firebase-compat-supabase.js"></script>
  <script src="firebase-auth-compat-supabase.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grupo | Doke</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="style.css">
    <script src="script.js" defer></script>
    <script src="comunidades-supabase-patch.js" defer></script>
    <style>
        /* ======================================================
           ESTILOS ESPECÍFICOS DA PÁGINA COMUNIDADES
           ====================================================== */
        
        body { background: linear-gradient(180deg, var(--cor2) 0%, var(--cor4) 200px); }

        main { padding: 20px; max-width: 1600px; }
        @media (min-width: 1024px) {
            main { margin-left: 270px; padding: 30px 40px; width: auto; }
        }

        .comm-hero-container {
                background: radial-gradient(1200px 500px at 50% 0%, rgba(255, 255, 255, 0.20), transparent 55%), linear-gradient(135deg, #1f4d75 0%, #13324f 55%, #0b7768 140%);
            padding: 40px; border-radius: 20px; margin-bottom: 40px;
            color: white; box-shadow: 0 10px 30px rgba(42, 95, 144, 0.25);
            position: relative; overflow: hidden;
        }
        .comm-hero-container::before {
            content: ''; position: absolute; top: -50px; right: -50px;
            width: 200px; height: 200px; background: rgba(255,255,255,0.05);
            border-radius: 50%; pointer-events: none;
        }

        .comm-header {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 30px; flex-wrap: wrap; gap: 20px; position: relative; z-index: 2;
        }
        .comm-title h1 { color: white; font-size: 2.2rem; margin-bottom: 8px; font-weight: 700; }
        .comm-title p { color: rgba(255,255,255,0.85); font-size: 1rem; max-width: 500px; }

        .header-actions { display: flex; gap: 15px; align-items: center; }
        .search-bar-comm {
            display: flex; align-items: center; background: white;
            padding: 12px 20px; border-radius: 50px; width: 320px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: 0.3s;
        }
        .search-bar-comm input { background: transparent; border: none; outline: none; width: 100%; color: #333; }
        
        .btn-create-comm {
            background: #00d2d3; color: #005f5f; border: none; padding: 12px 25px;
            border-radius: 30px; font-weight: 700; cursor: pointer; display: flex; 
            align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(0, 210, 211, 0.3);
            transition: 0.2s; white-space: nowrap;
        }
        .btn-create-comm:hover { background: #fff; color: var(--cor2); }

        /* Meus Grupos */
        .my-groups-section { position: relative; z-index: 2; }
        .section-label { color: white; font-size: 0.85rem; font-weight: 700; margin-bottom: 15px; text-transform: uppercase; opacity: 0.8; }
        .groups-scroll { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; min-height: 90px; }
        .my-group-item { display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer; min-width: 80px; transition: 0.2s; }
        .group-img-ring {
            width: 70px; height: 70px; border-radius: 20px; padding: 3px;
            background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center;
        }
        .group-img-ring img { width: 100%; height: 100%; border-radius: 17px; object-fit: cover; background: white; }
        .my-group-item span { color: white; font-size: 0.8rem; font-weight: 600; text-align: center; }

        /* Layout Principal */
        .comm-layout { display: grid; grid-template-columns: 1fr 350px; gap: 30px; }
        .filter-tabs { display: flex; gap: 12px; margin-bottom: 25px; overflow-x: auto; }
        .tab-btn {
            padding: 10px 24px; border: 1px solid #e0e0e0; background: white; border-radius: 30px;
            font-weight: 600; color: #555; cursor: pointer; white-space: nowrap; transition: 0.2s;
        }
        .tab-btn.active { background: var(--cor2); color: white; border-color: var(--cor2); }

        .grid-comunidades { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        
        .card-comm {
            background: white; border-radius: 16px; overflow: hidden;
            border: 1px solid #eee; transition: 0.3s; display: flex; flex-direction: column;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer;
        }
        .card-comm:hover { transform: translateY(-5px); box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
        .card-cover { height: 110px; background-size: cover; background-position: center; position: relative; background-color: #eee; }
        .card-tag {
            position: absolute; top: 10px; right: 10px; padding: 4px 12px;
            border-radius: 20px; font-size: 0.7rem; font-weight: 700; color: white; text-transform: uppercase;
        }
        .tag-pro { background: var(--cor0); }
        .tag-condo { background: var(--cor2); }
        .tag-hobby { background: #9b59b6; }

        .card-body { padding: 18px; margin-top: -40px; flex: 1; display: flex; flex-direction: column; }
        .card-icon {
            width: 64px; height: 64px; border-radius: 16px; background: white;
            padding: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 12px; position: relative; z-index: 2;
        }
        .card-icon img { width: 100%; height: 100%; border-radius: 12px; object-fit: cover; }
        .card-title { font-size: 1.15rem; font-weight: 700; color: #333; margin-bottom: 6px; }
        .card-desc { font-size: 0.9rem; color: #666; margin-bottom: 15px; line-height: 1.5; }
        .members-preview { display: flex; align-items: center; margin-bottom: 15px; margin-top: auto; }
        .mem-avatar { width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; margin-left: -10px; background:#ddd; }
        .mem-count { font-size: 0.8rem; color: #888; margin-left: 10px; font-weight: 500; }
        .card-footer { padding: 15px 18px; border-top: 1px solid #f5f5f5; background: #fafafa; }
        .btn-entrar { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: white; color: #555; font-weight: 700; cursor: pointer; }
        .btn-entrar:hover { background: var(--cor2); color: white; border-color: var(--cor2); }

        /* Sidebar Widgets */
        .widget-box { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #eee; margin-bottom: 25px; }
        .widget-title { font-size: 1.1rem; font-weight: 700; color: var(--cor2); margin-bottom: 20px; border-bottom: 2px solid #f5f5f5; padding-bottom: 10px; }
        .topic-item { display: flex; gap: 15px; margin-bottom: 15px; }
        .topic-icon { width: 40px; height: 40px; background: #f0f7ff; color: var(--cor2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; flex-shrink: 0; }
        
        /* Modal Criar */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-card { background: white; width: 90%; max-width: 500px; border-radius: 16px; padding: 30px; position: relative; animation: zoomIn 0.3s; }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .form-label { display: block; font-weight: 600; margin-bottom: 8px; color: #444; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; outline: none; }
        .btn-submit-modal { width: 100%; padding: 14px; background: var(--cor2); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }

        @media (max-width: 768px) {
            .comm-layout { display: flex; flex-direction: column; }
            .comm-hero-container { padding: 30px 20px; border-radius: 0 0 20px 20px; margin: -20px -15px 30px -15px; }
            .comm-header { flex-direction: column; align-items: flex-start; }
            .search-bar-comm, .btn-create-comm { width: 100%; justify-content: center; }
            .grid-comunidades { grid-template-columns: 1fr; }
            main { margin-left: 0 !important; padding: 20px !important; }
        }
    </style>

  <!-- Supabase (UMD) + init + compat (Firestore/Auth) -->

<style>
/* =========================
   DOKE - Grupo (layout)
   Mantém header/sidebar do site
   ========================= */
.grupo-page{ padding: 14px 18px 30px; }
.grupo-page{
  /* deixa a coluna do meio (conversas/feed) mais larga */
  max-width: 1600px;
  margin: 0 auto;
}
.grupo-grid{
  display:grid;
  /* laterais menores para sobrar mais espaço no centro */
  grid-template-columns: minmax(0, 1fr) 320px;
  gap: 18px;
  align-items: start;
}

.grupo-sidecol{
  display:flex;
  flex-direction:column;
  gap: 18px;
  min-width:0;
}
.grupo-pane{
  background:#fff;
  border-radius:18px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.06);
  overflow:hidden;
  max-height: calc(100vh - 160px);
  display:flex;
  flex-direction:column;
}
.grupo-pane.scroll{ overflow:auto; }

.grupo-nav .grupo-nav-head{
  padding: 16px;
  border-bottom: 1px solid #eef0f4;
  display:flex;
  gap: 10px;
  align-items:center;
}
.btn-voltar{
  width:42px;height:42px;border-radius:12px;
  border:1px solid #eef0f4; background:#fff;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
}
.grupo-nav-title{ font-weight:800; color:#1d2b3a; }

.grupo-channels{ padding: 12px; display:flex; flex-direction:column; gap:10px; }
.grupo-channel{
  display:flex; align-items:center; gap:10px;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid #eef0f4;
  background:#fff;
  cursor:pointer;
  font-weight:700;
  color:#1f2d3d;
}
.grupo-channel i{ font-size:18px; color: var(--cor2); }
.grupo-channel.active{ background: rgba(42,95,144,0.08); border-color: rgba(42,95,144,0.25); }

.grupo-admin-mini{ padding: 0 12px 14px; }

.grupo-center{ overflow:hidden; }
.grupo-center .inner{ overflow:auto; padding-bottom: 16px; }

.grupo-hero{ border-bottom: 1px solid #eef0f4; }
.grupo-cover{
  height: 190px;
  background: linear-gradient(120deg, #2a5f90, #7b2cbf);
  background-size: cover;
  background-position:center;
}
.grupo-hero-info{
  padding: 14px 16px 16px;
  display:flex;
  gap: 14px;
  align-items:flex-end;
  justify-content:space-between;
}
.grupo-hero-left{ display:flex; gap: 14px; align-items:flex-end; min-width:0; }
.grupo-avatar{
  width:74px;height:74px;border-radius:18px;
  background:#fff;
  border:1px solid #eef0f4;
  margin-top:-42px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.08);
  display:flex; align-items:center; justify-content:center;
  overflow:hidden;
}
.grupo-avatar img{ width:100%; height:100%; object-fit:cover; }
.grupo-avatar .initial{
  width:100%; height:100%;
  display:flex; align-items:center; justify-content:center;
  font-weight:900; font-size: 22px;
  color:#1f2d3d;
  background: linear-gradient(120deg, rgba(42,95,144,0.12), rgba(123,44,191,0.10));
}

.grupo-hero-text{ min-width:0; }
.grupo-hero-text h2{
  margin:0; font-size: 1.25rem;
  color:#1d2b3a; font-weight: 900;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.grupo-hero-text p{
  margin:6px 0 0; color:#5b6674;
  font-weight:600;
  overflow:hidden; text-overflow:ellipsis;
  display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
}
.grupo-meta{ margin-top: 8px; color:#7a8696; font-weight:700; font-size: 0.92rem; }

.grupo-hero-actions{ display:flex; gap: 10px; flex-wrap:wrap; justify-content:flex-end; }
.btn-icon-mini{
  width:42px; height:42px;
  border-radius: 14px;
  border: 1px solid #eef0f4;
  background:#fff;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
}
.btn-icon-mini i{ font-size: 20px; color:#1f2d3d; }
.btn-icon-mini.primary{ background: var(--cor2); border-color: rgba(0,0,0,0.05); }
.btn-icon-mini.primary i{ color:#fff; }

.grupo-composer{
  margin: 16px;
  border:1px solid #eef0f4;
  border-radius: 18px;
  background:#fff;
  box-shadow: 0 10px 25px rgba(0,0,0,0.04);
}
.grupo-composer textarea{
  width:100%;
  min-height: 84px;
  border:none;
  outline:none;
  padding: 14px 14px 6px;
  resize: vertical;
  font-weight:700;
  color:#1d2b3a;
}
.composer-actions{
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 10px 12px 12px;
}
.btn-icon{
  width:44px;height:44px;border-radius:14px;
  border:1px solid #eef0f4; background:#fff;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
}
.btn-icon i{ font-size:20px; color:#1f2d3d; }
.composer-hint{
  flex:1;
  display:flex; align-items:center; gap:8px;
  color:#7a8696; font-weight:700;
  padding-left: 4px;
  min-width:0;
}
.composer-hint i{ font-size:18px; color: var(--cor2); }
.btn-send{
  width:46px;height:46px;border-radius:16px;
  border:none;
  background: var(--cor2);
  color:#fff;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
}
.btn-send i{ font-size:20px; }

.grupo-feed{ padding: 0 16px 16px; display:flex; flex-direction:column; gap: 14px; }
.post-card{
  border:1px solid #eef0f4;
  border-radius: 18px;
  background:#fff;
  overflow:hidden;
  box-shadow: 0 10px 22px rgba(0,0,0,0.04);
}
.post-head{
  padding: 12px 14px;
  display:flex; align-items:center; justify-content:space-between;
}
.post-user{
  display:flex; align-items:center; gap:10px; min-width:0;
}
.post-user .avatar{
  width:38px;height:38px;border-radius:12px;
  background: #f1f4f9;
  overflow:hidden;
  display:flex; align-items:center; justify-content:center;
  font-weight:900;
  color:#1f2d3d;
}
.post-user .avatar img{ width:100%; height:100%; object-fit:cover; }
.post-user .name{
  font-weight:900;
  color:#1d2b3a;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.post-time{ color:#7a8696; font-weight:700; font-size: 0.9rem; }
.post-body{ padding: 0 14px 14px; color:#2a3340; font-weight:700; line-height: 1.35; }
.post-media{
  margin-top: 10px;
  border-radius: 16px;
  overflow:hidden;
  border: 1px solid #eef0f4;
}
.post-media img, .post-media video{
  width:100%;
  display:block;
  aspect-ratio: 16/9;
  object-fit: cover;
}

.empty-state{
  border:1px dashed rgba(42,95,144,0.35);
  border-radius: 18px;
  padding: 18px;
  background: rgba(42,95,144,0.05);
}
.empty-state h3{ margin:0; font-weight: 900; color:#1d2b3a; }
.empty-state p{ margin:6px 0 0; color:#6b7686; font-weight:700; }

.membros-head{
  padding: 16px;
  border-bottom: 1px solid #eef0f4;
  display:flex; align-items:flex-end; justify-content:space-between;
}
.membros-head h3{ margin:0; font-weight: 900; color:#1d2b3a; }
.membros-head small{ color:#7a8696; font-weight:800; }
.membros-section{ padding: 12px 14px; }
.membros-title{ color:#7a8696; font-weight: 900; letter-spacing: 0.05em; font-size: 0.82rem; margin-bottom: 8px; }
.membros-list{ display:flex; flex-direction:column; gap: 10px; }
.membro-item{
  display:flex; align-items:center; justify-content:space-between;
  gap: 10px;
  padding: 10px 10px;
  border: 1px solid #eef0f4;
  border-radius: 14px;
}
.membro-left{ display:flex; align-items:center; gap: 10px; min-width:0; }
.membro-avatar{
  width:34px;height:34px;border-radius: 12px;
  background:#f1f4f9;
  overflow:hidden;
  display:flex; align-items:center; justify-content:center;
  font-weight:900;
  color:#1f2d3d;
}
.membro-avatar img{ width:100%; height:100%; object-fit:cover; }
.membro-name{
  font-weight: 900; color:#1d2b3a;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.membro-badge{
  font-weight: 900;
  font-size: 0.82rem;
  color: #1f2d3d;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid #eef0f4;
  background:#fff;
}
.membro-badge.dono{
  border-color: rgba(42,95,144,0.35);
  background: rgba(42,95,144,0.08);
  color: var(--cor2);
}

@media (max-width: 1100px){
  .grupo-grid{ grid-template-columns: minmax(0, 1fr) 300px; }
  .grupo-members{ display:none; }
}
@media (max-width: 820px){
  .grupo-page{ padding: 10px 10px 80px; }
  .grupo-grid{ grid-template-columns: 1fr; }
  .grupo-pane{ max-height: none; }
  .grupo-sidecol{ order: 2; }
  .grupo-center{ order: 1; }
}
</style>

</head>
<body>

        <header class="navbar-desktop">
        <div id="logo-desktop">
            <a href="projeto.html">
                <img src="assets/Imagens/doke-logo.png" alt="Doke">
            </a>
        </div>
        <nav class="menu">
            <div class="cep-wrapper">
                <a href="#" class="cep" id="linkCep" onclick="toggleCep(event)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                    </svg>
                    <span id="textoCepSpan">Informe seu CEP</span>
                </a>

                <div class="cep-popup" id="boxCep">
                    <p>Digite seu CEP:</p>
                    <div class="cep-input-group">
                        <input type="text" id="inputCep" placeholder="00000-000" maxlength="9">
                        <button onclick="salvarCep()">OK</button>
                    </div>
                </div>
            </div>
            
            <a href="anunciar.html">Anuncie seu serviço</a>
            <a href="comunidade.html ">Comunidades <span class="badge-novo1">NOVO</span></a>
            <a href="novidades.html">Novidades</a>
        </nav>

        <div class="botoes-direita">
            <a href="login.html" class="entrar">Entrar</a>
            <a href="login.html">
            </a>
        </div>
    </header>

    <aside class="sidebar-icones">
        <div id="logo"><a href="index.html"><img src="assets/Imagens/doke-logo.png" alt="Doke"></a></div>
        <div class="item"><a href="index.html"><img src="https://cdn-icons-png.flaticon.com/512/1946/1946436.png" class="icon azul"><span>Início</span></a></div>
        <div class="item"><a href="explorar.html"><img src="https://cdn-icons-png.flaticon.com/512/622/622669.png" class="icon verde"><span>Explorar</span></a></div>
        <div class="item"><a href="notificacoes.html"><img src="https://cdn-icons-png.flaticon.com/512/1827/1827392.png" class="icon azul"><span>Notificações</span></a></div>
        <div class="item"><a href="chat.html"><img src="https://cdn-icons-png.flaticon.com/512/561/561127.png" class="icon azul"><span>Mensagens</span></a></div>
        <div class="item active"><a href="comunidade.html"><img src="https://cdn-icons-png.flaticon.com/512/1144/1144760.png" class="icon verde"><span>Comunidades</span></a></div>
        <div class="item"><a href="meuperfil.html"><img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="icon verde"><span>Perfil</span></a></div>
        <div class="item"><a href="mais.html"><img src="https://cdn-icons-png.flaticon.com/512/56/56763.png" class="icon azul"><span>Mais</span></a></div>
    </aside>

    <header class="navbar-mobile">
        <div id="logo-mobile"><a href="index.html"><img src="assets/Imagens/doke-logo.png" alt="Doke" style="height:25px;"></a></div>
        <button id="btn-menu-mobile" onclick="abrirMenuMobile()"><i class='bx bx-menu' style="font-size:30px; color:var(--cor2);"></i></button>
    </header>
    <div id="overlay-menu" onclick="fecharMenuMobile()"></div>

    
<main>
  <div class="grupo-page">
    <div class="grupo-grid">
<section class="grupo-pane grupo-center">
        <div class="inner">
          <div class="grupo-hero">
            <div class="grupo-cover" id="grupoCover"></div>
            <div class="grupo-hero-info">
              <div class="grupo-hero-left">
                <div class="grupo-avatar" id="grupoAvatar"><div class="initial">…</div></div>
                <div class="grupo-hero-text">
                  <h2 id="grupoNome">Carregando…</h2>
                  <p id="grupoDesc"></p>
                  <div class="grupo-meta">
                    <span id="grupoTipo"></span> <span id="grupoMetaSep">·</span> <span id="grupoMembrosCount"></span>
                  </div>
                </div>
              </div>
              <div class="grupo-hero-actions">
                <button class="btn-icon-mini" id="btnCopiarLink" title="Copiar link"><i class='bx bx-link'></i></button>
                <button class="btn-icon-mini" id="btnAbrirArquivos" title="Arquivos"><i class='bx bx-folder-open'></i></button>
                <button class="btn-icon-mini" id="btnConfigGrupo" title="Configurações" style="display:none;"><i class='bx bx-cog'></i></button>
              </div>
            </div>
          </div>

          <div class="grupo-composer" id="composerBox">
            <textarea id="postTexto" placeholder="Escreva um post para o grupo..."></textarea>
            <div class="composer-actions">
              <label class="btn-icon" title="Anexar">
                <i class='bx bx-paperclip'></i>
                <input type="file" id="postArquivo" accept="image/*,video/*,application/pdf" hidden>
              </label>

              <div class="composer-hint"><i class='bx bx-shield-quarter'></i> Respeite as regras do grupo.</div>

              <button class="btn-send" id="btnEnviarPost" title="Postar"><i class='bx bx-send'></i></button>
            </div>
          </div>

          <div class="grupo-feed" id="grupoFeed">
            <div class="empty-state" id="feedEmpty" style="display:none;">
              <h3>Sem posts ainda</h3>
              <p>Seja o primeiro a postar no grupo.</p>
            </div>
          </div>

          <!-- Área Arquivos (placeholder real: lista vazia até você plugar Storage) -->
          <div class="grupo-feed" id="tabArquivos" style="display:none; padding-top:16px;">
            <div class="empty-state">
              <h3>Nenhum arquivo enviado</h3>
              <p>Quando você ligar o Storage do Supabase, os arquivos do grupo aparecem aqui.</p>
            </div>
          </div>

          <!-- Área Sobre -->
          <div class="grupo-feed" id="tabSobre" style="display:none; padding-top:16px;">
            <div class="post-card" style="padding:14px;">
              <div style="font-weight:900; color:#1d2b3a; margin-bottom:8px;">Sobre o grupo</div>
              <div id="sobreTexto" style="font-weight:700; color:#2a3340; line-height:1.4;"></div>
            </div>
          </div>
        </div>
      </section>

      <div class="grupo-sidecol">
        <section class="grupo-pane grupo-nav">
        <div class="grupo-nav-head">
          <button class="btn-voltar" onclick="history.back()" title="Voltar"><i class='bx bx-left-arrow-alt' style="font-size:22px; color:var(--cor2);"></i></button>
          <div class="grupo-nav-title" id="navGrupoNome">Grupo</div>
        </div>
        <div class="grupo-channels">
          <button class="grupo-channel active" data-tab="feed"><i class='bx bx-hash'></i> Feed</button>
          <button class="grupo-channel" data-tab="arquivos"><i class='bx bx-folder'></i> Arquivos</button>
          <button class="grupo-channel" data-tab="sobre"><i class='bx bx-info-circle'></i> Sobre</button>
        </div>

        <!-- Admin (Dono/Mod): fica escondido em "Configurações" (não ocupa espaço) -->
        <div class="grupo-admin-mini" id="grupoAdminMini" style="display:none;">
          <button class="grupo-channel" id="btnAbrirConfig" data-tab="config"><i class='bx bx-cog'></i> Configurações</button>
        </div>
      </section>

        <section class="grupo-pane grupo-members">
        <div class="membros-head">
          <h3>Membros</h3>
          <small id="membrosSub">—</small>
        </div>

        <div class="membros-section">
          <div class="membros-title">ONLINE (<span id="countOnline">0</span>)</div>
          <div class="membros-list" id="listaOnline"></div>
        </div>

        <div class="membros-section">
          <div class="membros-title">OFFLINE (<span id="countOffline">0</span>)</div>
          <div class="membros-list" id="listaOffline"></div>
        </div>
      </section>
      </div>
    </div>
  </div>
</main>

<!-- Configurações do grupo (somente Dono/Mods) -->
<div id="modalGrupoConfig" class="modal-overlay" aria-hidden="true">
  <div class="modal-card" style="max-width:560px;">
    <button id="btnFecharConfig" style="position:absolute; top:15px; right:15px; border:none; background:none; font-size:1.6rem; cursor:pointer;">&times;</button>
    <h2 style="margin-bottom:8px; color:var(--cor2);">Configurações do grupo</h2>
    <p style="margin:0 0 16px; color:#667085; font-weight:700;">Ajustes rápidos (apenas para o dono/mods).</p>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:16px;">
      <button id="tabCfgEditar" class="tab-btn active" type="button">Editar</button>
      <button id="tabCfgCargos" class="tab-btn" type="button">Cargos</button>
    </div>

    <div id="cfgEditar">
      <label class="form-label">Nome do grupo</label>
      <input type="text" id="cfgNome" class="form-input" placeholder="" />
      <label class="form-label">Descrição</label>
      <textarea id="cfgDesc" class="form-textarea" placeholder=""></textarea>
      <button id="btnSalvarGrupo" class="btn-submit-modal" type="button">Salvar alterações</button>
    </div>

    <div id="cfgCargos" style="display:none;">
      <div style="background:#f7f9fc; border:1px solid #eef0f4; border-radius:12px; padding:12px; margin-bottom:12px;">
        <div style="font-weight:900; color:#1d2b3a; margin-bottom:6px;">Cargos do grupo</div>
        <div style="color:#667085; font-weight:700; font-size:0.95rem;">Para ativar cargos, crie a tabela <b>comunidade_cargos</b> no Supabase (com as colunas <b>comunidade_id</b>, <b>nome</b>, <b>cor</b> e <b>ordem</b>).</div>
      </div>

      <div style="display:flex; gap:10px; align-items:center; margin-bottom:12px;">
        <input id="cargoNome" class="form-input" style="margin:0;" placeholder="Nome do cargo (ex: Moderador)" />
        <input id="cargoCor" class="form-input" style="margin:0; width:120px;" placeholder="#2a5f90" />
        <button id="btnCriarCargo" class="btn-prim" type="button" style="white-space:nowrap;">Criar</button>
      </div>
      <div id="listaCargos" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>
  </div>
</div>


    <nav class="bottom-nav">
        <a href="index.html" class="item"><img src="https://cdn-icons-png.flaticon.com/512/1946/1946436.png" class="icon azul"><span>Início</span></a>
        <a href="comunidade.html" class="item active"><img src="https://cdn-icons-png.flaticon.com/512/1144/1144760.png" class="icon verde"><span>Grupos</span></a>
        <a href="meuperfil.html" class="item"><img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="icon verde"><span>Perfil</span></a>
    </nav>

<script>
(function(){
  // Toast simples (sem alert)
  function toast(title, msg){
    try{
      const t = document.createElement('div');
      t.style.position='fixed';
      t.style.right='16px';
      t.style.bottom='16px';
      t.style.zIndex='99999';
      t.style.maxWidth='360px';
      t.style.background='#111827';
      t.style.color='#fff';
      t.style.padding='12px 14px';
      t.style.borderRadius='14px';
      t.style.boxShadow='0 20px 40px rgba(0,0,0,0.35)';
      t.innerHTML = '<div style="font-weight:900; margin-bottom:4px;">'+(title||'')+'</div><div style="opacity:0.9; font-weight:700; font-size:0.92rem;">'+(msg||'')+'</div>';
      document.body.appendChild(t);
      setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .25s'; }, 2500);
      setTimeout(()=>{ t.remove(); }, 2850);
    }catch(e){}
  }

  const $ = (id)=>document.getElementById(id);
  const qs = (k)=>new URLSearchParams(window.location.search).get(k);

  async function waitGlobals(){
    const t0 = Date.now();
    while(Date.now()-t0 < 8000){
      if(window.db && window.doc && window.getDoc && window.auth) return true;
      await new Promise(r=>setTimeout(r, 80));
    }
    return false;
  }

  function setCover(url){
    const el = $('grupoCover');
    if(!el) return;
    if(url){
      el.style.backgroundImage = 'url('+url+')';
      el.style.backgroundSize = 'cover';
      el.style.backgroundPosition = 'center';
    }else{
      // fica o gradiente padrão do CSS
      el.style.backgroundImage = '';
    }
  }

  function setAvatar(url, initial){
    const box = $('grupoAvatar');
    if(!box) return;
    if(url){
      box.innerHTML = '<img src="'+url+'" alt="capa" onerror="this.remove();">';
    }else{
      box.innerHTML = '<div class="initial">'+(initial||'D')+'</div>';
    }
  }

  function safeText(v){ return (v==null?'':String(v)); }

  async function getUserDoc(uid){
    try{
      const ref = window.doc(window.db, "usuarios", uid);
      const snap = await window.getDoc(ref);
      if(!snap.exists()) return null;
      return snap.data();
    }catch(e){ return null; }
  }

  function pickUserName(u){
    return u?.user || u?.usuario || u?.nome || u?.name || u?.apelido || 'Usuário';
  }
  function pickUserPhoto(u){
    return u?.foto || u?.foto_url || u?.photoURL || u?.avatar || u?.imagem || '';
  }

  async function renderMembersFallback(grupo, uidAtual){
    const membros = Array.isArray(grupo?.membros) ? grupo.membros : [];
    const donoUid = grupo?.donoUid || grupo?.dono_uid || null;

    // online: só o usuário atual (fallback)
    const online = uidAtual ? [uidAtual] : [];
    const offline = membros.filter(x=>!online.includes(x));

    async function renderList(targetId, uids, badgeFn){
      const box = $(targetId);
      if(!box) return;
      box.innerHTML = '';
      for(const uid of uids){
        const udoc = await getUserDoc(uid);
        const nome = pickUserName(udoc);
        const foto = pickUserPhoto(udoc);
        const initial = (nome?.trim()?.[0] || 'U').toUpperCase();
        const badge = badgeFn(uid);
        const badgeClass = badge === 'Dono' ? 'membro-badge dono' : 'membro-badge';
        const item = document.createElement('div');
        item.className='membro-item';
        item.innerHTML = `
          <div class="membro-left">
            <div class="membro-avatar">${foto ? `<img src="${foto}" onerror="this.remove()">` : initial}</div>
            <div class="membro-name">${safeText(nome)}</div>
          </div>
          <div class="${badgeClass}">${badge}</div>
        `;
        box.appendChild(item);
      }
    }

    const badgeFn = (uid)=> (uid && donoUid && uid===donoUid) ? 'Dono' : 'Membro';

    $('countOnline').textContent = online.length;
    $('countOffline').textContent = offline.length;
    $('membrosSub').textContent = (grupo?.membrosCount || membros.length || 0) + ' no total';

    await renderList('listaOnline', online, badgeFn);
    await renderList('listaOffline', offline, badgeFn);
  }

  async function supa(){
    try{
      if(typeof window.getSupabaseClient === "function") return window.getSupabaseClient();
      if(typeof getSupabaseClient === "function") return getSupabaseClient();
    }catch(e){}
    return window.sb || window.supabaseClient || window.sbClient || null;
  }

  async function tableExists(client, table){
    try{
      const { error } = await client.from(table).select('*').limit(1);
      if(!error) return true;
      // PGRST205 = table missing
      if(String(error?.code||'') === 'PGRST205') return false;
      return true; // outras falhas (RLS) -> existe
    }catch(e){ return false; }
  }

  async function loadPosts(grupoId){
    const client = await supa();
    const feed = $('grupoFeed');
    const empty = $('feedEmpty');
    if(!feed || !client) return;

    const idCols = ['comunidade_id','comunidadeId','comunidade','grupo_id','grupoId'];
    const orderCols = ['criado_em','created_at','criadoEm','data','timestamp'];

    let data = null, lastErr = null, usedIdCol = null;
    for(const col of idCols){
      const q = client.from('comunidade_posts').select('*').eq(col, grupoId).limit(50);
      // tenta ordenar pelo melhor campo disponível
      let resp;
      for(const ocol of orderCols){
        resp = await q.order(ocol, { ascending:false });
        if(!resp.error) break;
      }
      if(resp && !resp.error){
        data = resp.data || [];
        usedIdCol = col;
        break;
      }
      lastErr = resp?.error || lastErr;
    }

    // Se não conseguiu filtrar por colunas conhecidas, tenta buscar sem filtro (não ideal) e filtrar local por comunidade_id/… se existir
    if(data === null){
      const resp = await client.from('comunidade_posts').select('*').limit(50);
      if(!resp.error){
        const all = resp.data || [];
        data = all.filter(p=>{
          return (p.comunidade_id===grupoId || p.comunidadeId===grupoId || p.grupo_id===grupoId || p.grupoId===grupoId || p.comunidade===grupoId);
        });
      }else{
        lastErr = resp.error;
        data = [];
      }
    }

    // Render
    // Remove cards antigos (mantém empty-state)
    Array.from(feed.querySelectorAll('.post-card')).forEach(n=>n.remove());

    if(!data || data.length===0){
      if(empty) empty.style.display='block';
      return;
    }
    if(empty) empty.style.display='none';

    for(const p of data){
      const uid = p.user_uid || p.uid || p.autor_uid || p.autor || p.userId || null;
      const udoc = uid ? await getUserDoc(uid) : null;
      const nome = pickUserName(udoc);
      const foto = pickUserPhoto(udoc);
      const initial = (nome?.trim()?.[0] || 'U').toUpperCase();

      const texto = p.texto || p.conteudo || p.mensagem || p.content || p.descricao || '';
      const created = p.criado_em || p.created_at || p.data || p.timestamp || null;
      const time = created ? new Date(created).toLocaleString('pt-BR') : '';

      const media = p.midia || p.imagem || p.imagem_url || p.media_url || p.arquivo_url || p.url || '';
      const mediaType = (p.tipo || p.media_type || '').toString().toLowerCase();

      const card = document.createElement('div');
      card.className='post-card';
      card.innerHTML = `
        <div class="post-head">
          <div class="post-user">
            <div class="avatar">${foto ? `<img src="${foto}" onerror="this.remove()">` : initial}</div>
            <div class="name">${safeText(nome)}</div>
          </div>
          <div class="post-time">${safeText(time)}</div>
        </div>
        <div class="post-body">
          ${safeText(texto)}
          ${media ? `
            <div class="post-media">
              ${(mediaType.includes('video') || (String(media).match(/\.mp4|\.webm|\.ogg/i))) 
                ? `<video src="${media}" controls></video>`
                : `<img src="${media}" onerror="this.style.display='none'">`}
            </div>
          ` : ``}
        </div>
      `;
      feed.appendChild(card);
    }
  }

  async function tryInsertPost(grupoId, uid, texto){
    const client = await supa();
    if(!client) throw new Error('Supabase não disponível');
    // tenta vários formatos de schema
    const candidates = [
      { comunidade_id: grupoId, user_uid: uid, texto: texto, criado_em: new Date().toISOString() },
      { comunidade_id: grupoId, uid: uid, texto: texto, created_at: new Date().toISOString() },
      { comunidadeId: grupoId, uid: uid, conteudo: texto, created_at: new Date().toISOString() },
      { grupo_id: grupoId, uid: uid, conteudo: texto, created_at: new Date().toISOString() },
      { grupoId: grupoId, user_uid: uid, mensagem: texto, data: new Date().toISOString() },
    ];
    let lastErr = null;
    for(const obj of candidates){
      const { error } = await client.from('comunidade_posts').insert(obj);
      if(!error) return true;
      lastErr = error;
    }
    throw lastErr || new Error('Falha ao postar');
  }

  async function init(){
    const ok = await waitGlobals();
    if(!ok){
      toast('Erro', 'Dependências do site não carregaram.');
      return;
    }

    const grupoId = qs('id');
    if(!grupoId){
      toast('Grupo não encontrado', 'URL sem parâmetro id.');
      return;
    }

    // Buscar grupo (coleção comunidades via compat)
    let grupo = null;
    try{
      const ref = window.doc(window.db, "comunidades", grupoId);
      const snap = await window.getDoc(ref);
      if(!snap.exists()){
        toast('Grupo não existe', 'ID não encontrado.');
        return;
      }
      grupo = snap.data();
    }catch(e){
      console.error(e);
      toast('Erro', 'Falha ao buscar o grupo.');
      return;
    }

    // Preencher UI
    const nome = grupo?.nome || 'Grupo';
    const tipo = grupo?.tipo || '';
    const desc = grupo?.descricao || '';
    const capa = grupo?.capa || '';
    const membrosCount = grupo?.membrosCount || (Array.isArray(grupo?.membros)?grupo.membros.length:0);

    $('grupoNome').textContent = nome;
    const navNome = $('navGrupoNome');
    if(navNome) navNome.textContent = nome;
    $('grupoTipo').textContent = tipo ? tipo : '';
    $('grupoDesc').textContent = desc ? desc : '';
    $('grupoMembrosCount').textContent = membrosCount ? (membrosCount + ' membros') : '';
    setCover(capa);
    setAvatar(capa, (nome.trim()[0]||'D').toUpperCase());

    // user atual
    const uidAtual = window.auth?.currentUser?.uid || null;
    const donoUid = grupo?.donoUid || grupo?.dono_uid || null;
    const souDono = uidAtual && donoUid && uidAtual === donoUid;

    // Admin (Dono/Mods) -> Configurações
    const modalCfg = $('modalGrupoConfig');
    const openCfg = ()=>{ if(modalCfg){ modalCfg.style.display='flex'; modalCfg.setAttribute('aria-hidden','false'); } };
    const closeCfg = ()=>{ if(modalCfg){ modalCfg.style.display='none'; modalCfg.setAttribute('aria-hidden','true'); } };

    function getSB(){
      return window.supabaseClient || window.supabase || (typeof window.getSupabaseClient==='function' ? window.getSupabaseClient() : null);
    }

    async function loadCargos(){
      const box = $('listaCargos');
      if(!box) return;
      box.innerHTML = '';
      const sb = getSB();
      if(!sb || typeof sb.from !== 'function'){
        box.innerHTML = '<div style="color:#667085; font-weight:800;">Supabase client não disponível nesta página.</div>';
        return;
      }
      try{
        const { data, error } = await sb.from('comunidade_cargos').select('*').eq('comunidade_id', grupoId).order('ordem', { ascending: true });
        if(error){
          box.innerHTML = '<div style="color:#667085; font-weight:800;">Tabela <b>comunidade_cargos</b> ainda não está ativa.</div>';
          return;
        }
        if(!data || data.length===0){
          box.innerHTML = '<div style="color:#667085; font-weight:800;">Nenhum cargo criado.</div>';
          return;
        }
        data.forEach(c=>{
          const row = document.createElement('div');
          row.className = 'membro-item';
          row.innerHTML = `
            <div class="membro-left">
              <div class="membro-avatar" style="border:2px solid ${c.cor || '#eef0f4'};">${(c.nome||'?').trim().slice(0,1).toUpperCase()}</div>
              <div class="membro-name">${safeText(c.nome)}</div>
            </div>
            <div class="membro-badge" style="border-color:${c.cor || '#eef0f4'};">${safeText(c.cor||'')}</div>
          `;
          box.appendChild(row);
        });
      }catch(e){
        box.innerHTML = '<div style="color:#667085; font-weight:800;">Não foi possível carregar cargos.</div>';
      }
    }

    async function salvarGrupo(){
      const sb = getSB();
      const novoNome = safeText($('cfgNome')?.value).trim();
      const novaDesc = safeText($('cfgDesc')?.value).trim();
      if(!novoNome){ toast('Nome obrigatório', 'Digite o nome do grupo.'); return; }
      if(!sb || typeof sb.from !== 'function'){
        toast('Supabase indisponível', 'Não consegui acessar o cliente do Supabase nessa página.');
        return;
      }
      try{
        const { error } = await sb.from('comunidades').update({ nome: novoNome, descricao: novaDesc }).eq('id', grupoId);
        if(error) throw error;
        $('grupoNome').textContent = novoNome;
        if(navNome) navNome.textContent = novoNome;
        $('grupoDesc').textContent = novaDesc;
        toast('Salvo', 'Alterações atualizadas.');
        closeCfg();
      }catch(e){
        console.error(e);
        toast('Erro ao salvar', 'Verifique permissões (RLS) e nomes das colunas no Supabase.');
      }
    }

    async function criarCargo(){
      const sb = getSB();
      const nomeCargo = safeText($('cargoNome')?.value).trim();
      const corCargo = safeText($('cargoCor')?.value).trim();
      if(!nomeCargo){ toast('Cargo', 'Digite o nome do cargo.'); return; }
      if(!sb || typeof sb.from !== 'function'){
        toast('Supabase indisponível', 'Não consegui acessar o cliente do Supabase nessa página.');
        return;
      }
      try{
        const payload = { comunidade_id: grupoId, nome: nomeCargo, cor: corCargo || null };
        const { error } = await sb.from('comunidade_cargos').insert(payload);
        if(error) throw error;
        $('cargoNome').value = '';
        toast('Cargo criado', 'Agora você pode atribuir aos membros.');
        await loadCargos();
      }catch(e){
        console.error(e);
        toast('Não foi possível', 'Crie a tabela comunidade_cargos e revise o schema.');
      }
    }

    function setCfgTab(tab){
      const t1 = $('tabCfgEditar');
      const t2 = $('tabCfgCargos');
      const e1 = $('cfgEditar');
      const e2 = $('cfgCargos');
      if(tab==='cargos'){
        t1?.classList.remove('active');
        t2?.classList.add('active');
        if(e1) e1.style.display='none';
        if(e2) e2.style.display='block';
        loadCargos();
      }else{
        t2?.classList.remove('active');
        t1?.classList.add('active');
        if(e2) e2.style.display='none';
        if(e1) e1.style.display='block';
      }
    }

    if(souDono){
      const mini = $('grupoAdminMini');
      if(mini) mini.style.display = 'block';
      const btnCfgIcon = $('btnConfigGrupo');
      if(btnCfgIcon){ btnCfgIcon.style.display = 'flex'; btnCfgIcon.addEventListener('click', openCfg); }
      $('btnAbrirConfig')?.addEventListener('click', openCfg);
      $('btnFecharConfig')?.addEventListener('click', closeCfg);
      modalCfg?.addEventListener('click', (e)=>{ if(e.target===modalCfg) closeCfg(); });

      // preencher campos
      $('cfgNome').value = nome;
      $('cfgDesc').value = desc;

      $('btnSalvarGrupo')?.addEventListener('click', salvarGrupo);
      $('btnCriarCargo')?.addEventListener('click', criarCargo);
      $('tabCfgEditar')?.addEventListener('click', ()=>setCfgTab('editar'));
      $('tabCfgCargos')?.addEventListener('click', ()=>setCfgTab('cargos'));
    }

    // copiar link
    $('btnCopiarLink').addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(window.location.href);
        toast('Link copiado', 'Agora é só compartilhar.');
      }catch(e){
        toast('Não foi possível copiar', 'Seu navegador bloqueou a cópia.');
      }
    });

    // tabs
    document.querySelectorAll('.grupo-channel').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.grupo-channel').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        if(tab==='arquivos'){ toast('Arquivos', 'Os arquivos aparecem nos posts com anexos.'); }
        if(tab==='sobre'){ toast('Sobre', desc || 'Sem descrição no momento.'); }
        if(tab==='config'){ openCfg(); }
      });
    });
    $('btnAbrirArquivos').addEventListener('click', ()=>toast('Arquivos', 'Os arquivos aparecem nos posts com anexos.'));

    // members (fallback se tabelas não existem)
    await renderMembersFallback(grupo, uidAtual);

    // posts
    await loadPosts(grupoId);

    // postar
    $('btnEnviarPost').addEventListener('click', async ()=>{
      const txt = $('postTexto').value.trim();
      if(!txt){
        toast('Escreva algo', 'Digite uma mensagem para postar.');
        return;
      }
      const uid = window.auth?.currentUser?.uid || null;
      if(!uid){
        toast('Faça login', 'Você precisa estar logado para postar.');
        return;
      }
      $('btnEnviarPost').disabled = true;
      try{
        await tryInsertPost(grupoId, uid, txt);
        $('postTexto').value='';
        await loadPosts(grupoId);
        toast('Postado', 'Seu post foi enviado.');
      }catch(e){
        console.error(e);
        toast('Falha ao postar', 'Sua tabela comunidade_posts tem colunas diferentes. Me envie print das colunas que eu ajusto automático.');
      }finally{
        $('btnEnviarPost').disabled = false;
      }
    });
  }

  window.addEventListener('DOMContentLoaded', init);
})();
</script>

</body>
</html>