<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Empresas | Doke</title>

  <!-- Supabase (UMD) + init + compat -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-init.js"></script>
  <script src="firebase-compat-supabase.js"></script>
  <script src="firebase-auth-compat-supabase.js"></script>

  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="doke-layout-fix.css" />
  <link rel="stylesheet" href="doke-fixes.css" />
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

  <style>
    body{
      background: radial-gradient(1200px 600px at 10% 0%, rgba(42,95,144,.18), transparent 55%),
                  radial-gradient(900px 500px at 90% 10%, rgba(11,119,104,.16), transparent 55%),
                  #f4f6f8;
    }

    /* Wrapper do conteúdo */
    .emp-wrap{ width: 100%; max-width: 1200px; }

    .emp-hero{
      position: relative;
      overflow: hidden;
      background: radial-gradient(900px 400px at 30% 0%, rgba(255,255,255,0.20), transparent 55%),
                  linear-gradient(135deg, #1f4d75 0%, #13324f 55%, #0b7768 140%);
      color: #fff;
      border-radius: 22px;
      padding: 34px 30px;
      box-shadow: 0 14px 34px rgba(16,24,40,.18);
      border: 1px solid rgba(255,255,255,.12);
    }
    .emp-hero::after{
      content:"";
      position:absolute;
      inset:-120px -120px auto auto;
      width: 260px;
      height: 260px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      filter: blur(0px);
      transform: rotate(12deg);
      pointer-events:none;
    }
    .emp-hero h1{ margin:0; font-size: clamp(1.6rem, 2.6vw, 2.1rem); letter-spacing:-.02em; }
    .emp-hero p{ margin: 8px 0 0; opacity: .92; max-width: 820px; }

    .emp-hero-actions{
      margin-top: 18px;
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items:center;
    }
    .btn-pill{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 12px 16px;
      border-radius: 999px;
      font-weight: 800;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color:#fff;
      cursor:pointer;
      text-decoration:none;
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
    }
    .btn-pill:hover{ transform: translateY(-1px); background: rgba(255,255,255,.14); box-shadow: 0 10px 22px rgba(0,0,0,.18); }
    .btn-pill--solid{
      border: none;
      background: linear-gradient(135deg, #0b7768, #2a5f90);
      box-shadow: 0 10px 22px rgba(11,119,104,.28);
    }
    .btn-pill--solid:hover{ box-shadow: 0 14px 28px rgba(11,119,104,.34); }

    .emp-grid{
      margin-top: 22px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 18px;
    }
    @media (max-width: 980px){
      .emp-grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 20px;
      box-shadow: 0 10px 26px rgba(0,0,0,.06);
      padding: 20px;
      backdrop-filter: blur(6px);
    }
    .card h2{ margin:0 0 8px; font-size: 1.25rem; letter-spacing:-.02em; color:#102a28; }
    .muted{ color: rgba(0,0,0,.6); font-weight: 550; }

    .emp-tools{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .tool{
      flex: 1;
      min-width: 220px;
      border: 1px solid rgba(0,0,0,.08);
      background:#fff;
      border-radius: 16px;
      padding: 14px;
      display:flex;
      gap: 12px;
      cursor:pointer;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      text-decoration:none;
      color: inherit;
    }
    .tool:hover{ transform: translateY(-2px); box-shadow: 0 14px 28px rgba(0,0,0,.08); border-color: rgba(11,119,104,.25); }
    .tool i{ font-size: 22px; color: var(--cor0, #0b7768); margin-top: 1px; }
    .tool b{ display:block; }
    .tool span{ display:block; margin-top: 2px; color: rgba(0,0,0,.62); font-weight: 560; font-size: .92rem; }

    .emp-search{
      display:flex;
      gap: 10px;
      align-items:center;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .emp-search .box{
      display:flex;
      gap: 10px;
      align-items:center;
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      border-radius: 999px;
      padding: 10px 14px;
      width: min(560px, 100%);
      box-shadow: 0 10px 24px rgba(0,0,0,.05);
    }
    .emp-search input{ border:0; outline:0; width:100%; font-size: 1rem; background:transparent; }
    .emp-search .box i{ color: rgba(0,0,0,.55); font-size: 1.2rem; }

    .list{ margin-top: 14px; display:flex; flex-direction: column; gap: 10px; }
    .emp-item{
      border: 1px solid rgba(0,0,0,.07);
      background: #fff;
      border-radius: 16px;
      padding: 14px;
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content: space-between;
    }
    .emp-item .left{ display:flex; gap: 12px; align-items:center; min-width:0; }
    .emp-logo{ width: 46px; height: 46px; border-radius: 12px; background: #eef2f6; object-fit: cover; border: 1px solid rgba(0,0,0,.06); }
    .emp-name{ font-weight: 900; color: #102a28; white-space:nowrap; overflow:hidden; text-overflow: ellipsis; }
    .emp-meta{ color: rgba(0,0,0,.55); font-weight: 600; font-size: .9rem; margin-top: 2px; white-space:nowrap; overflow:hidden; text-overflow: ellipsis; }
    .emp-actions{ display:flex; gap: 8px; flex-wrap: wrap; justify-content:flex-end; }
    .btn-mini{
      border-radius: 999px;
      padding: 9px 12px;
      border: 1px solid rgba(0,0,0,.10);
      background:#fff;
      font-weight: 800;
      cursor:pointer;
    }
    .btn-mini:hover{ border-color: rgba(42,95,144,.35); }
    .btn-mini.primary{
      border: none;
      background: linear-gradient(135deg, #0b7768, #2a5f90);
      color:#fff;
    }

    .empty{
      border: 1px dashed rgba(0,0,0,.18);
      border-radius: 18px;
      padding: 18px;
      background: rgba(255,255,255,.70);
      color: rgba(0,0,0,.62);
      font-weight: 650;
    }
  </style>

  <script src="script.js" defer></script>
</head>

<body data-page="empresas">

  <!-- header (mesmo padrão do index) -->
  <header class="navbar-desktop">
    <div id="logo-desktop"><a href="projeto.html"><img src="assets/Imagens/doke-logo.png" alt="Doke"></a></div>
    <nav class="menu">
      <div class="cep-wrapper">
        <a href="#" class="cep" id="linkCep" onclick="toggleCep(event)">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
          </svg>
          <span id="textoCepSpan">Informe seu CEP</span>
        </a>
        <div class="cep-popup" id="boxCep">
          <p>Digite seu CEP:</p>
          <div class="cep-input-group"><input type="text" id="inputCep" placeholder="00000-000" maxlength="9"><button onclick="salvarCep()">OK</button></div>
        </div>
      </div>
      <a href="escolheranuncio.html">Anunciar</a>
      <a href="comunidade.html">Comunidades <span class="badge-novo1">NOVO</span></a>
      <a href="novidades.html">Novidades</a>
    </nav>
    <div class="botoes-direita"><a href="login.html" class="entrar">Entrar</a></div>
  </header>

  <!-- sidebar -->
  <aside class="sidebar-icones">
    <div id="logo">
      <a href="index.html"><img src="assets/Imagens/doke-logo.png" alt="Logotipo da plataforma Doke"></a>
    </div>

    <div class="item">
      <a href="index.html"><img src="https://cdn-icons-png.flaticon.com/512/1946/1946436.png" class="icon azul" alt="Início"><span>Início</span></a>
    </div>

    <div class="item active">
      <a href="empresas.html"><i class='bx bx-store' style="color: var(--cor2); font-size: 26px;"></i><span>Empresas</span></a>
    </div>

    <div class="item">
      <a href="notificacoes.html"><img src="https://cdn-icons-png.flaticon.com/512/1827/1827392.png" class="icon azul" alt="Notificações"><span>Notificações</span></a>
    </div>
    <div class="item">
      <img src="https://cdn-icons-png.flaticon.com/512/561/561127.png" class="icon azul" alt="Mensagens">
      <a href="chat.html"><span>Mensagens</span></a>
    </div>
    <div class="item">
      <a href="comunidade.html"><img src="https://cdn-icons-png.flaticon.com/512/1144/1144760.png" class="icon verde" alt="Comunidades"><span>Comunidades</span></a>
    </div>
    <div class="item">
      <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="icon verde" alt="Perfil">
      <a href="#" onclick="irParaMeuPerfil(event)"><span>Perfil</span></a>
    </div>
    <div class="item">
      <img src="https://cdn-icons-png.flaticon.com/512/56/56763.png" class="icon azul" alt="Mais">
      <a href="mais.html"><span>Mais</span></a>
    </div>
  </aside>

  <main>
    <div class="emp-wrap">
      <section class="emp-hero">
        <h1>Empresas na Doke</h1>
        <p>Uma área para <b>descobrir negócios</b>, <b>cadastrar sua empresa</b> e (depois) acompanhar resultados — tudo no padrão do <b>anunciar.html</b>.</p>
        <div class="emp-hero-actions">
          <a class="btn-pill btn-pill--solid" href="anunciar-negocio.html"><i class='bx bx-plus-circle'></i> Cadastrar / anunciar negócio</a>
          <a class="btn-pill" href="negocios.html"><i class='bx bx-search'></i> Descobrir negócios</a>
          <a class="btn-pill" href="index.html"><i class='bx bx-home'></i> Voltar ao início</a>
        </div>
      </section>

      <div class="emp-grid">
        <section class="card">
          <h2>Ferramentas rápidas</h2>
          <div class="muted">O que eu faria aqui (próximos passos): criar cadastro completo da empresa + catálogo, horários, cupons, avaliações, e painel com métricas.</div>
          <div class="emp-tools">
            <a class="tool" href="anunciar-negocio.html">
              <i class='bx bx-edit-alt'></i>
              <div>
                <b>Criar anúncio de negócio</b>
                <span>Publicar seu estabelecimento com fotos, mapa, catálogo e plano.</span>
              </div>
            </a>
            <a class="tool" href="negocios.html">
              <i class='bx bx-compass'></i>
              <div>
                <b>Descobrir estabelecimentos</b>
                <span>Busca + filtros + (próximo passo) mapa ao vivo.</span>
              </div>
            </a>
            <a class="tool" href="carteira.html">
              <i class='bx bx-wallet'></i>
              <div>
                <b>Carteira & pagamentos</b>
                <span>Depois conectamos com pedidos, cupons e comissões.</span>
              </div>
            </a>
          </div>

          <div class="emp-search">
            <div class="box">
              <i class='bx bx-search'></i>
              <input id="empBusca" placeholder="Buscar minhas empresas (nome, bairro, categoria...)" />
            </div>
          </div>

          <div class="list" id="minhasEmpresas">
            <div class="empty">Carregando suas empresas…</div>
          </div>
        </section>

        <aside class="card">
          <h2>Checklist de padronização</h2>
          <div class="muted">
            Para manter tudo alinhado com o site inteiro, eu faria:
            <ul style="margin:10px 0 0; padding-left: 18px; line-height: 1.5;">
              <li><b>Um componente padrão</b> de container (max 1200px), usado em todas as páginas.</li>
              <li><b>Estados vazios</b> bonitos (sem textos soltos).</li>
              <li><b>Botões</b> com a mesma família (pill/primary/ghost).</li>
              <li><b>Cards</b> com borda suave + sombra leve (igual anunciar).</li>
              <li><b>Responsividade</b>: grid vira coluna e nada fica “colado” à esquerda.</li>
            </ul>
          </div>

          <div style="margin-top: 14px; display:flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn-mini primary" type="button" id="btnNovaEmpresa">Nova empresa</button>
            <button class="btn-mini" type="button" id="btnVerNegocios">Ver negócios</button>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <script>
    // Página: Empresas — carrega "minhas empresas" com fallback seguro.
    (function(){
      const listEl = document.getElementById('minhasEmpresas');
      const input = document.getElementById('empBusca');

      const btnNova = document.getElementById('btnNovaEmpresa');
      const btnNeg = document.getElementById('btnVerNegocios');
      btnNova?.addEventListener('click', () => window.location.href = 'anunciar-negocio.html');
      btnNeg?.addEventListener('click', () => window.location.href = 'negocios.html');

      function esc(s){ return String(s??'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
      function setEmpty(msg){
        if (!listEl) return;
        listEl.innerHTML = `<div class="empty">${msg}</div>`;
      }

      async function loadEmpresas(){
        if (!window.sb){
          setEmpty('Supabase não inicializado. Confira o <b>supabase-init.js</b>.');
          return;
        }
        const user = await window.sb.auth.getUser().catch(() => null);
        const userId = user?.data?.user?.id;

        if (!userId){
          setEmpty('Entre na sua conta para ver suas empresas.');
          return;
        }

        // Tentativas (sem quebrar se a tabela não existir)
        const candidates = ['empresas', 'negocios'];
        let rows = null;
        let lastErr = null;

        for (const table of candidates){
          const { data, error } = await window.sb
            .from(table)
            .select('*')
            .eq('user_id', userId)
            .order('created_at', { ascending: false })
            .limit(50);

          if (error){ lastErr = error; continue; }
          rows = Array.isArray(data) ? data : [];
          break;
        }

        if (!rows){
          console.warn('[DOKE] Falha ao carregar empresas:', lastErr);
          setEmpty('Ainda não conseguimos buscar suas empresas (tabela não encontrada ou RLS).');
          return;
        }

        if (!rows.length){
          setEmpty('Você ainda não cadastrou nenhuma empresa. Clique em <b>Nova empresa</b>.');
          return;
        }

        render(rows);
      }

      function render(rows){
        const q = (input?.value || '').trim().toLowerCase();
        const filtered = q ? rows.filter(r => {
          const name = (r.nome || r.name || r.titulo || '').toString().toLowerCase();
          const cat = (r.categoria || r.segmento || '').toString().toLowerCase();
          const bairro = (r.bairro || r.local_bairro || '').toString().toLowerCase();
          return name.includes(q) || cat.includes(q) || bairro.includes(q);
        }) : rows;

        listEl.innerHTML = filtered.map(r => {
          const nome = r.nome || r.name || r.titulo || 'Empresa';
          const cat = r.categoria || r.segmento || 'Categoria';
          const bairro = r.bairro || r.local_bairro || '';
          const cidade = r.cidade || r.local_cidade || '';
          const local = [bairro, cidade].filter(Boolean).join(' • ');
          const logo = r.logo_url || r.foto_url || r.imagem_url || '';

          return `
            <div class="emp-item">
              <div class="left">
                <img class="emp-logo" src="${esc(logo || 'assets/Imagens/doke-logo.png')}" alt="logo" onerror="this.src='assets/Imagens/doke-logo.png'"/>
                <div style="min-width:0;">
                  <div class="emp-name">${esc(nome)}</div>
                  <div class="emp-meta">${esc(cat)}${local ? ` • ${esc(local)}` : ''}</div>
                </div>
              </div>
              <div class="emp-actions">
                <button class="btn-mini" type="button" data-open="${esc(r.id || '')}">Ver</button>
                <button class="btn-mini primary" type="button" data-ads="${esc(r.id || '')}">Anunciar</button>
              </div>
            </div>
          `;
        }).join('');

        listEl.querySelectorAll('[data-open]')?.forEach(b => b.addEventListener('click', () => {
          // futuro: empresa-detalhe.html?id=...
          alert('Próximo passo: tela de detalhes da empresa.');
        }));
        listEl.querySelectorAll('[data-ads]')?.forEach(b => b.addEventListener('click', () => {
          window.location.href = 'anunciar-negocio.html';
        }));
      }

      let cache = [];
      input?.addEventListener('input', () => cache.length && render(cache));

      (async () => {
        await loadEmpresas();
        // se tiver carregado, armazena para filtrar
        try {
          const items = Array.from(listEl?.querySelectorAll('.emp-item') || []);
          if (items.length) {
            // nada; cache é preenchido dentro do load, mas mantemos aqui por compat
          }
        } catch {}
      })();

      // reaproveita o cache real depois do load
      const _load = loadEmpresas;
      loadEmpresas = async function(){
        // wrapper para capturar rows
        if (!window.sb) return _load();
        const user = await window.sb.auth.getUser().catch(() => null);
        const userId = user?.data?.user?.id;
        if (!userId) return _load();
        const candidates = ['empresas', 'negocios'];
        for (const table of candidates){
          const { data, error } = await window.sb.from(table).select('*').eq('user_id', userId).order('created_at', { ascending: false }).limit(50);
          if (!error) { cache = Array.isArray(data) ? data : []; break; }
        }
        if (!cache.length) return _load();
        render(cache);
      }
    })();
  </script>

</body>
</html>
