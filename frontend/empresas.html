<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Empresas | Doke</title>

  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="style.css">
  <script src="script.js" defer></script>

  <!-- Leaflet (Mapa) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    /* ============================================================
       EMPRESAS (REFAZ DO ZERO) — clean, app-like, sem poluição
       Mantém o padrão do site (sidebar/header/style.css).
       ============================================================ */

    .emp-shell {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Top bar */
    .emp-top {
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .emp-title h1 {
      margin:0;
      font-size: 1.55rem;
      font-weight: 900;
      color:#1e1e1e;
      letter-spacing: .2px;
    }
    .emp-title p {
      margin: 6px 0 0;
      color:#6a6a6a;
      font-weight: 700;
      line-height: 1.35;
      max-width: 780px;
      font-size: .95rem;
    }

    .emp-loc {
      display:inline-flex;
      align-items:center;
      gap: 8px;
      border: 1px solid #eaeaea;
      background: #fff;
      border-radius: 999px;
      padding: 8px 10px;
      color:#666;
      font-weight: 900;
      font-size: .82rem;
      margin-top: 10px;
      width: fit-content;
      box-shadow: 0 10px 25px rgba(0,0,0,0.04);
    }

    .emp-tabs {
      display:flex;
      gap: 8px;
      background:#fff;
      border:1px solid #eee;
      border-radius: 999px;
      padding: 6px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    }
    .emp-tab {
      border: none;
      background: transparent;
      cursor:pointer;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 900;
      color:#444;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select:none;
      white-space: nowrap;
    }
    .emp-tab.active {
      background: rgba(42,95,144,.12);
      color: var(--cor2);
    }

    /* Pages */
    .emp-page { display:none; }
    .emp-page.active { display:block; }

    /* Map card (igual referência) */
    .emp-map-card {
      position: relative;
      border-radius: 22px;
      overflow: hidden;
      border: 1px solid #eee;
      background: #fff;
      box-shadow: 0 18px 40px rgba(0,0,0,0.06);
    }

    #map {
      width: 100%;
      height: 520px;
      border-radius: 22px;
    }
    @media (max-width: 980px) {
      #map { height: 420px; }
    }
    @media (max-width: 520px) {
      #map { height: 360px; }
    }

    /* Dim / blur layer to make it look "hero" like */
    .emp-map-dim {
      position:absolute;
      inset: 0;
      background: radial-gradient(80% 120% at 50% 0%, rgba(0,0,0,0.00) 0%, rgba(0,0,0,0.20) 65%, rgba(0,0,0,0.30) 100%),
                  linear-gradient(180deg, rgba(0,0,0,0.00) 0%, rgba(0,0,0,0.25) 100%);
      pointer-events: none;
      opacity: .85;
      transition: opacity .25s ease;
    }
    .emp-map-card.is-open .emp-map-dim {
      opacity: .10;
    }

    .emp-overlay {
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 22px;
      pointer-events: none;
      transition: opacity .25s ease, transform .25s ease;
      opacity: 1;
      transform: translateY(0);
    }
    .emp-map-card.is-open .emp-overlay {
      opacity: 0;
      transform: translateY(10px);
    }

    .emp-hero {
      pointer-events: none;
      max-width: 780px;
    }
    .emp-hero h2 {
      margin:0;
      font-size: clamp(1.6rem, 3.4vw, 2.4rem);
      font-weight: 950;
      color:#fff;
      letter-spacing: .2px;
      text-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    .emp-hero p {
      margin: 10px 0 0;
      color: rgba(255,255,255,.92);
      font-weight: 800;
      line-height: 1.4;
      text-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }

    .emp-hero-actions {
      margin-top: 18px;
      display:flex;
      gap: 10px;
      justify-content:center;
      flex-wrap: wrap;
      pointer-events: auto;
    }

    .emp-btn {
      border:none;
      cursor:pointer;
      border-radius: 999px;
      padding: 12px 18px;
      font-weight: 950;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      user-select:none;
      transition: transform .08s ease;
      white-space: nowrap;
      box-shadow: 0 16px 34px rgba(0,0,0,0.18);
    }
    .emp-btn:active { transform: translateY(1px); }
    .emp-btn.primary {
      background: #fff;
      color: #1b1b1b;
    }
    .emp-btn.secondary {
      background: rgba(255,255,255,.18);
      color: #fff;
      border: 1px solid rgba(255,255,255,.28);
      box-shadow: none;
      backdrop-filter: blur(8px);
    }

    /* Floating search pill (clean) */
    .emp-pillbar {
      position:absolute;
      left: 16px;
      right: 16px;
      bottom: 16px;
      display:flex;
      align-items:center;
      gap: 10px;
      background: rgba(255,255,255,.95);
      border: 1px solid #eee;
      border-radius: 999px;
      padding: 10px 12px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.10);
      backdrop-filter: blur(10px);
    }
    .emp-pillbar .pill {
      display:flex;
      align-items:center;
      gap: 10px;
      flex: 1;
      min-width: 0;
    }
    .emp-pillbar input {
      border: none;
      outline: none;
      background: transparent;
      width: 100%;
      font-weight: 900;
      color:#333;
    }
    .emp-pillbar .mini {
      border: 1px solid #e8e8e8;
      border-radius: 999px;
      padding: 10px 12px;
      background: #fff;
      font-weight: 950;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
    }
    .emp-pillbar .mini.primary {
      background: var(--cor2);
      color:#fff;
      border-color: transparent;
    }

    /* FAB */
    .emp-fab {
      position: fixed;
      right: 22px;
      bottom: 22px;
      width: 54px;
      height: 54px;
      border-radius: 18px;
      background: var(--cor2);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 24px;
      border: none;
      cursor:pointer;
      box-shadow: 0 18px 40px rgba(42,95,144,.28);
      z-index: 50;
    }
    @media (max-width: 520px) {
      .emp-fab { right: 16px; bottom: 16px; }
    }

    /* Modal (Filtros) */
    .emp-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.38);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 60;
    }
    .emp-modal.open { display:flex; }

    .emp-modal-card {
      width: min(720px, 100%);
      background:#fff;
      border: 1px solid #eee;
      border-radius: 22px;
      padding: 14px;
      box-shadow: 0 28px 70px rgba(0,0,0,0.20);
    }

    .emp-modal-head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .emp-modal-head b {
      font-size: 1.05rem;
      font-weight: 950;
      color:#222;
    }
    .emp-x {
      border:none;
      background:#f5f5f5;
      width: 40px;
      height: 40px;
      border-radius: 14px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 20px;
    }

    .emp-grid {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 720px) {
      .emp-grid { grid-template-columns: 1fr; }
    }

    .emp-field label {
      display:block;
      font-size: .82rem;
      font-weight: 950;
      color:#555;
      margin: 8px 0 6px;
    }
    .emp-input, .emp-select {
      width: 100%;
      border: 1px solid #e8e8e8;
      border-radius: 16px;
      padding: 12px 12px;
      outline:none;
      background:#fff;
      font-weight: 900;
      color:#333;
    }
    .emp-input:focus, .emp-select:focus {
      border-color: var(--cor2);
      box-shadow: 0 0 0 4px rgba(42,95,144,.12);
    }

    .emp-chips {
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .emp-chip {
      border: 1px solid #e8e8e8;
      background:#fff;
      color:#444;
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 950;
      font-size: .85rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .emp-chip.active {
      border-color: rgba(42,95,144,.45);
      color: var(--cor2);
      box-shadow: 0 0 0 4px rgba(42,95,144,.10);
    }

    .emp-range {
      width: 100%;
    }

    .emp-modal-actions {
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
      justify-content:flex-end;
    }
    .emp-act {
      border:none;
      cursor:pointer;
      border-radius: 16px;
      padding: 12px 14px;
      font-weight: 950;
      display:inline-flex;
      align-items:center;
      gap: 10px;
      white-space: nowrap;
    }
    .emp-act.primary {
      background: var(--cor2);
      color:#fff;
      box-shadow: 0 16px 34px rgba(42,95,144,.22);
    }
    .emp-act.ghost {
      background: #fff;
      border: 1px solid #e8e8e8;
      color:#222;
    }

    /* Results sheet */
    .emp-sheet {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 16px;
      width: min(980px, calc(100% - 18px));
      background: rgba(255,255,255,.98);
      border: 1px solid #eee;
      border-radius: 22px;
      box-shadow: 0 26px 70px rgba(0,0,0,0.16);
      overflow:hidden;
      z-index: 55;
      display:none;
    }
    .emp-sheet.show { display:block; }
    .emp-sheet-head {
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      cursor:pointer;
      user-select:none;
    }
    .emp-handle {
      width: 42px;
      height: 5px;
      border-radius: 999px;
      background:#e6e6e6;
      margin: 6px auto 0;
    }
    .emp-sheet-head b {
      font-weight: 950;
      color:#222;
    }
    .emp-sheet-head span {
      color:#777;
      font-weight: 900;
      font-size: .86rem;
    }
    .emp-sheet-body {
      max-height: 58vh;
      overflow:auto;
      padding: 0 10px 10px;
      display:none;
    }
    .emp-sheet.expanded .emp-sheet-body {
      display:block;
    }

    .emp-item {
      display:flex;
      gap: 12px;
      align-items:flex-start;
      padding: 12px;
      border: 1px solid #eee;
      border-radius: 18px;
      background:#fff;
      margin: 10px 0;
      cursor:pointer;
    }
    .emp-dot {
      width: 44px;
      height: 44px;
      border-radius: 16px;
      background: rgba(42,95,144,.10);
      color: var(--cor2);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      flex: 0 0 44px;
    }
    .emp-item h4 {
      margin:0 0 4px;
      font-weight: 950;
      color:#222;
      font-size: .98rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 620px;
    }
    .emp-item p {
      margin:0;
      color:#666;
      font-weight: 800;
      font-size: .88rem;
      line-height: 1.3;
    }
    .emp-item .meta {
      margin-top: 10px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .emp-badge {
      border:1px solid #eee;
      border-radius:999px;
      padding: 7px 10px;
      font-weight: 950;
      font-size: .80rem;
      color:#666;
      background:#fff;
    }
    .emp-mini-actions {
      margin-top: 10px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .emp-mini {
      border: 1px solid #eee;
      background:#fff;
      border-radius: 14px;
      padding: 9px 11px;
      font-weight: 950;
      font-size: .80rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .emp-mini.primary {
      background: var(--cor2);
      color:#fff;
      border-color: transparent;
    }

    /* Conteúdos wrapper */
    .emp-content-wrap {
      max-width: 1200px;
      margin: 0 auto;
      margin-top: 12px;
    }
    .emp-content-head {
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin: 12px 0 10px;
    }
    .emp-content-head h2 {
      margin:0;
      font-size: 1.25rem;
      font-weight: 950;
      color:#222;
    }
    .emp-content-head p {
      margin: 0;
      color:#777;
      font-weight: 900;
      font-size: .92rem;
    }
  </style>
</head>

<body>

    <header class="navbar-mobile">
        <div id="logo-mobile"><a href="index.html"><img src="assets/Imagens/doke-logo.png" alt="Doke"></a></div>
        <div class="mobile-controls">
            <button onclick="abrirMenuMobile()"><i class='bx bx-menu' style="font-size: 30px; color: var(--cor2);"></i></button>
        </div>
    </header>
    <div id="overlay-menu" onclick="fecharMenuMobile()"></div>

    <aside class="sidebar-icones">
        <div id="logo">
            <a href="index.html">
                <img src="assets/Imagens/doke-logo.png" alt="Logotipo da plataforma Doke">
            </a>
        </div>

        <div class="item">
            <a href="index.html"><img src="https://cdn-icons-png.flaticon.com/512/1946/1946436.png" class="icon azul" alt="Início">
            <span>Início</span></a>
        </div>
        <div class="item">
            <a href="explorar.html"><img src="https://cdn-icons-png.flaticon.com/512/622/622669.png" class="icon verde" alt="Explorar">
            <span>Explorar</span></a>
        </div>

        <div class="item">
            <a href="empresas.html">
                <i class='bx bx-store' style="color: var(--cor2); font-size: 26px;"></i>
                <span>Empresas</span>
            </a>
        </div>

        <div class="item">
            <a href="notificacoes.html"><img src="https://cdn-icons-png.flaticon.com/512/1827/1827392.png" class="icon azul" alt="Notificações">
            <span>Notificações</span></a>
        </div>
        <div class="item">
            <img src="https://cdn-icons-png.flaticon.com/512/561/561127.png" class="icon azul" alt="Mensagens">
            <a href="chat.html"><span>Mensagens</span></a>
        </div>
        <div class="item">
            <a href="comunidade.html"><img src="https://cdn-icons-png.flaticon.com/512/1144/1144760.png" class="icon verde" alt="Comunidades">
            <span>Comunidades</span></a>
        </div>
        <div class="item">
            <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="icon verde" alt="Comunidades">
            <a href="#" onclick="irParaMeuPerfil(event)"><span>Perfil</span></a>
        </div>
        <div class="item">
            <img src="https://cdn-icons-png.flaticon.com/512/56/56763.png" class="icon azul" alt="Mais">
            <a href="mais.html"><span>Mais</span></a>
        </div>
    </aside>


    <header class="navbar-desktop">
        <div id="logo-desktop">
            <a href="projeto.html">
                <img src="assets/Imagens/doke-logo.png" alt="Doke">
            </a>
        </div>
        <nav class="menu">
            <div class="cep-wrapper">
                <a href="#" class="cep" id="linkCep" onclick="toggleCep(event)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                    </svg>
                    <span id="textoCepSpan">Informe seu CEP</span>
                </a>

                <div class="cep-popup" id="boxCep">
                    <p>Digite seu CEP:</p>
                    <div class="cep-input-group">
                        <input type="text" id="inputCep" placeholder="00000-000" maxlength="9">
                        <button onclick="salvarCep()">OK</button>
                    </div>
                </div>
            </div>
            
            <a href="anunciar.html">Anuncie seu serviço</a>
            <a href="comunidade.html ">Comunidades <span class="badge-novo1">NOVO</span></a>
            <a href="novidades.html">Novidades</a>
        </nav>

        <div class="botoes-direita">
            <a href="login.html" class="entrar">Entrar</a>
            <a href="login.html">
            </a>
        </div>
    </header>

    

  <main>
    <section class="anuncio-container emp-shell">

      <div class="emp-top">
        <div class="emp-title">
          <h1>Empresas & CNPJs</h1>
          <p>Um mapa limpo pra descobrir lugares perto de você. (Depois a gente liga no seu sistema de avaliação e “CNPJ verificado”.)</p>
          <div class="emp-loc" id="locText"><i class='bx bx-map'></i> Localização: não definida</div>
        </div>

        <div class="emp-tabs" role="tablist">
          <button class="emp-tab active" id="tabEmp" type="button"><i class='bx bx-store'></i> Empresas</button>
          <button class="emp-tab" id="tabCont" type="button"><i class='bx bx-play-circle'></i> Conteúdos</button>
        </div>
      </div>

      <!-- PAGE: EMPRESAS (clean) -->
      <div class="emp-page active" id="pageEmp">
        <div class="emp-map-card" id="mapCard">
          <div id="map" aria-label="Mapa de empresas"></div>

          <div class="emp-map-dim"></div>

          <div class="emp-overlay" id="mapOverlay">
            <div class="emp-hero">
              <h2>Empresas perto de você</h2>
              <p>Veja restaurantes, lojas e lugares por perto com um mapa interativo.</p>

              <div class="emp-hero-actions">
                <button class="emp-btn primary" id="btnOpenMap" type="button"><i class='bx bx-map'></i> Abrir mapa</button>
                <button class="emp-btn secondary" id="btnGPSHero" type="button"><i class='bx bx-target-lock'></i> Usar GPS</button>
              </div>
            </div>
          </div>

          <div class="emp-pillbar" aria-label="Busca rápida">
            <div class="pill">
              <i class='bx bx-search' style="font-size:20px;color:#666"></i>
              <input id="quickQ" type="text" placeholder="Buscar por nome (ex.: Pizza, Mercado...)" />
            </div>

            <button class="mini" id="btnQuickCat" type="button" title="Categoria">
              <i class='bx bx-restaurant'></i>
              <span id="quickCatLabel">Restaurantes</span>
            </button>

            <button class="mini primary" id="btnQuickSearch" type="button">
              <i class='bx bx-radar'></i> Buscar
            </button>
          </div>
        </div>

        <button class="emp-fab" id="btnFilters" type="button" title="Filtros">
          <i class='bx bx-slider-alt'></i>
        </button>

        <!-- Modal Filtros -->
        <div class="emp-modal" id="filtersModal" aria-hidden="true">
          <div class="emp-modal-card" role="dialog" aria-modal="true" aria-label="Filtros de busca">
            <div class="emp-modal-head">
              <b>Filtros</b>
              <button class="emp-x" id="btnCloseModal" type="button"><i class='bx bx-x'></i></button>
            </div>

            <div class="emp-field">
              <label>Categoria</label>
              <div class="emp-chips" id="catChips">
                <button class="emp-chip active" data-cat="restaurant"><i class='bx bx-restaurant'></i> Restaurantes</button>
                <button class="emp-chip" data-cat="supermarket"><i class='bx bx-cart'></i> Mercados</button>
                <button class="emp-chip" data-cat="pharmacy"><i class='bx bx-plus-medical'></i> Farmácias</button>
                <button class="emp-chip" data-cat="mall"><i class='bx bx-shopping-bag'></i> Shopping</button>
                <button class="emp-chip" data-cat="clothes"><i class='bx bx-t-shirt'></i> Roupas</button>
                <button class="emp-chip" data-cat="cafe"><i class='bx bx-coffee'></i> Cafés</button>
                <button class="emp-chip" data-cat="beauty"><i class='bx bx-cut'></i> Beleza</button>
              </div>
            </div>

            <div class="emp-grid">
              <div class="emp-field">
                <label>Buscar por nome</label>
                <input class="emp-input" id="qText" type="text" placeholder="Ex.: Sushi, Padaria, Mercado..." />
              </div>

              <div class="emp-field">
                <label>Raio: <span id="radiusLabel">2.0 km</span></label>
                <input class="emp-range" id="radius" type="range" min="500" max="10000" value="2000" step="250" />
              </div>
            </div>

            <div class="emp-grid">
              <div class="emp-field">
                <label>Endereço ou CEP (opcional)</label>
                <input class="emp-input" id="address" type="text" placeholder="Rua, bairro, cidade - UF ou CEP" />
              </div>

              <div class="emp-field">
                <label>CNPJ (opcional / modelo)</label>
                <input class="emp-input" id="cnpj" inputmode="numeric" maxlength="14" placeholder="00000000000000" />
              </div>
            </div>

            <div class="emp-modal-actions">
              <button class="emp-act ghost" id="btnUseCep" type="button"><i class='bx bx-location-plus'></i> CEP salvo</button>
              <button class="emp-act ghost" id="btnGPS" type="button"><i class='bx bx-target-lock'></i> GPS</button>
              <button class="emp-act primary" id="btnSearch" type="button"><i class='bx bx-radar'></i> Buscar</button>
            </div>
          </div>
        </div>

        <!-- Resultados (bottom sheet) -->
        <div class="emp-sheet" id="resultsSheet">
          <div class="emp-handle"></div>
          <div class="emp-sheet-head" id="sheetHead">
            <b><span id="kpiCount">0</span> resultados</b>
            <span id="status">Pronto.</span>
          </div>
          <div class="emp-sheet-body" id="results"></div>
        </div>
      </div>

      <!-- PAGE: CONTEÚDOS (igual index) -->
      <div class="emp-page" id="pageCont">
        <div class="emp-content-wrap">
          <div class="emp-content-head">
            <div>
              <h2>Vídeos-curtos & Publicações</h2>
              <p>Mesma estrutura do Index para manter o padrão.</p>
            </div>
          </div>
        </div>

        <section class="videos-container">
    <div class="videos-header-top">
        <h2 class="sec-title" id="categorias-title2">Videos-curtos</h2>
        <a href="feed.html" class="ver-todos">Ver Galeria ></a>
    </div>

<div class="tiktok-scroll-wrapper" id="galeria-dinamica">
        <div style="padding: 20px; color: white; text-align: center;">
            <i class='bx bx-loader-alt bx-spin'></i> Carregando destaques...
        </div>
    </div>


    </div>

</section>

        <section class="fotos-container">
    <div class="section-feed-title" style="padding: 0; margin-bottom: 25px; margin-top: 40px;">
        <h2 class="sec-title sec-title-light">Publicações</h2>
        <a href="comunidade.html" class="ver-todos">Ver Galeria ></a>
    </div>
    
    <div id="feed-global-container"></div>
</section>
      </div>

    </section>

  </main>

  <script>
    // ============================================================
    // Lógica (Overpass + Nominatim) — só dentro do empresas.html
    // ============================================================

    const OVERPASS = "https://overpass-api.de/api/interpreter";
    const NOMINATIM = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=";

    const $ = (id) => document.getElementById(id);

    // Estado
    let map, userMarker, circle;
    let markers = [];
    let currentCategory = "restaurant";
    let center = { lat: -12.9714, lng: -38.5014 }; // default Salvador

    // Utils
    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
    }
    function onlyDigits(s){ return (s||"").replace(/\D+/g,""); }
    function km(m){ return (m/1000).toFixed(1); }

    function haversineMeters(a,b){
      const R=6371000;
      const toRad=(x)=>x*Math.PI/180;
      const dLat=toRad(b.lat-a.lat);
      const dLng=toRad(b.lng-a.lng);
      const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
      const aa=s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
      return 2*R*Math.asin(Math.sqrt(aa));
    }

    function categoryToOverpass(cat){
      switch(cat){
        case "restaurant": return ['amenity="restaurant"'];
        case "cafe": return ['amenity="cafe"', 'shop="bakery"'];
        case "bar": return ['amenity="bar"','amenity="pub"'];
        case "fast_food": return ['amenity="fast_food"'];
        case "supermarket": return ['shop="supermarket"'];
        case "mall": return ['shop="mall"','shop="department_store"'];
        case "clothes": return ['shop="clothes"','shop="shoes"'];
        case "convenience": return ['shop="convenience"'];
        case "pharmacy": return ['amenity="pharmacy"','shop="pharmacy"'];
        case "electronics": return ['shop="electronics"','shop="mobile_phone"'];
        case "beauty": return ['shop="beauty"','shop="hairdresser"','amenity="beauty_salon"'];
        case "hotel": return ['tourism="hotel"','tourism="hostel"','tourism="guest_house"'];
        case "bank": return ['amenity="bank"','amenity="atm"'];
        default: return ['amenity="restaurant"'];
      }
    }

    function catLabel(cat){
      const m = {
        restaurant: "Restaurantes",
        supermarket: "Mercados",
        pharmacy: "Farmácias",
        mall: "Shopping",
        clothes: "Roupas",
        cafe: "Cafés",
        beauty: "Beleza",
        bar: "Bares",
        fast_food: "Fast-food",
        convenience: "Conveniência",
        electronics: "Eletrônicos",
        hotel: "Hotéis",
        bank: "Bancos"
      };
      return m[cat] || "Restaurantes";
    }

    function catIcon(cat){
      const m = {
        restaurant: "bx-restaurant",
        supermarket: "bx-cart",
        pharmacy: "bx-plus-medical",
        mall: "bx-shopping-bag",
        clothes: "bx-t-shirt",
        cafe: "bx-coffee",
        beauty: "bx-cut"
      };
      return m[cat] || "bx-restaurant";
    }

    function setCategory(cat){
      currentCategory = cat;
      $("quickCatLabel").textContent = catLabel(cat);
      const icon = $("btnQuickCat").querySelector("i");
      icon.className = "bx " + catIcon(cat);

      document.querySelectorAll("#catChips .emp-chip").forEach(b => {
        b.classList.toggle("active", b.dataset.cat === cat);
      });
    }

    // Tabs
    function setTab(which){
      const emp = which === "emp";
      $("tabEmp").classList.toggle("active", emp);
      $("tabCont").classList.toggle("active", !emp);
      $("pageEmp").classList.toggle("active", emp);
      $("pageCont").classList.toggle("active", !emp);
      if(emp) {
        setTimeout(()=>{ map && map.invalidateSize(); }, 120);
      }
    }
    $("tabEmp").addEventListener("click", ()=>setTab("emp"));
    $("tabCont").addEventListener("click", ()=>setTab("cont"));

    // Map init
    function initMap(){
      map = L.map("map", { zoomControl:true }).setView([center.lat, center.lng], 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19, attribution: "&copy; OpenStreetMap"
      }).addTo(map);

      userMarker = L.marker([center.lat, center.lng]).addTo(map).bindPopup("Centro da busca");
      circle = L.circle([center.lat, center.lng], {
        radius: Number($("radius").value),
        color: getComputedStyle(document.documentElement).getPropertyValue("--cor2") || "#2a5f90",
        fillColor: getComputedStyle(document.documentElement).getPropertyValue("--cor2") || "#2a5f90",
        fillOpacity: .10
      }).addTo(map);

      // Map starts "closed" visually, but loaded.
      setTimeout(()=>map.invalidateSize(), 80);
    }

    function setCenter(lat,lng,label){
      center = { lat, lng };
      map.setView([lat,lng], 13, { animate:true });
      userMarker.setLatLng([lat,lng]);
      circle.setLatLng([lat,lng]);
      $("locText").innerHTML = "<i class='bx bx-map'></i> Localização: " + escapeHtml(label || (lat.toFixed(5)+", "+lng.toFixed(5)));
    }

    function clearMarkers(){
      markers.forEach(m => map.removeLayer(m));
      markers = [];
    }

    function openMap(){
      $("mapCard").classList.add("is-open");
      // Allow interactions
      setTimeout(()=>{ map.invalidateSize(); }, 220);
    }

    // Modal
    function openModal(){
      $("filtersModal").classList.add("open");
      $("filtersModal").setAttribute("aria-hidden", "false");
      // Prefill modal fields from quick
      $("qText").value = ($("quickQ").value || "");
    }
    function closeModal(){
      $("filtersModal").classList.remove("open");
      $("filtersModal").setAttribute("aria-hidden", "true");
    }

    $("btnFilters").addEventListener("click", openModal);
    $("btnCloseModal").addEventListener("click", closeModal);
    $("filtersModal").addEventListener("click", (e)=>{ if(e.target === $("filtersModal")) closeModal(); });

    // Overlay buttons
    $("btnOpenMap").addEventListener("click", openMap);
    $("btnGPSHero").addEventListener("click", ()=>{ openMap(); useGeolocation(); });

    // Quick category button cycles through popular
    const quickCats = ["restaurant","supermarket","pharmacy","mall","clothes","cafe","beauty"];
    $("btnQuickCat").addEventListener("click", ()=>{
      const i = quickCats.indexOf(currentCategory);
      const next = quickCats[(i+1) % quickCats.length];
      setCategory(next);
    });

    // Radius label
    function updateRadiusLabel(){
      const r = Number($("radius").value);
      $("radiusLabel").textContent = (r/1000).toFixed(1) + " km";
      if(circle) circle.setRadius(r);
    }
    $("radius").addEventListener("input", updateRadiusLabel);

    // Chips in modal
    document.querySelectorAll("#catChips .emp-chip").forEach(btn => {
      btn.addEventListener("click", ()=>setCategory(btn.dataset.cat));
    });

    // CEP / Address / GPS
    async function geocodeAddress(addr){
      if(!addr) return false;
      $("status").textContent = "Buscando endereço...";
      try {
        const resp = await fetch(NOMINATIM + encodeURIComponent(addr), { headers:{"Accept":"application/json"} });
        const data = await resp.json();
        if(!data || !data[0]) throw new Error("not found");
        setCenter(Number(data[0].lat), Number(data[0].lon), data[0].display_name);
        $("status").textContent = "Localização definida.";
        return true;
      } catch(e) {
        console.error(e);
        $("status").textContent = "Não achei esse endereço.";
        return false;
      }
    }

    function tryUseCep(){
      const cep = localStorage.getItem("cepUsuario") || localStorage.getItem("cep") || "";
      if(!cep) {
        $("status").textContent = "Sem CEP salvo.";
        return;
      }
      $("address").value = cep;
      geocodeAddress(cep);
    }

    function useGeolocation(){
      if(!navigator.geolocation) {
        $("status").textContent = "Seu navegador não suporta GPS.";
        return;
      }
      $("status").textContent = "Pegando GPS...";
      navigator.geolocation.getCurrentPosition(
        (pos)=>{
          setCenter(pos.coords.latitude, pos.coords.longitude, "GPS do dispositivo");
          $("status").textContent = "GPS definido.";
        },
        ()=>{ $("status").textContent = "GPS negado/indisponível."; },
        { enableHighAccuracy:true, timeout:12000, maximumAge:5000 }
      );
    }

    $("btnUseCep").addEventListener("click", tryUseCep);
    $("btnGPS").addEventListener("click", useGeolocation);

    // Results sheet
    function showSheet(){
      $("resultsSheet").classList.add("show");
    }
    function toggleSheet(){
      $("resultsSheet").classList.toggle("expanded");
    }
    $("sheetHead").addEventListener("click", toggleSheet);

    function skeleton(){
      const box = $("results");
      box.innerHTML = "";
      for(let i=0;i<6;i++) {
        const d = document.createElement("div");
        d.className = "emp-item";
        d.style.opacity = ".6";
        d.innerHTML = `
          <div class="emp-dot"><i class='bx bx-loader-alt bx-spin'></i></div>
          <div style="flex:1;min-width:0">
            <h4>Carregando...</h4>
            <p>Buscando lugares por perto...</p>
            <div class="meta"><span class="emp-badge">…</span></div>
          </div>`;
        box.appendChild(d);
      }
    }

    // Search
    async function overpassSearch(opts = {}){
      const radius = Number($("radius").value);
      const q = (opts.q ?? $("qText").value ?? "").trim().toLowerCase();
      const around = `around:${radius},${center.lat},${center.lng}`;
      const filters = categoryToOverpass(currentCategory);

      $("status").textContent = "Buscando...";
      showSheet();
      $("resultsSheet").classList.add("expanded");
      skeleton();

      const parts = [];
      for(const f of filters){
        parts.push(`node[${f}](${around});`);
        parts.push(`way[${f}](${around});`);
        parts.push(`relation[${f}](${around});`);
      }

      const query = `
        [out:json][timeout:25];
        (
          ${parts.join("\n")}
        );
        out center tags;
      `;

      try {
        const resp = await fetch(OVERPASS, {
          method:"POST",
          headers:{ "Content-Type":"application/x-www-form-urlencoded; charset=UTF-8" },
          body:"data="+encodeURIComponent(query)
        });
        if(!resp.ok) throw new Error("Overpass "+resp.status);

        const data = await resp.json();
        let items = (data.elements || []).map(e=>{
          const lat = e.lat ?? (e.center && e.center.lat);
          const lng = e.lon ?? (e.center && e.center.lon);
          const tags = e.tags || {};
          const name = tags.name || "(Sem nome)";
          const addr = [
            tags["addr:street"],
            tags["addr:housenumber"],
            tags["addr:suburb"],
            tags["addr:city"] || tags["addr:municipality"],
            tags["addr:state"]
          ].filter(Boolean).join(", ");

          const dist = haversineMeters(center, {lat, lng});
          return {
            lat, lng,
            name,
            addr: addr || tags["addr:full"] || "",
            phone: tags.phone || tags["contact:phone"] || "",
            website: tags.website || tags["contact:website"] || "",
            opening: tags.opening_hours || "",
            dist
          };
        }).filter(x=>x.lat && x.lng);

        if(q) items = items.filter(x => (x.name||"").toLowerCase().includes(q));
        items.sort((a,b)=>a.dist-b.dist);

        render(items);
        $("status").textContent = items.length ? "Atualizado." : "Nada encontrado.";
        $("kpiCount").textContent = items.length;

        // update quick input display
        $("quickQ").value = q;
      } catch(e) {
        console.error(e);
        $("status").textContent = "Falha na busca (tente de novo).";
        render([]);
        $("kpiCount").textContent = "0";
      }
    }

    function render(items){
      clearMarkers();
      const box = $("results");
      box.innerHTML = "";

      if(!items.length){
        const empty = document.createElement("div");
        empty.style.padding = "12px 8px";
        empty.style.color = "#777";
        empty.style.fontWeight = "900";
        empty.innerHTML = "Nada por perto com esses filtros. Tente aumentar o raio.";
        box.appendChild(empty);
        return;
      }

      circle.setRadius(Number($("radius").value));

      items.slice(0, 80).forEach((it, idx)=>{
        const m = L.marker([it.lat, it.lng]).addTo(map);
        markers.push(m);
        m.bindPopup(`<b>${escapeHtml(it.name)}</b><br><span style="color:#666">${escapeHtml(it.addr||"")}</span><br><span style="color:#666;font-weight:900">A ${km(it.dist)} km</span>`);

        const card = document.createElement("div");
        card.className = "emp-item";
        card.innerHTML = `
          <div class="emp-dot">${idx+1}</div>
          <div style="flex:1;min-width:0">
            <h4>${escapeHtml(it.name)}</h4>
            <p>${escapeHtml(it.addr || "Endereço não informado")}</p>
            <div class="meta">
              <span class="emp-badge">A ${km(it.dist)} km</span>
              ${it.opening ? '<span class="emp-badge">Horário</span>' : ''}
              ${it.phone ? '<span class="emp-badge">Telefone</span>' : ''}
              ${it.website ? '<span class="emp-badge">Site</span>' : ''}
            </div>
            <div class="emp-mini-actions">
              <button class="emp-mini primary" data-act="route"><i class='bx bx-navigation'></i> Rotas</button>
              <button class="emp-mini" data-act="focus"><i class='bx bx-map-pin'></i> Ver</button>
              <button class="emp-mini" data-act="copy"><i class='bx bx-copy'></i> Copiar</button>
            </div>
          </div>
        `;

        card.addEventListener("click", (ev)=>{
          const act = ev.target && ev.target.dataset && ev.target.dataset.act;
          if(act){
            ev.stopPropagation();
            handleAction(act, it, m);
            return;
          }
          openMap();
          map.setView([it.lat, it.lng], 16, { animate:true });
          m.openPopup();
        });

        box.appendChild(card);
      });
    }

    function handleAction(act, it, marker){
      const google = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(it.lat+","+it.lng)}`;
      if(act === "route") window.open(google, "_blank", "noopener");
      if(act === "focus") {
        openMap();
        map.setView([it.lat, it.lng], 16, { animate:true });
        marker && marker.openPopup();
      }
      if(act === "copy") {
        const txt = `${it.name} — ${it.addr || ""} (A ${km(it.dist)} km)`;
        navigator.clipboard?.writeText(txt);
        $("status").textContent = "Copiado!";
        setTimeout(()=>{ $("status").textContent = "Atualizado."; }, 900);
      }
    }

    // Bind buttons
    $("btnSearch").addEventListener("click", async ()=>{
      // if address typed, geocode first
      const addr = ($("address").value || "").trim();
      if(addr) {
        await geocodeAddress(addr);
      }
      closeModal();
      openMap();
      await overpassSearch({ q: $("qText").value });
    });

    $("btnQuickSearch").addEventListener("click", async ()=>{
      openMap();
      await overpassSearch({ q: $("quickQ").value });
    });

    $("quickQ").addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("btnQuickSearch").click(); });
    $("qText").addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("btnSearch").click(); });

    // Prefill loc pill if CEP exists
    const cepTxt = localStorage.getItem("cepUsuario") || localStorage.getItem("cep");
    if(cepTxt) {
      $("locText").innerHTML = "<i class='bx bx-map'></i> Localização: CEP salvo (" + escapeHtml(cepTxt) + ")";
    }

    // CNPJ field: keep digits only
    $("cnpj").addEventListener("input", ()=>{
      $("cnpj").value = onlyDigits($("cnpj").value).slice(0,14);
    });

    // Init
    initMap();
    updateRadiusLabel();
    setCategory("restaurant");
  </script>

</body>
</html>
