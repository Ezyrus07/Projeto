<!DOCTYPE html>
<html lang="pt-br">
<head>

  <!-- Supabase (UMD) + init + compat (Firestore/Auth) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-init.js"></script>
  <script src="firebase-compat-supabase.js"></script>
  <script src="firebase-auth-compat-supabase.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comunidades - Doke</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="style.css">
    <script src="script.js" defer></script>
    <style>
        /* ======================================================
           ESTILOS ESPECÍFICOS DA PÁGINA COMUNIDADES
           ====================================================== */
        
        body { background: linear-gradient(180deg, var(--cor2) 0%, var(--cor4) 200px); }

        main { padding: 20px; max-width: 1600px; margin: 0 auto; }
        @media (min-width: 1024px) {
            main { margin-left: 270px; margin-right: 20px; padding: 30px 40px; width: auto; }
        }

        .comm-hero-container {
                background: radial-gradient(1200px 500px at 50% 0%, rgba(255, 255, 255, 0.20), transparent 55%), linear-gradient(135deg, #1f4d75 0%, #13324f 55%, #0b7768 140%);
            padding: 40px; border-radius: 20px; margin-bottom: 40px;
            color: white; box-shadow: 0 10px 30px rgba(42, 95, 144, 0.25);
            position: relative; overflow: hidden;
        }
        .comm-hero-container::before {
            content: ''; position: absolute; top: -50px; right: -50px;
            width: 200px; height: 200px; background: rgba(255,255,255,0.05);
            border-radius: 50%; pointer-events: none;
        }

        .comm-header {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 30px; flex-wrap: wrap; gap: 20px; position: relative; z-index: 2;
        }
        .comm-title h1 { color: white; font-size: 2.2rem; margin-bottom: 8px; font-weight: 700; }
        .comm-title p { color: rgba(255,255,255,0.85); font-size: 1rem; max-width: 500px; }

        .header-actions { display: flex; gap: 15px; align-items: center; }
        .search-bar-comm {
            display: flex; align-items: center; background: white;
            padding: 12px 20px; border-radius: 50px; width: 320px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: 0.3s;
        }
        .search-bar-comm input { background: transparent; border: none; outline: none; width: 100%; color: #333; }
        .search-bar-comm:focus-within { transform: translateY(-1px); box-shadow: 0 10px 26px rgba(0,0,0,0.12); outline: 3px solid rgba(42, 95, 144, 0.18); }
        
        .btn-create-comm {
            background: var(--cor0); color: #fff; border: 1px solid rgba(255,255,255,0.2);
            padding: 12px 25px; border-radius: 30px; font-weight: 800; cursor: pointer;
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 10px 22px rgba(11, 119, 104, 0.25);
            transition: 0.2s; white-space: nowrap;
        }
        .btn-create-comm:hover { background: #fff; color: var(--cor2); border-color: rgba(0,0,0,0.06); }
        .btn-create-comm:focus-visible { outline: 3px solid rgba(11, 119, 104, 0.28); outline-offset: 2px; }

        /* Meus Grupos */
        .my-groups-section { position: relative; z-index: 2; }
        .section-label { color: white; font-size: 0.85rem; font-weight: 700; margin-bottom: 15px; text-transform: uppercase; opacity: 0.8; }
        .groups-scroll { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; min-height: 90px; }
        .groups-scroll::-webkit-scrollbar { display: none; }
        .my-group-item { display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer; min-width: 80px; transition: 0.2s; }
        .group-img-ring {
            width: 70px; height: 70px; border-radius: 20px; padding: 3px;
            background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center;
        }
        .group-img-ring img { width: 100%; height: 100%; border-radius: 17px; object-fit: cover; background: white; }
        .my-group-item span { color: white; font-size: 0.8rem; font-weight: 600; text-align: center; }

        /* Layout Principal */
        .comm-layout { display: grid; grid-template-columns: 1fr 350px; gap: 30px; }
        .filter-tabs { display: flex; gap: 12px; margin-bottom: 25px; overflow-x: auto; align-items: center; flex-wrap: wrap; padding-bottom: 6px; }
        .filter-tabs::-webkit-scrollbar { display: none; }
        .tab-btn {
            padding: 10px 24px; border: 1px solid #e0e0e0; background: white; border-radius: 30px;
            font-weight: 600; color: #555; cursor: pointer; white-space: nowrap; transition: 0.2s;
        }
        .tab-btn.active { background: var(--cor2); color: white; border-color: var(--cor2); }
        .tab-btn:focus-visible { outline: 3px solid rgba(42, 95, 144, 0.22); outline-offset: 2px; }
        .results-count {
            margin-left: auto;
            font-size: 0.85rem;
            color: #666;
            background: rgba(255,255,255,0.7);
            border: 1px solid rgba(0,0,0,0.06);
            padding: 7px 12px;
            border-radius: 999px;
            white-space: nowrap;
        }

        .grid-comunidades { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        
        .card-comm {
            background: white; border-radius: 16px; overflow: hidden;
            border: 1px solid #eee; transition: 0.3s; display: flex; flex-direction: column;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer;
        }
        .card-comm:hover { transform: translateY(-5px); box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
        .card-cover { height: 110px; background-size: cover; background-position: center; position: relative; background-color: #eee; }
        .card-tag {
            position: absolute; top: 10px; right: 10px; padding: 4px 12px;
            border-radius: 20px; font-size: 0.7rem; font-weight: 700; color: white; text-transform: uppercase;
        }
        .tag-pro { background: var(--cor0); }
        .tag-condo { background: var(--cor2); }
        .tag-hobby { background: #9b59b6; }

        .card-body { padding: 18px; margin-top: -40px; flex: 1; display: flex; flex-direction: column; }
        .card-icon {
            width: 64px; height: 64px; border-radius: 16px; background: white;
            padding: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 12px; position: relative; z-index: 2;
        }
        .card-icon img { width: 100%; height: 100%; border-radius: 12px; object-fit: cover; }
        .card-title { font-size: 1.15rem; font-weight: 700; color: #333; margin-bottom: 6px; }
        .card-desc {
            font-size: 0.9rem; color: #666; margin-bottom: 12px; line-height: 1.5;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        .card-meta { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
        .meta-pill { font-size: 0.78rem; color: #666; background: #f2f5f9; border: 1px solid #e9eef6; padding: 6px 10px; border-radius: 999px; }
        .members-preview { display: flex; align-items: center; margin-bottom: 15px; margin-top: auto; }
        .mem-avatar { width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; margin-left: -10px; background:#ddd; }
        .mem-count { font-size: 0.8rem; color: #888; margin-left: 10px; font-weight: 500; }
        .card-footer { padding: 15px 18px; border-top: 1px solid #f5f5f5; background: #fafafa; }
        .btn-entrar { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; background: white; color: #555; font-weight: 800; cursor: pointer; transition: .2s; }
        .btn-entrar:hover { background: var(--cor2); color: white; border-color: var(--cor2); }
        .btn-entrar:focus-visible { outline: 3px solid rgba(42, 95, 144, 0.22); outline-offset: 2px; }
        .btn-entrar.is-member { background: rgba(11, 119, 104, 0.10); border-color: rgba(11, 119, 104, 0.25); color: #0b7768; }
        .btn-entrar.is-member:hover { background: rgba(11, 119, 104, 0.18); }
        .btn-entrar.is-pending { background: rgba(115, 115, 115, 0.10); border-color: rgba(115, 115, 115, 0.22); color: #4e4e4e; }
        .btn-entrar.is-pending:hover { background: rgba(115, 115, 115, 0.16); }

        /* Flags no card (privado/verificado) */
        .card-flags { position: absolute; top: 10px; left: 10px; display: flex; gap: 8px; }
        .flag {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 4px 10px; border-radius: 999px;
            font-size: 0.72rem; font-weight: 800;
            background: rgba(0,0,0,0.35); color: #fff; backdrop-filter: blur(6px);
            border: 1px solid rgba(255,255,255,0.18);
        }

        /* Skeleton */
        .skeleton-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .skeleton-card { background: #fff; border-radius: 16px; border: 1px solid #eee; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .sk-cover { height:110px; background: linear-gradient(90deg, #eee, #f6f6f6, #eee); background-size: 200% 100%; animation: shimmer 1.2s infinite; }
        .sk-body { padding: 18px; }
        .sk-line { height: 12px; border-radius: 8px; margin: 10px 0; background: linear-gradient(90deg, #eee, #f6f6f6, #eee); background-size: 200% 100%; animation: shimmer 1.2s infinite; }
        .sk-line.sm { width: 60%; }
        .sk-line.xs { width: 40%; }
        @keyframes shimmer { 0% { background-position: 0% 0; } 100% { background-position: 200% 0; } }

        /* Sidebar Widgets */
        .widget-box { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #eee; margin-bottom: 25px; }
        .widget-title { font-size: 1.1rem; font-weight: 700; color: var(--cor2); margin-bottom: 20px; border-bottom: 2px solid #f5f5f5; padding-bottom: 10px; }
        .topic-item { display: flex; gap: 15px; margin-bottom: 15px; }
        .topic-icon { width: 40px; height: 40px; background: #f0f7ff; color: var(--cor2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; flex-shrink: 0; }
        
        /* Modal Criar */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: flex-start; backdrop-filter: blur(3px);  overflow:auto; padding:18px 10px; }
        .modal-card{ background: white; width: 90%; max-width: 560px; border-radius: 16px; padding: 30px; position: relative; animation: zoomIn 0.3s;  max-height: calc(100vh - 36px); overflow:auto;}
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-close-btn {
            position:absolute; top:14px; right:14px;
            width: 42px; height: 42px; border-radius: 12px;
            border: 1px solid #eee; background: #fff;
            font-size: 1.4rem; cursor:pointer; display:flex; align-items:center; justify-content:center;
        }
        .modal-close-btn:hover { background: #f7f7f7; }
        .modal-close-btn:focus-visible { outline: 3px solid rgba(42, 95, 144, 0.22); outline-offset: 2px; }
        .form-label { display: block; font-weight: 600; margin-bottom: 8px; color: #444; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; outline: none; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: rgba(42, 95, 144, 0.55); box-shadow: 0 0 0 3px rgba(42, 95, 144, 0.12); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .help-text { font-size: 0.82rem; color: #777; margin-top: -10px; margin-bottom: 12px; }
        .img-preview {
            width: 100%; height: 140px; border-radius: 12px; border: 1px dashed #d9d9d9;
            display:flex; align-items:center; justify-content:center; overflow:hidden; background:#fafafa;
            margin-bottom: 12px;
        }
        .img-preview img { width: 100%; height: 100%; object-fit: cover; }
        .btn-submit-modal { width: 100%; padding: 14px; background: var(--cor2); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }
        .btn-submit-modal:hover { filter: brightness(0.98); }
        .btn-submit-modal:focus-visible { outline: 3px solid rgba(42, 95, 144, 0.22); outline-offset: 2px; }

        /* FAB mobile */
        .comm-fab {
            position: fixed; right: 18px; bottom: 84px;
            width: 56px; height: 56px; border-radius: 18px;
            background: var(--cor0); color: #fff;
            border: none; display: none; align-items:center; justify-content:center;
            box-shadow: 0 16px 36px rgba(0,0,0,0.22);
            z-index: 9998; cursor: pointer;
        }
        .comm-fab i { font-size: 1.6rem; }
        .comm-fab:focus-visible { outline: 3px solid rgba(11, 119, 104, 0.28); outline-offset: 2px; }

        @media (max-width: 768px) {
            .comm-layout { display: flex; flex-direction: column; }
            .comm-hero-container { padding: 30px 20px; border-radius: 0 0 20px 20px; margin: -20px -15px 30px -15px; }
            .comm-header { flex-direction: column; align-items: flex-start; }
            .search-bar-comm, .btn-create-comm { width: 100%; justify-content: center; }
            .grid-comunidades { grid-template-columns: 1fr; }
            main { margin-left: 0 !important; padding: 20px !important; }
            .btn-create-comm { display: none; }
            .comm-fab { display: flex; }
            .results-count { width: 100%; margin-left: 0; }
            .form-row { grid-template-columns: 1fr; }
        }
    
        /* =========================================================
           MODAL - FIX SCROLL + FILE INPUT BONITO
           ========================================================= */
        body.modal-open { overflow: hidden; }

        .modal-overlay {
            align-items: flex-start;
            padding: 18px 14px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .modal-card {
            margin: 16px auto;
            max-height: calc(100vh - 36px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .file-ui {
            width: 100%;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 12px;
            background: #fff;
            margin-bottom: 10px;
        }
        .file-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #e7e7e7;
            background: #f7f7f7;
            cursor: pointer;
            font-weight: 800;
            color: #333;
            user-select: none;
        }
        .file-btn:hover { background: #f1f1f1; }
        .file-btn:focus-visible { outline: 3px solid rgba(42, 95, 144, 0.22); outline-offset: 2px; }
        .file-name { font-size: 0.92rem; color: #555; }

        @media (max-width: 560px){
            .modal-card { padding: 18px; border-radius: 16px; }
            .form-row { grid-template-columns: 1fr; }
        }


        /* Toast (substitui alert do navegador) */
        .toast-wrap{
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 18px;
            z-index: 999999;
            display:flex;
            flex-direction: column;
            gap: 10px;
            width: min(520px, calc(100% - 24px));
            pointer-events:none;
        }
        .toast{
            pointer-events:auto;
            background: rgba(17,24,39,0.92);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px;
            padding: 12px 14px;
            display:flex;
            align-items:center;
            justify-content: space-between;
            gap: 10px;
            box-shadow: 0 18px 36px rgba(0,0,0,0.18);
        }
        .toast small{ color: rgba(255,255,255,0.78); font-weight: 700; }
        .toast button{
            border:none;
            background: rgba(255,255,255,0.12);
            color:#fff;
            font-weight: 1000;
            border-radius: 12px;
            padding: 8px 10px;
            cursor:pointer;
        }

        /* Força modal com scroll interno (mobile) */
        .modal-overlay{
            align-items: flex-start !important;
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch;
            padding: 18px 14px !important;
        }
        .modal-card{
            max-height: calc(100vh - 36px) !important;
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch;
        }

        /* Força esconder input file nativo e usar UI custom */
        #modalCriarComm input[type="file"]{ display:none !important; }

</style>

  <!-- Supabase (UMD) + init + compat (Firestore/Auth) -->
</head>
<body>
    <div class=\"toast-wrap\" id=\"toastWrap\"></div>

        <header class="navbar-desktop">
        <div id="logo-desktop">
            <a href="projeto.html">
                <img src="assets/Imagens/doke-logo.png" alt="Doke">
            </a>
        </div>
        <nav class="menu">
            <div class="cep-wrapper">
                <a href="#" class="cep" id="linkCep" onclick="toggleCep(event)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                    </svg>
                    <span id="textoCepSpan">Informe seu CEP</span>
                </a>

                <div class="cep-popup" id="boxCep">
                    <p>Digite seu CEP:</p>
                    <div class="cep-input-group">
                        <input type="text" id="inputCep" placeholder="00000-000" maxlength="9">
                        <button onclick="salvarCep()">OK</button>
                    </div>
                </div>
            </div>
            
            <a href="anunciar.html">Anuncie seu serviço</a>
            <a href="comunidade.html">Comunidades <span class="badge-novo1">NOVO</span></a>
            <a href="novidades.html">Novidades</a>
        </nav>

        <div class="botoes-direita">
            <a href="login.html" class="entrar">Entrar</a>
            <a href="login.html">
            </a>
        </div>
    </header>

    <aside class="sidebar-icones">
        <div id="logo"><a href="index.html"><img src="assets/Imagens/doke-logo.png" alt="Doke"></a></div>
        <div class="item"><a href="index.html"><img src="https://cdn-icons-png.flaticon.com/512/1946/1946436.png" class="icon azul"><span>Início</span></a></div>
        <div class="item"><a href="explorar.html"><img src="https://cdn-icons-png.flaticon.com/512/622/622669.png" class="icon verde"><span>Explorar</span></a></div>
        <div class="item"><a href="notificacoes.html"><img src="https://cdn-icons-png.flaticon.com/512/1827/1827392.png" class="icon azul"><span>Notificações</span></a></div>
        <div class="item"><a href="chat.html"><img src="https://cdn-icons-png.flaticon.com/512/561/561127.png" class="icon azul"><span>Mensagens</span></a></div>
        <div class="item active"><a href="comunidade.html"><img src="https://cdn-icons-png.flaticon.com/512/1144/1144760.png" class="icon verde"><span>Comunidades</span></a></div>
        <div class="item"><a href="meuperfil.html"><img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="icon verde"><span>Perfil</span></a></div>
        <div class="item"><a href="mais.html"><img src="https://cdn-icons-png.flaticon.com/512/56/56763.png" class="icon azul"><span>Mais</span></a></div>
    </aside>

    <header class="navbar-mobile">
        <div id="logo-mobile"><a href="index.html"><img src="assets/Imagens/doke-logo.png" alt="Doke" style="height:25px;"></a></div>
        <button id="btn-menu-mobile" onclick="abrirMenuMobile()"><i class='bx bx-menu' style="font-size:30px; color:var(--cor2);"></i></button>
    </header>
    <div id="overlay-menu" onclick="fecharMenuMobile()"></div>

    <main>
        
        <div class="comm-hero-container">
            <div class="comm-header">
                <div class="comm-title">
                    <h1>Comunidades</h1>
                    <p>Conecte-se, troque experiências e cresça junto com outros profissionais e vizinhos.</p>
                </div>
                <div class="header-actions">
                    <div class="search-bar-comm">
                        <i class='bx bx-search'></i>
                        <input type="text" placeholder="Buscar grupos..." id="inputBuscaComm" autocomplete="off" aria-label="Buscar comunidades">
                    </div>
                    <button class="btn-create-comm" onclick="abrirModalCriarComm()"><i class='bx bx-plus-circle'></i> Criar Grupo</button>
                </div>
            </div>

            <section class="my-groups-section">
                <div class="section-label">Meus Grupos</div>
                <div class="groups-scroll" id="listaMeusGrupos">
                    <div style="color:rgba(255,255,255,0.7); padding:10px;">Carregando seus grupos...</div>
                </div>
            </section>
        </div>

        <div class="comm-layout">
            <div class="main-feed-comm">
                <div class="filter-tabs">
                    <button class="tab-btn active" onclick="filtrarComunidadesTipo('todos', this)">Descobrir</button>
                    <button class="tab-btn" onclick="filtrarComunidadesTipo('Pro', this)">Profissionais</button>
                    <button class="tab-btn" onclick="filtrarComunidadesTipo('Condomínio', this)">Condomínios</button>
                    <button class="tab-btn" onclick="filtrarComunidadesTipo('Hobby', this)">Hobbies</button>
                    <div class="results-count" id="commResultsCount" aria-live="polite">0 resultados</div>
                </div>

                <div class="grid-comunidades" id="listaComunidadesGeral">
                    <div class="skeleton-card" aria-hidden="true"><div class="sk-cover"></div><div class="sk-body"><div class="sk-line sm"></div><div class="sk-line"></div><div class="sk-line xs"></div></div></div>
                    <div class="skeleton-card" aria-hidden="true"><div class="sk-cover"></div><div class="sk-body"><div class="sk-line sm"></div><div class="sk-line"></div><div class="sk-line xs"></div></div></div>
                    <div class="skeleton-card" aria-hidden="true"><div class="sk-cover"></div><div class="sk-body"><div class="sk-line sm"></div><div class="sk-line"></div><div class="sk-line xs"></div></div></div>
                    <div class="skeleton-card" aria-hidden="true"><div class="sk-cover"></div><div class="sk-body"><div class="sk-line sm"></div><div class="sk-line"></div><div class="sk-line xs"></div></div></div>
                    <div class="skeleton-card" aria-hidden="true"><div class="sk-cover"></div><div class="sk-body"><div class="sk-line sm"></div><div class="sk-line"></div><div class="sk-line xs"></div></div></div>
                    <div class="skeleton-card" aria-hidden="true"><div class="sk-cover"></div><div class="sk-body"><div class="sk-line sm"></div><div class="sk-line"></div><div class="sk-line xs"></div></div></div>
                </div>
            </div>

            <aside class="comm-sidebar">
<div class="widget-box">
    <h4 class="widget-title"><i class='bx bx-trending-up'></i> Tópicos em Alta</h4>
    
    <div class="topic-list" id="listaTopicos">
        <div style="padding:10px; color:#888; font-size:0.85rem;">Nenhum tópico no momento</div>
    </div>
</div>
            </aside>
        </div>
    </main>

    <nav class="bottom-nav">
        <a href="index.html" class="item"><img src="https://cdn-icons-png.flaticon.com/512/1946/1946436.png" class="icon azul"><span>Início</span></a>
        <a href="comunidade.html" class="item active"><img src="https://cdn-icons-png.flaticon.com/512/1144/1144760.png" class="icon verde"><span>Grupos</span></a>
        <a href="meuperfil.html" class="item"><img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="icon verde"><span>Perfil</span></a>
    </nav>

    <button class="comm-fab" id="commFab" type="button" aria-label="Criar Grupo">
        <i class='bx bx-plus'></i>
    </button>

    <div id="modalCriarComm" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modalCommTitle">
        <div class="modal-card">
            <button type="button" class="modal-close-btn" data-modal-close aria-label="Fechar">&times;</button>
            <h2 id="modalCommTitle" style="margin-bottom:20px; color:var(--cor2);">Novo Grupo</h2>
            <form onsubmit="criarNovaComunidade(event)">
                <label class="form-label">Nome do Grupo</label>
                <input type="text" id="commNome" class="form-input" placeholder="Ex: Eletricistas Unidos" required>
                
                <label class="form-label">Descrição</label>
                <textarea id="commDesc" class="form-textarea" placeholder="Sobre o que é este grupo?" required></textarea>
                
                <div class="form-row">
                    <div>
                        <label class="form-label">Tipo de Comunidade</label>
                        <select id="commTipo" class="form-select">
                            <option value="Pro">Profissional (Networking)</option>
                            <option value="Condomínio">Condomínio / Vizinhos</option>
                            <option value="Hobby">Hobby / Interesse</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Privacidade</label>
                        <select id="commPrivacidade" class="form-select">
                            <option value="publica">Pública</option>
                            <option value="privada">Privada</option>
                        </select>
                        <div class="help-text" id="commPrivHelp">Pública: qualquer pessoa entra. Privada: precisa solicitar entrada.</div>
                    </div>
                </div>

                <div class="form-row">
                    <div>
                        <label class="form-label">Categoria</label>
                        <select id="commCategoria" class="form-select">
                            <option value="">Selecione...</option>
                            <option value="Reforma e Construção">Reforma e Construção</option>
                            <option value="Assistência Técnica">Assistência Técnica</option>
                            <option value="Beleza e Estética">Beleza e Estética</option>
                            <option value="Aulas Particulares">Aulas Particulares</option>
                            <option value="Condomínio">Condomínio</option>
                            <option value="Hobby">Hobby</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Subcategoria (opcional)</label>
                        <input type="text" id="commSubcategoria" class="form-input" placeholder="Ex: Elétrica, Pintura...">
                    </div>
                </div>

                <label class="form-label">Imagem de Capa (Opcional)</label>
                <div class="img-preview" id="commImgPreview"><span style="color:#888; font-size:0.85rem;">Prévia da imagem</span></div>
                <input type="file" id="commFoto" accept="image/*" hidden>
                <div class="file-ui" role="group" aria-label="Selecionar imagem de capa">
                    <label for="commFoto" class="file-btn"><i class='bx bx-upload'></i> Escolher arquivo</label>
                    <span class="file-name" id="commFotoNome">Nenhum arquivo escolhido</span>
                </div>
                <div class="help-text">PNG/JPG, até 2MB. (a imagem aparece no topo do grupo)</div>

                <button type="submit" class="btn-submit-modal">Criar Comunidade</button>
            </form>
        </div>
    </div>

    
<script>
  // Comunidade | Doke — lógica real (Firestore via compat) + UI padronizada
  window.__DOKE_SUPABASE_STORAGE_BUCKET__ = window.__DOKE_SUPABASE_STORAGE_BUCKET__ || 'posts';

  (function(){
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

    function toast(msg, kind='info'){
      const wrap = document.getElementById('toastWrap') || (function(){
        const w = document.createElement('div');
        w.id = 'toastWrap';
        w.style.position = 'fixed';
        w.style.right = '14px';
        w.style.bottom = '14px';
        w.style.display = 'flex';
        w.style.flexDirection = 'column';
        w.style.gap = '10px';
        w.style.zIndex = '10000';
        document.body.appendChild(w);
        return w;
      })();

      const el = document.createElement('div');
      el.style.borderRadius = '14px';
      el.style.padding = '12px 14px';
      el.style.fontWeight = '800';
      el.style.color = '#fff';
      el.style.maxWidth = '340px';
      el.style.boxShadow = '0 12px 30px rgba(0,0,0,0.22)';
      el.style.background = kind==='success' ? 'var(--cor0)' : kind==='error' ? '#b91c1c' : '#111827';
      el.textContent = String(msg||'');
      wrap.appendChild(el);

      setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity .25s'; }, 3400);
      setTimeout(()=>{ try{el.remove();}catch(e){} }, 3800);
    }

    // override alert -> toast
    window.alert = (msg)=> {
      const t = String(msg||'');
      const kind = /erro|error|falha|inválid/i.test(t) ? 'error' : /sucesso|criado|ok|conclu/i.test(t) ? 'success' : 'info';
      toast(t, kind);
    };

    function openModal(){
      const modal = document.getElementById('modalCriarComm');
      if(!modal) return;
      modal.classList.add('show');
      modal.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
    }
    function closeModal(){
      const modal = document.getElementById('modalCriarComm');
      if(!modal) return;
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
    }

    window.abrirModalCriarComm = openModal;
    window.fecharModalCriarComm = closeModal;

    // clique fora do card fecha modal
    function bindModalClose(){
      const modal = document.getElementById('modalCriarComm');
      if(!modal) return;
      modal.addEventListener('click', (e)=>{
        if(e.target === modal) closeModal();
      });
      document.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape') closeModal();
      });
    }

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    async function readAsDataURL(file){
      return await new Promise((resolve, reject)=>{
        const reader = new FileReader();
        reader.onload = ()=>resolve(reader.result);
        reader.onerror = ()=>reject(reader.error);
        reader.readAsDataURL(file);
      });
    }

    async function waitForDb(){
      for(let i=0;i<80;i++){
        if(window.db && window.auth && window.collection && window.getDocs && window.addDoc) return true;
        await sleep(40);
      }
      return false;
    }

    const state = {
      user: null,
      all: [],
      tipo: 'todos',
      term: '',
      carregou: false,
    };

    // ===== UI: filtros
    window.filtrarComunidadesTipo = function(tipo, btn){
      state.tipo = tipo || 'todos';
      $$('.filter-tabs .tab-btn').forEach(b=>b.classList.remove('active'));
      if(btn) btn.classList.add('active');
      renderGrid();
    };

    function bindSearch(){
      const input = $('#inputBuscaComm');
      if(!input) return;
      let t=null;
      input.addEventListener('input', ()=>{
        clearTimeout(t);
        t=setTimeout(()=>{
          state.term = (input.value||'').toLowerCase().trim();
          renderGrid();
        }, 160);
      });
    }

    // ===== UI: file input
    function bindFile(){
      const file = $('#commFoto');
      const name = $('#commFotoNome');
      const preview = $('#commImgPreview img');
      if(!file) return;

      file.addEventListener('change', async ()=>{
        const f = file.files && file.files[0];
        if(!f){
          if(name) name.textContent = 'Nenhum arquivo';
          if(preview) preview.src = '';
          return;
        }
        if(name) name.textContent = f.name;

        try{
          const url = await readAsDataURL(f);
          if(preview) preview.src = url;
        }catch(e){}
      });
    }

    // ===== Create: real data
    window.criarNovaComunidade = async function(e){
      e?.preventDefault?.();

      if(!state.user){
        toast("Faça login para criar um grupo", "error");
        return;
      }

      const nome = ($('#commNome')?.value || '').trim();
      const descricao = ($('#commDesc')?.value || '').trim();
      const tipo = ($('#commTipo')?.value || 'Pro');
      const privacidade = ($('#commPrivacidade')?.value || 'Público');
      const categoria = ($('#commCategoria')?.value || '').trim();
      const subcategoria = ($('#commSubcategoria')?.value || '').trim();

      if(!nome || !descricao){
        toast("Preencha nome e descrição", "info");
        return;
      }

      const btn = $('#btnCriarComm');
      if(btn){
        btn.disabled = true;
        btn.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> Criando...";
      }

      try{
        let capaBase64 = '';
        const file = $('#commFoto')?.files?.[0];
        if(file){
          if(file.size > 2*1024*1024){
            toast("Imagem muito grande (máx 2MB)", "error");
            return;
          }
          capaBase64 = await readAsDataURL(file);
        }

        const docRef = await window.addDoc(window.collection(window.db, "comunidades"), {
          nome,
          descricao,
          tipo,
          privacidade,
          categoria,
          subcategoria,
          capa: capaBase64,
          donoUid: state.user.uid,
          membros: [state.user.uid],
          membrosCount: 1,
          dataCriacao: new Date().toISOString()
        });

        // cria cargos + membro do dono
        try{
          const cargosCol = window.collection(window.db, "comunidades", docRef.id, "cargos");
          const d1 = await window.addDoc(cargosCol, { nome: "Dono", cor: "#0b7768", rank: 100 });
          await window.addDoc(cargosCol, { nome: "Moderador", cor: "#2a5f90", rank: 70 });
          await window.addDoc(cargosCol, { nome: "Membro", cor: "#6b7280", rank: 10 });

          await window.setDoc(window.doc(window.db, "comunidades", docRef.id, "membros", state.user.uid), {
            uid: state.user.uid,
            roleId: d1.id
          }, { merge: true });
        }catch(err){
          // não quebra criação se falhar
          console.warn("Falha ao criar cargos/membro:", err);
        }

        toast("Grupo criado!", "success");
        closeModal();
        await carregarTudo();
        // abre direto no grupo
        window.location.href = `grupo.html?id=${docRef.id}`;

      }catch(err){
        console.error(err);
        toast("Erro ao criar grupo", "error");
      }finally{
        if(btn){
          btn.disabled = false;
          btn.innerHTML = "<i class='bx bx-plus'></i> Criar Grupo";
        }
      }
    };

    // ===== Load data
    async function carregarComunidadesGerais(){
      const grid = $('#listaComunidadesGeral');
      if(!grid) return;

      grid.innerHTML = `
        <div class="skeleton-card" aria-hidden="true"><div class="sk-cover"></div><div class="sk-body"><div class="sk-line"></div><div class="sk-line xs"></div></div></div>
        <div class="skeleton-card" aria-hidden="true"><div class="sk-cover"></div><div class="sk-body"><div class="sk-line"></div><div class="sk-line xs"></div></div></div>
        <div class="skeleton-card" aria-hidden="true"><div class="sk-cover"></div><div class="sk-body"><div class="sk-line"></div><div class="sk-line xs"></div></div></div>
      `;

      const snap = await window.getDocs(window.query(window.collection(window.db, "comunidades"), window.limit(120)));
      const items = [];
      snap.forEach(d=>{
        const data = d.data() || {};
        items.push({ id: d.id, ...data });
      });

      // ordena por data
      items.sort((a,b)=> (Date.parse(b.dataCriacao||0) - Date.parse(a.dataCriacao||0)));

      state.all = items;
      state.carregou = true;
      renderGrid();
    }

    async function carregarMeusGrupos(){
      const wrap = $('#listaMeusGrupos');
      if(!wrap) return;

      if(!state.user){
        wrap.innerHTML = `<div style="color:rgba(255,255,255,0.75);padding:10px;font-weight:700;">Faça login para ver seus grupos.</div>`;
        return;
      }

      wrap.innerHTML = `<div style="color:rgba(255,255,255,0.75);padding:10px;font-weight:700;">Carregando...</div>`;

      const q = window.query(
        window.collection(window.db, "comunidades"),
        window.where("membros", "array-contains", state.user.uid),
        window.limit(30)
      );

      const snap = await window.getDocs(q);
      const groups = [];
      snap.forEach(d=>{
        const data = d.data() || {};
        groups.push({ id: d.id, ...data });
      });

      groups.sort((a,b)=> (Date.parse(b.dataCriacao||0) - Date.parse(a.dataCriacao||0)));

      wrap.innerHTML = '';
      if(groups.length === 0){
        wrap.innerHTML = `<div style="color:rgba(255,255,255,0.75);padding:10px;font-weight:700;">Você ainda não entrou em nenhum grupo.</div>`;
        return;
      }

      for(const g of groups){
        const item = document.createElement('div');
        item.className = 'my-group-item';
        item.setAttribute('data-id', g.id);
        const img = g.capa && String(g.capa).trim() ? g.capa : 'https://picsum.photos/200?random=' + encodeURIComponent(g.id);
        const nome = g.nome ? String(g.nome).split(' ').slice(0,2).join(' ') : 'Grupo';
        item.innerHTML = `
          <div class="group-img-ring"><img src="${escapeHtml(img)}" loading="lazy" alt="${escapeHtml(nome)}"></div>
          <span>${escapeHtml(nome)}</span>
        `;
        item.addEventListener('click', ()=> window.location.href = `grupo.html?id=${g.id}`);
        wrap.appendChild(item);
      }
    }

    function tagClass(tipo){
      if(tipo === 'Condomínio') return 'tag-condo';
      if(tipo === 'Hobby') return 'tag-hobby';
      return 'tag-pro';
    }

    async function joinQuick(id, privacidade){
      if(!state.user){
        toast("Faça login para entrar", "error");
        return;
      }
      if(String(privacidade||'').toLowerCase().includes('priv')){
        toast("Grupo privado: peça acesso ao dono", "info");
        window.location.href = `grupo.html?id=${id}`;
        return;
      }

      try{
        const ref = window.doc(window.db, "comunidades", id);
        const snap = await window.getDoc(ref);
        if(!snap.exists()) return;
        const g = snap.data() || {};
        const membros = Array.isArray(g.membros) ? g.membros : [];
        if(!membros.includes(state.user.uid)){
          membros.push(state.user.uid);
          await window.updateDoc(ref, { membros, membrosCount: membros.length });
        }
        // cria membro doc se existir roles
        try{
          const cargosSnap = await window.getDocs(window.collection(window.db, "comunidades", id, "cargos"));
          let roleMembroId = '';
          cargosSnap.forEach(d=>{
            const data = d.data()||{};
            if(String(data.nome||'').toLowerCase()==='membro') roleMembroId = d.id;
          });
          await window.setDoc(window.doc(window.db, "comunidades", id, "membros", state.user.uid), {
            uid: state.user.uid,
            roleId: roleMembroId
          }, { merge: true });
        }catch(e){}

        toast("Você entrou!", "success");
        window.location.href = `grupo.html?id=${id}`;
      }catch(e){
        console.error(e);
        toast("Erro ao entrar", "error");
      }
    }

    function renderGrid(){
      const grid = $('#listaComunidadesGeral');
      if(!grid) return;

      if(!state.carregou){
        $('#commResultsCount').textContent = '0 resultados';
        return;
      }

      const term = state.term;
      const tipo = state.tipo;

      const filtered = state.all.filter(g=>{
        const okTipo = (tipo==='todos') ? true : (String(g.tipo||'')===tipo);
        const hay = (String(g.nome||'') + ' ' + String(g.descricao||'') + ' ' + String(g.categoria||'') + ' ' + String(g.subcategoria||'')).toLowerCase();
        const okTerm = term ? hay.includes(term) : true;
        return okTipo && okTerm;
      });

      $('#commResultsCount').textContent = `${filtered.length} resultados`;

      grid.innerHTML = '';
      if(filtered.length === 0){
        grid.innerHTML = `<div style="padding:14px;color:#666;font-weight:800;">Nenhum grupo encontrado.</div>`;
        return;
      }

      for(const g of filtered){
        const capa = g.capa && String(g.capa).trim() ? g.capa : '';
        const coverStyle = capa ? `background-image:url('${escapeHtml(capa)}')` : '';
        const iconImg = capa ? capa : 'https://picsum.photos/200?random=' + encodeURIComponent(g.id);

        const card = document.createElement('div');
        card.className = 'card-comm';
        card.setAttribute('data-id', g.id);

        card.innerHTML = `
          <div class="card-cover" style="${coverStyle}">
            <div class="card-tag ${tagClass(g.tipo)}">${escapeHtml(g.tipo||'Pro')}</div>
          </div>
          <div class="card-body">
            <div class="card-icon"><img src="${escapeHtml(iconImg)}" loading="lazy" alt=""></div>
            <div class="card-title">${escapeHtml(g.nome || 'Grupo')}</div>
            <div class="card-desc">${escapeHtml(g.descricao || '')}</div>
            <div class="card-meta">
              ${g.privacidade ? `<span class="meta-pill">${escapeHtml(g.privacidade)}</span>` : ''}
              ${g.categoria ? `<span class="meta-pill">${escapeHtml(g.categoria)}</span>` : ''}
              ${g.subcategoria ? `<span class="meta-pill">${escapeHtml(g.subcategoria)}</span>` : ''}
            </div>
            <div class="members-preview">
              <div class="mem-avatar" style="background-image:url('https://i.pravatar.cc/60?u=${encodeURIComponent(g.id+'a')}')"></div>
              <div class="mem-avatar" style="background-image:url('https://i.pravatar.cc/60?u=${encodeURIComponent(g.id+'b')}')"></div>
              <div class="mem-avatar" style="background-image:url('https://i.pravatar.cc/60?u=${encodeURIComponent(g.id+'c')}')"></div>
              <div class="mem-count">${escapeHtml(String(g.membrosCount ?? (Array.isArray(g.membros)?g.membros.length:0))) } membros</div>
            </div>
          </div>
          <div class="card-footer">
            <button class="btn-entrar" data-open="${escapeHtml(g.id)}">Abrir</button>
          </div>
        `;

        // card click abre também
        card.addEventListener('click', (ev)=>{
          const t = ev.target;
          if(t && t.closest && t.closest('button')) return;
          window.location.href = `grupo.html?id=${g.id}`;
        });

        // abrir
        const openBtn = card.querySelector('[data-open]');
        if(openBtn){
          openBtn.addEventListener('click', (ev)=>{
            ev.preventDefault();
            ev.stopPropagation();
            // se público, tenta entrar rápido, senão abre
            joinQuick(g.id, g.privacidade);
          });
        }

        grid.appendChild(card);
      }
    }

    async function carregarTudo(){
      await carregarComunidadesGerais();
      await carregarMeusGrupos();
    }

    async function main(){
      bindModalClose();
      bindSearch();
      bindFile();

      const ok = await waitForDb();
      if(!ok){
        toast("Falha ao iniciar banco (db/auth)", "error");
        return;
      }

      try{
        onAuthStateChanged(window.auth, async (user)=>{
          state.user = user || null;
          if(user && window.marcarComoOnline) window.marcarComoOnline(user.uid);
          await carregarTudo();
        });
      }catch(e){
        state.user = window.auth?.currentUser || null;
        await carregarTudo();
      }
    }

    window.addEventListener('load', main);
  })();
</script>

</body>
</html>