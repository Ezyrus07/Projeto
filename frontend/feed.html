<!DOCTYPE html>
<html lang="pt-br">
<head>

  <!-- Supabase (UMD) + init + compat (Firestore/Auth) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-init.js"></script>
  <script src="firebase-compat-supabase.js"></script>
  <script src="firebase-auth-compat-supabase.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feed | Doke</title>
    <link rel="stylesheet" href="style.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

  <!-- Supabase (UMD) + init + compat (Firestore/Auth) -->
</head>
<body class="page-feed">

    <header class="navbar-mobile">
        <div id="logo-mobile"><a href="index.html"><img src="assets/Imagens/doke-logo.png" alt="Doke"></a></div>
        <div class="mobile-controls"><button id="btn-menu-mobile" onclick="abrirMenuMobile()"><i class='bx bx-menu'></i></button></div>
    </header>
    <div id="overlay-menu" onclick="fecharMenuMobile()"></div>
    <aside class="sidebar-icones">
        <div id="logo">
            <a href="index.html">
                <img src="assets/Imagens/doke-logo.png" alt="Logotipo da plataforma Doke">
            </a>
        </div>

        <div class="item">
            <a href="index.html"><img src="https://cdn-icons-png.flaticon.com/512/1946/1946436.png" class="icon azul" alt="Início">
            <span>Início</span></a>
        </div>
        <div class="item">
            <a href="explorar.html"><img src="https://cdn-icons-png.flaticon.com/512/622/622669.png" class="icon verde" alt="Explorar">
            <span>Explorar</span></a>
        </div>
        <div class="item">
            <a href="notificacoes.html"><img src="https://cdn-icons-png.flaticon.com/512/1827/1827392.png" class="icon azul" alt="Notificações">
            <span>Notificações</span></a>
        </div>
        <div class="item">
            <img src="https://cdn-icons-png.flaticon.com/512/561/561127.png" class="icon azul" alt="Mensagens">
            <a href="chat.html"><span>Mensagens</span></a>
        </div>
        <div class="item">
            <a href="comunidade.html"><img src="https://cdn-icons-png.flaticon.com/512/1144/1144760.png" class="icon verde" alt="Comunidades">
            <span>Comunidades</span></a>
        </div>
        <div class="item">
            <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="icon verde" alt="Comunidades">
            <a href="#" onclick="irParaMeuPerfil(event)"><span>Perfil</span></a>
        </div>
        <div class="item">
            <img src="https://cdn-icons-png.flaticon.com/512/56/56763.png" class="icon azul" alt="Mais">
            <a href="mais.html"><span>Mais</span></a>
        </div>
    </aside>

    <main class="feed-main-container">
        
        <div class="reels-scroll-container" id="containerReels">
            <div style="text-align:center; padding:50px; color:white;">
                <i class='bx bx-loader-alt bx-spin' style="font-size:2rem;"></i> Carregando Feed...
            </div>
        </div>

    </main>
    <div id="reelCommentsOverlay" class="reel-comments-overlay" style="display: none;" onclick="if(event.target.id==='reelCommentsOverlay') fecharComentariosReel()">
        <div class="reel-comments-card">
            <div class="reel-comments-header">
                <b>Comentarios</b>
                <button type="button" class="reel-comments-close" onclick="fecharComentariosReel()">x</button>
            </div>
            <div id="reelCommentsList" class="reel-comments-list"></div>
            <div class="reel-comments-input">
                <input type="text" id="reelCommentInput" placeholder="Adicione um comentario...">
                <button type="button" onclick="enviarComentarioReel()">Publicar</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        </nav>

    <script>
        const { initializeApp } = window;
        const { getFirestore, collection, query, orderBy, limit, getDocs, doc, updateDoc, increment, addDoc } = window;
        const { getAuth, onAuthStateChanged, signOut } = window;

        // CONFIGURAÇÃO DO FIREBASE (Mesma do seu script.js)
        const firebaseConfig = {
            apiKey: "AIzaSyDbUwwj-joyhJ3aJ-tP4WJhGC1wLrwYh60",
            authDomain: "doke-site.firebaseapp.com",
            projectId: "doke-site",
            storageBucket: "doke-site.firebasestorage.app",
            messagingSenderId: "997098339190",
            appId: "1:997098339190:web:a865b696278be21f069857"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- LÓGICA DO FEED TIKTOK ---
function getSupabaseClient() {
    return window.sb || window.supabaseClient || window.sbClient || window.supabase || null;
}

async function fetchSupabaseReelsFeed() {
    const client = getSupabaseClient();
    if (!client) return [];
    const withJoin = "id, user_id, video_url, created_at, titulo, descricao, thumb_url, usuarios (id, uid, nome, user, foto)";
    let { data, error } = await client
        .from("videos_curtos")
        .select(withJoin)
        .order("created_at", { ascending: false })
        .limit(30);
    if (error) {
        const fallback = "id, user_id, video_url, created_at, titulo, descricao, thumb_url";
        const retry = await client
            .from("videos_curtos")
            .select(fallback)
            .order("created_at", { ascending: false })
            .limit(30);
        if (retry.error) {
            console.error("Erro ao carregar videos curtos supabase:", retry.error);
            return [];
        }
        return retry.data || [];
    }
    return data || [];
}

        
async function carregarReels() {
    const container = document.getElementById('containerReels');
    container.innerHTML = "";

    const feedItems = [];

    try {
        const q = query(collection(db, "reels"), orderBy("data", "desc"), limit(30));
        const snapshot = await getDocs(q);
        snapshot.forEach(doc => {
            const data = doc.data() || {};
            feedItems.push({
                source: "firebase",
                id: doc.id,
                createdAt: data.data,
                data
            });
        });
    } catch (e) {
        console.error(e);
    }

    try {
        const supaItems = await fetchSupabaseReelsFeed();
        supaItems.forEach(item => {
            feedItems.push({
                source: "supabase",
                id: item.id,
                createdAt: item.created_at,
                data: item
            });
        });
    } catch (e) {
        console.error(e);
    }

    if (feedItems.length === 0) {
        container.innerHTML = "<p style='color:white; text-align:center; padding:50px;'>Sem videos no momento.</p>";
        return;
    }

    feedItems.sort((a, b) => {
        const aTime = new Date(a.createdAt).getTime();
        const bTime = new Date(b.createdAt).getTime();
        return (bTime || 0) - (aTime || 0);
    });

    feedItems.forEach(entry => {
        const data = entry.data || {};
        const source = entry.source;
        let videoUrl = "";
        let capa = "";
        let perfilFoto = "https://placehold.co/150";
        let autorNome = "@usuario";
        let descricao = "";
        let uidSeguro = "";
        let likes = 0;

        if (source === "firebase") {
            videoUrl = data.videoUrl || "";
            capa = data.capa || data.img || "";
            perfilFoto = data.autorFoto || "https://placehold.co/150";
            autorNome = data.autorUser || data.autorNome || "@usuario";
            descricao = data.descricao || "";
            uidSeguro = data.uid || "";
            likes = data.likes || 0;
        } else {
            const autor = data.usuarios || {};
            videoUrl = data.video_url || "";
            capa = data.thumb_url || "";
            perfilFoto = autor.foto || "https://placehold.co/150";
            autorNome = autor.user || autor.nome || "@usuario";
            descricao = data.descricao || data.titulo || "";
            uidSeguro = autor.uid || "";
        }

        if (!videoUrl) return;
        const reelId = `${source === "supabase" ? "sb" : "fb"}-${entry.id}`;

        const html = `
        <div class="reel-page" id="reel-${reelId}">
            <div class="reels-layout">
                <div class="video-frame" onclick="togglePlayFeed(this)">
                    <video class="video-player-feed" loop playsinline muted ${capa ? `poster="${capa}"` : ""} src="${videoUrl}"></video>
                    <div class="play-overlay"><i class='bx bx-play'></i></div>
                    <div class="video-info-overlay">
                        <div class="author-row" onclick="event.stopPropagation(); irParaPerfil('${uidSeguro}')">
                            <img src="${perfilFoto}" class="author-avatar" onerror="this.src='https://placehold.co/150'">
                            <span class="author-name">${autorNome}</span>
                        </div>
                        <div class="video-caption">${descricao}</div>
                    </div>
                </div>

                <div class="actions-column">
                    <button class="short-profile-btn" onclick="irParaPerfil('${uidSeguro}')">
                        <img src="${perfilFoto}" class="short-avatar" onerror="this.src='https://placehold.co/150'">
                    </button>

                    <button class="short-action-btn" onclick="curtirReel('${source}', '${entry.id}', this)">
                        <i class='bx bx-heart'></i>
                        <span class="short-action-count">${likes}</span>
                    </button>

                    <button class="short-action-btn" onclick="comentarReel('${source}', '${entry.id}')">
                        <i class='bx bx-message-rounded'></i>
                    </button>

                    <button class="short-action-btn" onclick="compartilharReel('${autorNome}')">
                        <i class='bx bx-paper-plane'></i>
                    </button>
                </div>
            </div>
        </div>`;
        
        container.insertAdjacentHTML('beforeend', html);
    });

    iniciarObserver();

    const startId = new URLSearchParams(window.location.search).get('start');
    if (startId) {
        const alvo = document.getElementById(`reel-${startId}`);
        if (alvo) alvo.scrollIntoView({ block: 'start' });
    }
}

        // AUTO-PLAY AO ROLAR (Intersection Observer)
        function iniciarObserver() {
            const videos = document.querySelectorAll('.video-player-feed');
            const root = document.getElementById('containerReels');
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const video = entry.target;
                    const frame = video.closest('.video-frame');
                    if (entry.isIntersecting) {
                        video.currentTime = 0;
                        video.play().catch(() => {});
                        if (frame) frame.classList.remove('paused');
                    } else {
                        video.pause();
                        video.currentTime = 0;
                        if (frame) frame.classList.add('paused');
                    }
                });
            }, { threshold: 0.6, root });

            videos.forEach(video => observer.observe(video));
        }

        // Funções Globais para o HTML acessar
        window.togglePlayFeed = function(frame) {
            const video = frame.querySelector('video');
            const icon = frame.querySelector('.play-overlay');
            if (!video) return;
            if (video.paused) {
                video.play().catch(() => {});
                frame.classList.remove('paused');
                if (icon) icon.style.opacity = '0';
            } else {
                video.pause();
                frame.classList.add('paused');
                if (icon) {
                    icon.style.opacity = '1';
                    icon.style.transform = 'translate(-50%, -50%) scale(1.1)';
                    setTimeout(() => icon.style.transform = 'translate(-50%, -50%) scale(1)', 200);
                }
            }
        }

                window.curtirReel = async function(source, id, btn) {
            const icon = btn.querySelector('i');
            const span = btn.querySelector('.short-action-count');
            const liked = btn.classList.toggle('liked');
            if (icon) icon.className = liked ? 'bx bxs-heart' : 'bx bx-heart';
            let atual = parseInt(span?.innerText || "0", 10) || 0;
            atual = liked ? atual + 1 : Math.max(0, atual - 1);
            if (span) span.innerText = atual;

            if (source !== "firebase") return;

            try {
                await updateDoc(doc(db, "reels", id), { likes: increment(liked ? 1 : -1) });
            } catch(e) { console.error(e); }
        }
                        window.comentarReel = function(source, id) {
            const overlay = document.getElementById('reelCommentsOverlay');
            const list = document.getElementById('reelCommentsList');
            const input = document.getElementById('reelCommentInput');
            const sendBtn = overlay?.querySelector('.reel-comments-input button');
            if (!overlay || !list || !input || !sendBtn) return;

            window.currentReelCommentsSource = source;
            window.currentReelCommentsId = id;
            overlay.style.display = 'flex';

            if (source !== "firebase") {
                list.innerHTML = "<div class='reel-comments-empty'>Comentarios indisponiveis neste video.</div>";
                input.value = "";
                input.disabled = true;
                sendBtn.disabled = true;
                return;
            }

            input.disabled = false;
            sendBtn.disabled = false;
            list.innerHTML = "<div class='reel-comments-empty'>Carregando comentarios...</div>";
            carregarComentariosReelFirebase(id);
        }

        window.fecharComentariosReel = function() {
            const overlay = document.getElementById('reelCommentsOverlay');
            if (overlay) overlay.style.display = 'none';
            window.currentReelCommentsSource = null;
            window.currentReelCommentsId = null;
        }

        async function carregarComentariosReelFirebase(id) {
            const list = document.getElementById('reelCommentsList');
            if (!list) return;
            list.innerHTML = "";

            try {
                const q = query(collection(db, "reels", id, "comentarios"), orderBy("data", "desc"));
                const snap = await getDocs(q);
                if (snap.empty) {
                    list.innerHTML = "<div class='reel-comments-empty'>Sem comentarios ainda.</div>";
                    return;
                }
                snap.forEach(docSnap => {
                    const c = docSnap.data();
                    const html = `
                    <div class="reel-comment-item">
                        <img src="${c.foto || 'https://placehold.co/32'}" alt="">
                        <div>
                            <b>${c.user || 'Usuario'}</b>
                            <span>${c.texto || ''}</span>
                        </div>
                    </div>`;
                    list.insertAdjacentHTML('beforeend', html);
                });
            } catch (e) {
                console.error(e);
                list.innerHTML = "<div class='reel-comments-empty'>Erro ao carregar comentarios.</div>";
            }
        }

        window.enviarComentarioReel = async function() {
            const overlay = document.getElementById('reelCommentsOverlay');
            const input = document.getElementById('reelCommentInput');
            if (!overlay || !input) return;

            if (window.currentReelCommentsSource !== "firebase") {
                alert("Comentarios indisponiveis neste video.");
                return;
            }

            const user = auth.currentUser;
            if (!user) {
                alert("Faca login para comentar.");
                return;
            }

            const texto = input.value.trim();
            if (!texto) return;

            const perfilLocal = JSON.parse(localStorage.getItem('doke_usuario_perfil')) || {};
            try {
                await addDoc(collection(db, "reels", window.currentReelCommentsId, "comentarios"), {
                    uid: user.uid,
                    user: perfilLocal.user || "Usuario",
                    foto: perfilLocal.foto || "https://placehold.co/50",
                    texto: texto,
                    data: new Date().toISOString()
                });
                input.value = "";
                carregarComentariosReelFirebase(window.currentReelCommentsId);
            } catch (e) {
                console.error(e);
                alert("Erro ao comentar.");
            }
        }
        window.irParaPerfil = function(uid) {
            if (!uid) return;
            window.location.href = `perfil-profissional.html?uid=${uid}`;
        }

        // Inicia
        carregarReels();

        // Verifica Auth para Sidebar
        onAuthStateChanged(auth, (user) => {
            if(user) localStorage.setItem('usuarioLogado', 'true');
            // Aqui você pode chamar a função do script.js principal se quiser carregar avatar
        });

    </script>
</body>
</html>










