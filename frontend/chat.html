<!DOCTYPE html>

<html lang="pt-br">
<head>
<!-- Supabase (UMD) + init + compat (Firestore/Auth) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase-init.js"></script>
<!-- Storage bucket padrÃ£o (áudios/arquivos do chat). Ajuste se mudar o bucket no Supabase Storage. -->
<script>
    window.__DOKE_SUPABASE_STORAGE_BUCKET__ =
      window.__DOKE_SUPABASE_STORAGE_BUCKET__ ||
      localStorage.getItem("DOKE_SUPABASE_STORAGE_BUCKET") ||
      'posts';
  </script>
<script src="firebase-compat-supabase.js?v=20260207v24"></script>
<script src="firebase-auth-compat-supabase.js"></script>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Mensagens | Doke</title>
    <meta name="description" content="Converse com profissionais e clientes em um chat r&aacute;pido e responsivo.">
    <meta property="og:title" content="Doke - Chat">
    <meta property="og:description" content="Converse com profissionais e clientes em um chat r&aacute;pido e responsivo.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="assets/Imagens/doke-logo.png">
    <meta name="theme-color" content="#0b7768">

<link href="style.css?v=20260211v44" rel="stylesheet"/>
<link rel="stylesheet" href="doke-a11y.css?v=20260207v21">
<link href="doke-layout-fix.css?v=20260207v21" rel="stylesheet"/>
<link href="doke-fixes.css" rel="stylesheet"/>
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet"/>
<!-- script.js removido no chat para evitar conflitos/dobro de listeners (o chat jÃ¡ tem lÃ³gica prÃ³pria aqui) -->
<style>
        /* =========================================================================
           LAYOUT DE MENSAGERIA PROFISSIONAL (COM HEADER PADRÃƒO)
           ========================================================================= */
        
        :root{
            --ux-bg: #eef2f7;
            --ux-panel: #ffffff;
            --ux-ink: #0f172a;
            --ux-muted: #64748b;
            --ux-line: #e2e8f0;
            --ux-brand: #0b7768;
            --ux-brand-weak: rgba(11,119,104,0.12);
            --ux-warm: #fff7ed;
            --ux-warm-line: #fde7c7;
            --ux-card-shadow: 0 10px 24px rgba(15,23,42,0.08);
        }

        html, body { height: 100%; margin: 0; padding: 0 !important; padding-top: 0 !important; padding-bottom: 0 !important; overflow: hidden; background: var(--ux-bg); font-family: 'Segoe UI', sans-serif; color: var(--ux-ink); }

        body[data-page="chat"], body[data-page="chat"].doke-shell-active{ padding-top: 0 !important; padding-bottom: 0 !important; }

        .navbar-mobile { justify-content: space-between; align-items: center; min-height: var(--navbar-height-mobile); }
        .navbar-mobile .mobile-controls { display: flex; align-items: center; gap: 12px; }
        #logo-mobile{ display:flex; align-items:center; min-height:48px; }
        #logo-mobile img{ display:block; height:32px; width:auto; }
        .navbar-mobile .botoes-direita{ min-width:56px; display:flex; justify-content:flex-end; align-items:center; }
        .header-mobile-avatar{
            width: 48px;
            height: 48px;
            border-radius: 999px;
            border: 2px solid var(--cor0);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            overflow: hidden;
        }
        .header-mobile-avatar img{
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            display:block;
        }
        #btn-menu-mobile { background: none; border: none; cursor: pointer; }
        /* Icon baseline fix (Boxicons) */
        .bx{ line-height: 1; }
        .archive-btn i, .chat-menu-btn i, .btn-enviar i, .btn-attach i, .msg-menu-btn i{ line-height: 1; display: block; margin: 0; }
        .archive-btn, .chat-menu-btn, .btn-enviar, .btn-attach, .msg-menu-btn{ padding: 0; }
        .btn-enviar, .btn-attach{ display: grid; place-items: center; line-height: 1; }
        .archive-btn{ width: 34px; height: 34px; border-radius: 10px; }
        .chat-menu-btn{ width: 40px; height: 40px; display: grid; place-items: center; }
        .chat-menu-btn i{ font-size: 22px; }


        /* Container Principal do Chat (Abaixo do Header) */
        .messenger-layout {
            display: grid;
            grid-template-columns: 380px 1fr; /* 380px Lista | Resto Chat */
            height: calc(100vh - var(--navbar-height-desktop)); /* Altura total MENOS o header */
            width: calc(100vw - var(--sidebar-width)); /* Largura total MENOS a sidebar */
            margin-left: var(--sidebar-width); /* EspaÃ§o da Sidebar */
            margin-top: var(--navbar-height-desktop); /* EspaÃ§o do Header */
            background: var(--ux-panel);
            position: relative;
            border-left: 1px solid var(--ux-line);
        }

        /* --- COLUNA ESQUERDA: LISTA --- */
        .coluna-lista {
            border-right: 1px solid var(--ux-line);
            background: var(--ux-panel);
            display: flex;
            flex-direction: column;
            z-index: 10;
            height: 100%;
            min-height: 0; /* importante para o scroll funcionar dentro do flex */
        }

        .lista-header {
            padding: 18px 20px 16px;
            background: linear-gradient(180deg, #ffffff 0%, #f7fafc 100%);
            border-bottom: 1px solid var(--ux-line);
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 5;
        }
        .lista-top{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
        }
        .lista-quick{
            margin-top:10px;
            display:flex;
            align-items:center;
            gap:10px;
            flex-wrap:wrap;
        }

        .titulo-msg { margin: 0 0 10px 0; color: var(--ux-ink); font-size: 1.5rem; font-weight: 800; letter-spacing: -0.01em; }

        /* Abas */
        .abas-container {
            display: flex;
            background: #eef2f7;
            padding: 4px;
            border-radius: 999px;
        }
        .aba-btn {
            flex: 1;
            border: none;
            background: transparent;
            padding: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #475569;
            border-radius: 999px;
            cursor: pointer;
            transition: 0.2s;
        }
        .aba-btn.active {
            background: #ffffff;
            color: var(--ux-brand);
            box-shadow: 0 6px 14px rgba(15,23,42,0.08);
        }
        .pedidos-filtros{
            display:flex;
            gap:8px;
            margin-top:10px;
            flex-wrap:wrap;
        }
        .pf-btn{
            border:1px solid #e2e8f0;
            background:#fff;
            color:#475569;
            padding:6px 10px;
            border-radius:999px;
            font-size:0.75rem;
            font-weight:800;
            cursor:pointer;
        }
        .pf-btn.active{
            border-color: rgba(11,119,104,0.35);
            background: var(--ux-brand-weak);
            color:#064e42;
        }
        .lista-tools{
            display:flex;
            flex-direction:column;
            gap:10px;
            margin-top:12px;
        }
        .lista-search{
            position:relative;
            flex:1;
        }
        .lista-search i{
            position:absolute;
            left:10px;
            top:50%;
            transform:translateY(-50%);
            color:#94a3b8;
            font-size:1.05rem;
        }
        .lista-search input{
            width:100%;
            padding:8px 12px 8px 34px;
            border-radius:10px;
            border:1px solid #e2e8f0;
            background:#fff;
            font-size:0.85rem;
            color:#111;
            outline:none;
        }
        .filter-btn{
            border:1px solid #e2e8f0;
            background:#fff;
            color:#0f172a;
            padding:8px 12px;
            border-radius:10px;
            font-size:0.78rem;
            font-weight:800;
            cursor:pointer;
            display:flex;
            align-items:center;
            gap:6px;
            white-space:nowrap;
        }
        .filter-btn:hover{ background:#f8fafc; }
        .bulk-select-bar{
            display:flex;
            align-items:center;
            gap:8px;
            flex-wrap:wrap;
            padding:2px 0;
        }
        #conversasBulkBar{
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            max-width: 100%;
        }
        #conversasBulkBar::-webkit-scrollbar{ display:none; }
        #conversasBulkBar .bulk-count{ flex: 0 0 auto; }
        .bulk-count{
            font-size:.78rem;
            font-weight:800;
            color:#0f172a;
            white-space:nowrap;
        }
        .bulk-btn{
            border:1px solid #e2e8f0;
            background:#fff;
            color:#0f172a;
            padding:7px 10px;
            border-radius:10px;
            font-size:.74rem;
            font-weight:800;
            cursor:pointer;
            white-space:nowrap;
        }
        .bulk-btn i{
            font-size: 1rem;
            line-height: 1;
        }
        .bulk-btn.bulk-icon{
            width: 34px;
            min-width: 34px;
            height: 34px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }
        .bulk-btn.bulk-primary{
            border-color: rgba(11,119,104,0.45);
            background:#0b7768;
            color:#fff;
        }
        .bulk-btn.bulk-danger{
            border-color:#fecaca;
            background:#fee2e2;
            color:#b91c1c;
        }
        .bulk-btn:disabled{
            opacity:.55;
            cursor:not-allowed;
        }
        @media (max-width: 760px){
            .bulk-select-bar{
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                max-width: 100%;
            }
            .bulk-select-bar::-webkit-scrollbar{ display:none; }
        }
        .lista-filters-panel{
            margin-top:12px;
            padding:10px;
            border:1px solid var(--ux-line);
            border-radius:12px;
            background:#fff;
            display:none;
            gap:10px;
            flex-direction:column;
        }
        .lista-filters-panel.open{ display:flex; }
        .lista-search input:focus{
            border-color: rgba(11,119,104,0.35);
            box-shadow: 0 0 0 3px rgba(11,119,104,0.12);
        }
        .lista-archive-toggle{
            display:flex;
            gap:8px;
            flex-wrap:wrap;
        }

        /* Listas com Scroll */
        .lista-scroll {
            flex: 1;
            overflow-y: auto;
            background: #f8fafc;
            min-height: 0; /* permite a lista encolher e ativar o overflow */
            overscroll-behavior: contain;
        }
        .lista-scroll { padding: 10px 10px 24px; }

        /* CARD DE PEDIDO */
        .item-pedido {
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            border-left: 4px solid transparent;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: #fff;
            border-radius: 12px;
            margin: 6px 6px;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.06);
        }
        .item-pedido:hover { background-color: #f8fafc; transform: translateY(-1px); }
        .item-pedido.active { background-color: #f0fdf4; border-color: rgba(11,119,104,0.35); box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08); }
        .item-pedido.is-select-mode{ cursor: pointer; }
        .item-pedido.is-selected{
            border-color: rgba(11,119,104,.42) !important;
            box-shadow: 0 14px 30px rgba(11,119,104,.17), 0 0 0 2px rgba(11,119,104,.10) !important;
            background: linear-gradient(180deg, #ffffff, #eefaf6);
        }

        .status-border-pendente { border-left-color: #ff9800; }
        .status-border-aceito { border-left-color: #2e7d32; }
        .status-border-recusado { border-left-color: #c62828; }

        .ip-header {
            display: grid;
            grid-template-columns: auto auto;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .ip-header-actions{
            display:flex;
            align-items:center;
            justify-content:flex-end;
            gap:8px;
            flex-wrap:nowrap;
            min-width:0;
        }
        .ip-header-actions .unread-dot{
            width: 10px;
            height: 10px;
            min-width: 10px;
            min-height: 10px;
            margin: 0 2px 0 0;
            align-self: center;
            transform: translateY(0);
            box-shadow: 0 0 0 2px #fff;
            flex-shrink: 0;
        }
        .ip-header .tag-orcamento,
        .ip-header .ip-badge,
        .ip-header .unread-dot{
            white-space: nowrap;
            flex-shrink: 0;
        }
        .ip-select-indicator{
            width:24px;
            height:24px;
            min-width:24px;
            border-radius:999px;
            border:1px solid #cbd5e1;
            background:#fff;
            color:#64748b;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
            padding:0;
        }
        .ip-select-indicator.selected{
            border-color:#0b7768;
            background:#0b7768;
            color:#fff;
        }
        .ip-header .tag-orcamento{
            display:inline-flex;
            align-items:center;
            width: auto;
            max-width: none;
            flex: 0 0 auto;
        }
        @media (min-width: 1025px){
            .ip-header-actions{
                min-width: 0;
            }
            .ip-header-actions .unread-dot{
                margin-left: 6px;
                margin-right: 2px;
            }
        }
        .ip-user { display: flex; align-items: center; gap: 8px; font-weight: 600; color: #333; font-size: 0.82rem; }
        .ip-user img { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; }
        
        .ip-badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 700;
            text-transform: uppercase;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .badge-pendente { background: #fff3e0; color: #ef6c00; }
        .badge-aceito { background: #e8f5e9; color: #2e7d32; }
        .badge-recusado { background: #ffebee; color: #c62828; }
        .badge-aceito{
            white-space: nowrap;
            word-break: keep-all;
        }


        /* Chip de status do pedido (Topo do chat) */
        .chip-pedido-status{
            display:inline-flex;
            align-items:center;
            gap:6px;
            padding:4px 10px;
            border-radius:999px;
            font-size:0.72rem;
            font-weight:800;
            text-transform:uppercase;
            width:fit-content;
            margin-top:6px;
        }
        .chip-pendente{ background:#fff3e0; color:#ef6c00; border:1px solid #ffe0b2; }
        .chip-aceito{ background:#e8f5e9; color:#2e7d32; border:1px solid #c8e6c9; }
        .chip-pago{ background:#e0f2f1; color:#00695c; border:1px solid #b2dfdb; }
        .chip-finalizado{ background:#e8eaf6; color:#303f9f; border:1px solid #c5cae9; }
        .chip-recusado{ background:#ffebee; color:#c62828; border:1px solid #ffcdd2; }
        .chip-cancelado{ background:#ffebee; color:#c62828; border:1px solid #ffcdd2; }

        .ip-body h4 { margin: 0; font-size: 0.88rem; color: #111; font-weight: 700; }
        .ip-body p { margin: 2px 0 0 0; font-size: 0.78rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ip-date { font-size: 0.75rem; color: #999; text-align: right; margin-top: 4px; }
        @media (min-width: 1025px){
            .coluna-lista .lista-scroll{
                padding: 12px 14px 30px;
            }
            .item-pedido{
                padding: 14px 16px;
                gap: 8px;
                border-radius: 14px;
            }
            .ip-user{
                font-size: 0.88rem;
            }
            .ip-body h4{
                font-size: 1rem;
                margin-top: 4px;
            }
            .ip-sub{
                font-size: 0.84rem;
                line-height: 1.35;
            }
        }

        /* CARD DE CONVERSA */
        .item-conversa {
            display: flex; padding: 10px 12px; gap: 10px; cursor: pointer; transition: 0.2s; align-items: center;
            border: 1px solid #e2e8f0; background: #fff; border-radius: 12px; margin: 6px 6px;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.06);
        }
        .item-conversa:hover { background-color: #f8fafc; transform: translateY(-1px); }
        .item-conversa.active { background-color: #f0fdf4; border-color: rgba(11,119,104,0.35); box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08); }
        .item-conversa.is-select-mode{ cursor: pointer; }
        .item-conversa.is-selected{
            border-color: rgba(11,119,104,.42) !important;
            box-shadow: 0 14px 30px rgba(11,119,104,.17), 0 0 0 2px rgba(11,119,104,.10) !important;
            background: linear-gradient(180deg, #ffffff, #eefaf6);
        }
        @media (hover: hover) and (pointer: fine){
            .item-pedido,
            .item-conversa{
                transition: transform .18s ease, box-shadow .22s ease, border-color .2s ease, background-color .2s ease;
            }
            .item-pedido:hover,
            .item-conversa:hover{
                transform: translateY(-2px);
                border-color: rgba(11, 119, 104, 0.30);
                box-shadow: 0 14px 30px rgba(15, 23, 42, 0.14);
                background: linear-gradient(180deg, #ffffff, #f8fbff);
            }
        }
        .item-conversa img { width: 34px; height: 34px; border-radius: 50%; object-fit: cover; }
        .ic-info { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .ic-nome { font-weight: 600; color: #111; font-size: 0.9rem; }
        .ic-msg { font-size: 0.78rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ic-meta { display:flex; align-items:center; gap:8px; margin-left:auto; }
        .unread-dot{
            width:10px;
            height:10px;
            border-radius:50%;
            background:#ef4444;
            box-shadow: 0 0 0 2px #fff;
        }
        .unread-badge{
            min-width:18px;
            height:18px;
            padding:0 6px;
            border-radius:999px;
            background:#ef4444;
            color:#fff;
            font-size:0.65rem;
            font-weight:800;
            display:flex;
            align-items:center;
            justify-content:center;
        }

        /* --- COLUNA DIREITA: CHAT --- */
        .coluna-chat {
            background-color: #f1f5f9;
            background-image: radial-gradient(#dce3ee 0.5px, transparent 0.5px);
            background-size: 24px 24px;
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            min-height: 0; /* importante para o scroll interno do chat */
        }

        #chat-placeholder {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; background: #f0f2f5; color: #555; text-align: center; border-bottom: 6px solid #009688;
        }

        #box-conversa-real { display: none; flex-direction: column; height: 100%; overflow: hidden; }

        .chat-header {
            height: 64px; background: rgba(255,255,255,0.92); border-bottom: 1px solid var(--ux-line);
            display: flex; align-items: center; padding: 0 20px; gap: 15px; flex-shrink: 0;
            backdrop-filter: blur(10px);
        }
        .chat-header h4 { margin: 0; font-size: 1rem; color: #111; }
        .chat-header span { font-size: 0.8rem; color: #666; }
        #chatAvatar{
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex: 0 0 auto;
        }
        .chat-info{ flex: 1; min-width: 0; }
        .chat-info h4{ line-height: 1.15; }
        #chatStatus{
            display: inline-flex;
            align-items: center;
            gap: 6px;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }


        .header-actions { margin-left: auto; display: flex; gap: 10px; }
        .btn-header { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-weight: 600; font-size: 0.8rem; }
        .btn-aceitar-mini { background: #2e7d32; color: white; }
        .btn-recusar-mini { background: #c62828; color: white; }
        .chat-menu{
            position: relative;
            margin-left: 6px;
        }
        .chat-header-tools{
            margin-left: auto;
            display:flex;
            align-items:center;
            gap:8px;
            flex-shrink:0;
        }
        .chat-menu-btn{
            width:40px;
            height:40px;
            border-radius:50%;
            border:1px solid #e2e8f0;
            background:#fff;
            cursor:pointer;
            display:grid;
            place-items:center;
            color:#444;
        }
        .chat-menu-btn:hover{ background:#f8fafc; }
        .chat-menu-dropdown{
            position:absolute;
            right:0;
            top:44px;
            min-width:210px;
            background:#fff;
            border:1px solid #e5e7eb;
            border-radius:10px;
            box-shadow:0 12px 30px rgba(0,0,0,0.12);
            padding:6px;
            display:none;
            z-index: 300;
        }
        .chat-menu.open .chat-menu-dropdown{ display:block; }
        .chat-menu-item{
            width:100%;
            padding:10px 12px;
            border:none;
            background:transparent;
            text-align:left;
            font-size:0.85rem;
            font-weight:700;
            color:#1f2937;
            border-radius:8px;
            cursor:pointer;
        }
        .chat-menu-item:hover{ background:#f3f4f6; }
        .chat-menu-item.danger{ color:#b91c1c; }
        .chat-menu{ position: relative; z-index: 60; }
        .chat-menu-dropdown{ z-index: 99999; }
        .chat-header{ position: relative; z-index: 60; overflow: visible; }
        .mensagens-body{ position: relative; z-index: 1; }
        .coluna-chat, #box-conversa-real{ overflow: hidden; }

        .archive-btn{
            width:34px;
            height:34px;
            border-radius:10px;
            border:1px solid #e2e8f0;
            background:#fff;
            color:#64748b;
            display:grid;
            place-items:center;
            cursor:pointer;
            transition:all .15s ease;
        }
        .archive-btn i{
            font-size: 1.02rem;
            line-height: 1 !important;
            margin: 0 !important;
            display: block;
        }
        .archive-btn:hover{ background:#f1f5f9; color:var(--cor0); }

        .muted-badge{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            width:18px;
            height:18px;
            border-radius:999px;
            background:#eef2f7;
            color:#64748b;
            font-size:.8rem;
        }

        .reply-bar{
            display:none;
            align-items:center;
            justify-content:space-between;
            gap:12px;
            padding:8px 12px;
            border:1px solid #e2e8f0;
            background:#f8fafc;
            border-radius:12px;
            margin:8px 16px 0 16px;
        }
        .reply-bar.show{ display:flex; }
        .reply-bar .rb-left{ min-width:0; flex:1; }
        .reply-bar .rb-user{ font-weight:800; font-size:0.85rem; }
        .reply-bar .rb-text{ font-size:0.82rem; color:#64748b; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .reply-bar .rb-close{
            width:32px; height:32px; border-radius:10px;
            border:1px solid #e2e8f0; background:#fff; cursor:pointer;
        }
        /* Reply estilo Direct */
        .reply-preview{
            background: rgba(255,255,255,0.12);
            border-left:3px solid rgba(255,255,255,0.5);
            padding:6px 10px;
            margin-bottom:8px;
            border-radius:10px;
            font-size:0.78rem;
            color: rgba(247,255,251,0.9);
        }
        .msg-recebida .reply-preview{
            background:#f1f5f9;
            border-left-color: var(--cor0);
            color: #64748b;
        }
        .msg-reply-btn{
            border:none; background:transparent; cursor:pointer;
            color:#94a3b8; padding:2px 4px; border-radius:6px;
            float:right; margin-left:6px; font-size:0.72rem;
        }
        .msg-reply-btn:hover{ background:#f1f5f9; color:#0b7768; }
        .pedido-info-card, .pedido-recusa-card{
            align-self: center;
            width: min(520px, 92%);
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 14px 16px;
            box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
            margin: 6px auto 10px;
        }
        .pedido-info-card .pi-header{
            display:flex; align-items:center; justify-content:space-between; gap:10px;
            margin-bottom: 8px;
        }
        .pedido-info-card .pi-title{
            font-weight: 800; color:#0f172a; font-size:0.95rem;
        }
        .pedido-info-card .pi-chip{
            background:#e0f2f1; color:#0b7768; border-radius:999px;
            padding:4px 10px; font-size:0.7rem; font-weight:800;
        }
        .pedido-info-card .pi-desc{
            font-size:0.82rem; color:#475569; margin-bottom: 10px;
        }
        .pedido-info-card .pi-grid{
            display:grid; grid-template-columns: 1fr 1fr; gap:10px;
            margin-bottom: 10px;
        }
        .pedido-info-card .pi-label{ font-size:0.7rem; color:#94a3b8; text-transform:uppercase; font-weight:800; }
        .pedido-info-card .pi-value{ font-size:0.82rem; color:#1f2937; font-weight:700; }
        .pedido-info-card .pi-block{
            background:#f8fafc; border:1px dashed #e2e8f0; border-radius:12px;
            padding:10px;
        }
        .pedido-info-card .pi-list{
            display:flex; flex-direction:column; gap:6px; font-size:0.8rem; color:#475569;
        }
        .pedido-info-card .pi-anexos-grid{
            display:grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap:8px;
            margin-top:6px;
        }
        .pedido-info-card .pi-anexos-grid img{
            width:100%;
            height:72px;
            object-fit:cover;
            border-radius:10px;
            border:1px solid #e2e8f0;
            background:#f1f5f9;
            cursor:pointer;
            transition: transform .15s ease, box-shadow .15s ease;
        }
        .pedido-info-card .pi-anexos-grid img:hover{
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(15, 23, 42, 0.12);
        }
        .pedido-info-card .pi-qa b{ color:#0f172a; font-size:0.78rem; display:block; margin-bottom:2px; }
        .pedido-info-card .pi-links a{ color:var(--cor0); font-weight:700; text-decoration:none; }
        .pedido-recusa-card{
            border-color:#fecaca;
            background:#fff1f2;
        }
        .pedido-recusa-card .pr-title{ font-weight:800; color:#b91c1c; font-size:0.9rem; margin-bottom:6px; }
        .pedido-recusa-card .pr-text{ color:#7f1d1d; font-size:0.85rem; }
        .chat-context-bar{
            display:none;
            align-items:center;
            justify-content:space-between;
            gap:12px;
            padding:10px 16px;
            background:#fff;
            border-bottom:1px solid #e2e8f0;
            font-size:0.82rem;
            color:#475569;
        }
        .chat-context-bar.show{ display:flex; }
        .chat-context-actions{ display:flex; gap:8px; flex-wrap:wrap; }
        .chat-context-actions button{
            border:1px solid #e2e8f0;
            background:#fff;
            color:#0f172a;
            padding:6px 10px;
            border-radius:999px;
            font-size:0.72rem;
            font-weight:800;
            cursor:pointer;
        }
        .chat-context-actions .primary{
            background: var(--cor0);
            color:#fff;
            border-color: var(--cor0);
        }
        .chat-context-actions .danger{
            background:#fee2e2;
            color:#b91c1c;
            border-color:#fecaca;
        }
        .chat-context-actions .close-card{
            width:30px;
            min-width:30px;
            height:30px;
            padding:0;
            border-radius:999px;
            font-size:1rem;
            line-height:1;
            font-weight:900;
            color:#475569;
        }
        .ip-andamento{
            position: relative;
            margin-top:10px;
            background:#ffffff;
            border:1px solid #e6e6e6;
            border-radius:14px;
            padding:12px;
            display:flex;
            align-items:center;
            gap:12px;
            box-shadow:0 2px 10px rgba(0,0,0,0.04);
        }
        .ip-andamento.has-close{ padding-right:42px; }
        .ip-andamento-icon{
            width:38px;
            height:38px;
            border-radius:12px;
            background:#e0f2f1;
            display:flex;
            align-items:center;
            justify-content:center;
            color:var(--cor0);
            flex-shrink:0;
        }
        .ip-andamento-content{
            flex:1;
            min-width:0;
        }
        .ip-andamento-title{
            font-weight:800;
            color:#111;
            font-size:0.92rem;
            line-height:1.2;
        }
        .ip-andamento-text{
            font-size:0.78rem;
            color:#6b7280;
            margin-top:2px;
            line-height:1.35;
        }
        .ip-andamento-close{
            position:absolute;
            right:8px;
            top:8px;
            width:24px;
            height:24px;
            border:none;
            border-radius:999px;
            background:#f1f5f9;
            color:#64748b;
            font-size:0.9rem;
            cursor:pointer;
            display:grid;
            place-items:center;
        }
        .ip-andamento-close:hover{ background:#e2e8f0; color:#0f172a; }

        .pinned-bar{
            display:flex;
            align-items:center;
            gap:10px;
            padding:8px 14px;
            background:#fff7ed;
            border-top:1px solid #f1f5f9;
            border-bottom:1px solid #f1f5f9;
        }
        .pinned-title{
            font-size:0.72rem;
            font-weight:800;
            color:#92400e;
            display:flex;
            align-items:center;
            gap:6px;
            white-space:nowrap;
        }
        .pinned-list{
            display:flex;
            gap:8px;
            overflow-x:auto;
            padding:4px 0;
            scrollbar-width: thin;
        }
        .pinned-item{
            background:#fff;
            border:1px solid #fed7aa;
            border-radius:10px;
            padding:6px 10px;
            font-size:0.72rem;
            font-weight:700;
            color:#7c2d12;
            cursor:pointer;
            white-space:nowrap;
        }
        .pinned-item span{ font-weight:600; color:#9a3412; }
        .pinned-item:hover{ background:#fff2e0; }

        .lista-view-toggle{
            display:flex;
            gap:8px;
            margin-top:10px;
            flex-wrap:wrap;
        }

        .agenda-panel{
            background:#fff;
            border:1px solid #e2e8f0;
            border-radius:16px;
            padding:14px;
            margin:0 14px 16px;
            box-shadow:0 4px 12px rgba(15,23,42,0.04);
        }
        .agenda-top{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:10px;
        }
        .agenda-title{ font-weight:800; color:#0f172a; }
        .agenda-nav{
            background:#f8fafc;
            border:1px solid #e2e8f0;
            border-radius:10px;
            width:32px; height:32px;
            display:flex; align-items:center; justify-content:center;
            cursor:pointer;
        }
        .agenda-weekdays{
            display:grid;
            grid-template-columns:repeat(7,1fr);
            gap:6px;
            margin-top:12px;
            font-size:0.68rem;
            color:#64748b;
            text-align:center;
            font-weight:700;
            text-transform:uppercase;
        }
        .agenda-grid{
            display:grid;
            grid-template-columns:repeat(7,1fr);
            gap:6px;
            margin-top:8px;
        }
        .agenda-day{
            position:relative;
            border:1px solid #e2e8f0;
            border-radius:10px;
            min-height:56px;
            padding:6px 6px 14px;
            background:#f8fafc;
            cursor:pointer;
            font-size:0.72rem;
        }
        .agenda-day.off{ opacity:0.45; background:#f1f5f9; }
        .agenda-day.has{ background:#ecfeff; border-color:#67e8f9; }
        .agenda-day.active{ outline:2px solid #0b7768; outline-offset:1px; }
        .agenda-day .day-num{ font-weight:800; color:#334155; }
        .agenda-dots{
            position:absolute;
            bottom:6px; left:6px;
            display:flex; gap:4px;
        }
        .agenda-dot{ width:6px; height:6px; border-radius:50%; }
        .status-dot-pendente{ background:#f59e0b; }
        .status-dot-andamento{ background:#10b981; }
        .status-dot-finalizado{ background:#64748b; }
        .status-dot-disputa{ background:#ef4444; }

        .agenda-day-details{
            margin-top:12px;
            border-top:1px dashed #e2e8f0;
            padding-top:10px;
        }
        .agenda-day-title{
            font-weight:800;
            color:#0f172a;
            font-size:0.85rem;
        }
        .agenda-day-list{ margin-top:8px; display:flex; flex-direction:column; gap:8px; }
        .agenda-item{
            border:1px solid #e2e8f0;
            border-radius:12px;
            padding:10px;
            display:flex;
            flex-direction:column;
            gap:4px;
            background:#fff;
            cursor:pointer;
        }
        .agenda-item-title{ font-weight:700; color:#0f172a; font-size:0.8rem; }
        .agenda-item-meta{ font-size:0.7rem; color:#64748b; display:flex; gap:8px; flex-wrap:wrap; }
        .agenda-item-status{
            align-self:flex-start;
            padding:2px 6px;
            border-radius:999px;
            font-size:0.65rem;
            font-weight:800;
            text-transform:uppercase;
            background:#f1f5f9;
            color:#475569;
        }

        .disputa-status-badge{
            display:inline-flex;
            align-items:center;
            gap:6px;
            padding:6px 10px;
            border-radius:999px;
            font-size:0.72rem;
            font-weight:800;
            text-transform:uppercase;
        }
        .disputa-status-aberta{ background:#fee2e2; color:#b91c1c; }
        .disputa-status-analise{ background:#e0f2fe; color:#0369a1; }
        .disputa-status-resolvida{ background:#dcfce7; color:#166534; }
        .disputa-actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
        .disputa-actions button{
            border:1px solid #e2e8f0;
            background:#fff;
            padding:8px 12px;
            border-radius:12px;
            font-size:0.8rem;
            font-weight:800;
            cursor:pointer;
        }
        .disputa-actions .primary{ background:#0b7768; color:#fff; border-color:#0b7768; }
        .disputa-actions .danger{ background:#fee2e2; color:#b91c1c; border-color:#fecaca; }
        .disputa-timeline{ margin-top:14px; display:flex; flex-direction:column; gap:10px; }
        .disputa-event{
            border:1px solid #e2e8f0;
            border-radius:12px;
            padding:10px 12px;
            background:#fff;
        }
        .disputa-event-title{ font-weight:800; color:#0f172a; font-size:0.85rem; }
        .disputa-event-meta{ font-size:0.7rem; color:#64748b; margin-top:4px; }
        .disputa-provas{ display:flex; flex-direction:column; gap:8px; margin-top:12px; }
        .disputa-provas a{ color:#0b7768; font-weight:700; text-decoration:none; font-size:0.8rem; }
        .disputa-provas a:hover{ text-decoration:underline; }
        .disputa-upload{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:10px; }
        .disputa-upload input[type="file"]{ font-size:0.78rem; }

        .mensagens-body {
            flex: 1;
            overflow-y: auto;
            height: 100%;
            padding: 26px 46px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: #94a3b8 #f1f5f9;
        }

        .chat-footer {
            min-height: 64px; background: #ffffff; border-top: 1px solid var(--ux-line);
            display: flex; align-items: center; padding: 12px 20px; gap: 10px; flex-shrink: 0;
        }
        .input-msg { flex: 1; padding: 12px; border-radius: 8px; border: none; outline: none; }
        .btn-enviar { background: #009688; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: grid; place-items: center; font-size: 1.2rem; }
        .btn-attach { background: #e0e0e0; color: #555; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: grid; place-items: center; font-size: 1.2rem; }
        .btn-enviar i, .btn-attach i, .chat-menu-btn i{ margin: 0; line-height: 1; display: block; }
        .btn-attach:hover { filter: brightness(0.98); }

        .msg-bubble { max-width: 68%; padding: 10px 14px; border-radius: 16px; font-size: 0.92rem; position: relative; box-shadow: 0 4px 12px rgba(15,23,42,0.08); line-height: 1.45; }
        .msg-enviada { align-self: flex-end; background: var(--ux-brand); color: #fff; border-top-right-radius: 6px; }
        .msg-recebida { align-self: flex-start; background: #ffffff; color: #0f172a; border-top-left-radius: 6px; }
        .msg-hora { font-size: 0.7rem; color: #999; float: right; margin-top: 5px; margin-left: 10px; }

        .btn-voltar-mobile { display: none; }


        /* Fix flex overflow (texto vertical/colado) */
        .coluna-chat, .coluna-lista, .chat-header, .ip-body { min-width: 0; }
        #chatNome { max-width: 220px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ip-user span { display:block; max-width: 220px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ip-sub { margin: 6px 0 0; color: #64748b; font-size: 0.82rem; line-height: 1.25; }

        @media (max-width: 1024px) {
            .navbar-desktop { display: none; }
            /* Reserva espaÃ§o para header + bottom-nav (evita barra flutuando e gaps) */
            /* v25 â€” evita "gap" entre barra de digitar e bottom-nav */
            .messenger-layout { position: fixed; top: var(--navbar-height-mobile); left: 0; right: 0; bottom: var(--bottom-nav-height); width: auto; height: auto; margin: 0; display: block; border-left: 0; }
            .coluna-lista { width: 100%; height: 100%; position: relative; }
            .coluna-chat { 
                position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
                z-index: 200; transform: translateX(100%); transition: transform 0.3s ease;
            }
            .mobile-chat-open .coluna-chat { transform: translateX(0); }
            #chat-placeholder { display: none; }
            .btn-voltar-mobile { display: block; border: none; background: none; font-size: 1.5rem; color: #555; cursor: pointer; margin-right: 10px; }
        }
        @media (max-width: 560px){
            .chat-header{ height: auto; padding: 10px 12px; gap: 10px; flex-wrap: wrap; align-content: flex-start; }
            #chatAvatar{ width: 36px; height: 36px; margin-right: 0 !important; }
            .chat-info{ flex: 1 1 auto; min-width: 0; }
            #chatNome{ max-width: 100% !important; font-size: 0.95rem; }
            #chatStatus{ display:block; white-space: normal; overflow: visible; text-overflow: unset; font-size: 0.75rem; }
            #container-acao-header, #acoes-profissional-header{ width: 100%; justify-content: flex-end; order: 10; }
            #btn-cobranca-topo{ width: auto; max-width: 100%; }
            .chat-menu{ margin-left: auto; order: 5; }
            .chat-menu-btn{ width: 38px; height: 38px; }
        }


        .btn-cobranca {
    background-color: #f1c40f; /* Amarelo Ouro */
    color: #333; /* Texto escuro para contraste */
    border: none;
    padding: 8px 16px;
    border-radius: 30px; /* Borda redonda moderna */
    font-weight: 700;
    font-size: 0.85rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px; /* EspaÃ§o entre Ã­cone e texto */
    transition: 0.2s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-right: 0;
}

.btn-cobranca:hover {
    background-color: #f39c12; /* Amarelo mais escuro ao passar o mouse */
    transform: translateY(-2px);
}

/* --- CARD DE PAGAMENTO (CORRIGIDO) --- */
.msg-card-pagamento {
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    min-width: 280px;
    max-width: 320px;
    /* Removido o overflow hidden para nÃ£o cortar o botÃ£o se ele tiver sombra */
    margin: 12px 0;
    border: 1px solid #edf2f7;
    display: flex;
    flex-direction: column;
}

.cp-header {
    background-color: #f8fafc;
    color: #4a5568;
    padding: 14px;
    font-size: 0.85rem;
    font-weight: 600;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    border-bottom: 1px solid #edf2f7;
}

.cp-body {
    padding: 20px; /* Reduzi um pouco para o botÃ£o subir */
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px; /* EspaÃ§amento uniforme entre elementos */
}

.cp-valor {
    font-size: 2.2rem;
    font-weight: 800;
    color: #1a202c;
    margin: 0;
}

.cp-desc {
    font-size: 0.9rem;
    color: #718096;
    margin-bottom: 10px;
}

/* BotÃ£o ajustado para nÃ£o cortar */
.btn-pagar-card {
    width: 100%;
    background: #009688;
    color: white;
    border: none;
    padding: 12px;
    border-radius: 10px;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    box-sizing: border-box; /* Garante que o padding nÃ£o aumente o tamanho real */
}

/* Efeito de Vidro (Glassmorphism) no Header do Chat */
.chat-header {
    height: 70px; /* Um pouco mais alto para respiro */
    background: rgba(240, 242, 245, 0.9);
    backdrop-filter: blur(10px); /* Efeito de desfoque moderno */
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    padding: 0 25px;
}

/* Melhoria nas Bubbles de Mensagem */
.msg-bubble {
    max-width: 70%;
    padding: 10px 16px;
    border-radius: 18px; /* Bordas mais arredondadas */
    font-size: 0.92rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: transform 0.2s ease;
}

.msg-enviada {
    background: var(--cor0); /* Verde Doke */
    color: white;
    border-bottom-right-radius: 4px;
}

.msg-recebida {
    background: #ffffff;
    color: #333;
    border-bottom-left-radius: 4px;
}

/* Ãrea de Mensagens com Fundo Personalizado */
.mensagens-body {
    background-color: #f0f2f5;
    /* Adicionando um padrÃ£o leve de fundo que lembra o WhatsApp */
    background-image: radial-gradient(#d1d1d1 0.5px, transparent 0.5px);
    background-size: 20px 20px;
    padding: 25px 50px;
}

/* CustomizaÃ§Ã£o da Scrollbar para ficar elegante */
.lista-scroll::-webkit-scrollbar, 
.mensagens-body::-webkit-scrollbar {
    width: 6px;
}

.lista-scroll::-webkit-scrollbar-thumb, 
.mensagens-body::-webkit-scrollbar-thumb {
    background-color: rgba(0, 150, 136, 0.2);
    border-radius: 10px;
}

/* Hover nos itens da lista lateral */
.item-pedido, .item-conversa {
    margin: 8px 12px;
    border-radius: 12px;
    border: 1px solid transparent;
    transition: all 0.3s ease;
}

.item-pedido:hover, .item-conversa:hover {
    background-color: #f8f9fa;
    border-color: #eee;
    transform: translateX(5px);
}

.chat-footer {
    padding: 15px 25px;
    background: white;
    border-top: none;
}

.input-msg {
    background: #f0f2f5;
    padding: 12px 20px;
    border-radius: 25px; /* Estilo pÃ­lula */
    border: 1px solid transparent;
    font-family: inherit;
}

.input-msg:focus {
    background: white;
    border-color: var(--cor0);
    box-shadow: 0 0 0 3px rgba(11, 119, 104, 0.1);
}

/* Feedback visual para elementos clicÃ¡veis no chat */
#chatAvatar, #chatNome, .ip-user, .ic-nome {
    cursor: pointer;
    transition: opacity 0.2s ease, transform 0.2s ease;
}

#chatAvatar:hover, #chatNome:hover, .ip-user:hover, .ic-nome:hover {
    opacity: 0.85;
    transform: translateY(-1px);
}

/* Garante que o card de mensagem tenha a animaÃ§Ã£o de entrada corrigida */
@keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.msg-bubble, .msg-card-pagamento {
    animation: slideIn 0.3s ease-out forwards;
}

/* Estilo para Pedidos de OrÃ§amento (Verde) */
.tipo-pedido {
    border-left: 5px solid #0b7768 !important;
    background-color: #f0f9f8;
}
.tipo-pedido .ip-badge {
    background: #0b7768;
    color: white;
}

/* Estilo para SolicitaÃ§Ãµes de Conversa (Azul) */
.tipo-conversa {
    border-left: 5px solid #2a5f90 !important;
    background-color: #f0f4f9;
}
.tipo-conversa .ic-nome {
    color: #2a5f90;
}

/* Badge identificador de tipo */
.tag-tipo {
    font-size: 0.65rem;
    font-weight: 800;
    text-transform: uppercase;
    padding: 2px 6px;
    border-radius: 4px;
    margin-bottom: 5px;
    display: inline-block;
}
.tag-orcamento { background: #e0f2f1; color: #0b7768; }
.tag-papo { background: #e3f2fd; color: #2a5f90; }

/* Card de OrÃ§amento (Verde) */
.card-orcamento {
    border-left: 5px solid #0b7768 !important;
    background-color: #f0f9f8 !important;
}

/* Card de Conversa (Azul) */
.card-conversa {
    border-left: 5px solid #2a5f90 !important;
    background-color: #f0f4f9 !important;
}

.tag-card {
    font-size: 0.6rem;
    font-weight: bold;
    text-transform: uppercase;
    padding: 2px 5px;
    border-radius: 3px;
    margin-bottom: 5px;
    display: inline-block;
}

/* Estilo para o botÃ£o de cancelar dentro do card */
.item-pedido .btn-recusar-mini {
    padding: 8px;
    font-size: 0.8rem;
    background-color: #fce4e4; /* Vermelho bem claro */
    color: #c62828;
    border: 1px solid #ef9a9a;
    transition: 0.2s;
}

.item-pedido .btn-recusar-mini:hover {
    background-color: #c62828;
    color: white;
}

/* MODAL DE DETALHES */
.modal-detalhes {
    display: none; position: fixed; z-index: 9999; left: 0; top: 0;
    width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
}
.modal-content {
    background: #fff; margin: 10% auto; padding: 0; border-radius: 16px;
    width: 90%; max-width: 500px; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    animation: slideUp 0.3s ease-out; overflow: hidden;
}
.modal-header {
    background: var(--cor2); color: white; padding: 20px;
    display: flex; justify-content: space-between; align-items: center;
}
        .modal-body { padding: 25px; max-height: 70vh; overflow-y: auto; }
        .md-triagem{
            margin-top: 12px;
            display: grid;
            gap: 8px;
        }
        .md-triagem .md-qa{
            background:#f8fafc;
            border:1px solid #e2e8f0;
            border-radius:10px;
            padding:10px 12px;
        }
        .md-triagem .md-qa b{
            display:block;
            font-size:0.72rem;
            color:#0b7768;
            text-transform:uppercase;
            letter-spacing:.04em;
            margin-bottom:4px;
        }
        .md-triagem .md-qa span{
            color:#334155;
            font-size:0.9rem;
        }
        .md-timeline{
            margin-top:16px;
            display:grid;
            gap:10px;
        }
        .md-step{
            display:flex;
            align-items:center;
            gap:10px;
            padding:10px 12px;
            border:1px solid #e5e7eb;
            border-radius:10px;
            background:#fff;
        }
        .md-step.done{
            border-color:#c7f2e3;
            background:#f0fdf9;
        }
        .md-step .dot{
            width:10px;
            height:10px;
            border-radius:50%;
            background:#cbd5f5;
            flex-shrink:0;
        }
        .md-step.done .dot{ background:#10b981; }
        .md-step .label{
            font-weight:800;
            font-size:0.85rem;
            color:#111;
        }
        .md-step .date{
            margin-left:auto;
            font-size:0.72rem;
            color:#64748b;
        }
.detail-row { margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
.detail-label { font-size: 0.75rem; color: #888; text-transform: uppercase; font-weight: 700; margin-bottom: 4px; }
.detail-value { color: #333; font-weight: 500; line-height: 1.4; }

/* BOTÃ•ES E LINKS DISCRETOS */
.btn-detalhes {
    background: #f0fdfa; color: var(--cor0); border: 1px solid #ccfbf1;
    padding: 8px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 600;
    cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 5px; margin-top: 10px;
}
.btn-detalhes:hover { background: var(--cor0); color: white; }

.link-cancelar {
    color: #ef4444; font-size: 0.75rem; font-weight: 600; 
    cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: 0.2s;
}
.link-cancelar:hover { background: #fee2e2; }

@keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* MODAL DE DETALHES DO ORÇAMENTO */
.modal-detalhes {
    display: none; position: fixed; z-index: 9999; left: 0; top: 0;
    width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
    justify-content: center; align-items: center;
}
.md-content {
    background: #fff; width: 90%; max-width: 500px; border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2); animation: zoomIn 0.3s ease;
    overflow: hidden;
}
.md-header {
    background: var(--cor2); color: white; padding: 20px;
    display: flex; justify-content: space-between; align-items: center;
}
.md-body { padding: 25px; max-height: 75vh; overflow-y: auto; }
.md-row { margin-bottom: 18px; border-bottom: 1px solid #f1f1f1; padding-bottom: 10px; }
.md-label { font-size: 0.7rem; color: #999; text-transform: uppercase; font-weight: 800; margin-bottom: 5px; }
.md-value { color: #333; font-weight: 500; line-height: 1.5; font-size: 0.95rem; }

/* ESTILO DO LINK CANCELAR (Inspirado no meuperfil.html) */
.btn-cancelar-discreto {
    color: #e74c3c; font-size: 0.75rem; font-weight: 700;
    cursor: pointer; text-decoration: none; padding: 4px 8px;
    border-radius: 6px; transition: 0.2s; background: #fff1f0;
}
.btn-cancelar-discreto:hover { background: #e74c3c; color: #fff; }

/* BOTÃƒO MAIS DETALHES */
.btn-detalhes-card {
    background: #f0f7f6; color: var(--cor0); border: 1px solid #d1e9e5;
    padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 700;
    cursor: pointer; display: flex; align-items: center; gap: 6px; margin-top: 10px;
    transition: 0.2s; width: fit-content;
}
.btn-detalhes-card:hover { background: var(--cor0); color: white; }

@keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

/* Modal de Motivo da Recusa */
#modalRecusa {
    display: none; position: fixed; z-index: 10000; left: 0; top: 0;
    width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
    justify-content: center; align-items: center;
}
.recusa-content {
    background: #fff; width: 90%; max-width: 400px; border-radius: 20px;
    padding: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); animation: zoomIn 0.3s;
}
.recusa-input {
    width: 100%; height: 100px; padding: 12px; border: 1px solid #ddd;
    border-radius: 12px; margin: 15px 0; font-family: inherit; resize: none;
}
.btn-confirm-recusa {
    width: 100%; background: #e74c3c; color: white; border: none;
    padding: 12px; border-radius: 12px; font-weight: 700; cursor: pointer;
}

/* BotÃ£o de FinalizaÃ§Ã£o no Topo */
.btn-conclusao-topo {
    background: #0b7768;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.8rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: background 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 4px 10px rgba(11, 119, 104, 0.2);
    margin-right: 10px;
}

.btn-conclusao-topo:hover {
    background: #085a4f;
    box-shadow: 0 6px 14px rgba(11, 119, 104, 0.28);
}

/* Tooltip do Dinheiro Retido */
.tooltip-container {
    position: relative;
    display: inline-block;
}

.ip-badge.badge-pago {
    background: #0b7768;
    color: white;
    cursor: help; /* Muda o mouse para indicar que hÃ¡ informaÃ§Ã£o */
}

.tooltip-card {
    visibility: hidden;
    width: 240px;
    background-color: #ffffff;
    color: #333;
    text-align: left;
    border-radius: 12px;
    padding: 15px;
    position: absolute;
    z-index: 100;
    bottom: 125%; /* Aparece acima do badge */
    left: 50%;
    transform: translateX(-50%);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    border: 1px solid #e0f2f1;
    opacity: 0;
    transition: opacity 0.3s;
}

/* TriÃ¢ngulo do card */
.tooltip-card::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -8px;
    border-width: 8px;
    border-style: solid;
    border-color: #fff transparent transparent transparent;
}

.tooltip-container:hover .tooltip-card {
    visibility: visible;
    opacity: 1;
}

.tooltip-card h5 {
    margin: 0 0 8px 0;
    color: #0b7768;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 5px;
}

.tooltip-card p {
    margin: 0;
    font-size: 0.75rem;
    line-height: 1.4;
    color: #666;
}

.tooltip-card a {
    display: inline-block;
    margin-top: 10px;
    color: #0b7768;
    text-decoration: underline;
    font-weight: 700;
    font-size: 0.75rem;
}

.modal-overlay-custom {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
        z-index: 10000; display: flex; align-items: center; justify-content: center;
    }
    .modal-box-custom {
        background: white; width: 90%; max-width: 400px; border-radius: 20px;
        padding: 30px; text-align: center; position: relative;
        box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    }
    .modal-icon-top {
        width: 70px; height: 70px; background: #e8f5e9; color: #2e7d32;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 3rem; margin: -65px auto 20px auto; border: 5px solid white;
    }
    .modal-box-custom h3 { margin: 0 0 10px 0; color: #333; font-size: 1.5rem; }
    .modal-actions-col { display: flex; flex-direction: column; gap: 10px; }
    
    .btn-primary-modal {
        background: var(--cor0); color: white; border: none; padding: 14px;
        border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer;
        display: flex; align-items: center; justify-content: center; gap: 8px;
        transition: 0.2s;
    }
    /* Evita "piscar" no hover (principalmente em alguns mobiles/Chromium) */
    .btn-primary-modal{ transform: translateZ(0); }
    .btn-primary-modal:hover { background: #096356; transform: translateZ(0); }
    
    .btn-secondary-modal {
        background: transparent; color: #777; border: none; padding: 12px;
        font-weight: 600; cursor: pointer;
    }
    .btn-secondary-modal:hover { color: #333; }

    .finalizar-upload {
        display: flex;
        flex-direction: column;
        gap: 8px;
        background: #f8fafc;
        border: 1px dashed #cbd5f5;
        border-radius: 14px;
        padding: 12px;
        text-align: left;
        margin: 12px 0 16px;
    }
    .finalizar-upload .btn-upload {
        background: #e8f5f1;
        color: #0b7768;
        border: 1px solid rgba(11,119,104,0.3);
        padding: 10px 12px;
        border-radius: 10px;
        font-weight: 800;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        width: fit-content;
    }
    .finalizar-upload small { color: #6b7280; }
    .finalizar-preview {
        margin-top: 10px;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 10px;
        display: none;
        align-items: center;
        gap: 10px;
    }
    .finalizar-preview img {
        width: 70px;
        height: 70px;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
    }
    .finalizar-preview video {
        width: 120px;
        height: 70px;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: #000;
    }
    .finalizar-preview button {
        background: #fee2e2;
        color: #b91c1c;
        border: none;
        padding: 6px 10px;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
    }
    .finalizar-modo {
        display: flex;
        gap: 14px;
        flex-wrap: wrap;
        margin-top: 12px;
    }
    .finalizar-modo label {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-weight: 700;
        color: #334155;
        font-size: 0.9rem;
    }
    .finalizar-dupla {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
    .finalizar-slot {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 10px;
    }
    #modalFinalizarPedido{
        align-items: flex-start;
        justify-content: center;
        overflow-y: auto;
        padding: max(12px, env(safe-area-inset-top)) 12px max(12px, env(safe-area-inset-bottom));
        -webkit-overflow-scrolling: touch;
    }
    #modalFinalizarPedido .modal-box-custom{
        width: min(94vw, 460px);
        max-width: min(94vw, 460px);
        padding: 22px 18px 16px;
        max-height: calc(100vh - 24px);
        max-height: calc(100svh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
        max-height: calc(100dvh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 auto;
    }
    #modalFinalizarPedido .modal-icon-top{
        margin: 0 auto 14px !important;
        width: 72px;
        height: 72px;
        font-size: 2.2rem;
        flex-shrink: 0;
    }
    @media (max-width: 560px) {
        .finalizar-dupla {
            grid-template-columns: 1fr;
        }
        #modalFinalizarPedido{
            align-items: flex-start;
            justify-content: center;
            padding-top: calc(env(safe-area-inset-top) + 8px);
            padding-bottom: max(84px, calc(env(safe-area-inset-bottom) + 16px));
        }
        #modalFinalizarPedido .modal-box-custom{
            width: min(94vw, 460px) !important;
            max-width: min(94vw, 460px) !important;
            border-radius: 20px !important;
            padding: 18px 16px 14px !important;
            max-height: calc(100svh - 20px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            overflow-y: auto;
            overflow-x: hidden;
            overscroll-behavior: contain;
        }
        #modalFinalizarPedido .modal-icon-top{
            width: 64px;
            height: 64px;
            font-size: 2rem;
            margin: 2px auto 12px !important;
        }
        #modalFinalizarPedido .modal-box-custom h3{
            font-size: clamp(2rem, 6vw, 2.3rem);
            margin-bottom: 8px;
        }
        #modalFinalizarPedido .modal-actions-col{
            position: sticky;
            bottom: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0), #fff 22%);
            padding-top: 8px;
        }
        #modalFinalizarPedido .btn-primary-modal{
            min-height: 52px;
        }
    }

    @keyframes bounceIn {
        0% { transform: scale(0.8); opacity: 0; }
        60% { transform: scale(1.05); opacity: 1; }
        100% { transform: scale(1); }
    }
    .bounceIn { animation: bounceIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

    /* BotÃ£o Cancelar Discreto e Elegante */
.btn-cancelar-discreto {
    width: 100%;
    margin-top: 10px;
    background: transparent;
    border: 1px solid #ffcccc;
    color: #e74c3c;
    padding: 8px;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

/* #chatStatus: regras definidas acima */

/* Alinhamento do Status */
/* #chatStatus: regras definidas acima */

/* Ajuste fino da bolinha */
.status-dot {
    font-size: 0.6rem; /* Tamanho da bolinha */
    display: inline-block;
    position: relative;
    top: 0px; /* Ajuste manual se precisar subir/descer */
}

/* AnimaÃ§Ã£o do Ponto Vermelho */
.recording-indicator {
    display: flex; align-items: center; gap: 8px; color: #e74c3c; font-weight: bold;
}
.red-dot {
    width: 10px; height: 10px; background-color: #e74c3c; border-radius: 50%;
    animation: pulse 1s infinite;
}
@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.5; }
    100% { transform: scale(1); opacity: 1; }
}

/* Estilo do Player de Áudio na Conversa */
.audio-bubble {
    display: flex; align-items: center; gap: 10px; min-width: 200px;
}
.btn-play-audio {
    background: white; border: none; border-radius: 50%; width: 35px; height: 35px;
    display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--cor0);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.audio-wave {
    flex: 1; height: 4px; background: rgba(0,0,0,0.1); border-radius: 2px; position: relative; overflow: hidden;
}
.audio-wave::after {
    content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 0%;
    background: currentColor; transition: width 0.1s linear;
}

/* AnimaÃ§Ã£o de Pulso para o Status Online */
.status-pulse {
    width: 10px;
    height: 10px;
    background-color: #2ecc71;
    border-radius: 50%;
    position: relative;
    display: inline-block;
    /* A mÃ¡gica do pulso acontece aqui */
    box-shadow: 0 0 0 rgba(46, 204, 113, 0.4);
    animation: pulse-green 2s infinite;
}

@keyframes pulse-green {
    0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);
    }
    70% {
        transform: scale(1);
        box-shadow: 0 0 0 6px rgba(46, 204, 113, 0);
    }
    100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(46, 204, 113, 0);
    }
}

/* Container para alinhar texto e bolinha perfeitamente */
.status-container-online {
    display: flex;
    align-items: center;
    gap: 8px; /* EspaÃ§o entre bolinha e texto */
    font-weight: 600;
    color: #2ecc71;
    font-size: 0.85rem;
}

        /* --- Pequenas melhorias visuais (sem quebrar o JS existente) --- */
        .chat-shell{ backdrop-filter: blur(8px); }
        .chat-main{ background: linear-gradient(180deg, rgba(42,95,144,.08), rgba(11,119,104,.05), rgba(236,237,242,.45)); }

        @keyframes msgPop {
            from { transform: translateY(6px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .msg-bubble{ animation: msgPop .18s ease-out; font-size:1rem; }

        /* Botao flutuante para descer (aparece via JS) */
        .scroll-down{
            position: absolute;
            right: 16px;
            bottom: 92px;
            width: 42px;
            height: 42px;
            border-radius: 999px;
            border: 1px solid rgba(0,0,0,.08);
            background: #fff;
            box-shadow: 0 10px 24px rgba(0,0,0,.10);
            display: none;
            place-items: center;
            cursor: pointer;
            z-index: 50;
        }
        .scroll-down.show{ display: none; }
        .scroll-down i{ font-size: 1.3rem; color: var(--cor0); }
        /* =====================
           POLIMENTO VISUAL DOS CARDS (versÃ£o mais bonita, sem mexer no layout)
           ===================== */
        .coluna-lista { background: #f6f7f8; }

        .lista-header { background: #ffffff; }

        .item-pedido, .item-conversa {
            background: #fff;
            border: 1px solid #eceff1;
            box-shadow: 0 8px 24px rgba(0,0,0,0.06);
            margin: 10px 14px;
        }

        .item-pedido:hover, .item-conversa:hover {
            transform: translateY(-1px);
            border-color: rgba(11, 119, 104, 0.25);
            box-shadow: 0 10px 28px rgba(0,0,0,0.08);
        }

        .tag-orcamento {
            background: linear-gradient(135deg, rgba(11,119,104,0.12), rgba(42,95,144,0.12));
            color: #0b7768;
            border: 1px solid rgba(11,119,104,0.18);
            border-radius: 999px;
            padding: 3px 10px;
            font-weight: 800;
            letter-spacing: 0.4px;
        }

        .ip-badge {
            border-radius: 999px;
            padding: 0 14px;
            min-height: 34px;
            font-size: 0.65rem;
            white-space: nowrap;
            letter-spacing: .01em;
        }
        .ip-header-actions .ip-badge{
            min-width: 0;
            flex: 0 0 auto;
        }
        .ip-header-actions .ip-badge.badge-aceito{
            min-width: 0;
        }
        @media (max-width: 768px){
            .ip-header-actions .ip-badge{
                min-width: 0;
                padding: 0 10px;
                min-height: 30px;
            }
        }

        .ip-body h4 {
            margin: 2px 0 0 0;
            overflow-wrap: anywhere;
            line-height: 1.28;
        }

        .btn-detalhes-card {
            border-radius: 999px;
            padding: 8px 12px;
            border: 1px solid #e7eef3;
            background: #f7fafc;
            font-weight: 800;
        }
        .btn-detalhes-card:hover { background: #eef6ff; border-color: rgba(42,95,144,0.25); }

        .btn-cancelar-discreto {
            border-radius: 999px;
            padding: 10px 12px;
            border: 1px solid rgba(231,76,60,0.35);
            background: #fff;
            color: #e74c3c;
            font-weight: 900;
        }
        .btn-cancelar-discreto:hover { background: #e74c3c; color: #fff; }

        @media (max-width: 520px){
            .item-pedido, .item-conversa { margin: 8px 10px; }
            .mensagens-body { padding: 16px 14px; }
        }

/* ESTILOS DA GALERIA (LIGHTBOX) */
.galeria-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9); /* Fundo bem escuro */
    z-index: 20000; /* Bem alto para ficar na frente de tudo */
    display: flex;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(5px); /* Desfoque no fundo */
    animation: fadeIn 0.3s ease;
}

.galeria-conteudo {
    position: relative;
    max-width: 90%;
    max-height: 90%;
    display: flex;
    justify-content: center;
    align-items: center;
}

.galeria-conteudo img {
    max-width: 100%;
    max-height: 85vh; /* Altura mÃ¡xima para nÃ£o estourar a tela */
    border-radius: 8px;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    object-fit: contain;
}

.btn-fechar-galeria {
    position: absolute;
    top: 20px;
    right: 30px;
    color: white;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
    z-index: 20001;
    transition: 0.2s;
}
.btn-fechar-galeria:hover { color: #ccc; }

/* Setas de NavegaÃ§Ã£o */
.nav-seta {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255,255,255,0.1);
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 2rem;
    transition: 0.3s;
    z-index: 20001;
}
.nav-seta:hover { background: rgba(255,255,255,0.3); }
.nav-seta.esq { left: 20px; }
.nav-seta.dir { right: 20px; }

@media (max-width: 768px) {
    .nav-seta { width: 40px; height: 40px; font-size: 1.5rem; }
}

/* FAIXA DE MINIATURAS */
.galeria-thumbnails {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
    max-width: 90%;
    overflow-x: auto; /* Permite rolar se tiver muitas fotos */
    padding: 10px;
    background: rgba(0,0,0,0.5); /* Fundo semi-transparente atrÃ¡s das thumbs */
    border-radius: 12px;
    z-index: 20002;
    scrollbar-width: none; /* Esconde barra de rolagem no Firefox */
}

/* Esconde barra de rolagem no Chrome/Safari */
.galeria-thumbnails::-webkit-scrollbar { display: none; }

.thumb-item {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
    cursor: pointer;
    opacity: 0.6;
    transition: 0.2s;
    border: 2px solid transparent;
    flex-shrink: 0; /* Impede que a foto seja esmagada */
}

.thumb-item:hover {
    opacity: 1;
}

/* Quando a foto estÃ¡ selecionada */
.thumb-item.ativo {
    opacity: 1;
    border: 2px solid #fff; /* Borda branca igual Webmotors */
    transform: scale(1.1);
}

/* Ajuste no mobile */
@media (max-width: 768px) {
    .galeria-thumbnails {
        bottom: 60px; /* Sobe um pouco no celular */
        justify-content: flex-start; /* Alinha Ã  esquerda para rolar */
    }
}

    /* Chat bubble overrides (smaller + readable) */
    .mensagens-body {
        background-color: #f5f7fa !important;
        background-image: none !important;
        padding: 12px 18px !important;
    }
    .msg-bubble {
        max-width: 52% !important;
        padding: 6px 10px !important;
        border-radius: 12px !important;
        font-size: 0.76rem !important;
        line-height: 1.2 !important;
        width: fit-content !important;
        display: inline-block !important;
        word-break: break-word !important;
        white-space: normal !important;
    }
    .msg-bubble img {
        max-width: min(100%, 260px) !important;
        max-height: min(46vh, 320px) !important;
        width: auto !important;
        height: auto !important;
        object-fit: contain;
        border-radius: 12px;
    }
    .msg-bubble .msg-media-image{
        display: block;
        cursor: pointer;
    }
    @media (max-width: 560px){
        .msg-bubble .msg-media-image{
            max-width: min(68vw, 240px) !important;
            max-height: min(42vh, 280px) !important;
        }
    }
    .msg-enviada {
        background: #0b7768 !important;
        color: #ffffff !important;
    }
    .msg-recebida {
        background: #ffffff !important;
        color: #1f2937 !important;
        border: 1px solid #e5e7eb !important;
    }
    .msg-footer {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 6px;
        margin-top: 4px;
        font-size: 0.6rem;
        color: #94a3b8;
    }
    .msg-recebida .msg-footer { justify-content: flex-start; }
    .msg-footer .msg-hora { float: none; margin: 0; color: inherit; font-size: 0.7rem; }
    .msg-reply-btn { float: none; }
    .msg-read{
        display:inline-flex;
        align-items:center;
        gap:2px;
        font-size:0.7rem;
        opacity:0.7;
    }
    .msg-read.read{ color:#38bdf8; opacity:1; }
    .msg-highlight{ animation: msgFlash 1.2s ease; }
    @keyframes msgFlash {
        0% { box-shadow: 0 0 0 0 rgba(56,189,248,0.6); }
        100% { box-shadow: 0 0 0 8px rgba(56,189,248,0); }
    }
    .msg-enviada .reply-preview {
        color: rgba(255, 255, 255, 0.85);
        border-left-color: rgba(255, 255, 255, 0.55);
    }
    .reply-preview .rp-user { font-weight: 800; font-size: 0.66rem; }
    .reply-preview .rp-text {
        font-size: 0.66rem;
        opacity: 0.85;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    /* Menu 3 pontinhos por mensagem */
    .msg-bubble{ position:relative; }
    .msg-bubble.has-menu{ padding-right:42px !important; }
    .msg-menu-btn{
        border:none; background:transparent; cursor:pointer;
        width:26px; height:26px; border-radius:50%;
        display:grid; place-items:center;
        color:inherit; opacity:.7;
        line-height:1;
        position:absolute;
        top:6px;
        right:6px;
        z-index:3;
    }
    .msg-menu-btn i{
        display:block;
        margin:0;
        line-height:1;
    }
    .msg-menu-btn:hover{ background:rgba(15,23,42,0.08); opacity:1; }
    .msg-menu{
        position:absolute; z-index:30; top:6px;
        display:none; flex-direction:column;
        background:#ffffff;
        border:1px solid rgba(11,119,104,.2);
        border-radius:14px; box-shadow:0 14px 28px rgba(2,6,23,.12);
        min-width:190px; overflow:hidden;
    }
    .msg-menu .menu-title{
        padding:7px 12px; font-size:.7rem; letter-spacing:.04em;
        color:#0b7768; text-transform:uppercase; font-weight:800;
        background:rgba(11,119,104,.08);
        border-bottom:1px solid rgba(11,119,104,.12);
    }
    .msg-menu button{
        padding:11px 12px; border:none; background:transparent; text-align:left;
        font-size:.9rem; cursor:pointer; color:#0f172a;
        display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .msg-menu button:hover{ background:rgba(11,119,104,.08); }
    .msg-menu .danger{ color:#b42318; font-weight:800; }
    .msg-menu-right{ right:100%; margin-right:8px; }
    .msg-menu-left{ left:100%; margin-left:8px; }
    .audio-bubble { min-width: 140px !important; }

    </style>
<!-- Supabase (UMD) + init + compat (Firestore/Auth) -->
<link href="doke-toast.css" rel="stylesheet"/>
<link href="doke-alerts.css" rel="stylesheet"/>
<link href="doke-ux.css?v=20260207v21" rel="stylesheet"/>
<link rel="stylesheet" href="doke-shell.css?v=20260211v33">

<link rel="stylesheet" href="doke-responsive.css?v=20260209v23">
  <link rel="stylesheet" href="page-chat.css?v=20260212v37">

<link rel="stylesheet" href="doke-skeleton.css?v=20260209v1">
<link rel="stylesheet" href="doke-tablet-fix.css?v=20260209v1">
</head>
<body data-page="chat">
<aside class="sidebar-icones">
  <div id="logo">
    <a href="index.html">
      <img alt="Logotipo da plataforma Doke" decoding="async" loading="lazy" src="assets/Imagens/doke-logo.png"/>
    </a>
  </div>

  <div class="item">
    <a href="index.html">
      <i class='bx bx-home-alt icon azul'></i>
      <span>Início</span>
    </a>
  </div>

  <div class="item" id="pvSearchSidebarItem">
    <a href="#" class="pv-search-toggle" aria-label="Pesquisar">
      <i class='bx bx-search-alt-2 icon azul'></i>
      <span>Pesquisar</span>
    </a>
  </div>

  <div class="item">
    <a href="empresas.html">
      <i class='bx bx-store icon verde'></i>
      <span>Empresas</span>
    </a>
  </div>

  <div class="item">
    <a href="notificacoes.html">
      <i class='bx bx-bell icon azul'></i>
      <span>Notifica&ccedil;&otilde;es</span>
    </a>
  </div>

  <div class="item">
    <a href="chat.html">
      <i class='bx bx-message-rounded-dots icon azul'></i>
      <span>Mensagens</span>
    </a>
  </div>

  <div class="item">
    <a href="comunidade.html">
      <i class='bx bx-group icon verde'></i>
      <span>Comunidades</span>
    </a>
  </div>

  <div class="item">
    <a href="#" onclick="irParaMeuPerfil(event)">
      <i class='bx bx-user icon verde'></i>
      <span>Perfil</span>
    </a>
  </div>

  <div class="item">
    <a href="mais.html">
      <i class='bx bx-menu icon azul'></i>
      <span>Mais</span>
    </a>
  </div>
</aside>

<header class="navbar-desktop">
<div id="logo-desktop"><a href="projeto.html"><img alt="Doke" decoding="async" loading="lazy" src="assets/Imagens/doke-logo.png"/></a></div>
<nav class="menu">
<div class="cep-wrapper">
<a class="cep" href="#" id="linkCep" onclick="toggleCep(event)">
<svg fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"></path>
</svg>
<span id="textoCepSpan">Informe seu CEP</span>
</a>
<div class="cep-popup" id="boxCep">
<p>Digite seu CEP:</p>
<div class="cep-input-group"><input id="inputCep" maxlength="9" placeholder="00000-000" type="text"/><button onclick="salvarCep()">OK</button></div>
</div>
</div>
<a href="escolheranuncio.html">Anunciar</a>
<a href="comunidade.html ">Comunidades <span class="badge-novo1">NOVO</span></a>
<a href="novidades.html">Novidades</a>
</nav>
<div class="botoes-direita" id="header-user-area"><a class="entrar" href="login.html">Entrar</a></div>
</header>
<header class="navbar-mobile">
<div id="logo-mobile">
<a href="index.html">
<img alt="Doke" decoding="async" loading="eager" fetchpriority="high" src="assets/Imagens/doke-logo.png"/>
</a>
</div>
<div class="botoes-direita">
<a class="header-mobile-avatar" href="login.html" id="header-user-mobile" aria-label="Perfil">
<img id="header-mobile-avatar-img" alt="Entrar" decoding="async" loading="eager" src="assets/Imagens/user_placeholder.png" onerror="this.onerror=null;this.src='assets/Imagens/user_placeholder.png';"/>
</a>
</div>
</header>
<script>
    (function(){
        try {
            var perfil = JSON.parse(localStorage.getItem('doke_usuario_perfil') || 'null');
            if (!perfil) return;
            var mobileLink = document.getElementById('header-user-mobile');
            var mobileImg = document.getElementById('header-mobile-avatar-img');
            if (mobileLink) mobileLink.href = perfil.isProfissional ? 'meuperfil.html' : 'perfil-usuario.html';
            if (mobileImg && perfil.foto) {
                mobileImg.src = perfil.foto;
                mobileImg.alt = 'Perfil';
            }
        } catch (_) {}
    })();
</script>
<div id="overlay-menu" onclick="fecharMenuMobile()"></div>
<div class="messenger-layout" id="messengerMaster">
<div class="coluna-lista">
<div class="lista-header">
<div class="lista-top">
<h2 class="titulo-msg">Mensagens</h2>
<div class="abas-container">
<button class="aba-btn active" onclick="trocarAba('pedidos')">Pedidos</button>
<button class="aba-btn" onclick="trocarAba('conversas')">Mensagens</button>
</div>
</div>
<div class="lista-quick">
<div class="lista-search">
<i class="bx bx-search"></i>
<input id="inputBuscaLista" placeholder="Buscar por nome ou servi&ccedil;o" type="text"/>
</div>
<button class="filter-btn" id="toggleFilters" onclick="toggleListaFilters(event)">
                         Filtros <i class="bx bx-slider-alt"></i>
</button>
<button class="filter-btn" id="btnSelecionarPedidos" onclick="iniciarSelecaoPedidos()" style="display:none;">
                        Selecionar <i class="bx bx-check-square"></i>
</button>
<button class="filter-btn" id="btnSelecionarConversas" onclick="iniciarSelecaoConversas()" style="display:none;">
                        Selecionar <i class="bx bx-check-square"></i>
</button>
<div class="bulk-select-bar" id="pedidosBulkBar" style="display:none;">
<span class="bulk-count" id="pedidosBulkCount">0 selecionados</span>
<button class="bulk-btn bulk-primary" id="btnArquivarSelecionados" onclick="arquivarPedidosSelecionados()" type="button">Arquivar</button>
<button class="bulk-btn" id="btnCancelarSelecaoPedidos" onclick="cancelarSelecaoPedidos()" type="button">Cancelar</button>
</div>
<div class="bulk-select-bar" id="conversasBulkBar" style="display:none;">
<span class="bulk-count" id="conversasBulkCount">0 selecionados</span>
<button aria-label="Arquivar contatos selecionados" class="bulk-btn bulk-primary" id="btnArquivarConversasSelecionadas" onclick="arquivarConversasSelecionadas()" type="button"><i class="bx bx-archive"></i> Arquivar</button>
<button aria-label="Silenciar contatos selecionados" class="bulk-btn bulk-icon" id="btnSilenciarConversasSelecionadas" onclick="silenciarConversasSelecionadas()" type="button"><i class="bx bx-bell-off"></i></button>
<button aria-label="Excluir contatos selecionados" class="bulk-btn bulk-danger bulk-icon" id="btnExcluirConversasSelecionadas" onclick="excluirConversasSelecionadas()" type="button"><i class="bx bx-trash"></i></button>
<button aria-label="Cancelar seleção" class="bulk-btn bulk-icon" id="btnCancelarSelecaoConversas" onclick="cancelarSelecaoConversas()" type="button"><i class="bx bx-x"></i></button>
</div>
</div>
<div class="lista-filters-panel" id="listaFiltersPanel">
<div class="pedidos-filtros" id="pedidosFilters">
<button class="pf-btn active" data-status="todos">Todos</button>
<button class="pf-btn" data-status="pendente">Pendentes</button>
<button class="pf-btn" data-status="andamento">Em andamento</button>
<button class="pf-btn" data-status="finalizado">Finalizados</button>
</div>
<div class="pedidos-filtros" id="conversasFilters" style="display:none;">
<button class="pf-btn active" data-status="todos">Todos</button>
<button class="pf-btn" data-status="andamento">Em andamento</button>
<button class="pf-btn" data-status="finalizado">Finalizados</button>
</div>
<div class="lista-archive-toggle" id="listaArchiveToggle">
<button class="pf-btn active" data-archive="ativos">Ativos</button>
<button class="pf-btn" data-archive="arquivados">Arquivados</button>
</div>
<div class="lista-view-toggle" id="listaViewToggle">
<button class="pf-btn active" data-view="lista" onclick="trocarViewLista('lista')">Lista</button>
<button class="pf-btn" data-view="agenda" onclick="trocarViewLista('agenda')">Agenda</button>
</div>
</div>
</div>
<div class="lista-scroll" id="lista-pedidos">
<div style="text-align:center; padding:20px; color:#999;">Carregando...</div>
</div>
<div class="lista-scroll" id="lista-conversas" style="display:none;">
<div style="text-align:center; padding:20px; color:#999;">Carregando...</div>
</div>
<div class="agenda-panel" id="agendaPanel" style="display:none;">
<div class="agenda-top">
<button aria-label="M&ecirc;s anterior" class="agenda-nav" onclick="navegarAgenda(-1)"><i class="bx bx-chevron-left"></i></button>
<div class="agenda-title" id="agendaTitle">Agenda</div>
<button aria-label="Pr&oacute;ximo m&ecirc;s" class="agenda-nav" onclick="navegarAgenda(1)"><i class="bx bx-chevron-right"></i></button>
</div>
<div class="agenda-weekdays">
<span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>Sab</span>
</div>
<div class="agenda-grid" id="agendaGrid"></div>
<div class="agenda-day-details">
<div class="agenda-day-title" id="agendaDayTitle">Selecione um dia</div>
<div class="agenda-day-list" id="agendaDayList"></div>
</div>
</div>
</div>
<div class="coluna-chat">
<div id="chat-placeholder">
<img decoding="async" loading="lazy" src="assets/Imagens/doke-logo.png" style="opacity:0.5; margin-bottom:20px;" width="120"/>
<p>Selecione uma conversa para come&ccedil;ar.</p>
</div>
<div id="box-conversa-real">
<div class="chat-header">
<button class="btn-voltar-mobile" onclick="fecharChatMobile()"><i class="bx bx-arrow-back"></i></button>
<img decoding="async" id="chatAvatar" loading="lazy" src="" alt="Foto do contato" onerror="this.onerror=null;this.src='assets/Imagens/user_placeholder.png';"/>
<div class="chat-info">
<h4 id="chatNome">Usu&aacute;rio</h4>
<span id="chatStatus">Offline</span>
<div class="chip-pedido-status chip-pendente" id="chipPedidoStatus" style="display:none;">Pedido em espera</div>
</div>
<div id="container-acao-header" style="display: flex; align-items: center;"></div>
<div class="header-actions" id="acoes-profissional-header" style="display:none;">
<button class="btn-header btn-recusar-mini" onclick="acaoPedido('recusado')">Recusar</button>
<button class="btn-header btn-aceitar-mini" onclick="acaoPedido('aceito')">Aceitar Pedido</button>
</div>
<div class="chat-header-tools">
<button class="btn-cobranca" id="btn-cobranca-topo" onclick="gerarPagamento()" style="display:none;" title="Gerar Cobran&ccedil;a">
<i class="bx bx-dollar-circle"></i> <span class="btn-label">Gerar Cobran&ccedil;a</span>
</button>
<div class="chat-menu" id="chatMenu">
<button aria-label="Mais op&ccedil;&otilde;es" class="chat-menu-btn" onclick="toggleChatMenuOptions(event)">
<i class="bx bx-dots-vertical-rounded"></i>
</button>
<div class="chat-menu-dropdown">
<button class="chat-menu-item" id="menuArquivar" onclick="arquivarConversaAtual()">Arquivar</button>
<button class="chat-menu-item" id="menuDesarquivar" onclick="desarquivarConversaAtual()" style="display:none;">Desarquivar</button>
<button class="chat-menu-item" id="menuLimpar" onclick="limparHistoricoLocal()">Limpar mensagens</button>
<button class="chat-menu-item" id="menuRestaurar" onclick="restaurarHistoricoLocal()" style="display:none;">Restaurar mensagens</button>
<button class="chat-menu-item danger" id="menuReembolso" onclick="solicitarReembolso(); fecharMenuChat();" style="display:none;">Solicitar reembolso</button>
</div>
</div>
</div>
</div>
<div class="pinned-bar" id="pinnedBar" style="display:none;">
<div class="pinned-title"><i class="bx bx-pin"></i> Fixadas</div>
<div class="pinned-list" id="pinnedList"></div>
</div>
<div class="chat-context-bar" id="chatContextBar">
<div id="chatContextText"></div>
<div class="chat-context-actions" id="chatContextActions"></div>
</div>
<div class="mensagens-body" id="areaMensagens"></div>
<div class="reply-bar" id="replyBar">
<div class="rb-left">
<div class="rb-user" id="replyUser">@usuario</div>
<div class="rb-text" id="replyPreview"></div>
</div>
<button aria-label="Cancelar resposta" class="rb-close" onclick="cancelarResposta()" type="button">
<i class="bx bx-x"></i>
</button>
</div>
<div class="chat-footer" id="chatFooter">
<button class="btn-enviar" id="btn-pagamento" onclick="gerarPagamento()" style="background:#f1c40f; display:none; margin-right:10px;" title="Gerar Cobran&ccedil;a">
<i class="bx bx-dollar"></i>
</button>
<div id="area-input-texto" style="display:flex; flex:1; gap:10px; align-items:center;">
<button class="btn-attach" id="btn-attach" onclick="abrirSeletorAnexo()" title="Anexar imagem/arquivo">
<i class="bx bx-paperclip"></i>
</button>
<input accept="image/*,audio/*,video/*,.pdf,.doc,.docx,.zip,.rar" id="inputAnexo" style="display:none" type="file">
<input class="input-msg" id="inputMsg" onkeypress="verificarEnter(event)" placeholder="Digite uma mensagem..." type="text"/>
<button class="btn-enviar" id="btn-mic" onclick="iniciarGravacao()" style="background:#e0e0e0; color:#555;">
<i class="bx bxs-microphone"></i>
</button>
<button class="btn-enviar" id="btn-send-txt" onclick="enviarMensagemTexto()">
<i class="bx bxs-send"></i>
</button>
</div>
<div id="uiGravando" style="display:none; flex:1; align-items:center; gap:15px; background:#fff; padding:0 10px;">
<div class="recording-indicator">
<div class="red-dot"></div>
<span id="timerGravacao">00:00</span>
</div>
<span style="flex:1; color:#666; font-size:0.9rem;">Gravando &aacute;udio...</span>
<button onclick="cancelarGravacao()" style="color:#e74c3c; background:none; border:none; cursor:pointer; font-size:1.5rem;">
<i class="bx bx-trash"></i>
</button>
<button onclick="enviarAudio()" style="color:#2ecc71; background:none; border:none; cursor:pointer; font-size:1.5rem;">
<i class="bx bxs-send"></i>
</button>
</div>
</div>
<div class="modal-detalhes" id="modalCancelConfirm">
<div class="md-content" style="max-width: 400px; text-align: center;">
<div style="padding: 30px 20px;">
<div style="background: #ffebee; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
<i class="bx bx-trash" style="font-size: 30px; color: #e74c3c;"></i>
</div>
<h3 style="margin: 0 0 10px 0;">Cancelar Pedido?</h3>
<p style="color: #666; font-size: 0.95rem;">Tem certeza que deseja remover este pedido pendente? Esta ação não pode ser desfeita.</p>
<div style="display: flex; gap: 12px; margin-top: 25px;">
<button onclick="fecharCancelConfirm()" style="flex:1; padding:12px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; font-weight:600;">Voltar</button>
<button id="btnConfirmCancelFinal" onclick="confirmarCancelamentoFinal()" style="flex:1; padding:12px; border-radius:10px; border:none; background:#e74c3c; color:#fff; cursor:pointer; font-weight:600;">Sim, Cancelar</button>
</div>
</div>
</div>
</div>
<div id="modalRecusa">
<div class="recusa-content">
<h3 style="margin:0; color:#333;">Recusar Pedido</h3>
<p style="color:#666; font-size:0.9rem; margin:10px 0 0;">Por favor, informe ao cliente o motivo da recusa:</p>
<textarea class="recusa-input" id="motivoRecusaTexto" placeholder="Ex: N&atilde;o tenho disponibilidade nesta data..."></textarea>
<div style="display:flex; gap:10px;">
<button onclick="fecharModalRecusa()" style="flex:1; background:#f0f0f0; border:none; border-radius:12px; cursor:pointer; font-weight:600;">Voltar</button>
<button class="btn-confirm-recusa" onclick="confirmarRecusaFinal()">Confirmar Recusa</button>
</div>
</div>
</div>
<div class="modal-overlay-custom" id="modalSucessoAvaliacao" style="display:none;">
<div class="modal-box-custom bounceIn">
<div class="modal-icon-top">
<i class="bx bx-check"></i>
</div>
<h3>Servi&ccedil;o Finalizado!</h3>
<p>O pagamento foi liberado para o profissional com seguran&ccedil;a.</p>
<div style="background:#fff9db; padding:15px; border-radius:12px; margin:20px 0; border:1px solid #ffe082;">
<strong style="color:#d35400; display:block; margin-bottom:5px;">Como foi sua experi&ecirc;ncia?</strong>
<span style="font-size:0.9rem; color:#555;">Sua avalia&ccedil;&atilde;o ajuda a comunidade a contratar com confian&ccedil;a.</span>
</div>
<div class="modal-actions-col">
<button class="btn-primary-modal" onclick="irParaAvaliacaoDireta()">
<i class="bx bxs-star"></i> Avaliar Agora
            </button>
<button class="btn-secondary-modal" onclick="fecharModalSucesso()">
                Avaliar depois
            </button>
</div>
</div>
</div>
<div class="modal-overlay-custom" id="modalFinalizarPedido" style="display:none;">
<div class="modal-box-custom bounceIn" style="max-width: 460px; text-align: left;">
<div class="modal-icon-top" style="background:#e8f5f1; color:#0b7768;">
<i class="bx bx-check-double"></i>
</div>
<h3 style="text-align:center;">Finalizar pedido</h3>
<p style="color:#666; font-size:0.92rem; margin: 8px 0 0; text-align:center;">
            Confirme a conclus&atilde;o do servi&ccedil;o. Anexe uma m&iacute;dia &uacute;nica ou um par antes/depois.
        </p>
<div class="finalizar-modo">
<label><input checked="" name="finalizarModo" onclick="alterarModoFinalizacao('unico')" type="radio" value="unico"/> M&iacute;dia &uacute;nica</label>
<label><input name="finalizarModo" onclick="alterarModoFinalizacao('antes_depois')" type="radio" value="antes_depois"/> Antes e depois</label>
</div>
<div class="finalizar-upload" id="finalizarUploadUnico">
<label class="btn-upload" for="finalizarAnexoUnico">
<i class="bx bx-image-add"></i> Anexar m&iacute;dia (opcional)
            </label>
<small id="finalizarNomeArquivoUnico"></small>
<input accept="image/*,video/*" id="finalizarAnexoUnico" style="display:none;" type="file">
<div class="finalizar-preview" id="finalizarPreviewUnico">
<img alt="Preview" decoding="async" id="finalizarPreviewImgUnico" loading="lazy" style="display:none;">
<video controls="" id="finalizarPreviewVideoUnico" muted="" playsinline="" preload="metadata" style="display:none;"></video>
<button onclick="limparArquivoFinalizacao('unico')" type="button">Remover</button>
</div>
</div>
<div class="finalizar-upload" id="finalizarUploadAntesDepois" style="display:none;">
<div class="finalizar-dupla">
<div class="finalizar-slot">
<label class="btn-upload" for="finalizarAnexoAntes">
<i class="bx bx-image-add"></i> Anexar antes
</label>
<small id="finalizarNomeArquivoAntes"></small>
<input accept="image/*,video/*" id="finalizarAnexoAntes" style="display:none;" type="file">
<div class="finalizar-preview" id="finalizarPreviewAntes">
<img alt="Preview antes" decoding="async" id="finalizarPreviewImgAntes" loading="lazy" style="display:none;">
<video controls="" id="finalizarPreviewVideoAntes" muted="" playsinline="" preload="metadata" style="display:none;"></video>
<button onclick="limparArquivoFinalizacao('antes')" type="button">Remover</button>
</div>
</div>
<div class="finalizar-slot">
<label class="btn-upload" for="finalizarAnexoDepois">
<i class="bx bx-image-add"></i> Anexar depois
</label>
<small id="finalizarNomeArquivoDepois"></small>
<input accept="image/*,video/*" id="finalizarAnexoDepois" style="display:none;" type="file">
<div class="finalizar-preview" id="finalizarPreviewDepois">
<img alt="Preview depois" decoding="async" id="finalizarPreviewImgDepois" loading="lazy" style="display:none;">
<video controls="" id="finalizarPreviewVideoDepois" muted="" playsinline="" preload="metadata" style="display:none;"></video>
<button onclick="limparArquivoFinalizacao('depois')" type="button">Remover</button>
</div>
</div>
</div>
</div>
<div class="modal-actions-col">
<button class="btn-primary-modal" onclick="confirmarFinalizacaoPedido()">
<i class="bx bx-check"></i> Finalizar servi&ccedil;o</button>
<button class="btn-secondary-modal" onclick="fecharModalFinalizarPedido()">Cancelar</button>
</div>
</div>
</div>
</div>
</div>
</div>


<div class="modal-detalhes" id="modalOrcamento" style="display:none;">
<div class="md-content" style="max-width: 520px; text-align: left;">
<div class="md-header">
<div style="display:flex; align-items:center; gap:10px;">
<i class="bx bx-receipt" style="font-size:1.3rem; color:var(--cor0);"></i>
<strong>Detalhes do Pedido</strong>
</div>
<button onclick="fecharModalDetalhes()" style="background:none; border:none; font-size:1.2rem; cursor:pointer; color:#666;">
<i class="bx bx-x"></i>
</button>
</div>
<div class="md-body" id="mdBody"></div>
</div>
</div>
<div class="modal-detalhes" id="modalGerarCobranca" style="display:none; justify-content:center; align-items:center;">
<div class="md-content" style="max-width: 420px; width:min(92vw,420px); text-align:left;">
<div class="md-header">
<div style="display:flex; align-items:center; gap:10px;">
<i class="bx bx-dollar-circle" style="font-size:1.3rem; color:#d4a600;"></i>
<strong>Gerar cobran&ccedil;a</strong>
</div>
<button onclick="fecharModalGerarCobranca()" style="background:none; border:none; font-size:1.2rem; cursor:pointer; color:#666;">
<i class="bx bx-x"></i>
</button>
</div>
<div class="md-body">
<div class="input-group" style="margin-bottom:12px;">
<label for="cobrancaValorInput" style="display:block; font-size:.84rem; color:#64748b; font-weight:700; margin-bottom:6px;">Valor</label>
<input class="input-premium" id="cobrancaValorInput" inputmode="decimal" placeholder="R$ 0,00" type="text"/>
</div>
<div class="input-group" style="margin-bottom:12px;">
<label for="cobrancaTituloInput" style="display:block; font-size:.84rem; color:#64748b; font-weight:700; margin-bottom:6px;">T&iacute;tulo da cobran&ccedil;a</label>
<input class="input-premium" id="cobrancaTituloInput" placeholder="Ex: M&atilde;o de obra el&eacute;trica" type="text"/>
</div>
<div class="input-group" style="margin-bottom:2px;">
<label for="cobrancaParcelasInput" style="display:block; font-size:.84rem; color:#64748b; font-weight:700; margin-bottom:6px;">Parcelas sem juros</label>
<select class="input-premium" id="cobrancaParcelasInput">
<option value="1">1x</option>
<option value="2">2x</option>
<option value="3">3x</option>
<option value="4">4x</option>
<option value="5">5x</option>
<option value="6">6x</option>
<option value="7">7x</option>
<option value="8">8x</option>
<option value="9">9x</option>
<option value="10">10x</option>
<option value="11">11x</option>
<option value="12">12x</option>
</select>
</div>
<div style="display:flex; justify-content:flex-end; gap:8px; margin-top:16px;">
<button class="btn-dm btn-dm-cancel" onclick="fecharModalGerarCobranca()" type="button">Cancelar</button>
<button class="btn-dm btn-dm-confirm" id="btnConfirmarGerarCobranca" onclick="confirmarGerarCobranca()" type="button">Enviar cobran&ccedil;a</button>
</div>
</div>
</div>
</div>
<script>
    (function(){
    const { getFirestore, collection, query, where, orderBy, getDocs, doc, getDoc, updateDoc, onSnapshot, addDoc, deleteDoc } = window;
    const { getAuth, onAuthStateChanged, signOut } = window;

    const db = window.db || getFirestore();
    const auth = window.auth || getAuth();
    // Storage (Supabase Storage via compat). Bucket padrÃ£o definido no <head>.
    const storage = window.storage || (window.getStorage ? getStorage() : { bucket: 'posts' });
    window.storage = storage;

    let currentUserUid = null;
    const getUserUid = () => currentUserUid || auth.currentUser?.uid || localStorage.getItem('doke_uid') || null;
    let chatIdAtual = null;
    let colecaoAtual = 'pedidos'; 
    let chatUnsubscribe = null;
    let pedidoDocUnsub = null;
    let conversaDocUnsub = null;
    let outroUserUnsub = null;
    let idPedidoParaAcao = null;
    let pedidosRenderToken = 0;
    let pedidosFiltro = 'todos';
    let conversasFiltro = 'todos';
    let statusPedidoAtual = 'pendente';
    let avaliadoPedidoAtual = false;
    let abaAtual = 'pedidos';
    let listaView = 'lista';
    let pedidosAgendaCache = [];
    let chatOutroUidAtual = '';
    let pinnedAtual = [];
    let agendaMonthOffset = 0;
    let agendaSelectedDate = null;
    let listaBusca = '';
    let chatContatoFotoAtual = '';
    let listaModo = 'ativos';
    let pedidosSelecaoModo = false;
    let pedidosSelecionados = new Set();
    let conversasSelecaoModo = false;
    let conversasSelecionadas = new Set();
    let pedidoAtualData = null;
    let conversaArquivadaAtual = false;
    let replyContext = null;
    const andamentoCardHidden = (() => {
        try {
            const parsed = JSON.parse(localStorage.getItem('doke_andamento_hidden') || '{}');
            return parsed && typeof parsed === 'object' ? parsed : {};
        } catch (_) {
            return {};
        }
    })();
    const contextoCardHidden = (() => {
        try {
            const parsed = JSON.parse(localStorage.getItem('doke_context_hidden') || '{}');
            return parsed && typeof parsed === 'object' ? parsed : {};
        } catch (_) {
            return {};
        }
    })();
    const avaliacaoCache = {};
      let pedidoFinalizarId = null;
      let finalizacaoModo = 'unico';
      let finalizacaoFileUnico = null;
      let finalizacaoFileAntes = null;
      let finalizacaoFileDepois = null;
      let finalizacaoPreviewUrlUnico = null;
      let finalizacaoPreviewUrlAntes = null;
      let finalizacaoPreviewUrlDepois = null;
      let pedidoInfoRenderId = null;

    const persistAndamentoHidden = () => {
        try { localStorage.setItem('doke_andamento_hidden', JSON.stringify(andamentoCardHidden)); } catch (_) {}
    };
    const persistContextoHidden = () => {
        try { localStorage.setItem('doke_context_hidden', JSON.stringify(contextoCardHidden)); } catch (_) {}
    };

    window.ocultarCardAndamento = function(pedidoId) {
        if (!pedidoId) return;
        andamentoCardHidden[String(pedidoId)] = true;
        persistAndamentoHidden();
        document.querySelectorAll(`.ip-andamento[data-pedido-id="${pedidoId}"]`).forEach((el) => el.remove());
    };

    window.fecharCardContextoPedido = function(status) {
        if (!chatIdAtual || !status) return;
        const key = `${chatIdAtual}:${String(status).toLowerCase()}`;
        contextoCardHidden[key] = true;
        persistContextoHidden();
        const bar = document.getElementById('chatContextBar');
        if (bar) {
            bar.classList.remove('show');
            bar.style.display = 'none';
        }
    };

    window.abrirPerfilUsuario = function(uid, isProfissional){
        if (!uid) return;
        if (isProfissional) {
            if (typeof window.irParaPerfilComContagem === "function") {
                window.irParaPerfilComContagem(uid);
            } else {
                window.location.href = `perfil-profissional.html?uid=${uid}`;
            }
            return;
        }
        window.location.href = `perfil-usuario.html?id=${uid}`;
    };

    window.abrirAvaliacaoPedido = function(pedidoId){
        if (!pedidoId) return;
        if (avaliadoPedidoAtual) {
            if (window.dokeAlert) window.dokeAlert("Serviço já avaliado.");
            else alert("Serviço já avaliado.");
            return;
        }
        window.pedidoIdParaAvaliar = pedidoId;
        const modalSucesso = document.getElementById('modalSucessoAvaliacao');
        if(modalSucesso) {
            modalSucesso.style.display = 'flex';
        } else {
            window.location.href = `avaliar.html?pedidoId=${pedidoId}`;
        }
    };

    async function checarAvaliacaoPedido(pedidoId){
        if (!pedidoId) return false;
        const lsKey = `doke_avaliado_${pedidoId}`;
        if (localStorage.getItem(lsKey) === '1') {
            avaliadoPedidoAtual = true;
            if (pedidoAtualData) pedidoAtualData.avaliado = true;
            if (colecaoAtual === 'pedidos' && chatIdAtual === pedidoId && pedidoAtualData) {
                atualizarContextoChat(pedidoAtualData);
            }
            return true;
        }
        const cache = avaliacaoCache[pedidoId];
        const agora = Date.now();
        if (cache && (agora - cache.ts) < 60000) {
            if (cache.result) {
                avaliadoPedidoAtual = true;
                if (pedidoAtualData) pedidoAtualData.avaliado = true;
            }
            return !!cache.result;
        }
        try {
            const q = query(collection(db, "avaliacoes"), where("pedidoId", "==", pedidoId));
            const snap = await getDocs(q);
            const found = !!(snap && !snap.empty);
            avaliacaoCache[pedidoId] = { ts: agora, result: found };
            if (found) {
                avaliadoPedidoAtual = true;
                if (pedidoAtualData) pedidoAtualData.avaliado = true;
                try { localStorage.setItem(lsKey, '1'); } catch (_) {}
                try { await updateDoc(doc(db, "pedidos", pedidoId), { avaliado: true }); } catch (_) {}
                if (colecaoAtual === 'pedidos' && chatIdAtual === pedidoId) {
                    if (pedidoAtualData) atualizarContextoChat(pedidoAtualData);
                    carregarMensagens(colecaoAtual, chatIdAtual);
                }
            }
            return found;
        } catch (e) {
            console.warn("Falha ao checar avaliacao do pedido:", e);
            return false;
        }
    }

    function initPedidosFilters(){
        const wrap = document.getElementById('pedidosFilters');
        if (!wrap) return;
        wrap.addEventListener('click', (e) => {
            const btn = e.target.closest('.pf-btn');
            if (!btn) return;
            pedidosFiltro = btn.dataset.status || 'todos';
            wrap.querySelectorAll('.pf-btn').forEach(b => b.classList.toggle('active', b === btn));
            carregarListaPedidos();
        });
    }

    function initConversasFilters(){
        const wrap = document.getElementById('conversasFilters');
        if (!wrap) return;
        wrap.addEventListener('click', (e) => {
            const btn = e.target.closest('.pf-btn');
            if (!btn) return;
            conversasFiltro = btn.dataset.status || 'todos';
            wrap.querySelectorAll('.pf-btn').forEach(b => b.classList.toggle('active', b === btn));
            if (window.carregarListaConversas) window.carregarListaConversas();
        });
    }

    function initListaTools(){
        const input = document.getElementById('inputBuscaLista');
        if (input && !input.dataset.bound) {
            input.dataset.bound = '1';
            input.addEventListener('input', () => {
                listaBusca = input.value || '';
                if (abaAtual === 'pedidos') carregarListaPedidos();
                else if (window.carregarListaConversas) window.carregarListaConversas();
            });
        }
        const toggle = document.getElementById('listaArchiveToggle');
        if (toggle && !toggle.dataset.bound) {
            toggle.dataset.bound = '1';
            toggle.addEventListener('click', (e) => {
                const btn = e.target.closest('.pf-btn');
                if (!btn) return;
                listaModo = btn.dataset.archive || 'ativos';
                if (listaModo !== 'ativos' && pedidosSelecaoModo) {
                    pedidosSelecaoModo = false;
                    pedidosSelecionados.clear();
                }
                if (conversasSelecaoModo) {
                    conversasSelecaoModo = false;
                    conversasSelecionadas.clear();
                }
                toggle.querySelectorAll('.pf-btn').forEach(b => b.classList.toggle('active', b === btn));
                if (abaAtual === 'pedidos') carregarListaPedidos();
                else if (window.carregarListaConversas) window.carregarListaConversas();
                updatePedidosBulkUI();
            });
        }
        updatePedidosBulkUI();
    }

    function getSelectedConversaUids(){
        const out = [];
        conversasSelecionadas.forEach((id) => {
            const card = document.querySelector(`.item-conversa[data-id="${String(id).replace(/"/g, '\\"')}"]`);
            const uid = String(card?.dataset?.outroUid || '').trim();
            if (uid) out.push(uid);
        });
        return Array.from(new Set(out));
    }

    function updatePedidosBulkUI(){
        const btnSelecionarPedidos = document.getElementById('btnSelecionarPedidos');
        const btnSelecionarConversas = document.getElementById('btnSelecionarConversas');
        const pedidosBulkBar = document.getElementById('pedidosBulkBar');
        const conversasBulkBar = document.getElementById('conversasBulkBar');
        const pedidosCountEl = document.getElementById('pedidosBulkCount');
        const conversasCountEl = document.getElementById('conversasBulkCount');
        const btnArquivar = document.getElementById('btnArquivarSelecionados');
        const btnArquivarConversas = document.getElementById('btnArquivarConversasSelecionadas');
        const btnSilenciarConversas = document.getElementById('btnSilenciarConversasSelecionadas');
        const btnExcluirConversas = document.getElementById('btnExcluirConversasSelecionadas');
        const btnFiltros = document.getElementById('toggleFilters');
        const emPedidosLista = (abaAtual === 'pedidos' && listaView === 'lista');
        const emConversasLista = (abaAtual === 'conversas' && listaView === 'lista');
        const acaoModoArquivados = (listaModo === 'arquivados');
        if (btnSelecionarPedidos) btnSelecionarPedidos.style.display = (emPedidosLista && !pedidosSelecaoModo) ? 'inline-flex' : 'none';
        if (btnSelecionarConversas) btnSelecionarConversas.style.display = (emConversasLista && !conversasSelecaoModo) ? 'inline-flex' : 'none';
        if (pedidosBulkBar) pedidosBulkBar.style.display = (emPedidosLista && pedidosSelecaoModo) ? 'flex' : 'none';
        if (conversasBulkBar) conversasBulkBar.style.display = (emConversasLista && conversasSelecaoModo) ? 'flex' : 'none';
        if (btnFiltros) btnFiltros.style.display = ((emPedidosLista && pedidosSelecaoModo) || (emConversasLista && conversasSelecaoModo)) ? 'none' : 'inline-flex';
        if (pedidosCountEl) pedidosCountEl.textContent = `${pedidosSelecionados.size} selecionado${pedidosSelecionados.size === 1 ? '' : 's'}`;
        if (conversasCountEl) conversasCountEl.textContent = `${conversasSelecionadas.size} selecionado${conversasSelecionadas.size === 1 ? '' : 's'}`;
        if (btnArquivar) btnArquivar.disabled = pedidosSelecionados.size === 0;
        if (btnArquivar) btnArquivar.textContent = acaoModoArquivados ? 'Desarquivar' : 'Arquivar';
        if (btnArquivarConversas) {
            const desarquivar = (listaModo === 'arquivados');
            btnArquivarConversas.disabled = conversasSelecionadas.size === 0;
            btnArquivarConversas.innerHTML = `<i class='bx ${desarquivar ? 'bx-folder-open' : 'bx-archive'}'></i> ${desarquivar ? 'Desarquivar' : 'Arquivar'}`;
            btnArquivarConversas.setAttribute('aria-label', desarquivar ? 'Desarquivar contatos selecionados' : 'Arquivar contatos selecionados');
        }
        if (btnExcluirConversas) btnExcluirConversas.disabled = conversasSelecionadas.size === 0;
        if (btnSilenciarConversas) {
            const uids = getSelectedConversaUids();
            const silenciados = getSilenciadosLocal();
            const allMuted = !!uids.length && uids.every((uid) => silenciados.includes(uid));
            btnSilenciarConversas.disabled = conversasSelecionadas.size === 0;
            btnSilenciarConversas.innerHTML = `<i class='bx ${allMuted ? 'bx-bell' : 'bx-bell-off'}'></i>`;
            btnSilenciarConversas.title = allMuted ? 'Ativar som' : 'Silenciar';
            btnSilenciarConversas.setAttribute('aria-label', allMuted ? 'Ativar som dos contatos selecionados' : 'Silenciar contatos selecionados');
        }
    }

    function marcarCardsSelecionadosPedidos(){
        const ids = new Set(Array.from(pedidosSelecionados));
        document.querySelectorAll('.item-pedido[data-id]').forEach((card) => {
            const id = String(card.dataset.id || '');
            const selected = pedidosSelecaoModo && ids.has(id);
            card.classList.toggle('is-select-mode', pedidosSelecaoModo);
            card.classList.toggle('is-selected', selected);
            const mark = card.querySelector('.ip-select-indicator');
            if (mark) mark.classList.toggle('selected', selected);
        });
    }

    function marcarCardsSelecionadosConversas(){
        const cards = Array.from(document.querySelectorAll('.item-conversa[data-id]'));
        const idsNaTela = new Set(cards.map((card) => String(card.dataset.id || '')));
        Array.from(conversasSelecionadas).forEach((id) => {
            if (!idsNaTela.has(String(id))) conversasSelecionadas.delete(String(id));
        });
        cards.forEach((card) => {
            const id = String(card.dataset.id || '');
            const selected = conversasSelecaoModo && conversasSelecionadas.has(id);
            card.classList.toggle('is-select-mode', conversasSelecaoModo);
            card.classList.toggle('is-selected', selected);
            const mark = card.querySelector('.ip-select-indicator');
            if (mark) mark.classList.toggle('selected', selected);
        });
    }

    window.toggleSelecaoPedido = function(id){
        const key = String(id || '').trim();
        if (!pedidosSelecaoModo || !key) return;
        if (pedidosSelecionados.has(key)) pedidosSelecionados.delete(key);
        else pedidosSelecionados.add(key);
        updatePedidosBulkUI();
        marcarCardsSelecionadosPedidos();
    };

    window.iniciarSelecaoPedidos = function(){
        if (abaAtual !== 'pedidos' || listaView !== 'lista') return;
        pedidosSelecaoModo = true;
        pedidosSelecionados.clear();
        const panel = document.getElementById('listaFiltersPanel');
        if (panel) panel.classList.remove('open');
        updatePedidosBulkUI();
        carregarListaPedidos({ silent: true });
    };

    window.cancelarSelecaoPedidos = function(){
        pedidosSelecaoModo = false;
        pedidosSelecionados.clear();
        updatePedidosBulkUI();
        carregarListaPedidos({ silent: true });
    };

    window.arquivarPedidosSelecionados = async function(){
        const ids = Array.from(pedidosSelecionados);
        if (!ids.length) return;
        const desarquivar = (listaModo === 'arquivados');
        const verbo = desarquivar ? 'Desarquivar' : 'Arquivar';
        const ok = await window.dokeConfirm(`${verbo} ${ids.length} pedido${ids.length === 1 ? '' : 's'} selecionado${ids.length === 1 ? '' : 's'}?`, verbo);
        if (!ok) return;
        try {
            await Promise.all(ids.map((id) => atualizarArrayUsuario(doc(db, 'pedidos', id), 'arquivadoPor', !desarquivar)));
            pedidosSelecionados.clear();
            pedidosSelecaoModo = false;
            updatePedidosBulkUI();
            carregarListaPedidos({ silent: true });
            if (window.dokeToast) window.dokeToast(desarquivar ? 'Pedidos desarquivados.' : 'Pedidos arquivados.');
        } catch (e) {
            console.error('Falha ao arquivar pedidos em lote:', e);
            const msg = desarquivar
                ? 'Não foi possível desarquivar os pedidos selecionados.'
                : 'Não foi possível arquivar os pedidos selecionados.';
            window.dokeAlert ? window.dokeAlert(msg) : alert(msg);
        }
    };

    window.toggleSelecaoConversa = function(id){
        const key = String(id || '').trim();
        if (!conversasSelecaoModo || !key) return;
        if (conversasSelecionadas.has(key)) conversasSelecionadas.delete(key);
        else conversasSelecionadas.add(key);
        updatePedidosBulkUI();
        marcarCardsSelecionadosConversas();
    };

    window.iniciarSelecaoConversas = function(){
        if (abaAtual !== 'conversas' || listaView !== 'lista') return;
        conversasSelecaoModo = true;
        conversasSelecionadas.clear();
        const panel = document.getElementById('listaFiltersPanel');
        if (panel) panel.classList.remove('open');
        updatePedidosBulkUI();
        if (window.carregarListaConversas) window.carregarListaConversas();
    };

    window.cancelarSelecaoConversas = function(){
        conversasSelecaoModo = false;
        conversasSelecionadas.clear();
        updatePedidosBulkUI();
        if (window.carregarListaConversas) window.carregarListaConversas();
    };

    window.handleConversaCardClick = function(event, idDoc, uidOutro){
        const id = String(idDoc || '').trim();
        if (!id) return;
        const target = event?.target || null;
        if (target && target.closest && target.closest('button, a, input, textarea, select, label')) return;
        if (conversasSelecaoModo) {
            event?.preventDefault?.();
            event?.stopPropagation?.();
            window.toggleSelecaoConversa(id);
            return;
        }
        window.abrirChat(id, uidOutro || '', '', '', 'conversas', '');
    };

    window.arquivarConversasSelecionadas = async function(){
        const ids = Array.from(conversasSelecionadas);
        if (!ids.length) return;
        const desarquivar = (listaModo === 'arquivados');
        const verbo = desarquivar ? 'Desarquivar' : 'Arquivar';
        const ok = await window.dokeConfirm(`${verbo} ${ids.length} contato${ids.length === 1 ? '' : 's'} selecionado${ids.length === 1 ? '' : 's'}?`, verbo);
        if (!ok) return;
        try {
            await Promise.all(ids.map((id) => atualizarArrayUsuario(doc(db, 'conversas', id), 'arquivadoPor', !desarquivar)));
            conversasSelecionadas.clear();
            conversasSelecaoModo = false;
            updatePedidosBulkUI();
            if (window.carregarListaConversas) window.carregarListaConversas();
            if (window.dokeToast) window.dokeToast(desarquivar ? 'Contatos desarquivados.' : 'Contatos arquivados.');
        } catch (e) {
            console.error('Falha ao arquivar/desarquivar contatos:', e);
            const msg = desarquivar
                ? 'Não foi possível desarquivar os contatos selecionados.'
                : 'Não foi possível arquivar os contatos selecionados.';
            window.dokeAlert ? window.dokeAlert(msg) : alert(msg);
        }
    };
    window.ocultarConversasSelecionadas = window.arquivarConversasSelecionadas;

    window.silenciarConversasSelecionadas = async function(){
        const ids = Array.from(conversasSelecionadas);
        if (!ids.length) return;
        const uids = getSelectedConversaUids();
        if (!uids.length) return;
        const silenciados = getSilenciadosLocal();
        const allMuted = uids.every((uid) => silenciados.includes(uid));
        const titulo = allMuted ? 'Ativar notificações' : 'Silenciar';
        const ok = await window.dokeConfirm(`${titulo} ${uids.length} contato${uids.length === 1 ? '' : 's'} selecionado${uids.length === 1 ? '' : 's'}?`, titulo);
        if (!ok) return;
        if (allMuted) {
            setSilenciadosLocal(silenciados.filter((uid) => !uids.includes(uid)));
        } else {
            setSilenciadosLocal(Array.from(new Set(silenciados.concat(uids))));
        }
        conversasSelecionadas.clear();
        conversasSelecaoModo = false;
        updatePedidosBulkUI();
        if (window.carregarListaConversas) window.carregarListaConversas();
        if (window.dokeToast) window.dokeToast(allMuted ? 'Notificações ativadas.' : 'Contatos silenciados.');
    };

    window.excluirConversasSelecionadas = async function(){
        const ids = Array.from(conversasSelecionadas);
        if (!ids.length) return;
        const ok = await window.dokeConfirm(`Excluir ${ids.length} contato${ids.length === 1 ? '' : 's'} da sua lista?`, 'Excluir', 'danger');
        if (!ok) return;
        try {
            await Promise.all(ids.map((id) => atualizarArrayUsuario(doc(db, 'conversas', id), 'ocultoChatPor', true)));
            if (ids.includes(String(chatIdAtual || '')) && colecaoAtual === 'conversas') {
                chatIdAtual = null;
                chatOutroUidAtual = '';
                const placeholder = document.getElementById('chat-placeholder');
                const conversa = document.getElementById('box-conversa-real');
                if (placeholder) placeholder.style.display = 'flex';
                if (conversa) conversa.style.display = 'none';
            }
            conversasSelecionadas.clear();
            conversasSelecaoModo = false;
            updatePedidosBulkUI();
            if (window.carregarListaConversas) window.carregarListaConversas();
            if (window.dokeToast) window.dokeToast('Contatos excluídos da sua lista.');
        } catch (e) {
            console.error('Falha ao excluir contatos selecionados:', e);
            window.dokeAlert ? window.dokeAlert('Não foi possível excluir os contatos selecionados.') : alert('Não foi possível excluir os contatos selecionados.');
        }
    };

    window.handlePedidoCardClick = function(event, idDoc, uidOutro, statusDoc){
        const id = String(idDoc || '').trim();
        if (!id) return;
        const target = event?.target || null;
        if (target && target.closest && target.closest('button, a, input, textarea, select, label, .bx-trash, .ip-andamento-close')) return;
        if (pedidosSelecaoModo) {
            event?.preventDefault?.();
            event?.stopPropagation?.();
            window.toggleSelecaoPedido(id);
            return;
        }
        window.abrirChat(id, uidOutro || '', '', '', 'pedidos', statusDoc || 'pendente');
    };

    window.toggleListaFilters = function(ev){
        if (ev) ev.stopPropagation();
        const panel = document.getElementById('listaFiltersPanel');
        if (!panel) return;
        panel.classList.toggle('open');
    };

    window.trocarViewLista = function(view){
        listaView = view || 'lista';
        if (listaView !== 'lista' && pedidosSelecaoModo) {
            pedidosSelecaoModo = false;
            pedidosSelecionados.clear();
        }
        if (listaView !== 'lista' && conversasSelecaoModo) {
            conversasSelecaoModo = false;
            conversasSelecionadas.clear();
        }
        const toggle = document.getElementById('listaViewToggle');
        if (toggle) {
            toggle.querySelectorAll('.pf-btn').forEach((b) => {
                b.classList.toggle('active', b.dataset.view === listaView);
            });
        }
        const listaPedidos = document.getElementById('lista-pedidos');
        const listaConversas = document.getElementById('lista-conversas');
        const agendaPanel = document.getElementById('agendaPanel');
        if (listaView === 'agenda' && abaAtual === 'pedidos') {
            if (listaPedidos) listaPedidos.style.display = 'none';
            if (listaConversas) listaConversas.style.display = 'none';
            if (agendaPanel) agendaPanel.style.display = 'block';
            renderAgenda();
        } else {
            if (agendaPanel) agendaPanel.style.display = 'none';
            if (listaPedidos) listaPedidos.style.display = (abaAtual === 'pedidos') ? 'block' : 'none';
            if (listaConversas) listaConversas.style.display = (abaAtual === 'conversas') ? 'block' : 'none';
        }
        updatePedidosBulkUI();
    };

    function formatDateKey(d){
        if (!d) return '';
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    }
    function parseAgendaDate(p){
        const raw = p?.dataEspecifica || p?.data_especifica || p?.dataPedido || p?.data_pedido || p?.createdat || p?.dataCriacao || null;
        if (!raw) return null;
        return parseDataHora(raw);
    }
    function getAgendaStatus(p){
        const st = String(p?.status || '').toLowerCase();
        const disputa = String(p?.disputaStatus || p?.disputa_status || '').toLowerCase();
        if (disputa === 'aberta' || disputa === 'em_analise') return 'disputa';
        if (st === 'pendente') return 'pendente';
        if (['aceito','pago'].includes(st)) return 'andamento';
        if (['finalizado','cancelado','recusado'].includes(st)) return 'finalizado';
        return 'pendente';
    }
    function renderAgenda(){
        const panel = document.getElementById('agendaPanel');
        if (!panel || abaAtual !== 'pedidos' || listaView !== 'agenda') return;
        const grid = document.getElementById('agendaGrid');
        const title = document.getElementById('agendaTitle');
        const dayTitle = document.getElementById('agendaDayTitle');
        const dayList = document.getElementById('agendaDayList');
        if (!grid || !title || !dayTitle || !dayList) return;

        const base = new Date();
        const monthDate = new Date(base.getFullYear(), base.getMonth() + agendaMonthOffset, 1);
        const monthLabel = monthDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        title.textContent = monthLabel;

        const map = new Map();
        (pedidosAgendaCache || []).forEach((it) => {
            if (!it?.dateKey) return;
            if (!map.has(it.dateKey)) map.set(it.dateKey, []);
            map.get(it.dateKey).push(it);
        });

        const firstDay = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
        const startDay = firstDay.getDay();
        const daysInMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).getDate();
        const prevMonthDays = new Date(monthDate.getFullYear(), monthDate.getMonth(), 0).getDate();
        const totalCells = Math.ceil((startDay + daysInMonth) / 7) * 7;

        grid.innerHTML = '';
        let selectedKey = agendaSelectedDate;
        if (!selectedKey || !map.has(selectedKey)) {
            const todayKey = formatDateKey(base);
            selectedKey = map.has(todayKey) ? todayKey : (map.keys().next().value || formatDateKey(firstDay));
            agendaSelectedDate = selectedKey;
        }

        for (let i = 0; i < totalCells; i++) {
            const dayNum = i - startDay + 1;
            let cellDate = null;
            let off = false;
            if (dayNum < 1) {
                cellDate = new Date(monthDate.getFullYear(), monthDate.getMonth() - 1, prevMonthDays + dayNum);
                off = true;
            } else if (dayNum > daysInMonth) {
                cellDate = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, dayNum - daysInMonth);
                off = true;
            } else {
                cellDate = new Date(monthDate.getFullYear(), monthDate.getMonth(), dayNum);
            }
            const key = formatDateKey(cellDate);
            const items = map.get(key) || [];
            const dots = { pendente: 0, andamento: 0, finalizado: 0, disputa: 0 };
            items.forEach((it) => { dots[it.status] = (dots[it.status] || 0) + 1; });
            const has = items.length > 0;
            const dotHtml = Object.keys(dots).filter(k => dots[k]).map(k => `<span class="agenda-dot status-dot-${k}"></span>`).join('');
            const cls = `agenda-day${off ? ' off' : ''}${has ? ' has' : ''}${key === selectedKey ? ' active' : ''}`;
            grid.insertAdjacentHTML('beforeend', `
                <div class="${cls}" data-date="${key}" onclick="selecionarAgendaDia('${key}')">
                    <div class="day-num">${cellDate.getDate()}</div>
                    ${dotHtml ? `<div class="agenda-dots">${dotHtml}</div>` : ''}
                </div>
            `);
        }

        renderAgendaDia(selectedKey);
    }

    window.navegarAgenda = function(dir){
        agendaMonthOffset += Number(dir || 0);
        renderAgenda();
    };
    window.selecionarAgendaDia = function(key){
        agendaSelectedDate = key;
        renderAgenda();
    };
    function renderAgendaDia(key){
        const dayTitle = document.getElementById('agendaDayTitle');
        const dayList = document.getElementById('agendaDayList');
        if (!dayTitle || !dayList) return;
        const items = (pedidosAgendaCache || []).filter(it => it.dateKey === key);
        const label = key ? new Date(key + 'T00:00:00').toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'short' }) : '';
        dayTitle.textContent = items.length ? `${label} (${items.length})` : `Sem pedidos em ${label}`;
        dayList.innerHTML = items.length ? items.map(it => `
            <div class="agenda-item" onclick="abrirChat('${it.id}', '${it.uidOutro}', '', '', 'pedidos', '${it.statusRaw}')">
                <div class="agenda-item-title">${escapeHtml(it.titulo || 'Pedido')}</div>
                <div class="agenda-item-meta">
                    <span>${escapeHtml(it.cliente || '')}</span>
                    <span>${escapeHtml(it.turno || '')}</span>
                </div>
                <div class="agenda-item-status">${escapeHtml(it.statusLabel || it.statusRaw || '')}</div>
            </div>
        `).join('') : '<div style="color:#94a3b8; font-size:0.75rem;">Nenhum pedido para este dia.</div>';
    }

    function normalizarTexto(txt){
        return String(txt || '')
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .trim();
    }

    function escapeHtml(str){
        return String(str || '').replace(/[&<>"']/g, (m) => {
            return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m];
        });
    }

    const REPLY_MARK_START = '[[reply]]';
    const REPLY_MARK_END = '[[/reply]]';
    function encodeReplyMeta(meta){
        try { return btoa(unescape(encodeURIComponent(JSON.stringify(meta || {})))); }
        catch (e) { return ''; }
    }
    function decodeReplyMeta(raw){
        try { return JSON.parse(decodeURIComponent(escape(atob(raw)))); }
        catch (e) { return null; }
    }
    function extractReplyFromText(rawText){
        const raw = String(rawText || '');
        if (!raw.startsWith(REPLY_MARK_START)) return { meta: null, text: raw };
        const endIdx = raw.indexOf(REPLY_MARK_END);
        if (endIdx === -1) return { meta: null, text: raw };
        const metaRaw = raw.slice(REPLY_MARK_START.length, endIdx);
        const meta = decodeReplyMeta(metaRaw);
        const text = raw.slice(endIdx + REPLY_MARK_END.length).replace(/^\n+/, '');
        return { meta, text };
    }

    function getTipoPreview(tipo, texto, url){
        const t = String(tipo || '').toLowerCase();
        if (t === 'imagem') return 'Imagem';
        if (t === 'arquivo') return 'Arquivo';
        if (t === 'audio' || t === 'áudio' || t === 'voz') return 'Áudio';
        if (t === 'pagamento') return 'Cobrança';
        if (t === 'card_finalizado') return 'Pedido finalizado';
        if (t === 'card_avaliacao') return 'Avaliação';
        if (t === 'solicitacao_portfolio') return 'Solicitação de portfólio';
        if (t === 'portfolio_consent_result') return 'Resposta de portfólio';
        if (t === 'portfolio_publicado') return 'Publicado no portfólio';
        return (texto || '').slice(0, 140);
    }
    function normalizePinPreview(text){
        const t = String(text || '').replace(/\s+/g, ' ').trim();
        if (!t) return 'Mensagem';
        return t.length > 80 ? t.slice(0, 77) + '...' : t;
    }
    function safeDecodeURIComponent(value){
        try {
            return decodeURIComponent(String(value || ''));
        } catch (_) {
            return String(value || '');
        }
    }
    function isPlaceholderAvatar(url){
        const u = String(url || '').toLowerCase();
        if (!u) return true;
        return u.includes('user_placeholder') || u.includes('placehold.co') || u.includes('pravatar.cc');
    }
    function formatDurationClock(totalSeconds){
        const s = Number(totalSeconds);
        if (!Number.isFinite(s) || s <= 0) return '0:00';
        const mins = Math.floor(s / 60);
        const secs = Math.floor(s % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    function isMsgPinned(id){
        return !!(id && Array.isArray(pinnedAtual) && pinnedAtual.some(p => p.id === id));
    }
    function renderPinnedBar(){
        const bar = document.getElementById('pinnedBar');
        const list = document.getElementById('pinnedList');
        if (!bar || !list) return;
        const pins = Array.isArray(pinnedAtual) ? pinnedAtual : [];
        if (!pins.length) {
            bar.style.display = 'none';
            list.innerHTML = '';
            return;
        }
        bar.style.display = 'flex';
        list.innerHTML = pins.map((p) => {
            const preview = escapeHtml(p.preview || 'Mensagem');
            return `<div class="pinned-item" onclick="scrollToMessage('${p.id}')">${preview}</div>`;
        }).join('');
    }
    window.scrollToMessage = function(id){
        if (!id) return;
        const el = document.getElementById(`msg-${id}`);
        if (!el) return;
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.classList.add('msg-highlight');
        setTimeout(() => el.classList.remove('msg-highlight'), 1400);
    };
    window.togglePinMessage = async function(id, previewEnc, tipoEnc){
        if (!id || !chatIdAtual || !colecaoAtual) return;
        const preview = safeDecodeURIComponent(previewEnc || '');
        const tipo = safeDecodeURIComponent(tipoEnc || '');
        const existing = Array.isArray(pinnedAtual) ? pinnedAtual.slice() : [];
        const idxLocal = existing.findIndex(p => p.id === id);
        if (idxLocal >= 0) existing.splice(idxLocal, 1);
        else existing.unshift({ id, preview: normalizePinPreview(preview || tipo), tipo, by: currentUserUid || '', at: new Date().toISOString() });
        pinnedAtual = existing;
        renderPinnedBar();
        setPinnedLocal(colecaoAtual, chatIdAtual, existing);
        closeMsgMenus();
        try {
            const ref = doc(db, colecaoAtual, chatIdAtual);
            const snap = await getDoc(ref);
            const data = snap.exists() ? snap.data() : {};
            const remote = Array.isArray(data.pinned) ? data.pinned.slice() : [];
            const list = mergePinned(remote, existing).filter((item) => {
                return existing.some((p) => String(p.id) === String(item.id));
            });
            await updateDoc(ref, { pinned: list, pinnedUpdatedAt: new Date().toISOString() });
            pinnedAtual = list;
            renderPinnedBar();
            setPinnedLocal(colecaoAtual, chatIdAtual, list);
        } catch (e) {
            console.error('Falha ao fixar mensagem:', e);
            window.dokeToast ? window.dokeToast('Fixação salva localmente') : null;
        }
    };
    function buildReadReceiptHtml(msg, souEu){
        if (!souEu) return '';
        const map = msg?.lidoEm || msg?.lidoem || {};
        const read = !!(chatOutroUidAtual && map && map[chatOutroUidAtual]) || msg?.lido === true;
        const icon = read ? 'bx bx-check-double' : 'bx bx-check';
        const label = read ? 'Lido' : 'Enviado';
        return `<span class="msg-read ${read ? 'read' : ''}" title="${label}"><i class='${icon}'></i></span>`;
    }
      function buildReplyHtml(replyTo){
          if (!replyTo) return '';
          const user = escapeHtml(replyTo.user || 'Usuário');
          const preview = escapeHtml(replyTo.preview || '');
          return `<div class="reply-preview"><div class="rp-user">${user}</div><div class="rp-text">${preview}</div></div>`;
      }
      function closeMsgMenus(){
          document.querySelectorAll('.msg-menu').forEach((m) => { m.style.display = 'none'; });
      }
      function openMsgMenuById(id, ev){
          if (!id) return;
          if (ev) {
              ev.preventDefault?.();
              ev.stopPropagation?.();
          }
          const el = document.getElementById(`msg-menu-${id}`);
          if (!el) return;
          closeMsgMenus();
          el.style.display = 'flex';
      }
      window.toggleMsgMenu = function(id, ev){
          if (!id) return;
          if (ev) ev.stopPropagation();
          const el = document.getElementById(`msg-menu-${id}`);
          if (!el) return;
          const isOpen = el.style.display === 'flex';
          closeMsgMenus();
          el.style.display = isOpen ? 'none' : 'flex';
      };
      function bindLongPressMensagens(container){
          if (!container || container.dataset.longPressMsgReady === '1') return;
          container.dataset.longPressMsgReady = '1';
          const isTouchDevice = (('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0));
          const isSmallScreen = window.matchMedia('(max-width: 1024px)').matches;
          const enableTouchLongPressMenu = isTouchDevice || isSmallScreen;
          let holdTimer = null;
          let startX = 0;
          let startY = 0;
          let holdConsumed = false;
          let hoverBubble = null;

          const clearHold = () => {
              if (holdTimer) {
                  clearTimeout(holdTimer);
                  holdTimer = null;
              }
          };

          const clearHover = () => {
              if (!hoverBubble) return;
              hoverBubble.classList.remove('msg-touch-hover');
              hoverBubble = null;
          };

          const getMsgHostFromTarget = (target) => {
              return target?.closest?.('[id^="msg-"]') || null;
          };

          const getBubbleFromHost = (host) => {
              if (!host) return null;
              if (host.classList?.contains('msg-bubble')) return host;
              return host.querySelector?.('.msg-bubble') || null;
          };

          const getMsgIdFromTarget = (target) => {
              const host = getMsgHostFromTarget(target);
              if (!host || !host.id) return '';
              const id = host.id.replace(/^msg-/, '');
              if (!id) return '';
              const menu = document.getElementById(`msg-menu-${id}`);
              return menu ? id : '';
          };

          if (enableTouchLongPressMenu) {
              container.addEventListener('touchstart', (e) => {
                  const target = e.target;
                  if (!target || target.closest('.msg-menu') || target.closest('.msg-menu-btn')) return;
                  const msgId = getMsgIdFromTarget(target);
                  if (!msgId) return;
                  const touch = e.touches && e.touches[0];
                  if (!touch) return;
                  startX = touch.clientX;
                  startY = touch.clientY;
                  holdConsumed = false;
                  clearHold();
                  clearHover();
                  hoverBubble = getBubbleFromHost(getMsgHostFromTarget(target));
                  if (hoverBubble) hoverBubble.classList.add('msg-touch-hover');
                  holdTimer = setTimeout(() => {
                      holdConsumed = true;
                      openMsgMenuById(msgId, { preventDefault(){}, stopPropagation(){} });
                      setTimeout(clearHover, 140);
                  }, 520);
              }, { passive: true });

              container.addEventListener('touchmove', (e) => {
                  const touch = e.touches && e.touches[0];
                  if (!touch) return;
                  const dx = Math.abs(touch.clientX - startX);
                  const dy = Math.abs(touch.clientY - startY);
                  if (dx > 10 || dy > 10) {
                      clearHold();
                      clearHover();
                  }
              }, { passive: true });
              container.addEventListener('touchend', () => { clearHold(); clearHover(); }, { passive: true });
              container.addEventListener('touchcancel', () => { clearHold(); clearHover(); }, { passive: true });

              container.addEventListener('click', (e) => {
                  if (!holdConsumed) return;
                  holdConsumed = false;
                  clearHover();
                  e.preventDefault();
                  e.stopPropagation();
                  if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
              }, true);
          }

          container.addEventListener('contextmenu', (e) => {
              const target = e.target;
              if (!target || target.closest('.msg-menu')) return;
              const msgId = getMsgIdFromTarget(target);
              if (!msgId) return;
              clearHover();
              e.preventDefault();
              e.stopPropagation();
              openMsgMenuById(msgId, e);
          });
      }
      window.excluirMensagem = async function(msgId){
          if (!msgId || !chatIdAtual || !colecaoAtual) return;
          const confirmado = (typeof window.dokeConfirm === 'function')
              ? await window.dokeConfirm('Excluir esta mensagem?', 'Excluir', 'danger')
              : confirm('Excluir esta mensagem?');
          if (!confirmado) return;
          try {
              await deleteDoc(doc(db, colecaoAtual, chatIdAtual, "mensagens", msgId));
              closeMsgMenus();
              carregarMensagens(colecaoAtual, chatIdAtual);
          } catch (e) {
              try {
                  await updateDoc(doc(db, colecaoAtual, chatIdAtual, "mensagens", msgId), {
                      tipo: 'apagada',
                      texto: '',
                      apagadaEm: new Date().toISOString()
                  });
                  closeMsgMenus();
                  carregarMensagens(colecaoAtual, chatIdAtual);
                  return;
              } catch (e2) {
                  console.error('Falha ao excluir mensagem:', e);
                  console.error('Falha ao marcar como apagada:', e2);
                  addHiddenMsgId(colecaoAtual, chatIdAtual, msgId);
                  closeMsgMenus();
                  carregarMensagens(colecaoAtual, chatIdAtual);
                  window.dokeAlert ? window.dokeAlert('Mensagem ocultada para você (sem permissão para apagar no servidor).') : alert('Mensagem ocultada para você.');
              }
          }
      };
      window.copiarMensagem = async function(texto){
          try {
              const raw = safeDecodeURIComponent(String(texto || ''));
              await navigator.clipboard.writeText(raw);
              closeMsgMenus();
              window.dokeToast ? window.dokeToast('Mensagem copiada') : null;
          } catch (e) {
              console.warn('Falha ao copiar mensagem:', e);
          }
      };
      window.encaminharMensagem = function(){
          closeMsgMenus();
          window.dokeAlert ? window.dokeAlert('Encaminhar: em breve.') : alert('Encaminhar: em breve.');
      };
    function normalizeUrlForCompare(url){
        const raw = String(url || '').trim();
        if (!raw) return '';
        const noHash = raw.split('#')[0];
        const noQuery = noHash.split('?')[0];
        return noQuery.replace(/\/+$/, '').toLowerCase();
    }
    function getPedidoAnexosFromTriagem(p){
        const triagem = (function(){
            const raw = p?.formularioRespostas || p?.respostasTriagem || p?.formulario_respostas || p?.respostas_triagem || p?.formulariorespostas || p?.respostastriagem || null;
            if (!raw) return [];
            let list = raw;
            if (typeof list === 'string') {
                try { list = JSON.parse(list); } catch (e) { return []; }
            }
            if (!Array.isArray(list)) list = [list];
            return list;
        })();
        const anexosTriagem = triagem.filter(r => /anex/i.test(String(r?.pergunta || "")));
        if (!anexosTriagem.length) return [];
        const linhas = [];
        anexosTriagem.forEach((r) => {
            const texto = String(r?.resposta || "");
            texto.split(/\n+/).forEach((linha) => {
                const clean = linha.trim();
                if (clean) linhas.push(clean);
            });
        });
        if (!linhas.length) return [];
        return linhas.map((linha) => {
            const parts = linha.split(' - ');
            const nome = parts[0] ? parts[0].trim() : linha;
            const url = parts[1] ? parts[1].trim() : "";
            return { nome, url };
        }).filter(x => x.url);
    }
    function buildPedidoInfoCard(p){
        if (!p) return '';
        const titulo = escapeHtml(p.servicoReferencia || p.titulo || 'Pedido');
        const descricaoBase = (function(){
            if (p.descricaoBase) return String(p.descricaoBase || '').trim();
            const msg = String(p.mensagemInicial || '');
            const idx = msg.toLowerCase().indexOf('local do serviço:');
            if (idx === -1) return msg.trim();
            return msg.slice(0, idx).trim();
        })();
        const desc = escapeHtml(descricaoBase || 'Sem descrição');
        const prazo = escapeHtml(p.paraQuando || 'A combinar');
        const turno = escapeHtml(p.turno || 'Livre');
        const modo = escapeHtml(p.modoAtend || p.modo_atend || 'â€”');
        const dataEspecifica = p.dataEspecifica ? (() => {
            const d = parseDataHora(p.dataEspecifica) || new Date(p.dataEspecifica);
            return isNaN(d.getTime()) ? p.dataEspecifica : d.toLocaleDateString('pt-BR');
        })() : '';

        const localizacao = (function(){
            if (p.localizacao && typeof p.localizacao === 'object') return p.localizacao;
            return null;
        })();
        let localHtml = '';
        if (localizacao) {
            let linha = '';
            if (localizacao.endereco && localizacao.numero) linha = `${localizacao.endereco}, Nº ${localizacao.numero}`;
            else if (localizacao.endereco) linha = localizacao.endereco;
            else if (localizacao.numero) linha = `Nº ${localizacao.numero}`;
            if (localizacao.complemento) linha += `${linha ? ', ' : ''}${localizacao.complemento}`;
            if (localizacao.cep) linha += `${linha ? ' ' : ''}(CEP ${localizacao.cep})`;
            const extras = [];
            if (localizacao.referencia) extras.push(`Ponto de referência: ${localizacao.referencia}`);
            if (localizacao.info) extras.push(`Mais informações: ${localizacao.info}`);
            const extraHtml = extras.length ? `<div class="pi-list">${extras.map(e => `<span>${escapeHtml(e)}</span>`).join('')}</div>` : '';
            if (linha || extraHtml) {
                localHtml = `<div class="pi-block"><div class="pi-label">Local</div><div class="pi-value">${escapeHtml(linha)}</div>${extraHtml}</div>`;
            }
        }

        const triagemRespostas = (function(){
            const raw = p.formularioRespostas || p.respostasTriagem || p.formulario_respostas || p.respostas_triagem || p.formulariorespostas || p.respostastriagem || null;
            if (!raw) return [];
            let list = raw;
            if (typeof list === 'string') {
                try { list = JSON.parse(list); } catch (e) { return []; }
            }
            if (!Array.isArray(list)) list = [list];
            const out = [];
            list.forEach((item) => {
                if (!item) return;
                if (typeof item === 'string') {
                    out.push({ pergunta: 'Pergunta', resposta: item });
                    return;
                }
                const pergunta = item.pergunta || item.question || item.titulo || item.label || item.q;
                const resposta = item.resposta || item.answer || item.valor || item.a;
                if (pergunta || resposta) {
                    out.push({ pergunta: pergunta || 'Pergunta', resposta: (resposta != null ? String(resposta) : '-') });
                }
            });
            return out;
        })();

        const anexosList = getPedidoAnexosFromTriagem(p);
        const anexosHtml = (function(){
            if (!anexosList.length) return '';
            const isImg = (url) => /\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(url) || /\/image\/|image%2F/i.test(url);
            const imagens = anexosList.filter(a => isImg(a.url));
            const files = anexosList.filter(a => !isImg(a.url));
            const imgsHtml = imagens.length
                ? `<div class="pi-anexos-grid">${imagens.map(a => `<img src="${escapeHtml(a.url)}" alt="${escapeHtml(a.nome)}" onclick="abrirGaleria(['${escapeHtml(a.url)}'], 0)" / loading="lazy" decoding="async">`).join('')}</div>`
                : '';
            const filesHtml = files.length
                ? `<div class="pi-links pi-list">${files.map(a => `<a href="${escapeHtml(a.url)}" target="_blank" rel="noopener">${escapeHtml(a.nome)}</a>`).join('')}</div>`
                : '';
            return `<div class="pi-block"><div class="pi-label">Anexos</div>${imgsHtml}${filesHtml}</div>`;
        })();

        const triagemHtml = (function(){
            const list = triagemRespostas.filter(r => !/anex/i.test(String(r.pergunta || "")));
            if (!list.length) return '';
            return `<div class="pi-block"><div class="pi-label">Triagem</div><div class="pi-list">${list.map(r => `<div class="pi-qa"><b>${escapeHtml(r.pergunta)}</b><span>${escapeHtml(r.resposta)}</span></div>`).join('')}</div></div>`;
        })();

        return `
            <div class="pedido-info-card">
                <div class="pi-header">
                    <div class="pi-title">${titulo}</div>
                    <span class="pi-chip">ORÇAMENTO</span>
                </div>
                <div class="pi-desc">${desc}</div>
                <div class="pi-grid">
                    <div>
                        <div class="pi-label">Prazo</div>
                        <div class="pi-value">${prazo}</div>
                    </div>
                    <div>
                        <div class="pi-label">Turno</div>
                        <div class="pi-value">${turno}</div>
                    </div>
                    <div>
                        <div class="pi-label">Modo</div>
                        <div class="pi-value">${modo}</div>
                    </div>
                    ${dataEspecifica ? `<div><div class="pi-label">Data</div><div class="pi-value">${escapeHtml(dataEspecifica)}</div></div>` : ''}
                </div>
                ${localHtml}
                ${triagemHtml}
                ${anexosHtml}
            </div>`;
    }
    function buildRecusaCard(p){
        if (!p || String(p.status || '').toLowerCase() !== 'recusado') return '';
        const motivo =
            p.motivoRecusa ||
            p.motivo_recusa ||
            p.respostaRecusa ||
            p.resposta_recusa ||
            '';
        const texto = motivo ? escapeHtml(motivo) : 'O profissional não informou o motivo da recusa.';
        return `
            <div class="pedido-recusa-card">
                <div class="pr-title">Pedido recusado</div>
                <div class="pr-text">${texto}</div>
            </div>`;
    }
    function updateReplyBar(){
        const bar = document.getElementById('replyBar');
        if (!bar) return;
        if (!replyContext) {
            bar.classList.remove('show');
            updateScrollDownButton();
            return;
        }
        const userEl = document.getElementById('replyUser');
        const prevEl = document.getElementById('replyPreview');
        if (userEl) userEl.textContent = `@${replyContext.user || 'Usuário'}`;
        if (prevEl) prevEl.textContent = replyContext.preview || '';
        bar.classList.add('show');
        updateScrollDownButton();
    }
    window.responderMensagem = function(idEnc, userEnc, tipoEnc, previewEnc){
        const id = decodeURIComponent(idEnc || '');
        const user = decodeURIComponent(userEnc || '');
        const tipo = decodeURIComponent(tipoEnc || '');
        const preview = decodeURIComponent(previewEnc || '');
        replyContext = { id, user, tipo, preview };
        updateReplyBar();
    };
    window.cancelarResposta = function(){
        replyContext = null;
        updateReplyBar();
    };
    function applyReplyMetaToText(baseText){
        if (!replyContext) return String(baseText || '');
        const metaText = encodeReplyMeta(replyContext);
        return `${REPLY_MARK_START}${metaText}${REPLY_MARK_END}\n${String(baseText || '')}`;
    }

    function matchBusca(...campos){
        const needle = normalizarTexto(listaBusca);
        if (!needle) return true;
        return campos.some(c => normalizarTexto(c).includes(needle));
    }

    function getLastSeenKey(colecao, id){
        return `doke_chat_last_seen_${colecao || ''}_${id || ''}`;
    }
    function getClearKey(colecao, id){
        return `doke_chat_clear_${colecao || ''}_${id || ''}`;
    }
    function marcarChatComoLido(colecao, id){
        if (!colecao || !id) return;
        try { localStorage.setItem(getLastSeenKey(colecao, id), new Date().toISOString()); } catch(e){}
    }
    async function marcarMensagensComoLidas(refs){
        if (!Array.isArray(refs) || !refs.length || !currentUserUid) return;
        const stamp = new Date().toISOString();
        const payload = { [`lidoEm.${currentUserUid}`]: stamp };
        const chunk = refs.slice(0, 30);
        await Promise.allSettled(chunk.map((ref) => updateDoc(ref, payload)));
    }
    function getLastSeen(colecao, id){
        try {
            const raw = localStorage.getItem(getLastSeenKey(colecao, id));
            if (!raw) return null;
            const d = new Date(raw);
            return isNaN(d.getTime()) ? null : d;
        } catch(e){ return null; }
    }
    function getClearTime(colecao, id){
        try {
            const raw = localStorage.getItem(getClearKey(colecao, id));
            if (!raw) return null;
            const d = new Date(raw);
            return isNaN(d.getTime()) ? null : d;
        } catch(e){ return null; }
    }
    function setClearTime(colecao, id, whenIso){
        if (!colecao || !id) return;
        try { localStorage.setItem(getClearKey(colecao, id), whenIso); } catch(e){}
    }
    function clearClearTime(colecao, id){
        if (!colecao || !id) return;
        try { localStorage.removeItem(getClearKey(colecao, id)); } catch(e){}
    }
    function parseDataHora(v){
        if (!v) return null;
        if (typeof v === 'object' && typeof v.seconds === 'number') return new Date(v.seconds * 1000);
        const d = new Date(v);
        return isNaN(d.getTime()) ? null : d;
    }
    function buildRespostaPayload(p){
        const now = new Date();
        const dp = parseDataHora(p?.dataPedido || p?.data_pedido || p?.createdat || p?.dataCriacao || null);
        const payload = { dataResposta: now.toISOString() };
        if (dp) payload.tempoRespostaMs = Math.max(0, now.getTime() - dp.getTime());
        return payload;
    }
    function isNaoLido(updated, colecao, id){
        const upd = parseDataHora(updated);
        if (!upd) return false;
        const last = getLastSeen(colecao, id);
        if (!last) return true;
        return upd.getTime() > last.getTime();
    }
    function getOcultosLocal(field){
        const uid = getUserUid();
        if (!uid) return [];
        const key = `doke_${field || 'ocultoPor'}_${uid}`;
        try {
            const raw = JSON.parse(localStorage.getItem(key) || "[]");
            return Array.isArray(raw) ? raw : [];
        } catch (e) {
            return [];
        }
    }
    function setOcultosLocal(field, list){
        const uid = getUserUid();
        if (!uid) return;
        const key = `doke_${field || 'ocultoPor'}_${uid}`;
        localStorage.setItem(key, JSON.stringify(list || []));
    }
    function isOcultoPorUser(data, field, docId){
        const key = field || 'ocultoPor';
        const arr = data && Array.isArray(data[key]) ? data[key] : [];
        const local = getOcultosLocal(key);
        const ocultoLocal = docId ? local.includes(docId) : false;
        const uid = getUserUid();
        return (uid && arr.includes(uid)) || ocultoLocal;
    }
    function getArquivadosLocal(){
        const uid = getUserUid();
        if (!uid) return [];
        const key = `doke_arquivado_${uid}`;
        try {
            const raw = JSON.parse(localStorage.getItem(key) || "[]");
            return Array.isArray(raw) ? raw : [];
        } catch (e) {
            return [];
        }
    }
    function setArquivadosLocal(list){
        const uid = getUserUid();
        if (!uid) return;
        const key = `doke_arquivado_${uid}`;
        localStorage.setItem(key, JSON.stringify(list || []));
    }
    function getPinnedLocal(colecao, chatId){
        const uid = getUserUid();
        if (!uid || !colecao || !chatId) return [];
        const key = `doke_pinned_${uid}_${colecao}_${chatId}`;
        try {
            const raw = JSON.parse(localStorage.getItem(key) || "[]");
            return Array.isArray(raw) ? raw : [];
        } catch (_) {
            return [];
        }
    }
    function setPinnedLocal(colecao, chatId, list){
        const uid = getUserUid();
        if (!uid || !colecao || !chatId) return;
        const key = `doke_pinned_${uid}_${colecao}_${chatId}`;
        try {
            localStorage.setItem(key, JSON.stringify(Array.isArray(list) ? list : []));
        } catch (_) {}
    }
    function mergePinned(remote, local){
        const merged = [];
        const seen = new Set();
        const pushUnique = (item) => {
            if (!item || !item.id) return;
            const id = String(item.id);
            if (seen.has(id)) return;
            seen.add(id);
            merged.push(item);
        };
        (Array.isArray(remote) ? remote : []).forEach(pushUnique);
        (Array.isArray(local) ? local : []).forEach(pushUnique);
        return merged;
    }
    function getSilenciadosLocal(){
        const uid = getUserUid();
        if (!uid) return [];
        const key = `doke_silenciado_${uid}`;
        try {
            const raw = JSON.parse(localStorage.getItem(key) || "[]");
            return Array.isArray(raw) ? raw : [];
        } catch (e) {
            return [];
        }
    }
    function setSilenciadosLocal(list){
        const uid = getUserUid();
        if (!uid) return;
        const key = `doke_silenciado_${uid}`;
        localStorage.setItem(key, JSON.stringify(list || []));
    }
    function isContatoSilenciado(outroUid){
        if (!outroUid) return false;
        return getSilenciadosLocal().includes(String(outroUid));
    }
    function isArquivadoPorUser(data, docId){
        const arr = data && Array.isArray(data.arquivadoPor) ? data.arquivadoPor : [];
        const local = getArquivadosLocal();
        const localHas = docId ? local.includes(docId) : false;
        const uid = getUserUid();
        return (uid && arr.includes(uid)) || localHas;
    }

    async function atualizarArrayUsuario(ref, field, add){
        try {
            const uid = getUserUid();
            if (!uid) return [];
            const snap = await getDoc(ref);
            if (!snap.exists()) return [];
            const data = snap.data() || {};
            const arr = Array.isArray(data[field]) ? data[field].slice() : [];
            const idx = arr.indexOf(uid);
            if (add && idx === -1) arr.push(uid);
            if (!add && idx !== -1) arr.splice(idx, 1);
            await updateDoc(ref, { [field]: arr });
            if (field === 'ocultoPedidosPor' || field === 'ocultoChatPor') {
                const local = getOcultosLocal(field);
                const id = ref && ref.id ? ref.id : null;
                if (id) {
                    const has = local.includes(id);
                    if (add && !has) local.push(id);
                    if (!add && has) local.splice(local.indexOf(id), 1);
                    setOcultosLocal(field, local);
                }
            }
            if (field === 'arquivadoPor') {
                const local = getArquivadosLocal();
                const id = ref && ref.id ? ref.id : null;
                if (id) {
                    const has = local.includes(id);
                    if (add && !has) local.push(id);
                    if (!add && has) local.splice(local.indexOf(id), 1);
                    setArquivadosLocal(local);
                }
            }
            return arr;
        } catch(e){
            console.error(e);
            if (field === 'ocultoPedidosPor' || field === 'ocultoChatPor') {
                const local = getOcultosLocal(field);
                const id = ref && ref.id ? ref.id : null;
                if (id && !local.includes(id)) {
                    local.push(id);
                    setOcultosLocal(field, local);
                }
            }
            if (field === 'arquivadoPor') {
                const local = getArquivadosLocal();
                const id = ref && ref.id ? ref.id : null;
                if (id) {
                    const has = local.includes(id);
                    if (add && !has) local.push(id);
                    if (!add && has) local.splice(local.indexOf(id), 1);
                    setArquivadosLocal(local);
                }
            }
            return null;
        }
    }

    function atualizarMenuConversa(){
        const menu = document.getElementById('chatMenu');
        if (!menu) return;
        const btnArquivar = document.getElementById('menuArquivar');
        const btnDesarquivar = document.getElementById('menuDesarquivar');
        const btnRestaurar = document.getElementById('menuRestaurar');
        const btnReembolso = document.getElementById('menuReembolso');
        const btnDisputa = document.getElementById('menuDisputa');
        const clearAt = getClearTime(colecaoAtual, chatIdAtual);
        if (btnRestaurar) btnRestaurar.style.display = clearAt ? 'block' : 'none';
        if (conversaArquivadaAtual) {
            if (btnArquivar) btnArquivar.style.display = 'none';
            if (btnDesarquivar) btnDesarquivar.style.display = 'block';
        } else {
            if (btnArquivar) btnArquivar.style.display = 'block';
            if (btnDesarquivar) btnDesarquivar.style.display = 'none';
        }

        const souClientePedido = !!(pedidoAtualData && String(pedidoAtualData.deUid || '') === String(currentUserUid || ''));
        const showReembolso = (colecaoAtual === 'pedidos' && String(statusPedidoAtual || '').toLowerCase() === 'pago' && souClientePedido);
        if (btnReembolso) btnReembolso.style.display = showReembolso ? 'block' : 'none';
        if (btnDisputa) btnDisputa.style.display = 'none';
    }

    function fecharMenuChat(){
        const menu = document.getElementById('chatMenu');
        if (menu) menu.classList.remove('open');
    }

    window.toggleChatMenuOptions = function(event){
        if (event) event.stopPropagation();
        const menu = document.getElementById('chatMenu');
        if (!menu) return;
        menu.classList.toggle('open');
        atualizarMenuConversa();
    };

    window.ocultarConversaAtual = async function(){
        if (!chatIdAtual || !colecaoAtual) return;
        if (!await window.dokeConfirm('Ocultar esta conversa? Ela continuará disponível para o outro usuário.', 'Ocultar', 'danger')) return;
        const ref = doc(db, colecaoAtual, chatIdAtual);
        await atualizarArrayUsuario(ref, 'ocultoChatPor', true);
        fecharMenuChat();
        if (abaAtual === 'pedidos') carregarListaPedidos();
        else if (window.carregarListaConversas) window.carregarListaConversas();
    };

    window.arquivarConversaAtual = async function(){
        if (!chatIdAtual || !colecaoAtual) return;
        const ref = doc(db, colecaoAtual, chatIdAtual);
        await atualizarArrayUsuario(ref, 'arquivadoPor', true);
        conversaArquivadaAtual = true;
        fecharMenuChat();
        atualizarMenuConversa();
        if (abaAtual === 'pedidos') carregarListaPedidos();
        else if (window.carregarListaConversas) window.carregarListaConversas();
    };

    window.desarquivarConversaAtual = async function(){
        if (!chatIdAtual || !colecaoAtual) return;
        const ref = doc(db, colecaoAtual, chatIdAtual);
        await atualizarArrayUsuario(ref, 'arquivadoPor', false);
        conversaArquivadaAtual = false;
        fecharMenuChat();
        atualizarMenuConversa();
        if (abaAtual === 'pedidos') carregarListaPedidos();
        else if (window.carregarListaConversas) window.carregarListaConversas();
    };

    window.limparHistoricoLocal = async function(){
        if (!chatIdAtual || !colecaoAtual) return;
        if (!await window.dokeConfirm('Excluir mensagens apenas para você? Isso não apaga para o outro usuário.', 'Excluir mensagens', 'danger')) return;
        setClearTime(colecaoAtual, chatIdAtual, new Date().toISOString());
        fecharMenuChat();
        atualizarMenuConversa();
        carregarMensagens(colecaoAtual, chatIdAtual);
    };

    window.restaurarHistoricoLocal = function(){
        if (!chatIdAtual || !colecaoAtual) return;
        clearClearTime(colecaoAtual, chatIdAtual);
        fecharMenuChat();
        atualizarMenuConversa();
        carregarMensagens(colecaoAtual, chatIdAtual);
    };

    window.repetirPedidoAtual = function(){
        if (!pedidoAtualData || !chatIdAtual) return;
        const profUid = pedidoAtualData.paraUid || pedidoAtualData.parauid || '';
        const anuncioId = pedidoAtualData.anuncioId || pedidoAtualData.anuncio_id || '';
        if (!profUid) return;
        const url = `orcamento.html?uid=${encodeURIComponent(profUid)}&refPedido=${encodeURIComponent(chatIdAtual)}&aid=${encodeURIComponent(anuncioId)}`;
        window.location.href = url;
    };

    window.solicitarReembolso = async function(){
        if (!chatIdAtual || !pedidoAtualData) return;
        const motivo = await window.dokePrompt('Informe o motivo do reembolso/solicitação:', 'Ex: serviço incompleto', 'Solicitar reembolso');
        if (!motivo) return;
        try {
            await addDoc(collection(db, "pedidos", chatIdAtual, "mensagens"), {
                tipo: 'reembolso',
                texto: motivo,
                senderUid: currentUserUid,
                timestamp: new Date(),
                lidoEm: currentUserUid ? { [currentUserUid]: new Date().toISOString() } : {}
            });
        } catch (e) {
            console.error(e);
        }
        try {
            const disputa = buildDisputaUpdate(pedidoAtualData, {
                status: 'aberta',
                motivo,
                titulo: 'Disputa aberta',
                descricao: motivo
            });
            await updateDoc(doc(db, "pedidos", chatIdAtual), {
                disputa,
                disputaStatus: disputa.status,
                disputaMotivo: disputa.motivo || motivo,
                disputaEm: disputa.createdAt || new Date().toISOString()
            });
        } catch (e) {
            console.warn('Falha ao salvar disputa no pedido.', e);
        }
        if (pedidoAtualData.paraUid) {
            try { await window.criarNotificacaoPedido(pedidoAtualData.paraUid, 'pedido_reembolso', chatIdAtual); } catch (_) {}
        }
        window.dokeAlert('Solicitação enviada. Vamos analisar.');
    };

    function getDisputaFromPedido(p){
        if (!p) return null;
        if (p.disputa && typeof p.disputa === 'object') return { ...p.disputa };
        const status = p.disputaStatus || p.disputa_status || '';
        const motivo = p.disputaMotivo || p.disputa_motivo || '';
        if (!status && !motivo) return null;
        return {
            status: status || 'aberta',
            motivo: motivo || '',
            createdAt: p.disputaEm || p.disputa_em || p.dataAtualizacao || new Date().toISOString(),
            updatedAt: p.disputaEm || p.disputa_em || p.dataAtualizacao || new Date().toISOString(),
            timeline: [],
            provas: []
        };
    }
    function buildDisputaUpdate(p, { status, motivo, titulo, descricao } = {}){
        const now = new Date().toISOString();
        const disputa = getDisputaFromPedido(p) || { status: status || 'aberta', motivo: motivo || '', createdAt: now, provas: [], timeline: [] };
        if (motivo && !disputa.motivo) disputa.motivo = motivo;
        disputa.status = status || disputa.status || 'aberta';
        disputa.updatedAt = now;
        const timeline = Array.isArray(disputa.timeline) ? disputa.timeline.slice() : [];
        if (titulo) {
            timeline.unshift({
                titulo,
                descricao: descricao || motivo || '',
                at: now,
                by: currentUserUid || ''
            });
        }
        disputa.timeline = timeline;
        if (!Array.isArray(disputa.provas)) disputa.provas = [];
        if (!disputa.createdAt) disputa.createdAt = now;
        return disputa;
    }
    function renderDisputaModal(){
        const rowStatus = document.getElementById('disputaStatusRow');
        const rowMotivo = document.getElementById('disputaMotivoRow');
        const actions = document.getElementById('disputaActions');
        const provas = document.getElementById('disputaProvas');
        const timeline = document.getElementById('disputaTimeline');
        const inputFile = document.getElementById('disputaArquivo');
        if (!rowStatus || !rowMotivo || !actions || !provas || !timeline) return;
        if (!pedidoAtualData) {
            rowStatus.innerHTML = `<span class="disputa-status-badge disputa-status-aberta">Indisponivel</span>`;
            rowMotivo.innerHTML = `<div style="color:#64748b; font-size:0.85rem;">Use a disputa apenas em pedidos.</div>`;
            actions.innerHTML = '';
            provas.innerHTML = '';
            timeline.innerHTML = '';
            if (inputFile) inputFile.disabled = true;
            return;
        }
        const disputa = getDisputaFromPedido(pedidoAtualData);
        if (!disputa) {
            rowStatus.innerHTML = `<span class="disputa-status-badge disputa-status-aberta">Sem disputa</span>`;
            rowMotivo.innerHTML = `<div style="color:#64748b; font-size:0.85rem;">Nenhuma disputa aberta para este pedido.</div>`;
            actions.innerHTML = `<button class="danger" onclick="abrirDisputa()">Abrir disputa</button>`;
            provas.innerHTML = '';
            timeline.innerHTML = '';
            if (inputFile) inputFile.disabled = true;
            return;
        }
        const st = String(disputa.status || 'aberta').toLowerCase();
        const label = st === 'em_analise' ? 'Em analise' : (st === 'resolvida' ? 'Resolvida' : 'Aberta');
        const cls = st === 'em_analise' ? 'disputa-status-analise' : (st === 'resolvida' ? 'disputa-status-resolvida' : 'disputa-status-aberta');
        rowStatus.innerHTML = `<span class="disputa-status-badge ${cls}">${label}</span>`;
        rowMotivo.innerHTML = `<div style="font-weight:700; color:#0f172a;">Motivo</div><div style="color:#475569; font-size:0.85rem;">${escapeHtml(disputa.motivo || 'Nao informado')}</div>`;
        const btns = [];
        if (st === 'aberta') btns.push(`<button class="primary" onclick="enviarDisputaAnalise()">Enviar para analise</button>`);
        if (st !== 'resolvida') btns.push(`<button class="danger" onclick="resolverDisputa()">Marcar resolvida</button>`);
        actions.innerHTML = btns.join('');
        if (inputFile) inputFile.disabled = false;

        const listaProvas = Array.isArray(disputa.provas) ? disputa.provas : [];
        provas.innerHTML = listaProvas.length
            ? listaProvas.map(p => `<a href="${escapeHtml(p.url)}" target="_blank" rel="noopener">${escapeHtml(p.nome || 'Arquivo')}</a>`).join('')
            : `<div style="color:#94a3b8; font-size:0.78rem;">Nenhuma prova anexada.</div>`;
        const listTimeline = Array.isArray(disputa.timeline) ? disputa.timeline : [];
        timeline.innerHTML = listTimeline.length
            ? listTimeline.map(ev => `
                <div class="disputa-event">
                    <div class="disputa-event-title">${escapeHtml(ev.titulo || 'Atualizacao')}</div>
                    <div style="color:#475569; font-size:0.78rem; margin-top:4px;">${escapeHtml(ev.descricao || '')}</div>
                    <div class="disputa-event-meta">${ev.at ? new Date(ev.at).toLocaleString('pt-BR') : ''}</div>
                </div>
            `).join('')
            : `<div style="color:#94a3b8; font-size:0.78rem;">Sem eventos ainda.</div>`;
    }
    window.abrirDisputa = async function(){
        if (!chatIdAtual || !pedidoAtualData) return;
        const motivo = await window.dokePrompt('Descreva o problema:', 'Ex: servico incompleto', 'Abrir disputa');
        if (!motivo) return;
        const disputa = buildDisputaUpdate(pedidoAtualData, { status: 'aberta', motivo, titulo: 'Disputa aberta', descricao: motivo });
        await updateDoc(doc(db, "pedidos", chatIdAtual), {
            disputa,
            disputaStatus: disputa.status,
            disputaMotivo: disputa.motivo,
            disputaEm: disputa.createdAt || new Date().toISOString()
        });
        pedidoAtualData.disputa = disputa;
        pedidoAtualData.disputaStatus = disputa.status;
        renderDisputaModal();
    };
    window.enviarDisputaAnalise = async function(){
        if (!chatIdAtual || !pedidoAtualData) return;
        const disputa = buildDisputaUpdate(pedidoAtualData, { status: 'em_analise', titulo: 'Enviado para analise', descricao: 'Equipe Doke recebeu a solicitacao.' });
        await updateDoc(doc(db, "pedidos", chatIdAtual), { disputa, disputaStatus: disputa.status, disputaMotivo: disputa.motivo || '' });
        pedidoAtualData.disputa = disputa;
        pedidoAtualData.disputaStatus = disputa.status;
        renderDisputaModal();
    };
    window.resolverDisputa = async function(){
        if (!chatIdAtual || !pedidoAtualData) return;
        const disputa = buildDisputaUpdate(pedidoAtualData, { status: 'resolvida', titulo: 'Disputa resolvida', descricao: 'Status atualizado.' });
        await updateDoc(doc(db, "pedidos", chatIdAtual), { disputa, disputaStatus: disputa.status });
        pedidoAtualData.disputa = disputa;
        pedidoAtualData.disputaStatus = disputa.status;
        renderDisputaModal();
    };
    window.adicionarProvaDisputa = async function(){
        if (!chatIdAtual || !pedidoAtualData) return;
        const input = document.getElementById('disputaArquivo');
        const file = input?.files?.[0];
        if (!file) {
            window.dokeAlert ? window.dokeAlert('Selecione um arquivo.') : alert('Selecione um arquivo.');
            return;
        }
        try {
            const storage = getStorage();
            const safeName = String(file.name || 'prova').replace(/[^a-zA-Z0-9._-]/g, '_');
            const path = `disputas/${chatIdAtual}/${Date.now()}_${safeName}`;
            const r = ref(storage, path);
            await uploadBytes(r, file);
            const url = await getDownloadURL(r);
            const prova = { nome: safeName, url, at: new Date().toISOString(), by: currentUserUid || '' };
            const disputa = buildDisputaUpdate(pedidoAtualData, { titulo: 'Prova anexada', descricao: safeName });
            const provas = Array.isArray(disputa.provas) ? disputa.provas.slice() : [];
            provas.unshift(prova);
            disputa.provas = provas;
            await updateDoc(doc(db, "pedidos", chatIdAtual), { disputa });
            pedidoAtualData.disputa = disputa;
            if (input) input.value = '';
            renderDisputaModal();
        } catch (e) {
            console.error(e);
            window.dokeAlert ? window.dokeAlert('Erro ao anexar prova.') : alert('Erro ao anexar prova.');
        }
    };

    window.irRepetirPedido = function(idPedido, profUid, anuncioId){
        const pid = idPedido || chatIdAtual;
        const uid = profUid || (pedidoAtualData ? (pedidoAtualData.paraUid || '') : '');
        if (!pid || !uid) return;
        const aid = anuncioId || (pedidoAtualData ? (pedidoAtualData.anuncioId || '') : '');
        const url = `orcamento.html?uid=${encodeURIComponent(uid)}&refPedido=${encodeURIComponent(pid)}&aid=${encodeURIComponent(aid || '')}`;
        window.location.href = url;
    };

      let amizadeStatusAtual = 'none';
      let amizadeIdAtual = '';
      let amizadeDirecaoAtual = '';
      let amizadeOutroUidAtual = '';
      let dmPrivacidadeModoOutro = 'livre';
      let dmSolicitacaoAtivaAtual = false;
      let dmSolicitacaoStatusAtual = 'none';
      let dmSolicitacaoByAtual = '';
      let dmSolicitacaoTargetAtual = '';
      let dmPodeEnviarAtual = true;
      let dmOutroEhProfissionalAtual = false;

      function setChatInputEnabled(enabled, placeholderText){
          const input = document.getElementById('inputMsg');
          const btnSend = document.getElementById('btn-send-txt');
          const btnMic = document.getElementById('btn-mic');
          const btnAttach = document.getElementById('btn-attach');
          if (input) input.disabled = !enabled;
          if (btnSend) btnSend.disabled = !enabled;
          if (btnMic) btnMic.disabled = !enabled;
          if (btnAttach) btnAttach.disabled = !enabled;
          if (!enabled) cancelarResposta();
          if (input) {
              input.placeholder = enabled
                  ? 'Digite uma mensagem...'
                  : (placeholderText || 'Aguardando liberação para enviar mensagens.');
          }
      }

      function getDmPrivacidadeModo(data){
          const raw = String(
              (data && (
                  data.dmPrivacidadeModo ||
                  data.dm_privacidade_modo ||
                  data.privacidadeDmModo ||
                  data.privacidade_dm_modo ||
                  data.privacidadeMensagens ||
                  data.privacidade_mensagens
              )) || ''
          ).toLowerCase();
          return raw === 'solicitacao' ? 'solicitacao' : 'livre';
      }

      function resetDmSolicitacaoState(){
          dmPrivacidadeModoOutro = 'livre';
          dmSolicitacaoAtivaAtual = false;
          dmSolicitacaoStatusAtual = 'none';
          dmSolicitacaoByAtual = '';
          dmSolicitacaoTargetAtual = '';
          dmPodeEnviarAtual = true;
          dmOutroEhProfissionalAtual = false;
      }

      async function atualizarPrivacidadeDmConversa(uidOutro, opts){
          const targetUid = uidOutro || chatOutroUidAtual || '';
          if (!targetUid || colecaoAtual !== 'conversas' || !chatIdAtual) {
              resetDmSolicitacaoState();
              return;
          }

          let outroData = null;
          try {
              const outroSnap = await getDoc(doc(db, "usuarios", targetUid));
              if (outroSnap.exists()) outroData = outroSnap.data() || {};
          } catch (_) {}

          const outroEhProf = !!(outroData && (outroData.isProfissional === true || outroData.isprofissional === true));
          const modoOutro = outroEhProf ? getDmPrivacidadeModo(outroData) : 'livre';

          let meuPerfilLocal = null;
          try { meuPerfilLocal = JSON.parse(localStorage.getItem('doke_usuario_perfil') || 'null'); } catch (_) {}
          let meuEhProf = !!(meuPerfilLocal && (meuPerfilLocal.isProfissional === true || String(meuPerfilLocal.isProfissional || '').toLowerCase() === 'true'));
          let modoMeu = meuEhProf ? getDmPrivacidadeModo(meuPerfilLocal) : 'livre';
          if (!meuEhProf || !meuPerfilLocal || !meuPerfilLocal.dmPrivacidadeModo) {
              try {
                  const meuSnap = await getDoc(doc(db, "usuarios", currentUserUid));
                  if (meuSnap.exists()) {
                      const meuData = meuSnap.data() || {};
                      meuEhProf = meuData.isProfissional === true || meuData.isprofissional === true;
                      modoMeu = meuEhProf ? getDmPrivacidadeModo(meuData) : 'livre';
                  }
              } catch (_) {}
          }

          let requestTarget = '';
          if (outroEhProf && modoOutro === 'solicitacao') requestTarget = targetUid;
          else if (meuEhProf && modoMeu === 'solicitacao') requestTarget = String(currentUserUid || '');

          dmOutroEhProfissionalAtual = outroEhProf;
          dmPrivacidadeModoOutro = modoOutro;
          dmSolicitacaoAtivaAtual = !!requestTarget;
          dmSolicitacaoStatusAtual = 'none';
          dmSolicitacaoByAtual = '';
          dmSolicitacaoTargetAtual = requestTarget || targetUid;
          dmPodeEnviarAtual = true;

          if (!dmSolicitacaoAtivaAtual) return;

          let convData = (opts && opts.conversaData) ? (opts.conversaData || {}) : null;
          if (!convData) {
              try {
                  const convSnap = await getDoc(doc(db, "conversas", chatIdAtual));
                  convData = convSnap.exists() ? (convSnap.data() || {}) : {};
              } catch (_) {
                  convData = {};
              }
          }

          const reqStatus = String(
              convData.dmRequestStatus ||
              convData.dm_request_status ||
              convData.solicitacaoMensagemStatus ||
              convData.solicitacao_mensagem_status ||
              ''
          ).toLowerCase();
          const reqBy = String(
              convData.dmRequestBy ||
              convData.dm_request_by ||
              convData.solicitacaoMensagemBy ||
              convData.solicitacao_mensagem_by ||
              ''
          );
          const reqTarget = String(
              convData.dmRequestTarget ||
              convData.dm_request_target ||
              convData.solicitacaoMensagemTarget ||
              convData.solicitacao_mensagem_target ||
              targetUid
          );

          dmSolicitacaoStatusAtual = reqStatus || 'none';
          dmSolicitacaoByAtual = reqBy;
          dmSolicitacaoTargetAtual = reqTarget || targetUid;

          const souAlvoSolicitacao = String(currentUserUid || '') === String(dmSolicitacaoTargetAtual || '');
          if (souAlvoSolicitacao) {
              dmPodeEnviarAtual = true;
              return;
          }

          if (dmSolicitacaoStatusAtual === 'aprovado') {
              dmPodeEnviarAtual = true;
              return;
          }

          dmPodeEnviarAtual = false;
      }

      function renderContextoConversa(){
          const bar = document.getElementById('chatContextBar');
          const text = document.getElementById('chatContextText');
          const actions = document.getElementById('chatContextActions');
          if (!bar || !text || !actions) return;
          if (colecaoAtual !== 'conversas') return;

          actions.innerHTML = '';
          const souAlvoSolicitacao = String(currentUserUid || '') === String(dmSolicitacaoTargetAtual || '');

          if (dmSolicitacaoAtivaAtual) {
              bar.style.display = 'flex';
              bar.classList.add('show');

              if (souAlvoSolicitacao && dmSolicitacaoStatusAtual === 'pendente') {
                  text.textContent = 'Solicitação de mensagem recebida.';
                  actions.innerHTML = `
                      <button class="primary" onclick="aprovarSolicitacaoMensagem()">Aceitar</button>
                      <button class="danger" onclick="recusarSolicitacaoMensagem()">Recusar</button>
                  `;
                  setChatInputEnabled(true);
                  return;
              }

              if (!souAlvoSolicitacao && dmSolicitacaoStatusAtual === 'pendente') {
                  text.textContent = 'Solicitação enviada. Aguarde aprovação do profissional.';
                  actions.innerHTML = `<button onclick="enviarSolicitacaoMensagem()">Reenviar solicitação</button>`;
                  setChatInputEnabled(false, 'Aguardando aprovação da solicitação de mensagem.');
                  return;
              }

              if (!souAlvoSolicitacao && dmSolicitacaoStatusAtual === 'recusado') {
                  text.textContent = 'Sua solicitação de mensagem foi recusada.';
                  actions.innerHTML = `<button class="primary" onclick="enviarSolicitacaoMensagem()">Enviar nova solicitação</button>`;
                  setChatInputEnabled(false, 'Solicitação recusada. Envie uma nova solicitação.');
                  return;
              }

              if (!souAlvoSolicitacao && dmSolicitacaoStatusAtual !== 'aprovado') {
                  text.textContent = 'Este profissional recebe mensagens por solicitação.';
                  actions.innerHTML = `<button class="primary" onclick="enviarSolicitacaoMensagem()">Enviar solicitação</button>`;
                  setChatInputEnabled(false, 'Envie uma solicitação para iniciar esta conversa.');
                  return;
              }

              bar.classList.remove('show');
              bar.style.display = 'none';
              setChatInputEnabled(true);
              return;
          }

          if (amizadeStatusAtual === 'pendente_out') {
              bar.style.display = 'flex';
              bar.classList.add('show');
              text.textContent = 'Pedido de amizade enviado.';
              actions.innerHTML = `<button onclick="cancelarPedidoAmizade()">Cancelar pedido</button>`;
              setChatInputEnabled(true);
              return;
          }

          if (amizadeStatusAtual === 'pendente_in') {
              bar.style.display = 'flex';
              bar.classList.add('show');
              text.textContent = 'Você recebeu um pedido de amizade.';
              actions.innerHTML = `
                  <button class="primary" onclick="aceitarPedidoAmizade()">Aceitar</button>
                  <button class="danger" onclick="recusarPedidoAmizade()">Recusar</button>
              `;
              setChatInputEnabled(true);
              return;
          }

          if (amizadeStatusAtual === 'recusado') {
              bar.style.display = 'flex';
              bar.classList.add('show');
              text.textContent = 'Pedido de amizade recusado.';
              actions.innerHTML = `<button class="primary" onclick="enviarPedidoAmizade()">Enviar novo pedido</button>`;
              setChatInputEnabled(true);
              return;
          }

          bar.classList.remove('show');
          bar.style.display = 'none';
          text.textContent = '';
          actions.innerHTML = '';
          setChatInputEnabled(true);
      }

      async function getAmizadeStatus(uidOutro){
          if (!uidOutro || !currentUserUid) return { status: 'none' };
          try{
              const qOut = query(collection(db, "amizades"), where("deUid", "==", currentUserUid), where("paraUid", "==", uidOutro));
              const qIn = query(collection(db, "amizades"), where("deUid", "==", uidOutro), where("paraUid", "==", currentUserUid));
              const [sOut, sIn] = await Promise.all([getDocs(qOut), getDocs(qIn)]);
              const outDoc = sOut.docs[0];
              const inDoc = sIn.docs[0];
              const outData = outDoc ? (outDoc.data() || {}) : null;
              const inData = inDoc ? (inDoc.data() || {}) : null;

              const outStatus = outData ? String(outData.status || '').toLowerCase() : '';
              const inStatus = inData ? String(inData.status || '').toLowerCase() : '';

              if (outStatus === 'aceito' || inStatus === 'aceito') {
                  return { status: 'aceito', id: (outDoc?.id || inDoc?.id || ''), direction: outStatus === 'aceito' ? 'out' : 'in' };
              }
              if (inStatus === 'pendente') {
                  return { status: 'pendente_in', id: inDoc.id, direction: 'in' };
              }
              if (outStatus === 'pendente') {
                  return { status: 'pendente_out', id: outDoc.id, direction: 'out' };
              }
              if (inStatus === 'recusado') {
                  return { status: 'recusado', id: inDoc.id, direction: 'in' };
              }
              if (outStatus === 'recusado') {
                  return { status: 'recusado', id: outDoc.id, direction: 'out' };
              }
              return { status: 'none' };
          } catch (e) {
              console.warn('Falha ao consultar amizade:', e);
              return { status: 'none' };
          }
      }

      async function carregarMapaAmizades(){
          const map = new Map();
          if (!currentUserUid) return map;
          try{
              const qOut = query(collection(db, "amizades"), where("deUid", "==", currentUserUid));
              const qIn = query(collection(db, "amizades"), where("paraUid", "==", currentUserUid));
              const [sOut, sIn] = await Promise.all([getDocs(qOut), getDocs(qIn)]);

              sOut.forEach((docSnap) => {
                  const data = docSnap.data() || {};
                  const outroUid = data.paraUid;
                  if (!outroUid) return;
                  const status = String(data.status || '').toLowerCase();
                  map.set(outroUid, {
                      status: status === 'aceito' ? 'aceito' : (status === 'pendente' ? 'pendente_out' : status || 'none'),
                      id: docSnap.id,
                      direction: 'out'
                  });
              });

              sIn.forEach((docSnap) => {
                  const data = docSnap.data() || {};
                  const outroUid = data.deUid;
                  if (!outroUid) return;
                  const status = String(data.status || '').toLowerCase();
                  const existing = map.get(outroUid);
                  if (status === 'aceito') {
                      map.set(outroUid, { status: 'aceito', id: docSnap.id, direction: 'in' });
                      return;
                  }
                  if (existing && existing.status === 'aceito') return;
                  if (status === 'pendente') {
                      map.set(outroUid, { status: 'pendente_in', id: docSnap.id, direction: 'in' });
                      return;
                  }
                  map.set(outroUid, { status: status || 'none', id: docSnap.id, direction: 'in' });
              });
          } catch (e) {
              console.warn('Falha ao carregar mapa de amizades:', e);
          }
          return map;
      }

      async function atualizarContextoAmizade(uidOutro, opts){
          amizadeOutroUidAtual = uidOutro || '';

          const rel = await getAmizadeStatus(uidOutro);
          amizadeStatusAtual = rel.status || 'none';
          amizadeIdAtual = rel.id || '';
          amizadeDirecaoAtual = rel.direction || '';
          if (!(opts && opts.skipRender)) renderContextoConversa();
          atualizarMenuConversa();
      }

      function isConversaBloqueadaParaEnviar(){
          return colecaoAtual === 'conversas' && dmSolicitacaoAtivaAtual && !dmPodeEnviarAtual;
      }

      function getMensagemBloqueioConversa(){
          if (!(dmSolicitacaoAtivaAtual && !dmPodeEnviarAtual)) {
              return 'Não foi possível enviar mensagem neste momento.';
          }
          if (dmSolicitacaoStatusAtual === 'pendente') {
              return 'Aguardando aprovação da solicitação de mensagem.';
          }
          if (dmSolicitacaoStatusAtual === 'recusado') {
              return 'Solicitação de mensagem recusada. Envie uma nova solicitação.';
          }
          return 'Este profissional recebe DM apenas por solicitação.';
      }

      window.enviarSolicitacaoMensagem = async function(){
          if (colecaoAtual !== 'conversas' || !chatIdAtual || !currentUserUid) return;
          const targetUid = dmSolicitacaoTargetAtual || chatOutroUidAtual || amizadeOutroUidAtual || '';
          if (!targetUid) return;
          try {
              const agora = new Date().toISOString();
              const payload = {
                  dmRequestStatus: 'pendente',
                  dmRequestBy: currentUserUid,
                  dmRequestTarget: targetUid,
                  dmRequestUpdatedAt: agora,
                  ultimaMensagem: 'Solicitação de mensagem enviada',
                  dataAtualizacao: agora
              };
              if (dmSolicitacaoStatusAtual !== 'pendente') payload.dmRequestRequestedAt = agora;
              await updateDoc(doc(db, "conversas", chatIdAtual), payload);
              try {
                  if (typeof window.criarNotificacaoSocial === "function") {
                      await window.criarNotificacaoSocial({ acao: "solicitacao_mensagem", paraUid: targetUid });
                  }
              } catch (_) {}
              await atualizarPrivacidadeDmConversa(chatOutroUidAtual || targetUid);
              renderContextoConversa();
              if (window.carregarListaConversas) window.carregarListaConversas();
          } catch (e) {
              console.error('Falha ao enviar solicitação de mensagem:', e);
              window.dokeAlert ? window.dokeAlert('Não foi possível enviar a solicitação de mensagem.') : alert('Não foi possível enviar a solicitação de mensagem.');
          }
      };

      window.aprovarSolicitacaoMensagem = async function(){
          if (colecaoAtual !== 'conversas' || !chatIdAtual || !currentUserUid) return;
          try {
              const agora = new Date().toISOString();
              await updateDoc(doc(db, "conversas", chatIdAtual), {
                  dmRequestStatus: 'aprovado',
                  dmRequestUpdatedAt: agora,
                  dmRequestResolvedAt: agora,
                  dataAtualizacao: agora
              });
              await atualizarPrivacidadeDmConversa(chatOutroUidAtual || amizadeOutroUidAtual);
              renderContextoConversa();
              if (window.carregarListaConversas) window.carregarListaConversas();
          } catch (e) {
              console.error('Falha ao aprovar solicitação de mensagem:', e);
          }
      };

      window.recusarSolicitacaoMensagem = async function(){
          if (colecaoAtual !== 'conversas' || !chatIdAtual || !currentUserUid) return;
          try {
              const agora = new Date().toISOString();
              await updateDoc(doc(db, "conversas", chatIdAtual), {
                  dmRequestStatus: 'recusado',
                  dmRequestUpdatedAt: agora,
                  dmRequestResolvedAt: agora,
                  dataAtualizacao: agora
              });
              await atualizarPrivacidadeDmConversa(chatOutroUidAtual || amizadeOutroUidAtual);
              renderContextoConversa();
              if (window.carregarListaConversas) window.carregarListaConversas();
          } catch (e) {
              console.error('Falha ao recusar solicitação de mensagem:', e);
          }
      }

      window.enviarPedidoAmizade = async function(){
          if (!amizadeOutroUidAtual || !currentUserUid) return;
          try{
              if (amizadeIdAtual && amizadeDirecaoAtual === 'out') {
                  await updateDoc(doc(db, "amizades", amizadeIdAtual), {
                      status: 'pendente',
                      updated_at: new Date().toISOString()
                  });
              } else {
                  await addDoc(collection(db, "amizades"), {
                      deUid: currentUserUid,
                      paraUid: amizadeOutroUidAtual,
                      status: 'pendente',
                      created_at: new Date().toISOString(),
                      updated_at: new Date().toISOString()
                  });
              }
              try {
                  if (typeof window.criarNotificacaoSocial === "function") {
                      await window.criarNotificacaoSocial({ acao: "pedido_amizade", paraUid: amizadeOutroUidAtual });
                  } else if (window.addDoc && window.collection && window.db) {
                      const perfil = (function(){
                          try { return JSON.parse(localStorage.getItem('doke_usuario_perfil') || '{}') || {}; } catch (_) { return {}; }
                      })();
                      const nome = perfil.nome || perfil.user || "Usuario";
                      const user = perfil.user ? (String(perfil.user).startsWith("@") ? perfil.user : `@${perfil.user}`) : "@usuario";
                      const foto = perfil.foto || "https://placehold.co/50";
                      await addDoc(collection(db, "notificacoes"), {
                          parauid: amizadeOutroUidAtual,
                          deuid: currentUserUid,
                          denome: nome,
                          deuser: user,
                          defoto: foto,
                          acao: "pedido_amizade",
                          lida: false,
                          createdat: new Date().toISOString(),
                          link: `perfil-cliente.html?id=${encodeURIComponent(currentUserUid)}`
                      });
                  }
              } catch (_) {}
              await atualizarContextoAmizade(amizadeOutroUidAtual);
              if (window.carregarListaConversas) window.carregarListaConversas();
          } catch (e) {
              console.error('Falha ao enviar pedido de amizade:', e);
              window.dokeAlert ? window.dokeAlert('Não foi possível enviar o pedido de amizade.') : alert('Não foi possível enviar o pedido de amizade.');
          }
      };

      window.cancelarPedidoAmizade = async function(){
          if (!amizadeIdAtual) return;
          try{
              await updateDoc(doc(db, "amizades", amizadeIdAtual), {
                  status: 'recusado',
                  updated_at: new Date().toISOString()
              });
              await atualizarContextoAmizade(amizadeOutroUidAtual);
              if (window.carregarListaConversas) window.carregarListaConversas();
          } catch (e) {
              console.error('Falha ao cancelar pedido:', e);
          }
      };

      window.aceitarPedidoAmizade = async function(){
          if (!amizadeIdAtual) return;
          try{
              await updateDoc(doc(db, "amizades", amizadeIdAtual), {
                  status: 'aceito',
                  accepted_at: new Date().toISOString(),
                  updated_at: new Date().toISOString()
              });
              await atualizarContextoAmizade(amizadeOutroUidAtual);
              if (colecaoAtual === 'conversas' && chatIdAtual) {
                  carregarMensagens(colecaoAtual, chatIdAtual);
              }
              if (window.carregarListaConversas) window.carregarListaConversas();
          } catch (e) {
              console.error('Falha ao aceitar amizade:', e);
          }
      };

      window.recusarPedidoAmizade = async function(){
          if (!amizadeIdAtual) return;
          try{
              await updateDoc(doc(db, "amizades", amizadeIdAtual), {
                  status: 'recusado',
                  updated_at: new Date().toISOString()
              });
              await atualizarContextoAmizade(amizadeOutroUidAtual);
              if (window.carregarListaConversas) window.carregarListaConversas();
          } catch (e) {
              console.error('Falha ao recusar amizade:', e);
          }
      };

    function atualizarContextoChat(p){
        const bar = document.getElementById('chatContextBar');
        const text = document.getElementById('chatContextText');
        const actions = document.getElementById('chatContextActions');
        if (!bar || !text || !actions) return;
        if (!p || !p.status) {
            bar.classList.remove('show');
            bar.style.display = 'none';
            text.textContent = '';
            actions.innerHTML = '';
            return;
        }
        const status = String(p.status || 'pendente').toLowerCase();
        const contextHideKey = `${chatIdAtual || ''}:${status}`;
        if (contextoCardHidden[contextHideKey]) {
            bar.classList.remove('show');
            bar.style.display = 'none';
            text.textContent = '';
            actions.innerHTML = '';
            return;
        }
        const souCliente = p.deUid === currentUserUid;
        let msg = '';
        const btns = [];
        if (status === 'pendente') {
            msg = souCliente ? 'Pedido em espera. Aguardando aceite do profissional.' : 'Pedido pendente. Aceite para liberar o chat.';
        } else if (status === 'aceito') {
            msg = 'Pedido aceito. Combine detalhes no chat.';
        } else if (status === 'pago') {
            msg = souCliente ? 'Pagamento em garantia. Finalize quando o serviço estiver concluído.' : '';
        } else if (status === 'finalizado') {
            if (souCliente) {
                msg = p.avaliado ? 'Pedido finalizado e avaliado com sucesso.' : 'Servico finalizado. Sua avaliacao ajuda a comunidade.';
                if (!p.avaliado) btns.push(`<button onclick="abrirAvaliacaoPedido('${chatIdAtual}')">Avaliar</button>`);
                btns.push(`<button class="primary" onclick="repetirPedidoAtual()">Repetir pedido</button>`);
            } else {
                msg = p.avaliado ? 'Pedido finalizado e avaliado pelo cliente.' : 'Pedido finalizado. Aguardando avaliacao do cliente.';
            }
        } else if (status === 'recusado' || status === 'cancelado') {
            msg = 'Pedido encerrado.';
            if (souCliente) btns.push(`<button class="primary" onclick="repetirPedidoAtual()">Repetir pedido</button>`);
        }
        if (msg) {
            btns.push(`<button class="close-card" title="Ocultar card" aria-label="Ocultar card" onclick="fecharCardContextoPedido('${status}')">&times;</button>`);
        }
        if (!msg && !btns.length) {
            bar.classList.remove('show');
            bar.style.display = 'none';
            text.textContent = '';
            actions.innerHTML = '';
            return;
        }
        text.textContent = msg;
        actions.innerHTML = btns.join('');
        bar.style.display = 'flex';
        bar.classList.add('show');
    }

    try {
        const perfilInicial = JSON.parse(localStorage.getItem('doke_usuario_perfil') || 'null');
        if (perfilInicial) renderHeaderUser(perfilInicial);
    } catch (_) {}

    // =========================================================================
    // 1. SISTEMA DE ALERTAS PERSONALIZADOS (SUBSTITUI NATIVOS)
    // =========================================================================
    
    // InjeÃ§Ã£o de Estilos dos Modais
    const styleModal = document.createElement('style');
    styleModal.innerHTML = `
        .doke-overlay {
            display: none; position: fixed; z-index: 20000; left: 0; top: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px); justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.2s;
            pointer-events: none;
        }
        .doke-overlay.active { display: flex; opacity: 1; pointer-events: auto; }
        
        .doke-modal-box {
            background: #fff; width: 90%; max-width: 400px; border-radius: 16px;
            padding: 0; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            transform: scale(0.9); transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden;
        }
        .doke-overlay.active .doke-modal-box { transform: scale(1); }

        .dm-header { padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        .dm-title { margin: 0; font-size: 1.1rem; color: #333; font-weight: 700; }
        .dm-body { padding: 25px; font-size: 0.95rem; color: #555; line-height: 1.5; }
        .dm-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-top: 10px; outline: none; font-size: 1rem; box-sizing: border-box; }
        .dm-input:focus { border-color: #0b7768; box-shadow: 0 0 0 3px rgba(11, 119, 104, 0.1); }
        
        .dm-footer { padding: 15px 25px; background: #f9f9f9; display: flex; justify-content: flex-end; gap: 10px; }
        
        .btn-dm { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s; }
        .btn-dm-cancel { background: #fff; border: 1px solid #ddd; color: #666; }
        .btn-dm-cancel:hover { background: #f0f0f0; }
        .btn-dm-confirm { background: #0b7768; color: white; box-shadow: 0 4px 10px rgba(11, 119, 104, 0.2); }
        .btn-dm-confirm:hover { background: #096356; transform: translateY(-1px); }
        .btn-dm-danger { background: #e74c3c; color: white; }
        .btn-dm-danger:hover { background: #c0392b; }
    `;
    document.head.appendChild(styleModal);

    // HTML do Modal GenÃ©rico
    document.addEventListener("DOMContentLoaded", () => {
        initPedidosFilters();
        initConversasFilters();
        initListaTools();
        document.addEventListener('click', fecharMenuChat);
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('listaFiltersPanel');
            const btn = document.getElementById('toggleFilters');
            if (!panel || !panel.classList.contains('open')) return;
            if (panel.contains(e.target) || (btn && btn.contains(e.target))) return;
            panel.classList.remove('open');
        });
        if (!document.getElementById('dokeGlobalModal')) {
            const html = `
                <div id="dokeGlobalModal" class="doke-overlay">
                    <div class="doke-modal-box">
                        <div class="dm-header">
                            <i id="dmIcon" class='bx' style="font-size: 1.5rem;"></i>
                            <h3 id="dmTitle" class="dm-title">Título</h3>
                        </div>
                        <div class="dm-body">
                            <p id="dmText">Mensagem aqui</p>
                            <input type="text" id="dmInput" class="dm-input" style="display:none;">
                        </div>
                        <div class="dm-footer">
                            <button id="btnDmCancel" class="btn-dm btn-dm-cancel">Cancelar</button>
                            <button id="btnDmConfirm" class="btn-dm btn-dm-confirm">Confirmar</button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        }
    });

    // FunÃ§Ãµes Auxiliares de Promessa (Substitutos de alert/confirm/prompt)
    // IMPORTANT: script.js (defer) tambÃ©m define window.dokeAlert/Confirm/Prompt.
    // Para evitar conflito (modal some e fica travando a tela), nÃ³s reatribuÃ­mos
    // as funÃ§Ãµes APÃ“S o DOMContentLoaded, garantindo que esta versÃ£o seja a final.
    function bindDokeModalAPI(){
        window.dokeAlert = (msg, title = "Aviso") => new Promise(resolve => setupModal(title, msg, 'alert', resolve));
        window.dokeConfirm = (msg, title = "Confirmação", type = 'normal') => new Promise(resolve => setupModal(title, msg, type === 'danger' ? 'confirm-danger' : 'confirm', resolve));
        window.dokePrompt = (msg, placeholder = "", title = "Informação") => new Promise(resolve => setupModal(title, msg, 'prompt', resolve, placeholder));
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', bindDokeModalAPI);
    } else {
        bindDokeModalAPI();
    }

    function setupModal(title, text, type, resolveCallback, placeholder = "") {
        const overlay = document.getElementById('dokeGlobalModal');
        const elTitle = document.getElementById('dmTitle');
        const elText = document.getElementById('dmText');
        const elInput = document.getElementById('dmInput');
        const btnCancel = document.getElementById('btnDmCancel');
        const btnConfirm = document.getElementById('btnDmConfirm');
        const icon = document.getElementById('dmIcon');

        // Reset
        elTitle.innerText = title;
        elText.innerText = text;
        elInput.style.display = 'none';
        elInput.value = '';
        btnCancel.style.display = 'block';
        btnConfirm.className = 'btn-dm btn-dm-confirm'; // Reset classes
        
        // Ãcones e Cores
        if(type === 'alert') {
            icon.className = 'bx bx-info-circle'; icon.style.color = '#0b7768';
            btnCancel.style.display = 'none';
            btnConfirm.innerText = "OK";
        } else if (type === 'confirm') {
            icon.className = 'bx bx-help-circle'; icon.style.color = '#0b7768';
            btnConfirm.innerText = "Sim";
        } else if (type === 'confirm-danger') {
            icon.className = 'bx bx-error-circle'; icon.style.color = '#e74c3c';
            btnConfirm.classList.add('btn-dm-danger');
            btnConfirm.innerText = "Sim, remover";
        } else if (type === 'prompt') {
            icon.className = 'bx bx-pencil'; icon.style.color = '#0b7768';
            elInput.style.display = 'block';
            elInput.placeholder = placeholder;
            btnConfirm.innerText = "OK";
        }

        // Mostrar
        overlay.classList.add('active');
        if(type === 'prompt') setTimeout(() => elInput.focus(), 100);

        // Handlers (Remove listeners antigos clonando o elemento)
        const newConfirm = btnConfirm.cloneNode(true);
        const newCancel = btnCancel.cloneNode(true);
        btnConfirm.parentNode.replaceChild(newConfirm, btnConfirm);
        btnCancel.parentNode.replaceChild(newCancel, btnCancel);

        newConfirm.addEventListener('click', () => {
            overlay.classList.remove('active');
            if(type === 'prompt') resolveCallback(elInput.value);
            else resolveCallback(true);
        });

        newCancel.addEventListener('click', () => {
            overlay.classList.remove('active');
            if(type === 'prompt') resolveCallback(null);
            else resolveCallback(false);
        });
    }
    

    // =========================================================================
    // 2. FUNÃ‡Ã•ES DE INJEÃ‡ÃƒO DO MODAL DE GARANTIA (INFO)
    // =========================================================================
    document.addEventListener("DOMContentLoaded", () => {
        if (!document.getElementById('modalGarantiaInfo')) {
            const modalHTML = `
                <div id="modalGarantiaInfo" class="modal-detalhes" style="display:none; justify-content:center; align-items:center;">
                    <div class="md-content" style="max-width: 450px; text-align: left; animation: zoomIn 0.2s;">
                        <div class="md-header" style="background:#0b7768;">
                            <h3 style="margin:0; color:white; display:flex; align-items:center; gap:10px;">
                                <i class='bx bx-shield-quarter' style="font-size:1.5rem;"></i> Garantia Doke
                            </h3>
                            <i class='bx bx-x' style="cursor:pointer; font-size:24px; color:white;" onclick="fecharModalGarantia()"></i>
                        </div>
                        <div class="md-body" style="padding: 30px;">
                            <h4 style="margin-top:0; color:#0b7768;">Seu dinheiro está seguro.</h4>
                            <p style="color:#555; line-height:1.6; font-size:0.95rem;">
                                O pagamento do cliente já foi realizado, mas não foi enviado diretamente para o profissional.
                            </p>
                            <p style="color:#555; line-height:1.6; font-size:0.95rem;">
                                Ele fica guardado em uma <strong>"Conta Cofre" (Escrow)</strong> da Doke e só é liberado automaticamente assim que o serviço for finalizado com sucesso.
                            </p>
                            <div style="background:#e0f2f1; padding:15px; border-radius:8px; margin-top:20px; border:1px solid #b2dfdb;">
                                <i class='bx bx-info-circle' style="color:#00695c;"></i>
                                <span style="font-size:0.85rem; color:#004d40;">Isso protege você contra golpes e serviços não realizados.</span>
                            </div>
                            <a href="duvida.html" style="display:block; margin-top:20px; text-align:center; color:#0b7768; font-weight:700; text-decoration:none;">
                                Ler termos completos <i class='bx bx-right-arrow-alt'></i>
                            </a>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        if (!document.getElementById('modalDisputa')) {
            const disputaHtml = `
                <div id="modalDisputa" class="modal-detalhes" style="display:none; justify-content:center; align-items:center;">
                    <div class="md-content" style="max-width: 520px; text-align: left; animation: zoomIn 0.2s;">
                        <div class="md-header" style="background:#0f172a;">
                            <h3 style="margin:0; color:white; display:flex; align-items:center; gap:10px;">
                                <i class='bx bx-shield-quarter' style="font-size:1.5rem;"></i> Disputa e Garantia
                            </h3>
                            <i class='bx bx-x' style="cursor:pointer; font-size:24px; color:white;" onclick="fecharModalDisputa()"></i>
                        </div>
                        <div class="md-body" style="padding: 24px;">
                            <div id="disputaStatusRow"></div>
                            <div id="disputaMotivoRow" style="margin-top:10px;"></div>
                            <div class="disputa-actions" id="disputaActions"></div>
                            <div class="disputa-upload">
                                <input id="disputaArquivo" type="file" />
                                <button type="button" onclick="adicionarProvaDisputa()">Anexar prova</button>
                            </div>
                            <div id="disputaProvas" class="disputa-provas"></div>
                            <div class="disputa-timeline" id="disputaTimeline"></div>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', disputaHtml);
        }
    });

    function ensurePedidosLoaded() {
        const container = document.getElementById('lista-pedidos');
        if (!container) return;
        const hasSpinner = !!container.querySelector('.bx-spin');
        const hasContent = !!container.dataset.sig;
        if (hasSpinner || !hasContent) carregarListaPedidos();
    }

    window.abrirModalGarantia = () => { const m = document.getElementById('modalGarantiaInfo'); if(m) m.style.display = 'flex'; };
    window.fecharModalGarantia = () => { const m = document.getElementById('modalGarantiaInfo'); if(m) m.style.display = 'none'; };
    window.abrirModalDisputa = () => { const m = document.getElementById('modalDisputa'); if(m) { renderDisputaModal(); m.style.display = 'flex'; } };
    window.fecharModalDisputa = () => { const m = document.getElementById('modalDisputa'); if(m) m.style.display = 'none'; };

    // =========================================================================
    // 3. FUNÃ‡Ã•ES GERAIS DA APLICAÃ‡ÃƒO
    // =========================================================================

    window.irParaMeuPerfil = function(event) {
        if(event) event.preventDefault();
        const perfilLocal = JSON.parse(localStorage.getItem('doke_usuario_perfil'));
        if (!perfilLocal) { window.location.href = "login.html"; return; }
        window.location.href = perfilLocal.isProfissional ? "meuperfil.html" : "perfil-usuario.html";
    };

    function renderHeaderUser(perfil) {
        const container = document.getElementById('header-user-area');
        const mobile = document.getElementById('header-user-mobile');
        const mobileImg = document.getElementById('header-mobile-avatar-img');
        if (!container) return;

        if (!perfil) {
            container.innerHTML = `<a href="login.html" class="entrar">Entrar</a>`;
            if (mobile) {
                mobile.href = "login.html";
                if (mobileImg) {
                    mobileImg.src = "assets/Imagens/user_placeholder.png";
                    mobileImg.alt = "Entrar";
                }
            }
            return;
        }

        const foto = perfil.foto || "https://i.pravatar.cc/150?img=12";
        const userLabel = perfil.user || perfil.nome || "Usuario";
        const perfilHref = perfil.isProfissional ? "meuperfil.html" : "perfil-usuario.html";
        const linkAnunciar = perfil.isProfissional ? "anunciar.html" : "tornar-profissional.html";
        const textoAnunciar = "Anunciar";
        const itemCarteira = perfil.isProfissional
            ? `<a href="carteira.html" class="dropdown-item"><i class='bx bx-wallet'></i> Carteira</a>`
            : "";

        container.innerHTML = `
            <div class="profile-container">
                <img src="${foto}" class="profile-img-btn" onclick="toggleDropdown(event)" alt="Perfil" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; border: 2px solid #ddd;" loading="lazy" decoding="async">
                <div id="dropdownPerfil" class="dropdown-profile">
                    <div style="padding: 10px 15px; border-bottom: 1px solid #eee; font-weight: bold; color: var(--cor2);">
                        ${userLabel}
                    </div>
                    <a href="${perfilHref}" class="dropdown-item"><i class='bx bx-user-circle'></i> Ver Perfil</a>
                    ${itemCarteira}
                    <a href="#" onclick="alternarConta()" class="dropdown-item"><i class='bx bx-user-pin'></i> Alternar Conta</a>
                    <a href="${linkAnunciar}" class="dropdown-item"><i class='bx bx-plus-circle'></i> ${textoAnunciar}</a>
                    <a href="#" onclick="fazerLogout()" class="dropdown-item item-sair"><i class='bx bx-log-out'></i> Sair</a>
                </div>
            </div>`;

        if (mobile) {
            mobile.href = perfilHref;
            if (mobileImg) {
                mobileImg.src = foto;
                mobileImg.alt = "Perfil";
            }
        }
    }

    async function syncPerfilLocal(user) {
        if (!user) {
            renderHeaderUser(null);
            return;
        }

        let perfil = null;
        try { perfil = JSON.parse(localStorage.getItem('doke_usuario_perfil') || 'null'); } catch (_) {}

        if (!perfil || (!perfil.uid && !perfil.user)) {
            try {
                const snap = await getDoc(doc(db, "usuarios", user.uid));
                if (snap.exists()) {
                    const d = snap.data() || {};
                    perfil = {
                        ...d,
                        uid: user.uid,
                        nome: d.nome || d.user || "Usuario",
                        user: d.user || d.nome || "usuario",
                        foto: d.foto || "",
                        isProfissional: d.isProfissional === true
                    };
                }
            } catch (e) {
                console.error("Erro ao carregar perfil:", e);
            }
        }

        if (!perfil) {
            const nomeFallback = user.displayName || (user.email ? user.email.split('@')[0] : "Usuario");
            perfil = { nome: nomeFallback, user: nomeFallback, foto: user.photoURL || "", uid: user.uid };
        }

        localStorage.setItem('doke_usuario_perfil', JSON.stringify(perfil));
        localStorage.setItem('usuarioLogado', 'true');
        renderHeaderUser(perfil);
    }

      function getDraftKey() {
          if (!chatIdAtual || !colecaoAtual) return null;
          return `doke_chat_draft_${colecaoAtual}_${chatIdAtual}`;
      }
      function getHiddenMsgsKey(colecao, id){
          return `doke_chat_hidden_${colecao || ''}_${id || ''}`;
      }
      function getHiddenMsgs(colecao, id){
          try {
              const raw = localStorage.getItem(getHiddenMsgsKey(colecao, id));
              const arr = raw ? JSON.parse(raw) : [];
              return Array.isArray(arr) ? arr : [];
          } catch (e) { return []; }
      }
      function addHiddenMsgId(colecao, id, msgId){
          if (!colecao || !id || !msgId) return;
          const list = getHiddenMsgs(colecao, id);
          if (!list.includes(msgId)) list.push(msgId);
          try { localStorage.setItem(getHiddenMsgsKey(colecao, id), JSON.stringify(list)); } catch (e) {}
      }
      function isHiddenMsgId(colecao, id, msgId){
          if (!colecao || !id || !msgId) return false;
          return getHiddenMsgs(colecao, id).includes(msgId);
      }

    function salvarRascunhoChat() {
        const input = document.getElementById('inputMsg');
        const key = getDraftKey();
        if (!input || !key) return;
        if (!input.value) {
            localStorage.removeItem(key);
            return;
        }
        localStorage.setItem(key, input.value);
    }

    function restaurarRascunhoChat() {
        const input = document.getElementById('inputMsg');
        const key = getDraftKey();
        if (!input || !key) return;
        const draft = localStorage.getItem(key);
        if (draft) input.value = draft;
    }

    window.toggleCep = (e) => { if(e) e.preventDefault(); const p = document.getElementById('boxCep'); if(p) p.style.display = (p.style.display === 'block') ? 'none' : 'block'; };
    window.salvarCep = () => { const i = document.getElementById('inputCep'); if(i) { localStorage.setItem('meu_cep_doke', i.value); document.getElementById('textoCepSpan').innerText = i.value; document.getElementById('boxCep').style.display = 'none'; } };
    window.abrirMenuMobile = () => {
        const menu = document.querySelector('.sidebar-icones');
        if (menu) menu.classList.add('menu-aberto');
        document.body.classList.add('menu-ativo');
        const overlay = document.getElementById('overlay-menu');
        if (overlay) overlay.style.display = 'block';
    };
    window.fecharMenuMobile = () => {
        const menu = document.querySelector('.sidebar-icones');
        if (menu) menu.classList.remove('menu-aberto');
        document.body.classList.remove('menu-ativo');
        const overlay = document.getElementById('overlay-menu');
        if (overlay) overlay.style.display = 'none';
    };
    window.toggleDropdown = (event) => {
        if(event) event.stopPropagation();
        const target = event?.currentTarget || event?.target;
        const container = target ? target.closest('.profile-container') : null;
        const drop = (container && container.querySelector('.dropdown-profile')) || document.getElementById('dropdownPerfil');
        if (!drop) return;
        document.querySelectorAll('.dropdown-profile.show').forEach((el) => {
            if (el !== drop) el.classList.remove('show');
        });
        drop.classList.toggle('show');
    };
    if (!window.__dokeChatDropdownBound) {
        window.__dokeChatDropdownBound = true;
        document.addEventListener('click', () => {
            document.querySelectorAll('.dropdown-profile.show').forEach((el) => el.classList.remove('show'));
        });
    }

    const badgeStyle = `
        position: absolute; top: 5px; right: 5px;
        background: #ff2e63; color: white;
        font-size: 10px; font-weight: bold;
        min-width: 18px; height: 18px;
        border-radius: 50%; display: none;
        align-items: center; justify-content: center;
        border: 2px solid white; z-index: 100;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    `;
    function ensureSidebarBadge(selector, className, count) {
        document.querySelectorAll(selector).forEach((link) => {
            const parent = link.parentNode?.classList?.contains('item') ? link.parentNode : link;
            if (!parent) return;
            let badge = parent.querySelector(`.${className}`);
            if (!badge) {
                badge = document.createElement('span');
                badge.className = className;
                badge.style.cssText = badgeStyle;
                parent.style.position = 'relative';
                parent.appendChild(badge);
            }
            if (count > 0) {
                badge.textContent = String(count);
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        });
    }
    let sidebarBadgeUnsubs = [];
    function startSidebarBadges() {
        if (!currentUserUid || sidebarBadgeUnsubs.length) return;
        const qNotif = query(collection(db, "notificacoes"), where("parauid", "==", currentUserUid), where("lida", "==", false));
        const unsubNotif = onSnapshot(qNotif, (snap) => {
            ensureSidebarBadge('a[href="notificacoes.html"]', 'badge-sidebar', snap.docs.length);
        });
        const qPedCliente = query(collection(db, "pedidos"), where("deUid", "==", currentUserUid));
        const qPedProf = query(collection(db, "pedidos"), where("paraUid", "==", currentUserUid));
        const qConv = query(collection(db, "conversas"), where("participantes", "array-contains", currentUserUid));
        let unreadPedidosCliente = 0;
        let unreadPedidosProf = 0;
        let unreadConvs = 0;
        const updateChatBadge = () => ensureSidebarBadge('a[href="chat.html"]', 'badge-chat-sidebar', unreadPedidosCliente + unreadPedidosProf + unreadConvs);
        const unsubPed1 = onSnapshot(qPedCliente, (snap) => {
            unreadPedidosCliente = 0;
            snap.docs.forEach((docSnap) => {
                const p = docSnap.data() || {};
                if (isOcultoPorUser(p, 'ocultoPedidosPor', docSnap.id)) return;
                const updated = p.dataAtualizacao || p.dataPedido || p.createdat || null;
                if (isNaoLido(updated, 'pedidos', docSnap.id)) unreadPedidosCliente += 1;
            });
            updateChatBadge();
        });
        const unsubPed2 = onSnapshot(qPedProf, (snap) => {
            unreadPedidosProf = 0;
            snap.docs.forEach((docSnap) => {
                const p = docSnap.data() || {};
                if (isOcultoPorUser(p, 'ocultoPedidosPor', docSnap.id)) return;
                const updated = p.dataAtualizacao || p.dataPedido || p.createdat || null;
                if (isNaoLido(updated, 'pedidos', docSnap.id)) unreadPedidosProf += 1;
            });
            updateChatBadge();
        });
        const unsubConv = onSnapshot(qConv, (snap) => {
            unreadConvs = 0;
            snap.docs.forEach((docSnap) => {
                const c = docSnap.data() || {};
                if (isOcultoPorUser(c, 'ocultoChatPor', docSnap.id)) return;
                const updated = c.dataAtualizacao || c.updatedat || c.createdat || null;
                if (isNaoLido(updated, 'conversas', docSnap.id)) unreadConvs += 1;
            });
            updateChatBadge();
        });
        sidebarBadgeUnsubs = [unsubNotif, unsubPed1, unsubPed2, unsubConv];
    }

    // Logout Atualizado com DokeConfirm
    window.fazerLogout = async () => {
        if(await window.dokeConfirm("Tem certeza que deseja sair da sua conta?", "Sair")) {
            try {
                const user = auth.currentUser;
                if (user) {
                    const userRef = doc(db, "usuarios", user.uid);
                    await updateDoc(userRef, { status: "Offline", ultimaVezOnline: new Date().toISOString() });
                }
                await signOut(auth);
                localStorage.clear();
                window.location.href = 'index.html';
            } catch (error) {
                signOut(auth).then(() => { localStorage.clear(); window.location.href = 'index.html'; });
            }
        }
    };

    window.alternarConta = () => {
        localStorage.removeItem('usuarioLogado');
        localStorage.removeItem('doke_usuario_perfil');
        localStorage.removeItem('doke_uid');
        window.location.href = 'login.html';
    };

    window.trocarAba = function(aba) {
        if (aba !== 'pedidos' && pedidosSelecaoModo) {
            pedidosSelecaoModo = false;
            pedidosSelecionados.clear();
        }
        if (aba !== 'conversas' && conversasSelecaoModo) {
            conversasSelecaoModo = false;
            conversasSelecionadas.clear();
        }
        abaAtual = aba;
        const btns = document.querySelectorAll('.aba-btn');
        const filtros = document.getElementById('pedidosFilters');
        const filtrosConversas = document.getElementById('conversasFilters');
        const viewToggle = document.getElementById('listaViewToggle');
        const agendaPanel = document.getElementById('agendaPanel');
        btns.forEach(b => b.classList.remove('active'));
        if (aba === 'pedidos') {
            btns[0].classList.add('active');
            if (viewToggle) viewToggle.style.display = 'flex';
            if (agendaPanel) agendaPanel.style.display = (listaView === 'agenda') ? 'block' : 'none';
            document.getElementById('lista-pedidos').style.display = (listaView === 'agenda') ? 'none' : 'block';
            document.getElementById('lista-conversas').style.display = 'none';
            if (filtros) filtros.style.display = 'flex';
            if (filtrosConversas) filtrosConversas.style.display = 'none';
            carregarListaPedidos();
            abrirChatDeepLink(); 
        } else {
            btns[1].classList.add('active');
            if (viewToggle) viewToggle.style.display = 'none';
            if (agendaPanel) agendaPanel.style.display = 'none';
            document.getElementById('lista-pedidos').style.display = 'none';
            document.getElementById('lista-conversas').style.display = 'block';
            if (filtros) filtros.style.display = 'none';
            if (filtrosConversas) filtrosConversas.style.display = 'flex';
            window.carregarListaConversas();
        }
        updatePedidosBulkUI();
    };

    // Detalhes do Pedido
    window.abrirDetalhesPedido = function(idPedido){
        if (!idPedido) return;
        window.verDetalhesOrcamento(idPedido);
    };

    window.verDetalhesOrcamento = async function(idPedido) {
        // Mantido por compatibilidade (abre a pÃ¡gina de orÃ§amento)
        

        const modal = document.getElementById('modalOrcamento');
        const body = document.getElementById('mdBody');
        if(!modal || !body) return;
        modal.style.display = 'flex';
        body.innerHTML = '<div style="text-align:center; padding:20px;"><i class="bx bx-loader-alt bx-spin" style="font-size:2rem; color:var(--cor0);"></i></div>';

        try {
            const docSnap = await getDoc(doc(db, "pedidos", idPedido));
            if (!docSnap.exists()) return;
            const p = docSnap.data();

            atualizarChipPedido(p.status);
            const statusNorm = String(p.status || 'pendente').toLowerCase();
            const fmtData = (v) => {
                const d = parseDataHora(v);
                return d ? d.toLocaleDateString('pt-BR') : '';
            };
            const timelineSteps = [
                { label: 'Solicitação enviada', done: !!p.dataPedido, date: p.dataPedido },
                { label: 'Pedido aceito', done: ['aceito','pago','finalizado'].includes(statusNorm), date: p.dataAceite || p.dataAtualizacao },
                { label: 'Pagamento', done: ['pago','finalizado'].includes(statusNorm), date: p.dataPagamento || p.dataPago },
                { label: 'Finalizado', done: statusNorm === 'finalizado', date: p.dataConclusao || p.dataFinalizado }
            ];
            const timelineHtml = `
                <div class="md-row">
                    <div class="md-label">Status do pedido</div>
                    <div class="md-timeline">
                        ${timelineSteps.map(s => `
                            <div class="md-step ${s.done ? 'done' : ''}">
                                <span class="dot"></span>
                                <span class="label">${s.label}</span>
                                ${s.date ? `<span class="date">${fmtData(s.date)}</span>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            const repetirBtn = (currentUserUid && p.deUid === currentUserUid)
                ? `<button class="btn-detalhes-card" style="margin-top:12px;" onclick="irRepetirPedido('${idPedido}', '${p.paraUid || ''}', '${p.anuncioId || ''}')">Repetir pedido</button>`
                : "";

            const triagemRespostas = (function(){
                const raw = p.formularioRespostas || p.respostasTriagem || p.formulario_respostas || p.respostas_triagem || p.formulariorespostas || p.respostastriagem || null;
                if (!raw) return [];
                let list = raw;
                if (typeof list === 'string') {
                    try { list = JSON.parse(list); } catch (e) { return []; }
                }
                if (!Array.isArray(list)) list = [list];
                const out = [];
                list.forEach((item) => {
                    if (!item) return;
                    if (typeof item === 'string') {
                        out.push({ pergunta: 'Pergunta', resposta: item });
                        return;
                    }
                    const pergunta = item.pergunta || item.question || item.titulo || item.label || item.q;
                    const resposta = item.resposta || item.answer || item.valor || item.a;
                    if (pergunta || resposta) {
                        out.push({ pergunta: pergunta || 'Pergunta', resposta: (resposta != null ? String(resposta) : '-') });
                    }
                });
                return out;
            })();

            const descricaoBase = (function(){
                if (p.descricaoBase) return String(p.descricaoBase || '').trim();
                const msg = String(p.mensagemInicial || '');
                const idx = msg.toLowerCase().indexOf('local do serviço:');
                if (idx === -1) return msg.trim();
                return msg.slice(0, idx).trim();
            })();

            const localizacao = (function(){
                if (p.localizacao && typeof p.localizacao === 'object') return p.localizacao;
                const maybe = {
                    cep: p.cep || p.cepOrcamento || p.cepServico,
                    endereco: p.endereco || p.enderecoCompleto || p.localEndereco,
                    numero: p.numero || p.numeroResidencia || p.numeroServico,
                    complemento: p.complemento || p.complementoResidencia,
                    referencia: p.referencia || p.referenciaResidencia,
                    info: p.info || p.infoLocal
                };
                const hasAny = Object.values(maybe).some(v => v);
                return hasAny ? maybe : null;
            })();

            const localTextoFallback = (function(){
                const msg = String(p.mensagemInicial || '');
                const idx = msg.toLowerCase().indexOf('local do serviço:');
                if (idx === -1) return '';
                return msg.slice(idx + 'local do serviço:'.length).trim();
            })();

            const formatLocalHtml = (function(){
                if (localizacao) {
                    let linha = "";
                    if (localizacao.endereco && localizacao.numero) linha = `${localizacao.endereco}, Nº ${localizacao.numero}`;
                    else if (localizacao.endereco) linha = localizacao.endereco;
                    else if (localizacao.numero) linha = `Nº ${localizacao.numero}`;
                    if (localizacao.complemento) linha += `${linha ? ', ' : ''}${localizacao.complemento}`;
                    if (localizacao.cep) linha += `${linha ? ' ' : ''}(CEP ${localizacao.cep})`;
                    const extras = [];
                    if (localizacao.referencia) extras.push(`Ponto de referência: ${localizacao.referencia}`);
                    if (localizacao.info) extras.push(`Mais informações: ${localizacao.info}`);
                    const extraHtml = extras.length ? `<div style="margin-top:6px; color:#666; font-size:0.85rem;">${extras.map(e => escapeHtml(e)).join('<br>')}</div>` : "";
                    if (linha || extraHtml) {
                        return `${escapeHtml(linha)}${extraHtml}`;
                    }
                }
                if (localTextoFallback) {
                    return escapeHtml(localTextoFallback).replace(/\n/g, '<br>');
                }
                return "";
            })();

            const dataEspecifica = p.dataEspecifica || "";
            const dataEspecificaFmt = dataEspecifica ? (() => {
                const d = parseDataHora(dataEspecifica) || new Date(dataEspecifica);
                return isNaN(d.getTime()) ? dataEspecifica : d.toLocaleDateString('pt-BR');
            })() : "";

            const anexosTriagem = triagemRespostas.filter(r => /anex/i.test(String(r.pergunta || "")));
            const anexosHtml = (function(){
                if (!anexosTriagem.length) return "";
                const linhas = [];
                anexosTriagem.forEach((r) => {
                    const texto = String(r.resposta || "");
                    texto.split(/\n+/).forEach((linha) => {
                        const clean = linha.trim();
                        if (clean) linhas.push(clean);
                    });
                });
                if (!linhas.length) return "";
                const itens = linhas.map((linha) => {
                    const parts = linha.split(' - ');
                    const nome = parts[0] ? parts[0].trim() : linha;
                    const url = parts[1] ? parts[1].trim() : "";
                    if (url && /^https?:/i.test(url)) {
                        return `<a href="${escapeHtml(url)}" target="_blank" rel="noopener">${escapeHtml(nome)}</a>`;
                    }
                    return `<span>${escapeHtml(linha)}</span>`;
                });
                return `<div class="md-row"><div class="md-label">Anexos</div><div class="md-value" style="display:flex; flex-direction:column; gap:6px;">${itens.join('')}</div></div>`;
            })();

            let triagemHtml = "";
            if (triagemRespostas.length) {
                triagemHtml = `
                <div class="md-row">
                    <div class="md-label">Triagem</div>
                    <div class="md-triagem">
                        ${triagemRespostas.map((r) => `<div class="md-qa"><b>${r.pergunta}</b><span>${r.resposta}</span></div>`).join('')}
                    </div>
                </div>`;
            }

            let motivoRecusaHtml = (p.status === 'recusado' && p.motivoRecusa) ? `
                <div class="md-row" style="background:#fff1f0; padding:15px; border-radius:10px; border:1px solid #ffa39e; margin-top:10px;">
                    <div class="md-label" style="color:#cf1322;">Motivo da Recusa</div>
                    <div class="md-value" style="color:#cf1322; font-weight:700;">"${p.motivoRecusa}"</div>
                </div>` : "";

            const localHtml = formatLocalHtml
                ? `<div class="md-row"><div class="md-label">Local do serviço</div><div class="md-value">${formatLocalHtml}</div></div>`
                : "";
            const dataEspecificaHtml = dataEspecificaFmt
                ? `<div class="md-row"><div class="md-label">Data específica</div><div class="md-value">${escapeHtml(dataEspecificaFmt)}</div></div>`
                : "";

            body.innerHTML = `
                <div class="md-row"><div class="md-label">Serviço</div><div class="md-value">${escapeHtml(p.servicoReferencia || "-")}</div></div>
                <div class="md-row"><div class="md-label">Descrição</div><div class="md-value">${escapeHtml(descricaoBase || p.mensagemInicial || "Sem descrição")}</div></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;" class="md-row">
                    <div><div class="md-label">Prazo</div><div class="md-value">${escapeHtml(p.paraQuando || "A combinar")}</div></div>
                    <div><div class="md-label">Turno</div><div class="md-value">${escapeHtml(p.turno || "Livre")}</div></div>
                </div>
                <div class="md-row"><div class="md-label">Modo de atendimento</div><div class="md-value">${escapeHtml(p.modoAtend || p.modo_atend || "â€”")}</div></div>
                ${dataEspecificaHtml}
                ${localHtml}
                ${anexosHtml}
                ${timelineHtml}
                ${triagemHtml} ${motivoRecusaHtml}
                ${repetirBtn}
            `;
        } catch (e) { body.innerHTML = "Erro ao carregar dados."; }
    };

    window.fecharModalDetalhes = () => document.getElementById('modalOrcamento').style.display = 'none';

    function inferMediaTipoByUrl(url) {
        const u = String(url || '').toLowerCase();
        if (!u) return 'imagem';
        if (u.includes('.mp4') || u.includes('.webm') || u.includes('.mov') || u.includes('.m4v') || u.includes('.ogg')) return 'video';
        return 'imagem';
    }

    async function obterMidiaFinalizacaoDoPedido(pedidoId, pedidoData) {
        const fromAfter = (pedidoData && (pedidoData.finalizacaoDepoisUrl || pedidoData.finalizacaoDepoisURL)) || "";
        const fromMain = (pedidoData && (pedidoData.finalizacaoMediaUrl || pedidoData.finalizacaoMediaURL)) || "";
        const fromBefore = (pedidoData && (pedidoData.finalizacaoAntesUrl || pedidoData.finalizacaoAntesURL)) || "";
        const fromPedido = fromAfter || fromMain || fromBefore;
        if (fromPedido) {
            return {
                url: fromPedido,
                tipo: (
                    (fromAfter ? pedidoData.finalizacaoDepoisTipo : '') ||
                    pedidoData.finalizacaoMediaTipo ||
                    (fromBefore ? pedidoData.finalizacaoAntesTipo : '') ||
                    inferMediaTipoByUrl(fromPedido) ||
                    'imagem'
                ),
                nome: (
                    (fromAfter ? pedidoData.finalizacaoDepoisNome : '') ||
                    pedidoData.finalizacaoMediaNome ||
                    (fromBefore ? pedidoData.finalizacaoAntesNome : '') ||
                    ""
                ),
                beforeUrl: fromBefore || "",
                afterUrl: fromAfter || ""
            };
        }
        try {
            const qMsgs = query(collection(db, "pedidos", pedidoId, "mensagens"), orderBy("timestamp", "desc"), limit(40));
            const snap = await getDocs(qMsgs);
            const found = snap.docs.find((d) => {
                const m = d.data() || {};
                return m.tipo === 'card_finalizado' && !!(m.afterUrl || m.url || m.beforeUrl);
            });
            if (!found) return null;
            const m = found.data() || {};
            const foundUrl = m.afterUrl || m.url || m.beforeUrl || "";
            return {
                url: foundUrl,
                tipo: m.afterType || m.mediaType || m.beforeType || inferMediaTipoByUrl(foundUrl),
                nome: m.afterName || m.mediaName || m.beforeName || "",
                beforeUrl: m.beforeUrl || "",
                afterUrl: m.afterUrl || ""
            };
        } catch (e) {
            console.warn("Falha ao buscar midia de finalizacao no chat:", e);
            return null;
        }
    }

    async function resolverProfissionalIdPortfolio(pedidoData) {
        const sb = window.sb || window.supabase;
        if (!sb || typeof sb.from !== "function") return "";
        let profissionalId = (pedidoData && (pedidoData.profissional_id || pedidoData.profissionalId || pedidoData.profissionalid || pedidoData.paraId)) || "";
        if (profissionalId) return profissionalId;
        const profUid = getParaUid(pedidoData || {});
        if (!profUid) return "";
        try {
            const r1 = await sb.from("usuarios").select("id").eq("uid", profUid).maybeSingle();
            if (!r1.error && r1.data && r1.data.id) return r1.data.id;
        } catch (_) {}
        try {
            const r2 = await sb.from("usuarios").select("id").eq("id", profUid).maybeSingle();
            if (!r2.error && r2.data && r2.data.id) return r2.data.id;
        } catch (_) {}
        return "";
    }

    // Acoes de Pedido (agora com payload opcional para casos especiais)
    window.criarNotificacaoPedido = async function(paraUid, acao, pedidoId, extra = {}) {
        try {
            if(!paraUid || !pedidoId) return;
            const perfil = (function(){
                const p = JSON.parse(localStorage.getItem('doke_usuario_perfil')||'{}');
                const nome = p.nome || 'Usuário';
                const raw = p.user || '';
                const user = raw ? (raw.startsWith('@')? raw : '@'+raw) : '@usuario';
                return { nome, user, foto: p.foto || 'https://placehold.co/50' };
            })();
            const payload = {
                parauid: paraUid,
                deuid: currentUserUid,
                denome: perfil.nome,
                deuser: perfil.user,
                defoto: perfil.foto,
                acao: acao,
                postid: pedidoId,
                posttipo: 'pedido',
                postfonte: 'supabase',
                lida: false,
                createdat: new Date().toISOString(),
                link: `chat.html?chatId=${pedidoId}`
            };
            if (extra && typeof extra === "object") {
                const allow = [
                    "midia_url", "midia_tipo", "pedido_status_portfolio",
                    "pedidoid", "solicitacao_id", "resultado"
                ];
                allow.forEach((k) => {
                    if (extra[k] != null) payload[k] = extra[k];
                });
            }
            await addDoc(collection(db, 'notificacoes'), payload);
        } catch(e) { /* ignora */ }
    };

    window.solicitarAdicionarNoPortfolio = async function(pedidoId) {
        const id = pedidoId || chatIdAtual;
        if (!id) return;
        try {
            const pedidoRef = doc(db, "pedidos", id);
            const pedidoSnap = await getDoc(pedidoRef);
            if (!pedidoSnap.exists()) {
                window.dokeAlert("Pedido nao encontrado.");
                return;
            }
            const p = pedidoSnap.data() || {};
            const paraUid = getParaUid(p);
            const deUid = getDeUid(p);
            if (!paraUid || String(paraUid) !== String(currentUserUid || '')) {
                window.dokeAlert("Somente o profissional pode solicitar.");
                return;
            }

            if (p.portfolioAddedAt || p.portfolioItemId) {
                window.dokeAlert("Este item ja foi publicado no portfolio.");
                return;
            }

            let media = await obterMidiaFinalizacaoDoPedido(id, p);
            if (!media || !media.url) {
                window.dokeAlert("Nao ha imagem/video de finalizacao para este pedido.");
                return;
            }

            const consent = String(p.portfolioConsentStatus || '').toLowerCase();
            if (consent === 'pendente') {
                window.dokeAlert("Solicitacao ja enviada. Aguarde a resposta do cliente.");
                return;
            }
            if (consent === 'aprovado') {
                await window.publicarMidiaNoPortfolio(id);
                return;
            }

            const qRecentes = query(
                collection(db, "pedidos", id, "mensagens"),
                orderBy("timestamp", "desc"),
                limit(25)
            );
            const recentesSnap = await getDocs(qRecentes);
            const solicitacaoPendente = recentesSnap.docs.find((d) => {
                const item = d.data() || {};
                return item.tipo === 'solicitacao_portfolio' && String(item.status || '').toLowerCase() === 'pendente';
            });
            if (solicitacaoPendente) {
                window.dokeAlert("Solicitacao ja enviada. Aguarde a resposta do cliente.");
                return;
            }

            const senderUid = currentUserUid || auth.currentUser?.uid || 'sistema';
            const nowIso = new Date().toISOString();
            const msgRef = await addDoc(collection(db, "pedidos", id, "mensagens"), {
                tipo: 'solicitacao_portfolio',
                texto: 'Profissional solicitou autorizacao para usar a midia no portfolio.',
                status: 'pendente',
                mediaUrl: media.url,
                mediaType: media.tipo || 'imagem',
                mediaName: media.nome || '',
                senderUid,
                targetUid: deUid || '',
                timestamp: new Date(),
                lidoEm: senderUid ? { [senderUid]: nowIso } : {}
            });

            await updateDoc(pedidoRef, {
                finalizacaoMediaUrl: media.url,
                finalizacaoMediaTipo: media.tipo || 'imagem',
                finalizacaoMediaNome: media.nome || '',
                portfolioConsentStatus: 'pendente',
                portfolioConsentRequestedAt: nowIso,
                portfolioConsentRequestedBy: senderUid,
                portfolioConsentMsgId: msgRef.id,
                dataAtualizacao: nowIso,
                ultimaMensagem: "Solicitacao de portfolio enviada"
            });

            if (deUid) {
                await window.criarNotificacaoPedido(deUid, 'portfolio_consent_request', id, {
                    midia_url: media.url,
                    midia_tipo: media.tipo || 'imagem',
                    pedido_status_portfolio: 'pendente',
                    solicitacao_id: msgRef.id
                });
            }

            window.dokeAlert("Solicitacao enviada para o cliente.");
            if (abaAtual === 'pedidos') carregarListaPedidos({ silent: true });
        } catch (e) {
            console.error("Erro ao solicitar portfolio:", e);
            window.dokeAlert("Nao foi possivel enviar a solicitacao.");
        }
    };

    window.responderSolicitacaoPortfolio = async function(pedidoId, mensagemId, decisao) {
        const id = pedidoId || chatIdAtual;
        const msgId = mensagemId || "";
        if (!id || !msgId) return;
        const statusFinal = (String(decisao || '').toLowerCase() === 'aprovar') ? 'aprovado' : 'recusado';
        const confirmTxt = statusFinal === 'aprovado'
            ? "Permitir que esta midia apareca no portfolio do profissional?"
            : "Recusar uso desta midia no portfolio?";
        if (!await window.dokeConfirm(confirmTxt, "Portfolio")) return;

        try {
            const pedidoRef = doc(db, "pedidos", id);
            const msgRef = doc(db, "pedidos", id, "mensagens", msgId);
            const [pedidoSnap, msgSnap] = await Promise.all([getDoc(pedidoRef), getDoc(msgRef)]);
            if (!pedidoSnap.exists() || !msgSnap.exists()) {
                window.dokeAlert("Solicitacao nao encontrada.");
                return;
            }
            const p = pedidoSnap.data() || {};
            const deUid = getDeUid(p);
            const paraUid = getParaUid(p);
            if (!deUid || String(deUid) !== String(currentUserUid || '')) {
                window.dokeAlert("Somente o cliente pode responder.");
                return;
            }
            const m = msgSnap.data() || {};
            const atual = String(m.status || p.portfolioConsentStatus || '').toLowerCase();
            if (atual && atual !== 'pendente') {
                window.dokeAlert("Essa solicitacao ja foi respondida.");
                return;
            }

            const nowIso = new Date().toISOString();
            await updateDoc(msgRef, {
                status: statusFinal,
                decidedAt: nowIso,
                decidedBy: currentUserUid || ''
            });

            await updateDoc(pedidoRef, {
                portfolioConsentStatus: statusFinal,
                portfolioConsentDecisionAt: nowIso,
                portfolioConsentDecisionBy: currentUserUid || '',
                dataAtualizacao: nowIso,
                ultimaMensagem: statusFinal === 'aprovado'
                    ? "Cliente autorizou uso no portfolio"
                    : "Cliente recusou uso no portfolio"
            });

            const senderUid = currentUserUid || auth.currentUser?.uid || 'sistema';
            await addDoc(collection(db, "pedidos", id, "mensagens"), {
                tipo: 'portfolio_consent_result',
                texto: statusFinal === 'aprovado'
                    ? "Cliente autorizou o uso da midia no portfolio."
                    : "Cliente recusou o uso da midia no portfolio.",
                status: statusFinal,
                mediaUrl: m.mediaUrl || '',
                mediaType: m.mediaType || inferMediaTipoByUrl(m.mediaUrl || ''),
                senderUid,
                timestamp: new Date(),
                lidoEm: senderUid ? { [senderUid]: nowIso } : {}
            });

            if (paraUid) {
                await window.criarNotificacaoPedido(
                    paraUid,
                    statusFinal === 'aprovado' ? 'portfolio_consent_approved' : 'portfolio_consent_rejected',
                    id,
                    { pedido_status_portfolio: statusFinal }
                );
            }

            window.dokeAlert(statusFinal === 'aprovado' ? "Autorizacao enviada ao profissional." : "Recusa enviada ao profissional.");
            if (abaAtual === 'pedidos') carregarListaPedidos({ silent: true });
        } catch (e) {
            console.error("Erro ao responder solicitacao de portfolio:", e);
            window.dokeAlert("Nao foi possivel responder agora.");
        }
    };

    window.publicarMidiaNoPortfolio = async function(pedidoId) {
        const id = pedidoId || chatIdAtual;
        if (!id) return;
        try {
            const sb = window.sb || window.supabase;
            if (!sb || typeof sb.from !== "function") {
                window.dokeAlert("Integracao com portfolio indisponivel.");
                return;
            }
            const pedidoRef = doc(db, "pedidos", id);
            const pedidoSnap = await getDoc(pedidoRef);
            if (!pedidoSnap.exists()) {
                window.dokeAlert("Pedido nao encontrado.");
                return;
            }
            const p = pedidoSnap.data() || {};
            const paraUid = getParaUid(p);
            const deUid = getDeUid(p);
            if (!paraUid || String(paraUid) !== String(currentUserUid || '')) {
                window.dokeAlert("Somente o profissional pode publicar no portfolio.");
                return;
            }
            if (String(p.portfolioConsentStatus || '').toLowerCase() !== 'aprovado') {
                window.dokeAlert("Aguardando autorizacao do cliente.");
                return;
            }
            if (p.portfolioAddedAt || p.portfolioItemId) {
                window.dokeAlert("Este item ja esta no portfolio.");
                return;
            }

            let media = await obterMidiaFinalizacaoDoPedido(id, p);
            if (!media || !media.url) {
                window.dokeAlert("Nao foi encontrada midia para publicar.");
                return;
            }

            const profissionalId = await resolverProfissionalIdPortfolio(p);
            if (!profissionalId) {
                window.dokeAlert("Nao foi possivel identificar o perfil do profissional.");
                return;
            }

            const whenIso = p.dataConclusao || new Date().toISOString();
            const payload = {
                profissional_id: profissionalId,
                titulo: p.servicoReferencia || "Servico concluido",
                descricao: `Entrega concluida em ${new Date(whenIso).toLocaleDateString("pt-BR")}`,
                media_url: media.url
            };
            const ins = await sb.from("portfolio").insert(payload).select("id").maybeSingle();
            if (ins.error) throw ins.error;

            const nowIso = new Date().toISOString();
            await updateDoc(pedidoRef, {
                finalizacaoMediaUrl: media.url,
                finalizacaoMediaTipo: media.tipo || 'imagem',
                finalizacaoMediaNome: media.nome || '',
                portfolioAddedAt: nowIso,
                portfolioAddedBy: currentUserUid || '',
                portfolioItemId: ins.data?.id || '',
                dataAtualizacao: nowIso,
                ultimaMensagem: "Midia publicada no portfolio"
            });

            const senderUid = currentUserUid || auth.currentUser?.uid || 'sistema';
            await addDoc(collection(db, "pedidos", id, "mensagens"), {
                tipo: 'portfolio_publicado',
                texto: 'Midia publicada no portfolio do profissional.',
                mediaUrl: media.url,
                mediaType: media.tipo || 'imagem',
                senderUid,
                timestamp: new Date(),
                lidoEm: senderUid ? { [senderUid]: nowIso } : {}
            });

            if (deUid) {
                await window.criarNotificacaoPedido(deUid, 'portfolio_published', id, {
                    midia_url: media.url,
                    midia_tipo: media.tipo || 'imagem',
                    pedido_status_portfolio: 'publicado'
                });
            }

            window.dokeAlert("Midia adicionada ao portfolio com sucesso.");
            if (abaAtual === 'pedidos') carregarListaPedidos({ silent: true });
        } catch (e) {
            console.error("Erro ao publicar no portfolio:", e);
            window.dokeAlert("Nao foi possivel publicar no portfolio.");
        }
    };

    // AÃ§Ãµes de Pedido (Profissional: recusa com motivo)
    window.prepararRecusa = async (id) => {
        const motivo = await window.dokePrompt('Por favor, informe o motivo da recusa:', 'Ex: Indisponibilidade de agenda...', 'Recusar Pedido');
        if(!motivo) return;
        try {
            const snap = await getDoc(doc(db, 'pedidos', id));
            const p = snap.exists() ? snap.data() : {};
            const resp = buildRespostaPayload(p);
            await updateDoc(doc(db, 'pedidos', id), {
                status: 'recusado',
                motivoRecusa: motivo,
                dataAtualizacao: new Date().toISOString(),
                ...resp
            });
            await window.criarNotificacaoPedido(p.deUid, 'pedido_recusado', id);
            window.dokeAlert('Pedido recusado.');
            carregarListaPedidos();
        } catch (e) { console.error(e); window.dokeAlert('Erro ao recusar.'); }
    };

    window.aceitarPedidoProfissional = async (id) => {
        if(!await window.dokeConfirm('Deseja aceitar este pedido e iniciar o atendimento?', 'Aceitar')) return;
        try {
            const snap = await getDoc(doc(db, 'pedidos', id));
            const p = snap.exists() ? snap.data() : {};
            const resp = buildRespostaPayload(p);
            await updateDoc(doc(db, 'pedidos', id), {
                status: 'aceito',
                dataAceite: new Date().toISOString(),
                dataAtualizacao: new Date().toISOString(),
                ...resp
            });
            await window.criarNotificacaoPedido(p.deUid, 'pedido_aceito', id);
            window.dokeAlert('Pedido aceito.');
            carregarListaPedidos();
            // Abre chat automaticamente
            const uidOutro = p.deUid;
            if(uidOutro) {
                const uDoc = await getDoc(doc(db, 'usuarios', uidOutro));
                const dU = uDoc.exists() ? uDoc.data() : {};
                abrirChat(id, uidOutro, dU.user || 'Cliente', dU.foto || '', 'pedidos', 'aceito');
            }
        } catch (e) { console.error(e); window.dokeAlert('Erro ao aceitar.'); }
    };

    window.prepararCancelamento = async (id) => {
        if(!await window.dokeConfirm('Tem certeza que deseja cancelar esta solicitação?', 'Cancelar', 'danger')) return;
        try {
            const snap = await getDoc(doc(db, 'pedidos', id));
            const p = snap.exists() ? snap.data() : {};
            await updateDoc(doc(db, 'pedidos', id), {
                status: 'cancelado'
            });
            await window.criarNotificacaoPedido(p.paraUid, 'pedido_cancelado', id);
            window.dokeAlert('Solicitação cancelada.');
            carregarListaPedidos();
        } catch (e) { console.error(e); window.dokeAlert('Erro ao cancelar.'); }
    };

    

    // AÃ§Ãµes rÃ¡pidas no topo do chat (apenas quando o pedido estiver pendente e eu for o profissional)
    window.acaoPedido = async function(acao){
        if(!chatIdAtual) return;
        try {
            const snap = await getDoc(doc(db, 'pedidos', chatIdAtual));
            const p = snap.exists() ? snap.data() : {};
            const souProfissional = (p.paraUid === currentUserUid);
            if(!souProfissional) return;
            if(acao === 'aceito') return await window.aceitarPedidoProfissional(chatIdAtual);
            if(acao === 'recusado') return await window.prepararRecusa(chatIdAtual);
        } catch(e){ console.error(e); }
    };
window.apagarDocumentoPedido = async function(id) {
        if (!await window.dokeConfirm("Remover este pedido da sua lista? Ele continuará nas Mensagens.", "Remover", "danger")) {
            return;
        }
        try {
            const ref = doc(db, "pedidos", id);
            await atualizarArrayUsuario(ref, 'ocultoPedidosPor', true);
            carregarListaPedidos();
        } catch (e) {
            console.error(e);
            window.dokeAlert("Erro ao remover.");
        }
};

// EM CHAT.HTML
window.liberarPagamento = async (id) => {
    if (!id) return;
    pedidoFinalizarId = id;
    const modal = document.getElementById('modalFinalizarPedido');
    if (modal) modal.style.display = 'flex';
};
window.fecharModalFinalizarPedido = () => {
    const modal = document.getElementById('modalFinalizarPedido');
    if (modal) modal.style.display = 'none';
    window.limparAnexoFinalizacao();
    pedidoFinalizarId = null;
};

window.alterarModoFinalizacao = (modo) => {
    finalizacaoModo = (modo === 'antes_depois') ? 'antes_depois' : 'unico';
    const blocoUnico = document.getElementById('finalizarUploadUnico');
    const blocoDuplo = document.getElementById('finalizarUploadAntesDepois');
    if (blocoUnico) blocoUnico.style.display = finalizacaoModo === 'unico' ? 'flex' : 'none';
    if (blocoDuplo) blocoDuplo.style.display = finalizacaoModo === 'antes_depois' ? 'flex' : 'none';
};

function getFinalizacaoRefs(tipo) {
    if (tipo === 'antes') {
        return {
            input: document.getElementById('finalizarAnexoAntes'),
            nameEl: document.getElementById('finalizarNomeArquivoAntes'),
            preview: document.getElementById('finalizarPreviewAntes'),
            img: document.getElementById('finalizarPreviewImgAntes'),
            video: document.getElementById('finalizarPreviewVideoAntes')
        };
    }
    if (tipo === 'depois') {
        return {
            input: document.getElementById('finalizarAnexoDepois'),
            nameEl: document.getElementById('finalizarNomeArquivoDepois'),
            preview: document.getElementById('finalizarPreviewDepois'),
            img: document.getElementById('finalizarPreviewImgDepois'),
            video: document.getElementById('finalizarPreviewVideoDepois')
        };
    }
    return {
        input: document.getElementById('finalizarAnexoUnico'),
        nameEl: document.getElementById('finalizarNomeArquivoUnico'),
        preview: document.getElementById('finalizarPreviewUnico'),
        img: document.getElementById('finalizarPreviewImgUnico'),
        video: document.getElementById('finalizarPreviewVideoUnico')
    };
}

function limparPreviewMidiaFinalizacao(tipo) {
    const refs = getFinalizacaoRefs(tipo);
    if (refs.input) refs.input.value = "";
    if (refs.nameEl) refs.nameEl.textContent = "";
    if (refs.preview) refs.preview.style.display = 'none';
    if (refs.img) {
        refs.img.src = "";
        refs.img.style.display = 'none';
    }
    if (refs.video) {
        refs.video.pause();
        refs.video.removeAttribute('src');
        refs.video.load();
        refs.video.style.display = 'none';
    }

    if (tipo === 'antes') {
        if (finalizacaoPreviewUrlAntes) {
            try { URL.revokeObjectURL(finalizacaoPreviewUrlAntes); } catch (_) {}
            finalizacaoPreviewUrlAntes = null;
        }
    } else if (tipo === 'depois') {
        if (finalizacaoPreviewUrlDepois) {
            try { URL.revokeObjectURL(finalizacaoPreviewUrlDepois); } catch (_) {}
            finalizacaoPreviewUrlDepois = null;
        }
    } else {
        if (finalizacaoPreviewUrlUnico) {
            try { URL.revokeObjectURL(finalizacaoPreviewUrlUnico); } catch (_) {}
            finalizacaoPreviewUrlUnico = null;
        }
    }
}

window.limparArquivoFinalizacao = (tipo) => {
    if (tipo === 'antes') finalizacaoFileAntes = null;
    else if (tipo === 'depois') finalizacaoFileDepois = null;
    else finalizacaoFileUnico = null;
    limparPreviewMidiaFinalizacao(tipo || 'unico');
};

window.limparAnexoFinalizacao = () => {
    finalizacaoFileUnico = null;
    finalizacaoFileAntes = null;
    finalizacaoFileDepois = null;
    limparPreviewMidiaFinalizacao('unico');
    limparPreviewMidiaFinalizacao('antes');
    limparPreviewMidiaFinalizacao('depois');
    finalizacaoModo = 'unico';
    const radioUnico = document.querySelector('input[name="finalizarModo"][value="unico"]');
    if (radioUnico) radioUnico.checked = true;
    window.alterarModoFinalizacao('unico');
};

function preencherPreviewMidiaFinalizacao(tipo, file) {
    const refs = getFinalizacaoRefs(tipo);
    if (!file) {
        window.limparArquivoFinalizacao(tipo);
        return;
    }
    if (refs.nameEl) refs.nameEl.textContent = file.name || "";
    if (refs.preview) refs.preview.style.display = 'flex';

    let blobUrl = URL.createObjectURL(file);
    if (tipo === 'antes') {
        if (finalizacaoPreviewUrlAntes) {
            try { URL.revokeObjectURL(finalizacaoPreviewUrlAntes); } catch (_) {}
        }
        finalizacaoPreviewUrlAntes = blobUrl;
    } else if (tipo === 'depois') {
        if (finalizacaoPreviewUrlDepois) {
            try { URL.revokeObjectURL(finalizacaoPreviewUrlDepois); } catch (_) {}
        }
        finalizacaoPreviewUrlDepois = blobUrl;
    } else {
        if (finalizacaoPreviewUrlUnico) {
            try { URL.revokeObjectURL(finalizacaoPreviewUrlUnico); } catch (_) {}
        }
        finalizacaoPreviewUrlUnico = blobUrl;
    }

    const isVideo = String(file.type || '').toLowerCase().startsWith('video/');
    if (refs.img) {
        refs.img.style.display = isVideo ? 'none' : 'block';
        refs.img.src = isVideo ? '' : blobUrl;
    }
    if (refs.video) {
        refs.video.style.display = isVideo ? 'block' : 'none';
        if (isVideo) {
            refs.video.src = blobUrl;
            refs.video.load();
        } else {
            refs.video.pause();
            refs.video.removeAttribute('src');
            refs.video.load();
        }
    }
}

async function uploadArquivoFinalizacao(pedidoId, file, sufixo) {
    if (!file) return { url: "", tipo: "", nome: "" };
    const storage = (typeof getStorage === 'function') ? getStorage() : (window.storage || null);
    const mkRef = (typeof ref === 'function') ? ref : window.ref;
    const uploadFn = (typeof uploadBytes === 'function') ? uploadBytes : window.uploadBytes;
    const getUrlFn = (typeof getDownloadURL === 'function') ? getDownloadURL : window.getDownloadURL;
    if (!storage || !mkRef || !uploadFn || !getUrlFn) {
        throw new Error("Storage indisponível para upload.");
    }
    const safeName = String(file.name || 'resultado').replace(/[^a-zA-Z0-9._-]/g, '_');
    const path = `chat/pedidos/${pedidoId}/finalizado_${sufixo}_${Date.now()}_${safeName}`;
    const r = mkRef(storage, path);
    await uploadFn(r, file);
    const url = await getUrlFn(r);
    const tipo = String(file.type || '').toLowerCase().startsWith('video/') ? 'video' : 'imagem';
    return { url, tipo, nome: file.name || '' };
}

window.confirmarFinalizacaoPedido = async () => {
    const id = pedidoFinalizarId;
    if (!id) return;
    const btn = document.querySelector('#modalFinalizarPedido .btn-primary-modal');
    if (btn) { btn.disabled = true; btn.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> Finalizando..."; }

    try {
        const modoAtual = finalizacaoModo === 'antes_depois' ? 'antes_depois' : 'unico';
        let mediaUnica = { url: "", tipo: "", nome: "" };
        let mediaAntes = { url: "", tipo: "", nome: "" };
        let mediaDepois = { url: "", tipo: "", nome: "" };

        if (modoAtual === 'antes_depois') {
            if (!finalizacaoFileAntes || !finalizacaoFileDepois) {
                window.dokeAlert("Anexe os dois arquivos: antes e depois.");
                return;
            }
            mediaAntes = await uploadArquivoFinalizacao(id, finalizacaoFileAntes, 'antes');
            mediaDepois = await uploadArquivoFinalizacao(id, finalizacaoFileDepois, 'depois');
            mediaUnica = mediaDepois.url ? { ...mediaDepois } : { ...mediaAntes };
        } else if (finalizacaoFileUnico) {
            mediaUnica = await uploadArquivoFinalizacao(id, finalizacaoFileUnico, 'midia');
        }

        const temMidia = !!(mediaUnica.url || mediaAntes.url || mediaDepois.url);
        const consentInicial = temMidia ? 'nenhum' : '';

        await updateDoc(doc(db, "pedidos", id), { 
            status: 'finalizado',
            dataConclusao: new Date().toISOString(),
            notificacaoLidaProfissional: false,
            notificacaoLidaCliente: false,
            avaliado: false,
            finalizacaoModo: modoAtual,
            finalizacaoMediaUrl: mediaUnica.url || "",
            finalizacaoMediaTipo: mediaUnica.tipo || "",
            finalizacaoMediaNome: mediaUnica.nome || "",
            finalizacaoAntesUrl: mediaAntes.url || "",
            finalizacaoAntesTipo: mediaAntes.tipo || "",
            finalizacaoAntesNome: mediaAntes.nome || "",
            finalizacaoDepoisUrl: mediaDepois.url || "",
            finalizacaoDepoisTipo: mediaDepois.tipo || "",
            finalizacaoDepoisNome: mediaDepois.nome || "",
            portfolioConsentStatus: consentInicial,
            portfolioConsentRequestedAt: "",
            portfolioConsentRequestedBy: "",
            portfolioConsentDecisionAt: "",
            portfolioConsentDecisionBy: "",
            portfolioAddedAt: "",
            portfolioAddedBy: "",
            portfolioItemId: "",
            dataAtualizacao: new Date().toISOString(),
            ultimaMensagem: "Pedido finalizado"
        });
        try {
            const senderUid = currentUserUid || auth.currentUser?.uid || 'sistema';
            await addDoc(collection(db, "pedidos", id, "mensagens"), {
                tipo: 'card_finalizado',
                texto: "Pedido finalizado pelo cliente.",
                url: mediaUnica.url || "",
                mediaType: mediaUnica.tipo || "",
                mediaName: mediaUnica.nome || "",
                beforeUrl: mediaAntes.url || "",
                beforeType: mediaAntes.tipo || "",
                beforeName: mediaAntes.nome || "",
                afterUrl: mediaDepois.url || "",
                afterType: mediaDepois.tipo || "",
                afterName: mediaDepois.nome || "",
                senderUid,
                timestamp: new Date(),
                lidoEm: senderUid ? { [senderUid]: new Date().toISOString() } : {}
            });
        } catch (e) {
            console.warn("Falha ao registrar card de finalizacao no chat.", e);
        }

        window.fecharModalFinalizarPedido();

        window.pedidoIdParaAvaliar = id;
        const modalSucesso = document.getElementById('modalSucessoAvaliacao');
        if (modalSucesso) {
            modalSucesso.style.display = 'flex';
        } else {
            window.location.href = `avaliar.html?pedidoId=${id}`;
        }
    } catch (e) {
        console.error(e);
        const msgErro = e && e.message ? String(e.message) : "Falha ao finalizar o pedido.";
        window.dokeAlert(`Erro ao finalizar: ${msgErro}`);
    } finally {
        if (btn) { btn.disabled = false; btn.innerHTML = "<i class='bx bx-check'></i> Finalizar serviço"; }
    }
};
    // FunÃ§Ãµes do Modal
    window.irParaAvaliacaoDireta = () => {
        try { window.fecharModalSucesso(); } catch (_) {}
        window.location.href = `avaliar.html?pedidoId=${window.pedidoIdParaAvaliar}`;
    };
    window.fecharModalSucesso = () => {
        document.getElementById('modalSucessoAvaliacao').style.display = 'none';
    };
    // =========================================================================
    // 4. RENDERIZAÃ‡ÃƒO E CHAT
    // =========================================================================

    async function carregarListaPedidos(opts = {}) {
        const container = document.getElementById('lista-pedidos');
        if(!container) return;
        const token = ++pedidosRenderToken;
        const silent = !!opts.silent;
        if (!silent) {
            container.innerHTML = `<div style="text-align:center; padding:20px;"><i class="bx bx-loader-alt bx-spin"></i></div>`;
        }

        try {
            if (!currentUserUid) {
                container.innerHTML = `<div style="text-align:center; padding:30px; color:#999;">Faça login para ver seus pedidos.</div>`;
                return;
            }
            const deField = await resolvePedidosField('de');
            const paraField = await resolvePedidosField('para');
            if (!deField && !paraField) {
                container.innerHTML = `<div style="text-align:center; padding:30px; color:#999;">Não foi possível identificar os campos do pedido.</div>`;
                return;
            }
            pedidosFieldsDirty = false;
            const base = collection(db, "pedidos");
            const qDe = deField ? query(base, where(deField, "==", currentUserUid)) : null;
            const qPara = paraField ? query(base, where(paraField, "==", currentUserUid)) : null;
            const [s1, s2] = await Promise.all([
                qDe ? safeGetDocsWithField(qDe, deField) : emptySnap(),
                qPara ? safeGetDocsWithField(qPara, paraField) : emptySnap()
            ]);

            if (token !== pedidosRenderToken) return;
            const sigParts = [listaModo, pedidosFiltro, listaBusca];
            let htmlOut = "";
            const itensRaw = [
                ...s1.docs.map(d=>({d, papel:'cliente'})),
                ...s2.docs.map(d=>({d, papel:'profissional'}))
            ];
            const map = new Map();
            for (const it of itensRaw) {
                const pid = it?.d?.id;
                if (!pid) continue;
                // Preferir "cliente" quando duplicar, pois Ã© a visÃ£o mais comum para o usuário final.
                if (!map.has(pid) || (map.get(pid).papel !== 'cliente' && it.papel === 'cliente')) {
                    map.set(pid, it);
                }
            }
            const itens = Array.from(map.values()).sort((a, b) => {
                const ta = getPedidoSortTs(a?.d?.data?.());
                const tb = getPedidoSortTs(b?.d?.data?.());
                return tb - ta;
            });
            const agendaItems = [];

            if(itens.length === 0) {
                htmlOut = `<div style="text-align:center; padding:40px; color:#999;">Nenhum pedido.</div>`;
                pedidosAgendaCache = [];
                renderAgenda();
                if (container.dataset.sig !== 'empty' || container.querySelector('.bx-spin')) {
                    container.innerHTML = htmlOut;
                    container.dataset.sig = 'empty';
                }
                return;
            }

            const itemsForRender = [];
            const userIdsToLoad = new Set();
            for (const item of itens) {
                if (token !== pedidosRenderToken) return;
                const id = item.d.id;
                const p = item.d.data();
                const deUid = getDeUid(p);
                const paraUid = getParaUid(p);
                const papelReal = (deUid && deUid === currentUserUid) ? 'cliente'
                    : (paraUid && paraUid === currentUserUid) ? 'profissional'
                    : item.papel;
                if (isOcultoPorUser(p, 'ocultoPedidosPor', id)) continue;
                const isArquivado = isArquivadoPorUser(p, id);
                if (listaModo === 'arquivados' && !isArquivado) continue;
                if (listaModo !== 'arquivados' && isArquivado) continue;
                const statusRaw = String(p.status || '').toLowerCase();
                const isFinal = ['finalizado','cancelado','recusado'].includes(statusRaw);
                const isAndamento = ['aceito','pago'].includes(statusRaw);

                if (pedidosFiltro === 'pendente' && statusRaw !== 'pendente') continue;
                if (pedidosFiltro === 'andamento' && !isAndamento) continue;
                if (pedidosFiltro === 'finalizado' && !isFinal) continue;

                if (papelReal === 'profissional' && p.status === 'recusado') continue;

                const outroUid = (papelReal === 'cliente') ? paraUid : deUid;
                if (outroUid) userIdsToLoad.add(outroUid);
                itemsForRender.push({ id, p, papelReal, deUid, paraUid, outroUid, isArquivado });
            }

            const loadPromises = Array.from(userIdsToLoad).map(async (uid) => {
                if (userCache.has(uid)) return;
                await getUserCached(uid);
            });
            if (loadPromises.length) await Promise.all(loadPromises);

            for (const item of itemsForRender) {
                if (token !== pedidosRenderToken) return;
                const { id, p, papelReal, deUid, paraUid, outroUid, isArquivado } = item;
                const dU = (await getUserCached(outroUid)) || {};
                if (!matchBusca(dU?.user, p.servicoReferencia, p.mensagemInicial, p.paraNome, p.paraUser, p.deNome, p.deUser)) continue;
                
                let sT = p.status;
                if(p.status === 'aceito' && papelReal === 'profissional') sT = "Em andamento";
                
                // Badge ClicÃ¡vel (Abre Modal de Garantia)
                let badgeHtml = (p.status === 'pago') ? `
                    <span class="ip-badge" onclick="event.stopPropagation(); abrirModalGarantia()" 
                          title="Clique para saber mais sobre a garantia"
                          style="background:#0b7768; color:white; cursor:pointer; padding:4px 8px; border-radius:4px; font-weight:700; font-size:0.65rem; display:flex; align-items:center; gap:4px; transition:0.2s;">
                        <i class='bx bx-shield-quarter'></i> DINHEIRO RETIDO <i class='bx bx-help-circle'></i>
                    </span>` 
                    : `<span class="ip-badge badge-${p.status}">${sT.toUpperCase()}</span>`;

                let bApagar = (['recusado', 'finalizado', 'cancelado'].includes(p.status)) 
                    ? `<i class='bx bx-trash' style="color:#e74c3c; cursor:pointer; font-size:1.1rem;" onclick="event.stopPropagation(); apagarDocumentoPedido('${id}')"></i>` : "";
                const updatedPedido = p.dataAtualizacao || p.dataPedido || p.createdat || null;
                const unreadHtml = isNaoLido(updatedPedido, 'pedidos', id) ? '<span class="unread-dot"></span>' : "";

                // Info Saldo (Visual Clean Solicitado)
                let infoSaldo = (papelReal === 'profissional' && p.status === 'pago') ? `
                    <div style="background:#ffffff; padding:12px; border-radius:12px; margin-top:12px; border:1px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.03); display:flex; align-items:center; gap:12px;">
                        <div style="width:38px; height:38px; background:#e0f2f1; border-radius:8px; display:flex; align-items:center; justify-content:center; color:#0b7768;">
                            <i class='bx bx-lock-alt' style="font-size:1.3rem;"></i>
                        </div>
                        <div>
                            <span style="display:block; font-size:0.7rem; color:#888; font-weight:700; text-transform:uppercase;">Garantia Ativa</span>
                            <strong style="font-size:1.1rem; color:#333;">${p.valorFinal || '---'}</strong>
                        </div>
                    </div>` : "";

                // BotÃµes de AÃ§Ã£o
                let acoesHtml = "";
                if (papelReal === 'profissional' && p.status === 'pendente') {
                    acoesHtml = `<div style="display:flex; gap:10px; margin-top:10px;">
                        <button onclick="event.stopPropagation(); prepararRecusa('${id}')" style="flex:1; padding:8px; border-radius:8px; border:none; background:#ffebee; color:#e74c3c; font-weight:700; cursor:pointer;">Recusar</button>
                        <button onclick="event.stopPropagation(); aceitarPedidoProfissional('${id}')" style="flex:1; padding:8px; border-radius:8px; border:none; background:#e8f5e9; color:#2e7d32; font-weight:700; cursor:pointer;">Aceitar</button>
                    </div>`;
                } else if (papelReal === 'cliente' && p.status === 'pendente') {
                    acoesHtml = `<button class="btn-cancelar-discreto" onclick="event.stopPropagation(); prepararCancelamento('${id}')">Cancelar Solicitação</button>`;
                } else if (papelReal === 'cliente' && p.status === 'pago') {
                     // BotÃ£o de ConclusÃ£o (Design Compacto)
                     acoesHtml = `
                        <button onclick="event.stopPropagation(); liberarPagamento('${id}')" 
                                style="margin-top:8px; width:fit-content; background:var(--cor0); color:white; border:none; padding:6px 15px; border-radius:20px; font-weight:700; cursor:pointer; font-size:0.8rem; display:flex; align-items:center; gap:5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <i class='bx bx-check'></i> Confirmar Conclusão
                        </button>`;
                } else if (papelReal === 'profissional' && p.status === 'finalizado') {
                    const hasMedia = !!(p.finalizacaoMediaUrl || p.finalizacaoMediaURL);
                    const consent = String(p.portfolioConsentStatus || '').toLowerCase();
                    if (!hasMedia) {
                        acoesHtml = `<div style="margin-top:8px; font-size:0.78rem; color:#64748b; font-weight:700;">Sem midia anexada na finalizacao.</div>`;
                    } else if (p.portfolioAddedAt || p.portfolioItemId) {
                        acoesHtml = `<div style="margin-top:8px; font-size:0.78rem; color:#166534; font-weight:800;"><i class='bx bx-check-circle'></i> Midia ja publicada no portfolio.</div>`;
                    } else if (consent === 'pendente') {
                        acoesHtml = `<div style="margin-top:8px; font-size:0.78rem; color:#475569; font-weight:700;"><i class='bx bx-time-five'></i> Aguardando autorizacao do cliente.</div>`;
                    } else if (consent === 'aprovado') {
                        acoesHtml = `<button onclick="event.stopPropagation(); publicarMidiaNoPortfolio('${id}')" style="margin-top:8px; width:fit-content; background:#0b7768; color:#fff; border:none; padding:7px 15px; border-radius:20px; font-weight:800; cursor:pointer; font-size:0.8rem; display:flex; align-items:center; gap:6px;"><i class='bx bx-collection'></i> Publicar no portfolio</button>`;
                    } else {
                        acoesHtml = `<button onclick="event.stopPropagation(); solicitarAdicionarNoPortfolio('${id}')" style="margin-top:8px; width:fit-content; background:#1f4d75; color:#fff; border:none; padding:7px 15px; border-radius:20px; font-weight:800; cursor:pointer; font-size:0.8rem; display:flex; align-items:center; gap:6px;"><i class='bx bx-send'></i> Adicionar no portfolio</button>`;
                    }
                }


                // Mensagem curta (cliente/profissional)
                let subMsg = "";
                if (p.status === 'pendente') {
                    subMsg = (papelReal === 'cliente')
                        ? '<div class=\"ip-sub\">Aguardando resposta do profissional.</div>'
                        : '<div class=\"ip-sub\">Novo pedido. Analise e aceite para liberar o chat.</div>';
                } else if (p.status === 'recusado' && papelReal === 'cliente') {
                    const motivo = p.motivoRecusa ? ` Motivo: ${escapeHtml(String(p.motivoRecusa).slice(0, 90))}${String(p.motivoRecusa).length > 90 ? '...' : ''}` : '';
                    subMsg = `<div class="ip-sub">Pedido recusado.${motivo}</div>`;
                } else if (p.status === 'aceito' && papelReal === 'cliente') {
                    subMsg = '<div class=\"ip-sub\">Chat liberado. Você já pode negociar com o profissional.</div>';
                }

                // Card "Pedido em andamento" (diferencia OrÃ§amentos vs Mensagens)
                let cardAndamento = "";
                if (['aceito','pago','finalizado'].includes(String(p.status||'').toLowerCase())) {
                    const pedidoStatusNorm = String(p.status || '').toLowerCase();
                    const cardHidden = !!andamentoCardHidden[String(id)];
                    const label = (String(p.status||'').toLowerCase() === 'finalizado') ? 'Serviço finalizado' : 'Pedido em andamento';
                    if (!cardHidden) {
                        const cardCloseBtn = (pedidoStatusNorm === 'aceito')
                            ? `<button class="ip-andamento-close" title="Ocultar card" onclick="event.stopPropagation(); ocultarCardAndamento('${id}')"><i class='bx bx-x'></i></button>`
                            : '';
                        cardAndamento = `
                        <div class="ip-andamento ${cardCloseBtn ? 'has-close' : ''}" data-pedido-id="${id}">
                            ${cardCloseBtn}
                            <div class="ip-andamento-icon">
                                <i class='bx bx-receipt' style="font-size:20px;"></i>
                            </div>
                            <div class="ip-andamento-content">
                                <div class="ip-andamento-title">${label}</div>
                                <div class="ip-andamento-text">As informações do orçamento estão no chat.</div>
                            </div>
                        </div>`;
                    }
                }
                const isSelectedPedido = pedidosSelecaoModo && pedidosSelecionados.has(String(id));
                const selectMarker = pedidosSelecaoModo
                    ? `<button class="ip-select-indicator ${isSelectedPedido ? 'selected' : ''}" title="${isSelectedPedido ? 'Desmarcar' : 'Selecionar'}" onclick="event.stopPropagation(); toggleSelecaoPedido('${id}')"><i class='bx ${isSelectedPedido ? 'bx-check' : 'bx-circle'}'></i></button>`
                    : '';

                const agendaDate = parseAgendaDate(p);
                const agendaKey = agendaDate ? formatDateKey(agendaDate) : '';
                if (agendaKey) {
                    agendaItems.push({
                        id,
                        dateKey: agendaKey,
                        titulo: p.servicoReferencia || p.titulo || 'Pedido',
                        cliente: dU.user || p.paraUser || p.deUser || '',
                        turno: p.turno || p.turnoPreferido || 'Livre',
                        statusRaw: p.status || '',
                        statusLabel: sT || p.status || '',
                        status: getAgendaStatus(p),
                        uidOutro: outroUid || ''
                    });
                }

                const rowHtml = `
                    <div class="item-pedido tipo-pedido status-border-${p.status} ${pedidosSelecaoModo ? 'is-select-mode' : ''} ${isSelectedPedido ? 'is-selected' : ''}" data-colecao="pedidos" data-id="${id}" data-outro-uid="${outroUid || ''}" data-arquivado="${isArquivado ? '1' : '0'}" onclick="handlePedidoCardClick(event, '${id}', '${outroUid || ''}', '${p.status}')">
                        <div class="ip-header"><span class="tag-orcamento">ORÇAMENTO</span><div class="ip-header-actions">${selectMarker}${bApagar}${badgeHtml}</div></div>
                        <div class="ip-user">
                            <img src="${dU.foto || 'https://placehold.co/150'}" alt="Avatar" loading="lazy" decoding="async">
                            <span>${dU.user || 'Usuário'}</span>
                        </div>
                        <div class="ip-body">
                            <h4>${p.servicoReferencia}</h4>
                            ${subMsg}
                            ${cardAndamento}
                            ${infoSaldo} ${acoesHtml}
                        </div>
                    </div>`;
                htmlOut += rowHtml;
                sigParts.push([id, p.status, p.dataAtualizacao || p.dataPedido || '', isArquivado ? '1' : '0', unreadHtml ? 'u' : ''].join(':'));
            }
            if (!htmlOut.trim()) {
                htmlOut = `<div style="text-align:center; padding:40px; color:#999;">Nenhum pedido encontrado.</div>`;
            }
            pedidosAgendaCache = agendaItems;
            renderAgenda();
            const sig = sigParts.join('|');
            if (container.dataset.sig !== sig || container.querySelector('.bx-spin')) {
                container.innerHTML = htmlOut;
                container.dataset.sig = sig;
            }
            marcarCardsSelecionadosPedidos();
            updatePedidosBulkUI();
            if (pedidosFieldsDirty) restartPedidosRealtime();
            else if (!pedidosRealtimeUnsubs.length) startPedidosRealtime();
        } catch (e) {
            console.warn("Falha ao carregar pedidos:", e);
            if (container) {
                container.innerHTML = `
                    <div style="text-align:center; padding:30px; color:#999;">
                        Não foi possível carregar os pedidos.
                        <button style="margin-top:10px; padding:8px 12px; border-radius:8px; border:1px solid #e2e8f0; background:#fff; cursor:pointer;" onclick="carregarListaPedidos()">Tentar novamente</button>
                    </div>`;
            }
        }
    }

    let pedidosRealtimeUnsubs = [];
    function restartPedidosRealtime(){
        pedidosRealtimeUnsubs.forEach((fn) => { try { fn(); } catch (_) {} });
        pedidosRealtimeUnsubs = [];
        startPedidosRealtime();
    }
    function startPedidosRealtime(){
        if (!currentUserUid || pedidosRealtimeUnsubs.length) return;
        const deField = pedidosFieldResolved.de;
        const paraField = pedidosFieldResolved.para;
        if (!deField && !paraField) return;
        const base = collection(db, "pedidos");
        const q1 = deField ? query(base, where(deField, "==", currentUserUid)) : null;
        const q2 = paraField ? query(base, where(paraField, "==", currentUserUid)) : null;
        const onUpdate = () => {
            if (window.__pedidosRealtimeTimer) return;
            window.__pedidosRealtimeTimer = setTimeout(() => {
                window.__pedidosRealtimeTimer = null;
                if (abaAtual === 'pedidos') carregarListaPedidos({ silent: true });
            }, 250);
        };
        const subs = [];
        if (q1) subs.push(onSnapshot(q1, onUpdate));
        if (q2) subs.push(onSnapshot(q2, onUpdate));
        pedidosRealtimeUnsubs = subs;
    }

      function getConversaUpdated(data){
          if (!data) return 0;
          const raw = data.dataAtualizacao || data.updatedat || data.dataCriacao || data.createdat || data.created_at || null;
          const t = raw ? new Date(raw).getTime() : 0;
          return Number.isFinite(t) ? t : 0;
      }

      window.carregarListaConversas = async function() {
          const container = document.getElementById('lista-conversas');
          if(!container) return;
          container.innerHTML = `<div style="text-align:center; padding:20px;"><i class="bx bx-loader-alt bx-spin"></i></div>`;
  
          try {
              // 1) Conversas diretas
              const qConv = query(collection(db, "conversas"), where("participantes", "array-contains", currentUserUid));
              const snapConv = await getDocs(qConv);
 
              // Junta e remove duplicados por outroUid (client-side)
              const map = new Map();
              for (const d of snapConv.docs) {
                  const data = d.data() || {};
                  const outroUid = (data.participantes || []).find(u => u !== currentUserUid);
                  if(!outroUid) continue;
                  const updatedTs = getConversaUpdated(data);
                  const existing = map.get(outroUid);
                  if (!existing || updatedTs > (existing.updatedTs || 0)) {
                      map.set(outroUid, { kind:'conversa', id:d.id, data, updatedTs, outroUid });
                  }
              }
              const itens = Array.from(map.values()).sort((a,b) => (b.updatedTs || 0) - (a.updatedTs || 0));
  
              container.innerHTML = itens.length ? "" : "<p style='text-align:center; padding:20px;'>Sem mensagens.</p>";
  
              for (const it of itens) {
                  if (it.kind === 'conversa') {
                      const data = it.data;
                      if (isOcultoPorUser(data, 'ocultoChatPor', it.id)) continue;
                      const isArquivado = isArquivadoPorUser(data, it.id);
                      if (listaModo === 'arquivados' && !isArquivado) continue;
                      if (listaModo !== 'arquivados' && isArquivado) continue;
                      const outroUid = it.outroUid;
                      if(!outroUid) continue;
                      const lastMsg = data.ultimaMensagem || data.ultimamensagem || '';
                      const reqStatus = String(
                          data.dmRequestStatus ||
                          data.dm_request_status ||
                          data.solicitacaoMensagemStatus ||
                          data.solicitacao_mensagem_status ||
                          ''
                      ).toLowerCase();
                      const reqBy = String(
                          data.dmRequestBy ||
                          data.dm_request_by ||
                          data.solicitacaoMensagemBy ||
                          data.solicitacao_mensagem_by ||
                          ''
                      );
                      const reqTarget = String(
                          data.dmRequestTarget ||
                          data.dm_request_target ||
                          data.solicitacaoMensagemTarget ||
                          data.solicitacao_mensagem_target ||
                          outroUid
                      );
                      const souAlvoReq = String(currentUserUid || '') === String(reqTarget || '');
                      const souSolicitanteReq = String(currentUserUid || '') === String(reqBy || '');
                      const previewText = reqStatus === 'pendente'
                          ? (souAlvoReq ? 'Solicitação de mensagem recebida' : (souSolicitanteReq ? 'Solicitação de mensagem pendente' : 'Solicitação de mensagem'))
                          : (reqStatus === 'recusado'
                              ? (souSolicitanteReq ? 'Solicitação recusada' : 'Solicitação recusada')
                              : (lastMsg || 'Toque para conversar'));
                      const uD = await getDoc(doc(db, "usuarios", outroUid));
                      const u = uD.exists() ? uD.data() : {};
                      if (!matchBusca(u.user, lastMsg)) continue;
                      const silenciado = isContatoSilenciado(outroUid);
                      const isSelectedConversa = conversasSelecaoModo && conversasSelecionadas.has(String(it.id));
                      const selectMarker = conversasSelecaoModo
                        ? `<button class="ip-select-indicator ${isSelectedConversa ? 'selected' : ''}" title="${isSelectedConversa ? 'Desmarcar' : 'Selecionar'}" onclick="event.stopPropagation(); toggleSelecaoConversa('${it.id}')"><i class='bx ${isSelectedConversa ? 'bx-check' : 'bx-circle'}'></i></button>`
                        : '';
                      const unreadHtml = (!silenciado && isNaoLido(data.dataAtualizacao || data.updatedat || data.createdat || null, 'conversas', it.id)) ? '<span class="unread-dot"></span>' : "";
                      const mutedHtml = silenciado ? `<span class="muted-badge" title="Contato silenciado"><i class='bx bx-bell-off'></i></span>` : "";
                      container.insertAdjacentHTML('beforeend', `
                        <div class="item-conversa ${conversasSelecaoModo ? 'is-select-mode' : ''} ${isSelectedConversa ? 'is-selected' : ''}" data-colecao="conversas" data-id="${it.id}" data-outro-uid="${outroUid}" data-arquivado="${isArquivado ? '1' : '0'}" onclick="handleConversaCardClick(event, '${it.id}', '${outroUid}')">
                          <img src="${u.foto || 'https://placehold.co/150'}" alt="Avatar" loading="lazy" decoding="async">
                          <div class="ic-info">
                            <div class="ic-nome">${u.user || 'Usuário'}</div>
                            <div class="ic-msg">${previewText}</div>
                          </div>
                          <div class="ic-meta">${selectMarker}${unreadHtml}${mutedHtml}</div>
                        </div>`);
                  }
              }
              if (!container.children.length) {
                  container.innerHTML = "<p style='text-align:center; padding:20px;'>Sem mensagens.</p>";
              }
              marcarCardsSelecionadosConversas();
              updatePedidosBulkUI();
          } catch (e) {
              console.error(e);
              container.innerHTML = "<p style='text-align:center; padding:20px; color:#999;'>Erro ao carregar mensagens.</p>";
          }
      };

// FunÃ§Ã£o auxiliar para formatar a data (Coloque fora ou antes do abrirChat)
// FunÃ§Ã£o auxiliar de data (Mantenha ou adicione se nÃ£o tiver)
// FunÃ§Ã£o auxiliar de data (Mantenha igual a anterior)
    function formatarUltimaVez(dataIso) {
        if (!dataIso) return "Offline";
        try {
            const data = new Date(dataIso);
            const hoje = new Date();
            const ontem = new Date(hoje); ontem.setDate(ontem.getDate() - 1);
            const hora = data.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            if (data.toDateString() === hoje.toDateString()) return `Hoje às ${hora}`;
            else if (data.toDateString() === ontem.toDateString()) return `Ontem às ${hora}`;
            else return data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }) + ` às ${hora}`;
        } catch (e) { return "Offline"; }
    }

    async function withTimeout(promise, ms, label) {
        let t;
        const timeout = new Promise((_, reject) => {
            t = setTimeout(() => reject(new Error(`Timeout: ${label || 'operacao'}`)), ms);
        });
        try {
            return await Promise.race([promise, timeout]);
        } finally {
            clearTimeout(t);
        }
    }

    function getDeUid(p) {
        return p?.deUid || p?.deuid || '';
    }

    function getParaUid(p) {
        return p?.paraUid || p?.parauid || '';
    }

    const userCache = new Map();
    async function getUserCached(uid) {
        if (!uid) return null;
        if (userCache.has(uid)) return userCache.get(uid);
        try {
            const snap = await getDoc(doc(db, "usuarios", uid));
            const data = snap.exists() ? snap.data() : null;
            userCache.set(uid, data);
            return data;
        } catch (e) {
            return null;
        }
    }

    const pedidosFieldCaps = {
        deUid: true,
        paraUid: true,
        deuid: true,
        parauid: true
    };
    let pedidosFieldsDirty = false;
    const pedidosFieldResolved = { de: null, para: null };

    function isMissingColumnErr(err) {
        const msg = String(err?.message || err?.details || err?.hint || "").toLowerCase();
        return err?.status === 400 && (msg.includes("does not exist") || msg.includes("could not find") || msg.includes("column"));
    }

    function emptySnap() {
        return { empty: true, size: 0, docs: [], forEach: () => {} };
    }

    async function safeGetDocsWithField(q, fieldKey) {
        if (fieldKey && !pedidosFieldCaps[fieldKey]) return emptySnap();
        try {
            return await withTimeout(getDocs(q), 10000, `getDocs:${fieldKey || 'generic'}`);
        } catch (e) {
            if (fieldKey && isMissingColumnErr(e)) {
                pedidosFieldCaps[fieldKey] = false;
                pedidosFieldsDirty = true;
                return emptySnap();
            }
            throw e;
        }
    }

    async function resolvePedidosField(kind) {
        if (pedidosFieldResolved[kind]) return pedidosFieldResolved[kind];
        const base = collection(db, "pedidos");
        if (kind === 'de') {
            const q1 = query(base, where("deUid", "==", currentUserUid), limit(1));
            await safeGetDocsWithField(q1, 'deUid');
            if (pedidosFieldCaps.deUid) return (pedidosFieldResolved.de = 'deUid');
            const q2 = query(base, where("deuid", "==", currentUserUid), limit(1));
            await safeGetDocsWithField(q2, 'deuid');
            if (pedidosFieldCaps.deuid) return (pedidosFieldResolved.de = 'deuid');
        } else {
            const q1 = query(base, where("paraUid", "==", currentUserUid), limit(1));
            await safeGetDocsWithField(q1, 'paraUid');
            if (pedidosFieldCaps.paraUid) return (pedidosFieldResolved.para = 'paraUid');
            const q2 = query(base, where("parauid", "==", currentUserUid), limit(1));
            await safeGetDocsWithField(q2, 'parauid');
            if (pedidosFieldCaps.parauid) return (pedidosFieldResolved.para = 'parauid');
        }
        return null;
    }

    function getPedidoSortTs(p) {
        const raw = p?.dataPedido || p?.data_pedido || p?.dataAtualizacao || p?.dataAtualizacao || p?.createdat || p?.dataCriacao || p?.created_at || null;
        const dt = parseDataHora(raw);
        return dt ? dt.getTime() : 0;
    }

    async function hydratePedidoInicial(idDoc) {
        if (!idDoc || pedidoAtualData) return;
        try {
            const snap = await getDoc(doc(db, "pedidos", idDoc));
            if (!snap.exists()) return;
            const p = snap.data() || {};
            pedidoAtualData = p;
            statusPedidoAtual = p.status || statusPedidoAtual || 'pendente';
            conversaArquivadaAtual = isArquivadoPorUser(p, idDoc);
            pinnedAtual = mergePinned(Array.isArray(p.pinned) ? p.pinned : [], getPinnedLocal('pedidos', idDoc));
            renderPinnedBar();
            atualizarMenuConversa();
            atualizarContextoChat(p);
            carregarMensagens('pedidos', idDoc);
        } catch (e) {
            console.warn("Falha ao carregar pedido:", e);
        }
    }

    function syncChatHeaderLayout(){
        const header = document.querySelector('.chat-header');
        const btnC = document.getElementById('btn-cobranca-topo');
        if (!header || !btnC) return;
        const visivel = window.getComputedStyle(btnC).display !== 'none';
        header.classList.toggle('chat-has-cobranca', visivel);
    }

window.abrirChat = async function(idDoc, uidOutro, nomePadrao, fotoPadrao, colecao, statusDoc) {
        // Mobile: quando abrir conversa, traz o painel de chat para frente
        try{ document.body.classList.add('mobile-chat-open'); }catch(e){}
        chatContatoFotoAtual = String(fotoPadrao || chatContatoFotoAtual || '');
        // UI Inicial
        document.getElementById('chat-placeholder').style.display = 'none';
        document.getElementById('box-conversa-real').style.display = 'flex';
        const chatFooter = document.getElementById('chatFooter'); 
        const containerAcao = document.getElementById('container-acao-header');
        const btnC = document.getElementById('btn-cobranca-topo');
        const btnP = document.getElementById('btn-pagamento');
        const divAcoesPro = document.getElementById('acoes-profissional-header');

        statusPedidoAtual = (colecao === 'pedidos') ? (statusDoc || 'pendente') : 'pendente';
        avaliadoPedidoAtual = false;
        conversaArquivadaAtual = false;
        chatOutroUidAtual = uidOutro || '';
        chatIdAtual = idDoc;
        colecaoAtual = colecao;
        window.chatIdAtual = chatIdAtual;
        window.colecaoAtual = colecaoAtual;
        if (btnC) btnC.style.display = 'none';
        if (btnP) btnP.style.display = 'none';
        if (divAcoesPro) divAcoesPro.style.display = 'none';
        if (containerAcao) containerAcao.innerHTML = '';
        syncChatHeaderLayout();
        
        // Remove avisos antigos
        const aviso = document.getElementById('aviso-bloqueio-chat');
        if(aviso) aviso.remove();

        // 1. LÃ“GICA DE PEDIDOS (BLOQUEIO/STATUS)
          if (colecao === 'pedidos') {
              resetDmSolicitacaoState();
              setChatInputEnabled(true);
              await hydratePedidoInicial(idDoc);
              if (pedidoDocUnsub) { try { pedidoDocUnsub(); } catch (_) {} }
              pedidoDocUnsub = onSnapshot(doc(db, "pedidos", idDoc), (docSnap) => {
                  if (docSnap.exists()) {
                      const p = docSnap.data();
                    const deUid = getDeUid(p);
                    const paraUid = getParaUid(p);
                    const prevStatus = statusPedidoAtual;
                    const prevAvaliado = avaliadoPedidoAtual;
                    statusPedidoAtual = p.status || 'pendente';
                    avaliadoPedidoAtual = !!p.avaliado;
                    pedidoAtualData = p;
                    conversaArquivadaAtual = isArquivadoPorUser(p, idDoc);
                    pinnedAtual = mergePinned(Array.isArray(p.pinned) ? p.pinned : [], getPinnedLocal('pedidos', idDoc));
                    renderPinnedBar();
                    atualizarMenuConversa();
                    atualizarContextoChat(p);
                    const disputaModal = document.getElementById('modalDisputa');
                    if (disputaModal && disputaModal.style.display === 'flex') renderDisputaModal();
                    if (!avaliadoPedidoAtual && String(p.status || '').toLowerCase() === 'finalizado') {
                        checarAvaliacaoPedido(idDoc);
                    }
                      if (pedidoInfoRenderId !== idDoc) {
                          pedidoInfoRenderId = idDoc;
                          carregarMensagens(colecao, idDoc);
                      } else if (prevStatus !== statusPedidoAtual || prevAvaliado !== avaliadoPedidoAtual) {
                          carregarMensagens(colecao, idDoc);
                      }
                    
                    // LÃ³gica de bloqueio do chat
                    if (p.status === 'pendente') {
                        chatFooter.style.display = 'none'; 
                        if (currentUserUid === paraUid) mostrarAvisoBloqueio("Pedido em espera. Aceite o pedido para liberar o chat.");
                        else mostrarAvisoBloqueio("Pedido em espera. Aguardando aceite do profissional.");
                    } else if (['recusado', 'cancelado'].includes(p.status)) {
                        chatFooter.style.display = 'none'; 
                        mostrarAvisoBloqueio("Este pedido foi encerrado.");
                    } else {
                        chatFooter.style.display = 'flex'; 
                        if(document.getElementById('aviso-bloqueio-chat')) document.getElementById('aviso-bloqueio-chat').remove();
                    }

                    // BotÃµes Header (Finalizar / Aceitar / Recusar)
                    if(containerAcao) {
                        containerAcao.innerHTML = (deUid === currentUserUid && p.status === 'pago') 
                            ? `<button class="btn-conclusao-topo" onclick="liberarPagamento('${idDoc}')"><i class='bx bx-check'></i> Finalizar</button>` : "";
                        
                        if(divAcoesPro) divAcoesPro.style.display = (paraUid === currentUserUid && p.status === 'pendente') ? 'flex' : 'none';
                    }
                    
                    // BotÃµes Cobrança
                    if(btnC) btnC.style.display = (paraUid === currentUserUid && p.status === 'aceito') ? 'flex' : 'none';
                    if(btnP) btnP.style.display = (paraUid === currentUserUid && p.status === 'aceito') ? 'flex' : 'none';
                    syncChatHeaderLayout();
                  } else {
                      mostrarAvisoBloqueio("Pedido não encontrado.");
                      if (chatFooter) chatFooter.style.display = 'none';
                      syncChatHeaderLayout();
                  }
              }, (err) => {
                  console.warn("Falha ao ouvir pedido:", err);
                  mostrarAvisoBloqueio("Não foi possível carregar o pedido.");
                  if (chatFooter) chatFooter.style.display = 'none';
                  syncChatHeaderLayout();
              });
              await atualizarContextoAmizade(uidOutro);
              renderContextoConversa();
          } else {
              if (pedidoDocUnsub) { try { pedidoDocUnsub(); } catch (_) {} pedidoDocUnsub = null; }
              chatFooter.style.display = 'flex';
              pedidoAtualData = null;
              atualizarContextoChat(null);
              setChatInputEnabled(false, 'Carregando regras de mensagem...');
              await atualizarContextoAmizade(uidOutro, { skipRender: true });
              await atualizarPrivacidadeDmConversa(uidOutro);
              renderContextoConversa();
              try {
                  if (conversaDocUnsub) conversaDocUnsub();
                  conversaDocUnsub = onSnapshot(doc(db, "conversas", idDoc), async (snapConv) => {
                      if (!snapConv.exists()) {
                          resetDmSolicitacaoState();
                          renderContextoConversa();
                          return;
                      }
                      const convData = snapConv.data() || {};
                      conversaArquivadaAtual = isArquivadoPorUser(convData, idDoc);
                      pinnedAtual = mergePinned(Array.isArray(convData.pinned) ? convData.pinned : [], getPinnedLocal('conversas', idDoc));
                      await atualizarPrivacidadeDmConversa(uidOutro, { conversaData: convData });
                      renderContextoConversa();
                      renderPinnedBar();
                      atualizarMenuConversa();
                  });
              } catch (e) {}
              syncChatHeaderLayout();
          }

        // 2. CARREGA DADOS DO USUÃRIO + STATUS ONLINE (VISUAL MELHORADO)
              if (outroUserUnsub) { try { outroUserUnsub(); } catch (_) {} outroUserUnsub = null; }
              outroUserUnsub = onSnapshot(doc(db, "usuarios", uidOutro), (docSnap) => {
            if (docSnap.exists()) {
                const d = docSnap.data() || {};
                const pickName = (u) => u?.user || u?.nome || u?.username || u?.displayName || "";
                const pickPhoto = (u) => u?.foto || u?.photoURL || u?.photoUrl || u?.avatar || u?.avatarUrl || u?.defoto || "";
                const looksLikeBrandLogo = (url) => /doke-logo|logo-192|logo-512|assets\/imagens\/logo/i.test(String(url || ""));

                const nomeContato = pickName(d) || nomePadrao || "Usuario";
                let fotoContato = pickPhoto(d) || fotoPadrao || "assets/Imagens/user_placeholder.png";
                if (looksLikeBrandLogo(fotoContato) && fotoPadrao && !looksLikeBrandLogo(fotoPadrao)) {
                    fotoContato = fotoPadrao;
                }
                chatContatoFotoAtual = fotoContato || chatContatoFotoAtual || "";
                
                document.getElementById('chatNome').innerText = nomeContato;
                document.getElementById('chatAvatar').src = fotoContato;
                document.querySelectorAll('.msg-peer-avatar').forEach((img) => {
                    const atual = String(img.getAttribute('src') || img.src || '');
                    if (isPlaceholderAvatar(atual) && !isPlaceholderAvatar(fotoContato)) {
                        img.src = fotoContato;
                    }
                });

                const abrirPerfilOutro = () => window.abrirPerfilUsuario(uidOutro, !!d.isProfissional);
                document.getElementById('chatAvatar').onclick = abrirPerfilOutro;
                document.getElementById('chatNome').onclick = abrirPerfilOutro;

                const elStatus = document.getElementById('chatStatus');
                
                if (elStatus) {
                    const agora = new Date();
                    const ultimaVez = d.ultimaVezOnline ? new Date(d.ultimaVezOnline) : new Date(0);
                    const diffMinutos = (agora - ultimaVez) / 1000 / 60;

                    // LÃ³gica para determinar se estÃ¡ online (banco diz online E atualizou em menos de 3 min)
                    let isReallyOnline = (d.status === "Online" && diffMinutos < 3);

                    if (isReallyOnline) {
                        // --- AQUI ESTÃ A MUDANÃ‡A VISUAL ---
                        elStatus.innerHTML = `
                            <div class="status-container-online">
                                <div class="status-pulse"></div>
                                <span>Online</span>
                            </div>
                        `;
                        // Removemos estilos inline conflitantes para usar o CSS
                        elStatus.style.color = ""; 
                        elStatus.style.fontWeight = "";
                    } else {
                        // Status Offline (Texto Cinza PadrÃ£o)
                        elStatus.innerText = `Visto por último: ${formatarUltimaVez(d.ultimaVezOnline)}`;
                        elStatus.style.color = "#888";
                        elStatus.style.fontWeight = "400";
                    }
                }
                if (colecaoAtual === 'conversas' && String(uidOutro || '') === String(chatOutroUidAtual || '')) {
                    atualizarPrivacidadeDmConversa(uidOutro).then(() => {
                        renderContextoConversa();
                        atualizarMenuConversa();
                    }).catch(() => {});
                }
            }
        });

        restaurarRascunhoChat();
        carregarMensagens(colecao, idDoc);
        marcarChatComoLido(colecao, idDoc);
        atualizarMenuConversa();
    };



    function atualizarChipPedido(status) {
        const chip = document.getElementById('chipPedidoStatus');
        if (!chip) return;

        const map = {
            'pendente': { text: 'Pedido em espera', cls: 'chip-pendente' },
            'aceito': { text: 'Aceito', cls: 'chip-aceito' },
            'pago': { text: 'Pago (retido)', cls: 'chip-pago' },
            'finalizado': { text: 'Finalizado', cls: 'chip-finalizado' },
            'recusado': { text: 'Recusado', cls: 'chip-recusado' },
            'cancelado': { text: 'Cancelado', cls: 'chip-cancelado' },
        };

        const s = String(status || 'pendente').toLowerCase();
        const data = map[s] || map['pendente'];

        chip.className = 'chip-pedido-status ' + data.cls;
        chip.textContent = data.text;
        chip.style.display = 'inline-flex';
    }

    function mostrarAvisoBloqueio(texto) {
        const chatBox = document.getElementById('box-conversa-real');
        
        // Remove aviso antigo se o texto for diferente (para atualizar de "aguardando" para "aceite" se necessÃ¡rio)
        const avisoAntigo = document.getElementById('aviso-bloqueio-chat');
        if (avisoAntigo) {
            if (avisoAntigo.innerText.includes(texto)) return; // Se for o mesmo texto, nÃ£o faz nada
            avisoAntigo.remove(); // Se for diferente, remove para criar o novo
        }

        const div = document.createElement('div');
        div.id = "aviso-bloqueio-chat";
        div.style.cssText = "padding: 15px; background: #fff3cd; color: #856404; text-align: center; font-size: 0.9rem; border-top: 1px solid #ffeeba;";
        div.innerHTML = `<i class='bx bx-lock-alt'></i> ${texto}`;
        chatBox.appendChild(div);
    }
// EM CHAT.HTML - SUBSTITUA A FUNÃ‡ÃƒO carregarMensagens

      function carregarMensagens(colecao, docId) {
          const container = document.getElementById('areaMensagens');
          if (!container) return;
          bindLongPressMensagens(container);
          if (window.chatUnsubscribe) window.chatUnsubscribe();
          
          const q = query(collection(db, colecao, docId, "mensagens"), orderBy("timestamp", "asc"));
    let lastSig = "";
    const clearAt = getClearTime(colecao, docId);
    const clearTs = clearAt ? clearAt.getTime() : null;

    const sigValue = (v) => {
        if (v == null) return "";
        if (v instanceof Date) return v.toISOString();
        if (typeof v === 'object') {
            if (typeof v.seconds === 'number') return String(v.seconds);
            try { return JSON.stringify(v); } catch (e) { return String(v); }
        }
        return String(v);
    };
    
        window.chatUnsubscribe = onSnapshot(q, (snapshot) => {
            const wasNearBottom = isNearBottom(container, 120);
            const prevOffset = container.scrollHeight - container.scrollTop;
            const anexosUrlSet = new Set();
            if (colecao === 'pedidos' && pedidoAtualData) {
                const anexosBase = getPedidoAnexosFromTriagem(pedidoAtualData);
                anexosBase.forEach((a) => {
                    const norm = normalizeUrlForCompare(a.url);
                    if (norm) anexosUrlSet.add(norm);
                });
            }
            
            let statusPedido = (colecao === 'pedidos') ? (statusPedidoAtual || 'pendente') : 'pendente';
            const pedidoAvaliado = (colecao === 'pedidos') ? !!avaliadoPedidoAtual : false;
            const htmlParts = [];
            const sigParts = [];
            const toMark = [];
        sigParts.push(`clear@${clearTs || ''}`);
        if (colecao === 'pedidos' && pedidoAtualData) {
            sigParts.push([
                'pedido',
                sigValue(pedidoAtualData.status),
                sigValue(pedidoAtualData.motivoRecusa),
                sigValue(pedidoAtualData.descricaoBase),
                sigValue(pedidoAtualData.paraQuando),
                sigValue(pedidoAtualData.dataEspecifica),
                sigValue(pedidoAtualData.turno),
                sigValue(pedidoAtualData.modoAtend || pedidoAtualData.modo_atend),
                sigValue(pedidoAtualData.localizacao),
                sigValue(pedidoAtualData.respostasTriagem)
            ].join("|"));
            const infoCard = buildPedidoInfoCard(pedidoAtualData);
            if (infoCard) htmlParts.push(infoCard);
            const recusaCard = buildRecusaCard(pedidoAtualData);
            if (recusaCard) htmlParts.push(recusaCard);
        }
        const latestSolicitacaoPortfolioId = (() => {
            let latest = { id: "", ts: 0 };
            (snapshot.docs || []).forEach((d) => {
                const mData = d.data() || {};
                if (mData.tipo !== 'solicitacao_portfolio') return;
                const dt = parseDataHora(mData.timestamp);
                const ts = dt && !isNaN(dt.getTime()) ? dt.getTime() : 0;
                if (!latest.id || ts >= latest.ts) latest = { id: d.id || "", ts };
            });
            return latest.id || "";
        })();

          snapshot.forEach(docSnap => {
              const m = docSnap.data();
              if (isHiddenMsgId(colecao, docId, docSnap.id)) return;
              const msgDate = parseDataHora(m.timestamp);
              if (clearTs && msgDate && msgDate.getTime() <= clearTs) return;
            const shouldSkipAttachment = !!(anexosUrlSet.size && m.url && (m.tipo === 'imagem' || m.tipo === 'arquivo') && anexosUrlSet.has(normalizeUrlForCompare(m.url)));
            sigParts.push([
                docSnap.id || "",
                sigValue(m.timestamp),
                sigValue(m.texto),
                sigValue(m.tipo),
                sigValue(m.url),
                sigValue(m.valor),
                sigValue(m.maxParcelas || m.maxparcelas),
                sigValue(m.lidoEm || m.lidoem || m.lido)
            ].join("|"));
            if (shouldSkipAttachment) return;
            // Verifica se a mensagem foi enviada por MIM (usuário logado)
            const sender = m.senderUid || m.senderuid || m.senderUID || m.sender;
            const souEu = String(sender||'') === String(currentUserUid);
            if (!souEu && currentUserUid) {
                const lidoEm = m.lidoEm || m.lidoem || {};
                if (!lidoEm[currentUserUid]) toMark.push(docSnap.ref);
            }
            
            // Formatar hora (Firestore Timestamp / ISO / Date)
            let horaMsg = "";
            try {
                if (msgDate && !isNaN(msgDate.getTime())) horaMsg = msgDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            } catch(e) {}

            const parsedText = extractReplyFromText(m.texto || '');
            const cleanText = parsedText.text;
            const senderUserRaw = m.senderUser || m.sender_user || "";
            const senderUser = (senderUserRaw || (souEu ? 'Você' : 'Usuário'));
            const msgPreview = getTipoPreview(m.tipo, cleanText || '', m.url || '');
            const enc = (v) => encodeURIComponent(String(v || ""));
            const replyBtn = docSnap.id
                ? `<button class="msg-reply-btn" title="Responder" onclick="responderMensagem('${enc(docSnap.id)}','${enc(senderUser)}','${enc(m.tipo || 'texto')}','${enc(msgPreview)}')"><i class='bx bx-reply'></i></button>`
                : "";
            const msgId = docSnap.id || "";
            const msgIdAttr = msgId ? `id="msg-${msgId}"` : "";
            const menuId = msgId ? `msg-menu-${msgId}` : "";
            const menuSide = souEu ? "msg-menu-right" : "msg-menu-left";
            const isPinned = isMsgPinned(msgId);
            const pinLabel = isPinned ? 'Desafixar' : 'Fixar';
            const pinPreview = normalizePinPreview(msgPreview || cleanText || getTipoPreview(m.tipo, cleanText || '', m.url || ''));
            const menuBtn = "";
            const menuHtml = msgId
                ? `<div class="msg-menu ${menuSide}" id="${menuId}">
                        <div class="menu-title">${horaMsg || 'Agora'}</div>
                        <button onclick="togglePinMessage('${msgId}', '${enc(pinPreview)}', '${enc(m.tipo || 'texto')}')">${pinLabel} <i class='bx bx-pin'></i></button>
                        ${m.tipo === 'audio' ? '' : `<button onclick="copiarMensagem('${enc(cleanText)}')">Copiar <i class='bx bx-copy'></i></button>`}
                        ${souEu ? `<button class="danger" onclick="excluirMensagem('${msgId}')">Apagar mensagem <i class='bx bx-trash'></i></button>` : ""}
                   </div>`
                : "";
            let replyData = parsedText.meta;
            if (!replyData && m.reply_user && m.reply_preview) {
                replyData = { user: m.reply_user, preview: m.reply_preview };
            }
            if (!replyData && m.replyTo) {
                replyData = m.replyTo;
            }
            const replyHtml = buildReplyHtml(replyData);
            const readHtml = buildReadReceiptHtml(m, souEu);
            const headerAvatar = document.getElementById('chatAvatar')?.src || "";
            const pedidoClienteFoto = pedidoAtualData?.deFoto || pedidoAtualData?.clienteFoto || "";
            const pedidoProfFoto = pedidoAtualData?.paraFoto || pedidoAtualData?.profissionalFoto || "";
            const peerAvatarSrcRaw = (
                m.senderFoto ||
                m.sender_foto ||
                m.avatar ||
                chatContatoFotoAtual ||
                (!isPlaceholderAvatar(headerAvatar) ? headerAvatar : "") ||
                pedidoClienteFoto ||
                pedidoProfFoto ||
                "assets/Imagens/user_placeholder.png"
            );
            const peerAvatarSrc = escapeHtml(peerAvatarSrcRaw);
            const wrapMensagemComAvatar = (bubbleHtml) => {
                if (souEu) return `<div class="msg-row msg-row-me">${bubbleHtml}</div>`;
                return `
                <div class="msg-row msg-row-peer">
                    <img class="msg-peer-avatar" src="${peerAvatarSrc}" alt="Foto de perfil" loading="lazy" decoding="async" onerror="this.onerror=null;this.src='https://i.pravatar.cc/80?img=12';">
                    <div class="msg-row-bubble">${bubbleHtml}</div>
                </div>`;
            };

            // --- CARD PAGAMENTO (VERDE) ---
            if (m.tipo === 'pagamento') {
                if (colecao !== 'pedidos') return;
                const jaPago = (statusPedido === 'pago' || statusPedido === 'finalizado');
                const perfilLocal = (() => {
                    try { return JSON.parse(localStorage.getItem('doke_usuario_perfil') || "{}"); }
                    catch (e) { return {}; }
                })();
                const clienteNome = perfilLocal.nome || perfilLocal.user || "";
                const profNomeHeader = document.getElementById('chatNome')?.innerText || "";
                const profNome = m.profissionalNome || m.usernameProfissional || profNomeHeader || "";
                const fotoHeader = document.getElementById('chatAvatar')?.src || "";
                const fotoAnuncio = m.anuncioFoto || m.fotoServico || "";
                const fotoProf = m.profissionalFoto || fotoHeader || "";
                const fotoFinal = fotoAnuncio || fotoProf || "";
                const anuncioId = m.anuncioId || m.anuncio_id || "";
                const parcelas = m.maxParcelas || m.maxparcelas || 1;
                const linkPagar = `pagar.html?pedidoId=${encodeURIComponent(docId)}&valor=${encodeURIComponent(m.valor || "")}&parcelas=${encodeURIComponent(parcelas)}`;
                try {
                    sessionStorage.setItem(`doke_pagamento_${docId}`, JSON.stringify({
                        valor: m.valor || "",
                        parcelas,
                        prof: profNome || "",
                        user: clienteNome || "",
                        desc: m.descricao || "",
                        foto: fotoFinal || "",
                        anuncioId: anuncioId || "",
                        ts: Date.now()
                    }));
                } catch (_) {}
                
                let btnHtml = "";

                if (jaPago) {
                    // CASO 1: JÃ PAGO (Verde para ambos)
                    btnHtml = `<button style="width:100%; padding:10px; background:#2ecc71; color:white; border:none; border-radius:8px; font-weight:bold; cursor:default;"><i class='bx bx-check'></i> Pago</button>`;
                } else if (souEu) {
                    // CASO 2: EU SOU O PROFISSIONAL QUE ENVIOU (Aviso Cinza)
                    btnHtml = `<div style="width:100%; padding:10px; background:#f0f2f5; color:#777; border:1px dashed #ccc; border-radius:8px; font-weight:600; text-align:center; font-size:0.9rem;">
                                <i class='bx bx-time-five'></i> Aguardando Pagamento
                               </div>`;
                } else {
                    // CASO 3: EU SOU O CLIENTE (BotÃ£o Pagar)
                    btnHtml = `<button onclick="window.location.href='${linkPagar}'" style="width:100%; padding:10px; background:var(--cor0); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">Pagar Agora</button>`;
                }

                const html = `
                <div ${msgIdAttr} style="align-self:${souEu ? 'flex-end' : 'flex-start'}; background:white; border:1px solid #ddd; padding:15px; border-radius:12px; margin-bottom:10px; min-width:260px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                    <div style="color:var(--cor0); font-weight:bold; margin-bottom:5px;"><i class='bx bx-dollar-circle'></i> Cobran\u00e7a</div>
                    <div style="font-size:1.6rem; font-weight:800; color:#333; text-align:center; margin:10px 0;">${m.valor}</div>
                    <div style="font-size:0.9rem; color:#666; margin-bottom:15px; text-align:center;">${m.descricao}</div>
                    ${btnHtml}
                </div>`;
                htmlParts.push(html);
                return; // evita gerar mensagem vazia embaixo do card
            }
            // --- CARD AVALIAÃ‡ÃƒO (AMARELO) ---
            else if (m.tipo === 'card_avaliacao') {
                // Card amarelo removido (o card com foto de finalizaÃ§Ã£o jÃ¡ cobre essa necessidade)
                return;
            }
            // --- CARD FINALIZADO ---
            else if (m.tipo === 'card_finalizado') {
                const souClientePedido = pedidoAtualData && String(getDeUid(pedidoAtualData) || '') === String(currentUserUid || '');
                const souProfissionalPedido = pedidoAtualData && String(getParaUid(pedidoAtualData) || '') === String(currentUserUid || '');
                const titulo = pedidoAvaliado ? "Pedido avaliado com sucesso" : "Pedido finalizado";
                const subt = pedidoAvaliado
                    ? "Sua avaliação ajudou a comunidade."
                    : (souClientePedido ? "Que tal avaliar o profissional agora?" : "Aguardando avaliação do cliente.");
                const mediaType = m.mediaType || inferMediaTipoByUrl(m.url || "");
                const beforeUrl = m.beforeUrl || (pedidoAtualData && pedidoAtualData.finalizacaoAntesUrl) || "";
                const afterUrl = m.afterUrl || (pedidoAtualData && pedidoAtualData.finalizacaoDepoisUrl) || "";
                const hasBeforeAfter = !!(beforeUrl || afterUrl);
                let mediaHtml = "";
                if (hasBeforeAfter) {
                    const beforeType = m.beforeType || inferMediaTipoByUrl(beforeUrl);
                    const afterType = m.afterType || inferMediaTipoByUrl(afterUrl);
                    const beforeBox = beforeUrl
                        ? (beforeType === 'video'
                            ? `<video src="${beforeUrl}" controls playsinline preload="metadata" style="width:100%; border-radius:10px; border:1px solid #e5e7eb; display:block; background:#000; aspect-ratio:4/3; object-fit:cover;"></video>`
                            : `<img src="${beforeUrl}" alt="antes" style="width:100%; border-radius:10px; border:1px solid #e5e7eb; display:block; cursor:pointer; aspect-ratio:4/3; object-fit:cover;" onclick="abrirGaleria(['${beforeUrl}'], 0)" loading="lazy" decoding="async">`)
                        : `<div style="height:100%; min-height:100px; display:flex; align-items:center; justify-content:center; border:1px dashed #d1d5db; border-radius:10px; color:#94a3b8; font-size:0.8rem;">Sem midia</div>`;
                    const afterBox = afterUrl
                        ? (afterType === 'video'
                            ? `<video src="${afterUrl}" controls playsinline preload="metadata" style="width:100%; border-radius:10px; border:1px solid #e5e7eb; display:block; background:#000; aspect-ratio:4/3; object-fit:cover;"></video>`
                            : `<img src="${afterUrl}" alt="depois" style="width:100%; border-radius:10px; border:1px solid #e5e7eb; display:block; cursor:pointer; aspect-ratio:4/3; object-fit:cover;" onclick="abrirGaleria(['${afterUrl}'], 0)" loading="lazy" decoding="async">`)
                        : `<div style="height:100%; min-height:100px; display:flex; align-items:center; justify-content:center; border:1px dashed #d1d5db; border-radius:10px; color:#94a3b8; font-size:0.8rem;">Sem midia</div>`;
                    mediaHtml = `
                        <div style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:8px; text-align:left;">
                            <div><div style="font-size:0.72rem; color:#64748b; font-weight:800; margin-bottom:4px;">ANTES</div>${beforeBox}</div>
                            <div><div style="font-size:0.72rem; color:#64748b; font-weight:800; margin-bottom:4px;">DEPOIS</div>${afterBox}</div>
                        </div>`;
                } else if (m.url) {
                    mediaHtml = mediaType === 'video'
                        ? `<div style="margin-top:10px;"><video src="${m.url}" controls playsinline preload="metadata" style="max-width:320px; width:100%; border-radius:12px; border:1px solid #e5e7eb; display:block; background:#000;"></video></div>`
                        : `<div style="margin-top:10px;"><img src="${m.url}" alt="resultado" style="max-width:280px; width:100%; border-radius:12px; border:1px solid #e5e7eb; display:block; cursor:pointer;" onclick="abrirGaleria(['${m.url}'], 0)" loading="lazy" decoding="async"></div>`;
                }
                const btnHtml = (!pedidoAvaliado && souClientePedido)
                    ? `<button onclick="abrirAvaliacaoPedido('${docId}')" style="margin-top:10px; background:#0b7768; color:#fff; border:none; padding:9px 16px; border-radius:20px; font-weight:800; cursor:pointer;">Avaliar agora</button>`
                    : `<div style="margin-top:8px; color:${pedidoAvaliado ? '#166534' : '#64748b'}; font-size:0.85rem; font-weight:700;">${pedidoAvaliado ? 'Obrigado!' : ' '}</div>`;
                let portfolioBtnHtml = "";
                if (souProfissionalPedido) {
                    const hasMedia = !!((pedidoAtualData && pedidoAtualData.finalizacaoMediaUrl) || m.url);
                    const consent = String((pedidoAtualData && pedidoAtualData.portfolioConsentStatus) || '').toLowerCase();
                    const pedidoJaPublicado = !!(pedidoAtualData && (pedidoAtualData.portfolioAddedAt || pedidoAtualData.portfolioItemId));
                    if (hasMedia && !pedidoJaPublicado) {
                        if (consent === 'aprovado') {
                            portfolioBtnHtml = `<button onclick="publicarMidiaNoPortfolio('${docId}')" style="margin-top:8px; background:#0b7768; color:#fff; border:none; padding:8px 14px; border-radius:999px; font-weight:800; cursor:pointer;"><i class='bx bx-collection'></i> Publicar no portfolio</button>`;
                        } else if (consent !== 'pendente') {
                            portfolioBtnHtml = `<button onclick="solicitarAdicionarNoPortfolio('${docId}')" style="margin-top:8px; background:#1f4d75; color:#fff; border:none; padding:8px 14px; border-radius:999px; font-weight:800; cursor:pointer;"><i class='bx bx-send'></i> Adicionar no portfolio</button>`;
                        }
                    }
                }
                htmlParts.push(`
                <div ${msgIdAttr} style="align-self:center; background:#ffffff; border:1px solid #e5e7eb; padding:16px; border-radius:14px; margin:14px 0; text-align:center; box-shadow:0 6px 18px rgba(15,23,42,0.06);">
                    <div style="display:flex; align-items:center; justify-content:center; gap:8px; font-weight:800; color:#0f172a;">
                        <i class='bx bx-badge-check' style="color:#0b7768; font-size:1.3rem;"></i>
                        ${titulo}
                    </div>
                    <div style="margin-top:6px; color:#475569; font-size:0.9rem;">${subt}</div>
                    ${mediaHtml}
                    ${btnHtml}
                    ${portfolioBtnHtml}
                </div>`);
                return; // evita bolha vazia apÃ³s o card
            }
            // --- SOLICITACAO DE PORTFOLIO ---
            else if (m.tipo === 'solicitacao_portfolio') {
                if (latestSolicitacaoPortfolioId && msgId && msgId !== latestSolicitacaoPortfolioId) return;
                const souClientePedido = pedidoAtualData && String(getDeUid(pedidoAtualData) || '') === String(currentUserUid || '');
                const statusReq = String(m.status || '').toLowerCase() || String((pedidoAtualData && pedidoAtualData.portfolioConsentStatus) || '').toLowerCase() || 'pendente';
                const mediaType = m.mediaType || inferMediaTipoByUrl(m.mediaUrl || m.url || "");
                const mediaUrl = m.mediaUrl || m.url || "";
                const mediaHtml = mediaUrl
                    ? (mediaType === 'video'
                        ? `<video src="${mediaUrl}" controls playsinline preload="metadata" style="max-width:320px; width:100%; border-radius:12px; border:1px solid #e5e7eb; background:#000;"></video>`
                        : `<img src="${mediaUrl}" alt="midia solicitada" style="max-width:280px; width:100%; border-radius:12px; border:1px solid #e5e7eb; cursor:pointer;" onclick="abrirGaleria(['${mediaUrl}'], 0)" loading="lazy" decoding="async">`)
                    : "";
                let actions = "";
                if (statusReq === 'pendente' && souClientePedido) {
                    actions = `
                        <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:10px;">
                            <button onclick="responderSolicitacaoPortfolio('${docId}','${msgId}','aprovar')" style="background:#0b7768; color:#fff; border:none; padding:8px 14px; border-radius:999px; font-weight:800; cursor:pointer;">Permitir</button>
                            <button onclick="responderSolicitacaoPortfolio('${docId}','${msgId}','recusar')" style="background:#fff; color:#b91c1c; border:1px solid #fecaca; padding:8px 14px; border-radius:999px; font-weight:800; cursor:pointer;">Recusar</button>
                        </div>`;
                } else if (statusReq === 'aprovado') {
                    actions = `<div style="margin-top:8px; color:#166534; font-weight:800; font-size:0.85rem;"><i class='bx bx-check-circle'></i> Cliente autorizou.</div>`;
                } else if (statusReq === 'recusado') {
                    actions = `<div style="margin-top:8px; color:#b91c1c; font-weight:800; font-size:0.85rem;"><i class='bx bx-x-circle'></i> Cliente recusou.</div>`;
                } else {
                    actions = `<div style="margin-top:8px; color:#64748b; font-weight:700; font-size:0.84rem;"><i class='bx bx-time-five'></i> Aguardando resposta.</div>`;
                }
                htmlParts.push(`
                <div ${msgIdAttr} style="align-self:center; background:#ffffff; border:1px solid #cfe5e1; padding:16px; border-radius:14px; margin:14px 0; text-align:center; box-shadow:0 6px 18px rgba(15,23,42,0.06);">
                    <div style="display:flex; align-items:center; justify-content:center; gap:8px; font-weight:800; color:#0f172a;">
                        <i class='bx bx-collection' style="color:#0b7768; font-size:1.3rem;"></i>
                        Autorizacao para portfolio
                    </div>
                    <div style="margin-top:6px; color:#475569; font-size:0.9rem;">O profissional quer usar esta midia no portfolio.</div>
                    <div style="margin-top:10px;">${mediaHtml}</div>
                    ${actions}
                </div>`);
                return;
            }
            // --- RESPOSTA DA SOLICITACAO DE PORTFOLIO ---
            else if (m.tipo === 'portfolio_consent_result') {
                const souProfissionalPedido = pedidoAtualData && String(getParaUid(pedidoAtualData) || '') === String(currentUserUid || '');
                if (!souProfissionalPedido) return;
                const statusReq = String(m.status || '').toLowerCase();
                const ok = statusReq === 'aprovado';
                htmlParts.push(`
                <div ${msgIdAttr} style="align-self:center; background:${ok ? '#ecfdf5' : '#fef2f2'}; border:1px solid ${ok ? '#bbf7d0' : '#fecaca'}; padding:12px 14px; border-radius:12px; margin:12px 0; text-align:center;">
                    <i class='bx ${ok ? 'bx-check-circle' : 'bx-x-circle'}' style="color:${ok ? '#166534' : '#b91c1c'}; font-size:1.1rem;"></i>
                    <span style="font-size:0.88rem; color:${ok ? '#166534' : '#7f1d1d'}; font-weight:700; margin-left:6px;">${escapeHtml(m.texto || (ok ? 'Cliente autorizou o portfolio.' : 'Cliente recusou o portfolio.'))}</span>
                </div>`);
                return;
            }
            // --- MIDIA PUBLICADA NO PORTFOLIO ---
            else if (m.tipo === 'portfolio_publicado') {
                htmlParts.push(`
                <div ${msgIdAttr} style="align-self:center; background:#eff6ff; border:1px solid #bfdbfe; padding:12px 14px; border-radius:12px; margin:12px 0; text-align:center;">
                    <i class='bx bx-check-shield' style="color:#1d4ed8; font-size:1.1rem;"></i>
                    <span style="font-size:0.88rem; color:#1e3a8a; font-weight:700; margin-left:6px;">Midia publicada no portfolio do profissional.</span>
                </div>`);
                return;
            }
              // --- MENSAGEM APAGADA ---
              if (m.tipo === 'apagada') {
                  htmlParts.push(`
                  <div ${msgIdAttr} style="align-self:${souEu ? 'flex-end' : 'flex-start'}; font-size:0.78rem; color:#94a3b8; font-style:italic; margin:6px 0;">
                      Mensagem apagada
                  </div>`);
              }
              // --- SOLICITAÃ‡ÃƒO DE REEMBOLSO ---
              else if (m.tipo === 'reembolso') {
                const motivo = m.texto ? escapeHtml(m.texto) : "Solicitação registrada.";
                htmlParts.push(`
                <div ${msgIdAttr} style="align-self:center; background:#fee2e2; border:1px solid #fecaca; padding:14px; border-radius:12px; margin:12px 0; text-align:center;">
                    <i class='bx bx-receipt' style="color:#b91c1c; font-size:1.4rem;"></i>
                    <p style="margin:6px 0; font-weight:700; color:#7f1d1d;">Reembolso solicitado</p>
                    <div style="font-size:0.85rem; color:#7f1d1d;">${motivo}</div>
                </div>`);
            }
            // --- IMAGEM ---
              else if (m.tipo === 'imagem' && m.url) {
                  const htmlImg = `
                  <div class="msg-bubble ${souEu ? 'msg-enviada' : 'msg-recebida'} ${msgId ? 'has-menu' : ''}" ${msgIdAttr} style="padding:8px;">
                      ${menuBtn}
                      ${menuHtml}
                      ${replyHtml}
                      <img class="msg-media-image" src="${m.url}" alt="imagem" loading="lazy" decoding="async" onclick="abrirGaleria(['${m.url}'], 0)">
                      <div class="msg-footer">
                          ${replyBtn}
                        <span class="msg-hora">${horaMsg}</span>
                        ${readHtml}
                    </div>
                </div>`;
                htmlParts.push(wrapMensagemComAvatar(htmlImg));
            }
            // --- ARQUIVO ---
              else if (m.tipo === 'arquivo' && m.url) {
                  const nome = escapeHtml(cleanText || 'Arquivo');
                  const htmlFile = `
                  <div class="msg-bubble ${souEu ? 'msg-enviada' : 'msg-recebida'} ${msgId ? 'has-menu' : ''}" ${msgIdAttr}>
                      ${menuBtn}
                      ${menuHtml}
                      ${replyHtml}
                      <div style="display:flex; align-items:center; gap:10px;">
                        <div style="width:38px; height:38px; border-radius:10px; background:#eef2ff; display:flex; align-items:center; justify-content:center;">
                            <i class='bx bx-file' style="font-size:20px; color:#3949ab"></i>
                        </div>
                        <div style="flex:1; min-width:0;">
                            <div style="font-weight:700; color:#111; font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${nome}</div>
                            <a href="${m.url}" target="_blank" style="font-size:0.82rem; color:var(--cor0); font-weight:700; text-decoration:none;">Baixar / abrir</a>
                        </div>
                    </div>
                    <div class="msg-footer">
                        ${replyBtn}
                        <span class="msg-hora">${horaMsg}</span>
                        ${readHtml}
                    </div>
                </div>`;
                htmlParts.push(wrapMensagemComAvatar(htmlFile));
            }
            // --- MENSAGEM DE ÃUDIO ---
              else if (m.tipo === 'audio') {
                  const corWave = souEu ? 'white' : '#555';
                  const corIcone = souEu ? 'var(--cor0)' : '#555';
                  const duracaoSeg = Number(m.duracaoSegundos || m.duracao || m.duration || 0);
                  const duracaoLabel = formatDurationClock(duracaoSeg);
                
                const audioId = 'audio-' + Math.random().toString(36).substr(2, 9);
                  const htmlAudio = `
                  <div class="msg-bubble ${souEu ? 'msg-enviada' : 'msg-recebida'} ${msgId ? 'has-menu' : ''}" ${msgIdAttr}>
                      ${menuBtn}
                      ${menuHtml}
                      ${replyHtml}
                      <div class="audio-bubble" data-audio-id="${audioId}">
                        <button class="btn-play-audio" onclick="tocarAudio(this, '${m.url}', '${audioId}', ${Number.isFinite(duracaoSeg) ? duracaoSeg : 0})" style="color:${corIcone}">
                            <i class='bx bx-play'></i>
                        </button>
                        <div style="display:flex; flex-direction:column; justify-content:center; flex:1;">
                            <div class="audio-wave" style="background:${corWave}; opacity:0.3; height:3px; width:100px; margin-bottom:3px;"></div>
                            <span id="audio-time-${audioId}" style="font-size:0.7rem; opacity:0.8;">0:00 / ${duracaoLabel}</span>
                        </div>
                    </div>
                    <div class="msg-footer">
                        ${replyBtn}
                        <span class="msg-hora">${horaMsg}</span>
                        ${readHtml}
                    </div>
                </div>`;
                htmlParts.push(wrapMensagemComAvatar(htmlAudio));
            }
            // --- TEXTO NORMAL ---
              else {
                  const textoSeguro = escapeHtml(cleanText).replace(/\n/g, '<br>');
                  htmlParts.push(wrapMensagemComAvatar(`
                  <div class="msg-bubble ${souEu ? 'msg-enviada' : 'msg-recebida'} ${msgId ? 'has-menu' : ''}" ${msgIdAttr}>
                      ${menuBtn}
                      ${menuHtml}
                      ${replyHtml}
                      ${textoSeguro}
                      <div class="msg-footer">
                        ${replyBtn}
                        <span class="msg-hora">${horaMsg}</span>
                        ${readHtml}
                    </div>
                </div>`));
            }
        });

        const nextSig = sigParts.join("||") + "||" + statusPedido + "|" + (pedidoAvaliado ? "1" : "0");
        if (nextSig === lastSig) {
            updateScrollDownButton();
            if (toMark.length) marcarMensagensComoLidas(toMark);
            return;
        }
        lastSig = nextSig;
        const emptyHtml = clearTs
            ? `<div style="text-align:center; padding:30px; color:#888;">Histórico limpo para você. Novas mensagens aparecerão aqui.</div>`
            : `<div style="text-align:center; padding:30px; color:#888;">Nenhuma mensagem.</div>`;
        const nextHtml = htmlParts.length ? htmlParts.join("") : emptyHtml;
        container.innerHTML = nextHtml;
        if (wasNearBottom) {
            container.scrollTop = container.scrollHeight;
        } else {
            container.scrollTop = Math.max(0, container.scrollHeight - prevOffset);
        }
        updateScrollDownButton();
        if (toMark.length) marcarMensagensComoLidas(toMark);
        marcarChatComoLido(colecao, docId);
    });
}


    // Gerar Pagamento usando Modais Bonitos
// EM CHAT.HTML

// SUBSTITUA A FUNÃ‡ÃƒO window.gerarPagamento NO CHAT.HTML POR ESTA:

function formatCurrencyBRLFromDigits(digits){
    const clean = String(digits || "").replace(/\D/g, "");
    const n = Number(clean || "0") / 100;
    return n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

function ensureCobrancaModalBehavior(){
    const modal = document.getElementById('modalGerarCobranca');
    const valorInput = document.getElementById('cobrancaValorInput');
    if (!modal || !valorInput || modal.dataset.bound === "1") return;

    modal.dataset.bound = "1";
    valorInput.addEventListener('input', (e) => {
        const raw = String(e.target.value || "");
        e.target.value = formatCurrencyBRLFromDigits(raw);
    });

    modal.addEventListener('click', (e) => {
        if (e.target === modal) window.fecharModalGerarCobranca();
    });
}

window.fecharModalGerarCobranca = function(){
    const modal = document.getElementById('modalGerarCobranca');
    if (!modal) return;
    modal.style.display = 'none';
};

window.gerarPagamento = async function() {
    if (colecaoAtual !== 'pedidos') {
        const msg = "Cobrança disponível apenas em pedidos/orçamentos.";
        window.dokeAlert ? window.dokeAlert(msg) : alert(msg);
        return;
    }
    const idParaSalvar = chatIdAtual;
    if (!idParaSalvar) {
        alert("Erro: Nenhuma conversa aberta. Selecione um cliente na lista."); 
        return;
    }

    ensureCobrancaModalBehavior();
    const modal = document.getElementById('modalGerarCobranca');
    const valorInput = document.getElementById('cobrancaValorInput');
    const tituloInput = document.getElementById('cobrancaTituloInput');
    const parcelasInput = document.getElementById('cobrancaParcelasInput');
    if (!modal || !valorInput || !tituloInput || !parcelasInput) return;

    modal.dataset.pedidoId = idParaSalvar;
    valorInput.value = "R$ 0,00";
    tituloInput.value = "";
    parcelasInput.value = "1";
    modal.style.display = 'flex';
    setTimeout(() => valorInput.focus(), 140);
};

window.confirmarGerarCobranca = async function(){
    const modal = document.getElementById('modalGerarCobranca');
    const valorInput = document.getElementById('cobrancaValorInput');
    const tituloInput = document.getElementById('cobrancaTituloInput');
    const parcelasInput = document.getElementById('cobrancaParcelasInput');
    const btnConfirmar = document.getElementById('btnConfirmarGerarCobranca');
    if (!modal || !valorInput || !tituloInput || !parcelasInput || !btnConfirmar) return;

    const idParaSalvar = modal.dataset.pedidoId || chatIdAtual || "";
    if (!idParaSalvar) return;

    const valorDigits = String(valorInput.value || "").replace(/\D/g, "");
    const valorNum = Number(valorDigits || "0") / 100;
    const valorStr = formatCurrencyBRLFromDigits(valorDigits);
    const descricao = String(tituloInput.value || "").trim();
    const maxParcelas = parseInt(String(parcelasInput.value || "1"), 10) || 1;

    if (!valorNum || valorNum <= 0) {
        window.dokeAlert ? window.dokeAlert("Informe um valor válido.") : alert("Informe um valor válido.");
        valorInput.focus();
        return;
    }
    if (!descricao) {
        window.dokeAlert ? window.dokeAlert("Informe o título da cobrança.") : alert("Informe o título da cobrança.");
        tituloInput.focus();
        return;
    }

    btnConfirmar.disabled = true;
    btnConfirmar.innerHTML = "Enviando...";

    const perfil = JSON.parse(localStorage.getItem('doke_usuario_perfil')) || {};
    const nomeProfissional = perfil.user || perfil.nome || "Profissional";
    const fotoProfissional = perfil.foto || "";
    let anuncioFoto = "";
    let anuncioId = "";
    try {
        const pedidoSnap = await getDoc(doc(db, "pedidos", idParaSalvar));
        if (pedidoSnap.exists()) {
            const pedido = pedidoSnap.data() || {};
            anuncioFoto = pedido.anuncioFoto || pedido.fotoAnuncio || pedido.fotoServico || "";
            anuncioId = pedido.anuncioId || pedido.anuncio_id || "";
        }
    } catch (e) {
        console.warn("Erro ao carregar dados do pedido:", e);
    }

    try {
        await addDoc(collection(db, "pedidos", idParaSalvar, "mensagens"), { 
            tipo: 'pagamento', 
            valor: valorStr, 
            descricao: descricao,
            maxparcelas: maxParcelas,
            usernameProfissional: perfil.user, 
            profissionalNome: nomeProfissional,
            profissionalFoto: fotoProfissional,
            anuncioFoto: anuncioFoto,
            anuncioId: anuncioId,
            senderUid: currentUserUid, 
            timestamp: new Date(),
            lidoEm: currentUserUid ? { [currentUserUid]: new Date().toISOString() } : {}
        });
        window.fecharModalGerarCobranca();
    } catch(e) {
        console.error(e);
        alert("Erro ao criar cobrança.");
    } finally {
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = "Enviar cobrança";
    }
};

      window.enviarMensagemTexto = async () => {
          const inp = document.getElementById('inputMsg'); if(!inp.value.trim()) return;
          const txt = inp.value; inp.value = "";
          try {
              if (!chatIdAtual || !colecaoAtual) {
                window.dokeAlert ? window.dokeAlert('Abra um chat antes de enviar.') : alert('Abra um chat antes de enviar.');
                return;
            }
            const uid = currentUserUid || auth.currentUser?.uid || null;
              if (!uid) {
                  window.dokeAlert ? window.dokeAlert('Faça login para enviar mensagens.') : alert('Faça login para enviar mensagens.');
                  return;
              }
              if (isConversaBloqueadaParaEnviar()) {
                  const msg = getMensagemBloqueioConversa();
                  window.dokeAlert ? window.dokeAlert(msg) : alert(msg);
                  return;
              }
              const textoFinal = applyReplyMetaToText(txt);
            await addDoc(collection(db, colecaoAtual, chatIdAtual, "mensagens"), {
                tipo: 'texto',
                texto: textoFinal,
                senderUid: uid,
                timestamp: new Date(),
                lidoEm: uid ? { [uid]: new Date().toISOString() } : {}
            });
            const draftKey = getDraftKey();
            if (draftKey) localStorage.removeItem(draftKey);
            if(colecaoAtual === 'conversas') {
                try {
                    await updateDoc(doc(db, "conversas", chatIdAtual), { ultimaMensagem: txt, dataAtualizacao: new Date().toISOString() });
                } catch (e) { console.warn("Falha ao atualizar conversa:", e); }
            } else if (colecaoAtual === 'pedidos') {
                try {
                    await updateDoc(doc(db, "pedidos", chatIdAtual), { ultimaMensagem: txt, dataAtualizacao: new Date().toISOString() });
                } catch (e) { console.warn("Falha ao atualizar pedido:", e); }
            }
            marcarChatComoLido(colecaoAtual, chatIdAtual);
            cancelarResposta();
        } catch (e) {
            console.error(e);
            window.dokeAlert ? window.dokeAlert("Falha ao enviar. Verifique permissões (RLS) / colunas do Supabase.") : alert("Falha ao enviar. Verifique permissões (RLS).");
        }
    };

    // =============================
    // ANEXOS (imagem/arquivo)
    // =============================
      window.abrirSeletorAnexo = () => {
          if (!chatIdAtual || !colecaoAtual) {
              window.dokeAlert ? window.dokeAlert('Abra um chat antes de anexar.') : alert('Abra um chat antes de anexar.');
              return;
          }
          if (isConversaBloqueadaParaEnviar()) {
              const msg = getMensagemBloqueioConversa();
              window.dokeAlert ? window.dokeAlert(msg) : alert(msg);
              return;
          }
          const input = document.getElementById('inputAnexo');
          if (!input) return;
          input.value = "";
          input.click();
      };

      async function enviarAnexoArquivo(file){
          if (!file) return;
          if (!chatIdAtual || !colecaoAtual) return;
          if (isConversaBloqueadaParaEnviar()) {
              const msg = getMensagemBloqueioConversa();
              window.dokeAlert ? window.dokeAlert(msg) : alert(msg);
              return;
          }

          try {
            const storage = getStorage();
            const safeName = String(file.name || 'anexo').replace(/[^a-zA-Z0-9._-]/g, '_');
            const path = `chat/${colecaoAtual}/${chatIdAtual}/${Date.now()}_${safeName}`;
            const r = ref(storage, path);
            await uploadBytes(r, file);
            const url = await getDownloadURL(r);

            const isImg = (file.type || '').startsWith('image/');
            const textoFinal = applyReplyMetaToText(safeName);
            await addDoc(collection(db, colecaoAtual, chatIdAtual, "mensagens"), {
                tipo: isImg ? 'imagem' : 'arquivo',
                texto: textoFinal,
                url,
                senderUid: currentUserUid,
                timestamp: new Date(),
                lidoEm: currentUserUid ? { [currentUserUid]: new Date().toISOString() } : {}
            });
              if (colecaoAtual === 'pedidos') {
                  try {
                      const preview = isImg ? 'Imagem' : `Arquivo: ${safeName}`;
                      await updateDoc(doc(db, "pedidos", chatIdAtual), { ultimaMensagem: preview, dataAtualizacao: new Date().toISOString() });
                  } catch (e) { console.warn("Falha ao atualizar pedido:", e); }
              } else if (colecaoAtual === 'conversas') {
                  try {
                      const preview = isImg ? 'Imagem' : `Arquivo: ${safeName}`;
                      await updateDoc(doc(db, "conversas", chatIdAtual), { ultimaMensagem: preview, dataAtualizacao: new Date().toISOString() });
                  } catch (e) { console.warn("Falha ao atualizar conversa:", e); }
              }
            marcarChatComoLido(colecaoAtual, chatIdAtual);
            cancelarResposta();
        } catch (e) {
            console.error(e);
            window.dokeAlert ? window.dokeAlert('Falha ao enviar anexo. Verifique o Storage (bucket/policies).') : alert('Falha ao enviar anexo.');
        }
    }

    // Listener do input de anexo
      document.addEventListener('DOMContentLoaded', () => {
          const input = document.getElementById('inputAnexo');
          if (input) {
              input.addEventListener('change', async (e) => {
                  const file = e.target.files && e.target.files[0];
                  await enviarAnexoArquivo(file);
              });
          }
          if (!document.body.dataset.msgMenuBound) {
              document.body.dataset.msgMenuBound = "1";
              document.addEventListener('click', closeMsgMenus);
          }
          const finalizarInputUnico = document.getElementById('finalizarAnexoUnico');
          if (finalizarInputUnico) {
              finalizarInputUnico.addEventListener('change', (e) => {
                  const file = e.target.files && e.target.files[0];
                  finalizacaoFileUnico = file || null;
                  preencherPreviewMidiaFinalizacao('unico', file);
              });
          }
          const finalizarInputAntes = document.getElementById('finalizarAnexoAntes');
          if (finalizarInputAntes) {
              finalizarInputAntes.addEventListener('change', (e) => {
                  const file = e.target.files && e.target.files[0];
                  finalizacaoFileAntes = file || null;
                  preencherPreviewMidiaFinalizacao('antes', file);
              });
          }
          const finalizarInputDepois = document.getElementById('finalizarAnexoDepois');
          if (finalizarInputDepois) {
              finalizarInputDepois.addEventListener('change', (e) => {
                  const file = e.target.files && e.target.files[0];
                  finalizacaoFileDepois = file || null;
                  preencherPreviewMidiaFinalizacao('depois', file);
              });
          }
          window.alterarModoFinalizacao(finalizacaoModo);
        const msgInput = document.getElementById('inputMsg');
        if (msgInput) {
            msgInput.addEventListener('input', salvarRascunhoChat);
            const setKbState = (open) => {
                try {
                    document.body.classList.toggle('chat-kb-open', !!open);
                    document.body.classList.toggle('chat-keyboard-open', !!open);
                } catch (e) {}
            };
            msgInput.addEventListener('focus', () => setKbState(true));
            msgInput.addEventListener('blur', () => setKbState(false));
            if (window.visualViewport) {
                const syncKb = () => {
                    try {
                        const ae = document.activeElement;
                        const isTyping = ae && (ae.id === 'inputMsg' || ae.tagName === 'TEXTAREA');
                        const shrunk = window.visualViewport.height < (window.innerHeight - 90);
                        setKbState(isTyping && shrunk);
                    } catch (e) {}
                };
                window.visualViewport.addEventListener('resize', syncKb);
                window.visualViewport.addEventListener('scroll', syncKb);
                window.addEventListener('orientationchange', () => setKbState(false));
            }
        }
        initScrollDownButton();
    });

    window.verificarEnter = (e) => { if(e.key === 'Enter') window.enviarMensagemTexto(); };

    // Mobile: abrir/fechar painel de conversa (lista -> conversa)
    window.fecharChatMobile = function(){
        try{ document.body.classList.remove('mobile-chat-open'); }catch(e){}
    };


    function isNearBottom(el, threshold){
        if (!el) return true;
        const t = (typeof threshold === 'number') ? threshold : 80;
        return (el.scrollHeight - el.scrollTop - el.clientHeight) <= t;
    }

    function updateScrollDownButton(){
        const btn = document.getElementById('scrollDownBtn');
        const area = document.getElementById('areaMensagens');
        const replyBar = document.getElementById('replyBar');
        if (!btn || !area) return;
        if (replyBar && replyBar.classList.contains('show')) {
            btn.classList.remove('show');
            return;
        }
        if (isNearBottom(area, 80)) btn.classList.remove('show');
        else btn.classList.add('show');
    }

    function initScrollDownButton(){
        const btn = document.getElementById('scrollDownBtn');
        const area = document.getElementById('areaMensagens');
        if (!btn || !area) return;
        if (btn.dataset.bound === '1') return;
        btn.dataset.bound = '1';
        const toggle = () => updateScrollDownButton();
        area.addEventListener('scroll', toggle);
        window.addEventListener('resize', toggle);
        btn.addEventListener('click', () => {
            area.scrollTop = area.scrollHeight;
            updateScrollDownButton();
        });
        updateScrollDownButton();
    }



    async function abrirConversaComUid(uidOutro) {
        if (!uidOutro || !currentUserUid) return;
        try {
            const q = query(collection(db, "conversas"), where("participantes", "array-contains", currentUserUid));
            const snap = await getDocs(q);
            let convo = null;
            snap.forEach((d) => {
                const data = d.data() || {};
                const parts = Array.isArray(data.participantes) ? data.participantes : [];
                if (parts.includes(uidOutro)) {
                    const updatedTs = getConversaUpdated(data);
                    if (!convo || updatedTs > (convo.updatedTs || 0)) {
                        convo = { id: d.id, data, updatedTs };
                    }
                }
            });
            if (!convo) {
                const payload = {
                    participantes: [currentUserUid, uidOutro],
                    dataCriacao: new Date().toISOString(),
                    dataAtualizacao: new Date().toISOString(),
                    ultimaMensagem: ''
                };
                const ref = await addDoc(collection(db, "conversas"), payload);
                convo = { id: ref.id, data: payload, updatedTs: getConversaUpdated(payload) };
            }
            await window.abrirChat(convo.id, uidOutro, '', '', 'conversas', '');
            if (abaAtual !== 'conversas') trocarAba('conversas');
        } catch (e) {
            console.error('Falha ao abrir conversa por uid:', e);
        }
    }

    async function abrirChatDeepLink() {
        const params = new URLSearchParams(window.location.search);
        const chatId = params.get('chatId') || params.get('pedidoId');
        const uidOutro = params.get('uid') || params.get('userUid');

        if (uidOutro && currentUserUid) {
            await abrirConversaComUid(uidOutro);
            return;
        }
        if (!chatId || !currentUserUid) return;

        try {
            const pSnap = await getDoc(doc(db, 'pedidos', chatId));
            if (!pSnap.exists()) return;
            const p = pSnap.data();

            // Descobre o outro usuário
            const deUid = getDeUid(p);
            const paraUid = getParaUid(p);
            const outroUid = (deUid === currentUserUid) ? paraUid : deUid;

            // Abre como pedido (isso vai mostrar o status e travar/destravar o chat)
            await window.abrirChat(chatId, outroUid, '', '', 'pedidos', p.status || '');
        } catch (e) {
            console.error('DeepLink chatId erro:', e);
        }
    }

    let authFallbackTimer = null;
    function bootstrapSessionUser(userLike){
        const uid = String(userLike?.uid || userLike?.id || '').trim();
        if (!uid) return false;
        currentUserUid = uid;
        try {
            localStorage.setItem('usuarioLogado', 'true');
            localStorage.setItem('doke_uid', uid);
        } catch (_) {}
        if (authFallbackTimer) {
            clearTimeout(authFallbackTimer);
            authFallbackTimer = null;
        }
        syncPerfilLocal({
            uid,
            email: userLike?.email || '',
            displayName: userLike?.displayName || userLike?.user_metadata?.nome || ''
        });
        startSidebarBadges();
        startPedidosRealtime();
        carregarListaPedidos();
        abrirChatDeepLink();
        return true;
    }
    async function getSupabaseSessionUser(){
        try {
            if (!window.sb?.auth?.getSession) return null;
            const { data, error } = await window.sb.auth.getSession();
            if (error) return null;
            return data?.session?.user || null;
        } catch (_) {
            return null;
        }
    }
    onAuthStateChanged(auth, async (u) => {
        if (bootstrapSessionUser(u)) return;
        const sbUser = await getSupabaseSessionUser();
        if (bootstrapSessionUser(sbUser)) return;
        const uidLocal = localStorage.getItem('doke_uid');
        const logadoLocal = localStorage.getItem('usuarioLogado') === 'true';
        const tinhaSessaoRecente = !!uidLocal && logadoLocal;
        if (!tinhaSessaoRecente) {
            renderHeaderUser(null);
            window.location.href = "login.html";
            return;
        }
        renderHeaderUser(null);
        if (authFallbackTimer) clearTimeout(authFallbackTimer);
        authFallbackTimer = setTimeout(async () => {
            if (bootstrapSessionUser(auth.currentUser)) return;
            const lateSbUser = await getSupabaseSessionUser();
            if (bootstrapSessionUser(lateSbUser)) return;
            window.location.href = "login.html";
        }, 900);
    });

    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            if (!currentUserUid) {
                const uid = getUserUid();
                if (uid) currentUserUid = uid;
            }
            ensurePedidosLoaded();
        }, 800);
    });

    window.addEventListener('focus', () => {
        if (abaAtual === 'pedidos') ensurePedidosLoaded();
    });

    // --- VARIÃVEIS GLOBAIS PARA ÃUDIO ---
window.mediaRecorder = null;
window.audioChunks = [];
window.timerInterval = null;
window.audioRecordStartedAt = 0;

// 1. Iniciar GravaÃ§Ã£o
window.iniciarGravacao = async function() {
    if (isConversaBloqueadaParaEnviar()) {
        const msg = getMensagemBloqueioConversa();
        window.dokeAlert ? window.dokeAlert(msg) : alert(msg);
        return;
    }
    // Verifica suporte
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Seu navegador não suporta gravação de áudio.");
        return;
    }

    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        window.mediaRecorder = new MediaRecorder(stream);
        window.audioChunks = [];

        window.mediaRecorder.ondataavailable = event => {
            window.audioChunks.push(event.data);
        };

        window.mediaRecorder.start();
        window.audioRecordStartedAt = Date.now();

        // UI: Esconde texto, mostra gravador
        document.getElementById('area-input-texto').style.display = 'none';
        document.getElementById('uiGravando').style.display = 'flex';

        // Timer
        let segundos = 0;
        document.getElementById('timerGravacao').innerText = "00:00";
        window.timerInterval = setInterval(() => {
            segundos++;
            const mins = Math.floor(segundos / 60).toString().padStart(2, '0');
            const secs = (segundos % 60).toString().padStart(2, '0');
            document.getElementById('timerGravacao').innerText = `${mins}:${secs}`;
        }, 1000);

    } catch (err) {
        console.error("Erro ao acessar microfone:", err);
        alert("Permita o uso do microfone para gravar áudio.");
    }
}

// 2. Cancelar GravaÃ§Ã£o
window.cancelarGravacao = function() {
    if (window.mediaRecorder) {
        window.mediaRecorder.stop();
        window.mediaRecorder.stream.getTracks().forEach(track => track.stop()); // Desliga mic
    }
    clearInterval(window.timerInterval);
    window.audioChunks = [];
    window.audioRecordStartedAt = 0;
    
    // UI: Volta ao normal
    document.getElementById('uiGravando').style.display = 'none';
    document.getElementById('area-input-texto').style.display = 'flex';
}

// 3. Enviar Áudio (Salvar no Firebase)
window.enviarAudio = function() {
    if (!window.mediaRecorder) return;
    if (isConversaBloqueadaParaEnviar()) {
        const msg = getMensagemBloqueioConversa();
        window.dokeAlert ? window.dokeAlert(msg) : alert(msg);
        return;
    }

    // Quando o áudio estiver pronto (evento onstop do recorder)
    window.mediaRecorder.onstop = async () => {
        // Cria o arquivo de áudio (Blob)
        const audioBlob = new Blob(window.audioChunks, { type: 'audio/webm' }); // webm Ã© padrÃ£o web
        const gravacaoInicio = Number(window.audioRecordStartedAt || 0);
        const duracaoAudioSec = gravacaoInicio > 0
            ? Math.max(1, Math.round((Date.now() - gravacaoInicio) / 1000))
            : 0;
        window.audioRecordStartedAt = 0;
        
        // Feedback visual
        document.getElementById('uiGravando').style.display = 'none';
        document.getElementById('area-input-texto').style.display = 'flex';
        const btnSend = document.getElementById('btn-send-txt');
        btnSend.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i>"; // Loading

        try {
            const user = auth.currentUser;
            if (!user) throw new Error("Usuário não logado");

            // Precisa de um chat aberto
            if (!chatIdAtual || !colecaoAtual) {
                throw new Error("Nenhuma conversa aberta");
            }

            // Upload para o Storage
            const storage = (typeof getStorage === 'function') ? getStorage() : (window.storage || null);
            const mkRef = (typeof ref === 'function') ? ref : window.ref;
            const uploadFn = (typeof uploadBytes === 'function') ? uploadBytes : window.uploadBytes;
            const getUrlFn = (typeof getDownloadURL === 'function') ? getDownloadURL : window.getDownloadURL;
            if (!storage || !mkRef || !uploadFn || !getUrlFn) {
                throw new Error("Storage indisponível para áudio.");
            }
            const nomeArquivo = `audios/${chatIdAtual}/${Date.now()}.webm`;
            const storageRef = mkRef(storage, nomeArquivo);
            
            const snapshot = await uploadFn(storageRef, audioBlob);
            const downloadUrl = await getUrlFn(snapshot.ref || storageRef);

            // Salvar mensagem no Firestore
            const textoAudio = applyReplyMetaToText("Mensagem de voz");
            await addDoc(collection(db, colecaoAtual, chatIdAtual, "mensagens"), {
                tipo: 'audio',
                url: downloadUrl, // Link do áudio
                texto: textoAudio, // Texto de fallback + reply meta
                duracaoSegundos: duracaoAudioSec,
                senderUid: user.uid,
                timestamp: new Date(),
                lido: false,
                lidoEm: user?.uid ? { [user.uid]: new Date().toISOString() } : {}
            });

            // Atualiza Ãºltima mensagem da conversa
            if(colecaoAtual === 'conversas') {
                try {
                    await updateDoc(doc(db, "conversas", chatIdAtual), { 
                        ultimaMensagem: "Mensagem de voz",
                        dataAtualizacao: new Date().toISOString()
                    });
                } catch (e) { console.warn("Falha ao atualizar conversa:", e); }
            } else if (colecaoAtual === 'pedidos') {
                try {
                    await updateDoc(doc(db, "pedidos", chatIdAtual), {
                        ultimaMensagem: "Mensagem de voz",
                        dataAtualizacao: new Date().toISOString()
                    });
                } catch (e) { console.warn("Falha ao atualizar pedido:", e); }
            }
            marcarChatComoLido(colecaoAtual, chatIdAtual);
            cancelarResposta();

        } catch (e) {
            console.error("Erro no upload do áudio:", e);
            alert("Erro ao enviar áudio.");
        } finally {
            btnSend.innerHTML = "<i class='bx bxs-send'></i>"; // Volta icone normal
        }
    };

    // Para a gravaÃ§Ã£o
    window.mediaRecorder.stop();
    window.mediaRecorder.stream.getTracks().forEach(track => track.stop()); // Desliga mic
    clearInterval(window.timerInterval);
}

// ============================================================
// GALERIA LIGHTBOX
// ============================================================
window.abrirGaleria = function(listaFotos, index) {
    window.fotosAtuais = listaFotos;
    window.indiceAtual = index;
    
    const containerThumbs = document.getElementById('areaThumbnails');
    if(containerThumbs) {
        containerThumbs.innerHTML = ""; 
        listaFotos.forEach((foto, i) => {
            const img = document.createElement('img');
            img.src = foto;
            img.classList.add('thumb-item');
            img.id = `thumb-${i}`; 
            img.onclick = function(e) {
                e.stopPropagation(); 
                window.indiceAtual = i;
                atualizarImagemModal();
            };
            containerThumbs.appendChild(img);
        });
    }

    atualizarImagemModal();
    document.getElementById('modalGaleria').style.display = 'flex';
}

window.mudarImagem = function(direcao) {
    if(!window.fotosAtuais || window.fotosAtuais.length === 0) return;
    window.indiceAtual += direcao;
    if (window.indiceAtual >= window.fotosAtuais.length) window.indiceAtual = 0;
    if (window.indiceAtual < 0) window.indiceAtual = window.fotosAtuais.length - 1;
    atualizarImagemModal();
}

function atualizarImagemModal() {
    const img = document.getElementById('imgExpandida');
    if(img) img.src = window.fotosAtuais[window.indiceAtual];
    
    document.querySelectorAll('.thumb-item').forEach(el => el.classList.remove('ativo'));
    const thumbAtual = document.getElementById(`thumb-${window.indiceAtual}`);
    if(thumbAtual) {
        thumbAtual.classList.add('ativo');
        thumbAtual.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }
}

window.fecharGaleria = function(event) {
    if (!event || event.target.id === 'modalGaleria' || event.target.classList.contains('btn-fechar-galeria')) {
        document.getElementById('modalGaleria').style.display = 'none';
        document.getElementById('imgExpandida').src = "";
    }
}

// 4. FunÃ§Ã£o para Tocar Áudio (Player customizado)
window.tocarAudio = function(btn, url, audioId, duracaoInformada) {
    const audio = new Audio(url);
    const icon = btn.querySelector('i');
    const timeSpan = document.getElementById('audio-time-' + audioId);
    let totalDuracao = Number(duracaoInformada || 0);
    
    if (btn.classList.contains('playing')) return; // Evita clique duplo

    icon.className = 'bx bx-stop';
    btn.classList.add('playing');

    // FunÃ§Ã£o para formatar tempo
    const formatTime = (seconds) => {
        if (!Number.isFinite(seconds) || seconds < 0) return '0:00';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    };

    const syncTimeLabel = () => {
        if (!timeSpan) return;
        const atual = Number(audio.currentTime || 0);
        const finalDur = Number.isFinite(audio.duration) && audio.duration > 0 ? audio.duration : totalDuracao;
        timeSpan.textContent = `${formatTime(atual)} / ${formatTime(finalDur)}`;
    };

    // Atualizar duraÃ§Ã£o quando carregada
    audio.onloadedmetadata = () => {
        if (Number.isFinite(audio.duration) && audio.duration > 0) totalDuracao = audio.duration;
        syncTimeLabel();
    };

    // Atualizar tempo atual durante reproduÃ§Ã£o
    audio.ontimeupdate = () => {
        syncTimeLabel();
    };
    audio.ondurationchange = () => {
        if (Number.isFinite(audio.duration) && audio.duration > 0) totalDuracao = audio.duration;
        syncTimeLabel();
    };

    audio.play();

    audio.onended = () => {
        icon.className = 'bx bx-play';
        btn.classList.remove('playing');
        audio.currentTime = 0;
        syncTimeLabel();
    };
    audio.onerror = () => {
        icon.className = 'bx bx-play';
        btn.classList.remove('playing');
    };
}
    })();
</script>
<div class="galeria-overlay" id="modalGaleria" onclick="fecharGaleria(event)" style="display: none;">
<span class="btn-fechar-galeria">×</span>
<div class="nav-seta esq" onclick="mudarImagem(-1)"><i class="bx bx-chevron-left"></i></div>
<div class="galeria-conteudo"><img decoding="async" id="imgExpandida" loading="lazy" src=""/></div>
<div class="nav-seta dir" onclick="mudarImagem(1)"><i class="bx bx-chevron-right"></i></div>
<div class="galeria-thumbnails" id="areaThumbnails"></div>
</div>
<script>
  (function () {
    const syncChatTopOffset = () => {
      const header = document.querySelector(".doke-mobile-header") || document.querySelector(".navbar-mobile");
      if (!header) return;
      const h = Math.round(header.getBoundingClientRect().height || 0);
      if (h > 0) document.documentElement.style.setProperty("--chat-top-offset", `${h}px`);
    };

    window.addEventListener("resize", syncChatTopOffset);
    window.addEventListener("orientationchange", () => setTimeout(syncChatTopOffset, 120));
    requestAnimationFrame(syncChatTopOffset);

    if (!window.visualViewport) return;

    const body = document.body;
    const isInput = (el) => {
      if (!el) return false;
      const tag = (el.tagName || "").toLowerCase();
      return tag === "input" || tag === "textarea" || el.isContentEditable;
    };

    const refreshKeyboardState = () => {
      const vv = window.visualViewport;
      const keyboardOpen = (window.innerHeight - (vv.height + vv.offsetTop)) > 120;
      body.classList.toggle("chat-keyboard-open", keyboardOpen);

      if (keyboardOpen && isInput(document.activeElement)) {
        const footer = document.getElementById("chatFooter");
        if (footer) footer.scrollIntoView({ block: "nearest" });
      }
    };

    window.visualViewport.addEventListener("resize", refreshKeyboardState);
    window.visualViewport.addEventListener("scroll", refreshKeyboardState);
    document.addEventListener("focusin", refreshKeyboardState);
    document.addEventListener("focusout", () => setTimeout(refreshKeyboardState, 120));
    window.addEventListener("orientationchange", () => setTimeout(refreshKeyboardState, 120));
    window.visualViewport.addEventListener("resize", syncChatTopOffset);
    refreshKeyboardState();
  })();
</script>
<script src="doke-toast.js"></script>
<script src="doke-alerts.js"></script>
<script defer="True" src="doke-config.js"></script><script defer="True" src="doke-ux.js"></script>
<script src="doke-shell.js?v=20260209v22"></script>
<script>
  (function(){
    function recoverPageScroll(){
      try{
        document.documentElement.classList.remove('no-scroll');
        if (document.body) {
          document.body.classList.remove('no-scroll', 'chat-keyboard-open', 'doke-search-open', 'doke-drawer-open', 'doke-menu-open', 'menu-ativo');
          document.body.style.overflow = '';
        }
        document.documentElement.style.overflow = '';
        const overlayMenu = document.getElementById('overlay-menu');
        if (overlayMenu) overlayMenu.style.display = 'none';
        const sidebar = document.querySelector('.sidebar-icones');
        if (sidebar) sidebar.classList.remove('menu-aberto');
      }catch(_){}
    }

    window.addEventListener('pageshow', recoverPageScroll);
    window.addEventListener('focus', recoverPageScroll);
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) recoverPageScroll();
    });
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', recoverPageScroll);
    } else {
      recoverPageScroll();
    }
  })();
</script>
</body>
</html>



